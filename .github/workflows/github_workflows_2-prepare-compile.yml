name: "2. Prepare OpenWrt Compile"

on:
  workflow_dispatch:
  workflow_run:
    workflows: ["1. Prepare OpenWrt Environment"]
    types:
      - completed

env:
  CONFIG_FILE: .config
  DIY_P2_SH: diy-part2.sh
  TZ: Asia/Shanghai

jobs:
  prepare-compile:
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout
      uses: actions/checkout@main

    - name: Restore OpenWrt Source Cache
      uses: actions/cache@v3
      with:
        path: openwrt
        key: openwrt-source-${{ github.sha }}

    - name: Load custom configuration
      run: |
        [ -e files ] && mv files openwrt/files
        [ -e $CONFIG_FILE ] && mv $CONFIG_FILE openwrt/.config
        chmod +x $DIY_P2_SH
        cd openwrt
        $GITHUB_WORKSPACE/$DIY_P2_SH

    - name: Download package
      id: package
      run: |
        cd openwrt
        make defconfig
        make download -j8
        find dl -size -1024c -exec ls -l {} \;
        find dl -size -1024c -exec rm -f {} \;

    - name: Cache OpenWrt Downloads
      uses: actions/cache@v3
      with:
        path: openwrt/dl
        key: openwrt-dl-${{ github.sha }}

    - name: Cache OpenWrt BuildDir
      uses: actions/cache@v3
      with:
        path: openwrt/build_dir
        key: openwrt-build_dir-${{ github.sha }}