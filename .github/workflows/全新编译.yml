name: å…¨æ–°ç¼–è¯‘

on:
  repository_dispatch:
  workflow_dispatch:
    inputs:
      ssh:
        description: 'SSHè°ƒè¯•'
        required: false
        default: 'false'
      clean_build:
        description: 'æ¸…ç†ç¼“å­˜å¹¶å®Œå…¨é‡æ–°ç¼–è¯‘'
        required: false
        default: 'false'
      config_file:
        description: 'é…ç½®æ–‡ä»¶'
        required: false
        default: 'å¢é‡ç¼“å­˜ä¼˜åŒ–.config'

env:
  REPO_URL: https://github.com/coolsnowwolf/lede
  REPO_BRANCH: master
  FEEDS_CONF: feeds.conf.default
  CONFIG_FILE: ${{ github.event.inputs.config_file || 'å¢é‡ç¼“å­˜ä¼˜åŒ–.config' }}
  DIY_P1_SH: diy-part1.sh
  DIY_P2_SH: diy-part2.sh
  UPLOAD_BIN_DIR: false
  UPLOAD_FIRMWARE: true
  UPLOAD_RELEASE: true
  TZ: Asia/Shanghai
  CCACHE_DIR: ${{ github.workspace }}/ccache

jobs:
  build:
    runs-on: ubuntu-22.04
    if: github.event.repository.owner.id == github.event.sender.id || !github.event.sender.id

    steps:
    - name: æ˜¾ç¤ºç£ç›˜ç©ºé—´ä½¿ç”¨æƒ…å†µ(ä¼˜åŒ–å‰)
      run: |
        echo "ä¼˜åŒ–å‰ç£ç›˜ç©ºé—´æƒ…å†µï¼š"
        df -hT

    - name: ä¼˜åŒ–ç£ç›˜ç©ºé—´
      uses: easimon/maximize-build-space@master
      with:
        root-reserve-mb: 2048
        swap-size-mb: 1
        remove-dotnet: 'true'
        remove-android: 'true'
        remove-haskell: 'true'
        remove-codeql: 'true'
        remove-docker-images: 'true'

    - name: æ¸…ç†Dockerèµ„æº
      run: |
        sudo docker image prune --all --force
        sudo rm -rf /etc/apt/sources.list.d/* /usr/share/dotnet /usr/local/lib/android /opt/ghc /usr/local/share/boost /opt/hostedtoolcache/CodeQL

    - name: æ˜¾ç¤ºç£ç›˜ç©ºé—´ä½¿ç”¨æƒ…å†µ(ä¼˜åŒ–å)
      run: |
        echo "ä¼˜åŒ–åç£ç›˜ç©ºé—´æƒ…å†µï¼š"
        df -hT

    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@main

    - name: åˆå§‹åŒ–ç¯å¢ƒ
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        sudo -E apt-get -qq update
        sudo -E apt-get -qq install $(curl -fsSL https://raw.githubusercontent.com/coolsnowwolf/lede/master/prereq-build.mk | grep -o 'package-y += .*' | sed 's/package-y += //g')
        sudo -E apt-get -qq install ack antlr3 asciidoc autoconf automake autopoint binutils bison build-essential \
        bzip2 ccache cmake cpio curl device-tree-compiler fastjar flex gawk gettext gcc-multilib g++-multilib \
        git gperf haveged help2man intltool libc6-dev-i386 libelf-dev libglib2.0-dev libgmp3-dev libltdl-dev \
        libmpc-dev libmpfr-dev libncurses5-dev libncursesw5-dev libreadline-dev libssl-dev libtool lrzsz \
        mkisofs msmtp nano ninja-build p7zip p7zip-full patch pkgconf python2.7 python3 python3-pyelftools \
        libpython3-dev qemu-utils rsync scons squashfs-tools subversion swig texinfo uglifyjs upx-ucl unzip \
        vim wget xmlto xxd zlib1g-dev python3-setuptools
        sudo -E apt-get -qq autoremove --purge
        sudo -E apt-get -qq clean
        sudo timedatectl set-timezone "$TZ"
        sudo mkdir -p /workdir
        sudo chown $USER:$GROUPS /workdir
        echo "WORKDIR=/workdir" >> $GITHUB_ENV

    - name: å…‹éš†æºä»£ç 
      working-directory: /workdir
      run: |
        df -hT $PWD
        git clone --depth 1 $REPO_URL -b $REPO_BRANCH openwrt
        ln -sf /workdir/openwrt $GITHUB_WORKSPACE/openwrt
        cd openwrt
        find . -type f -name "*.sh" -exec chmod +x {} \;

    # æ¢å¤å·¥å…·é“¾ç¼“å­˜
    - name: æ¢å¤å·¥å…·é“¾ç¼“å­˜
      uses: actions/cache@v3
      if: inputs.clean_build != 'true'
      with:
        path: |
          /workdir/openwrt/staging_dir/toolchain-*
          /workdir/openwrt/build_dir/toolchain-*
        key: toolchain-${{ env.REPO_URL }}-${{ env.REPO_BRANCH }}-${{ hashFiles(format('{0}/{1}', github.workspace, env.CONFIG_FILE)) }}
        restore-keys: |
          toolchain-${{ env.REPO_URL }}-${{ env.REPO_BRANCH }}-

    # æ¢å¤åŒ…ç¼“å­˜
    - name: æ¢å¤è½¯ä»¶åŒ…ç¼“å­˜
      uses: actions/cache@v3
      if: inputs.clean_build != 'true'
      with:
        path: |
          /workdir/openwrt/build_dir/target-*
          /workdir/openwrt/staging_dir/target-*
          /workdir/openwrt/bin/packages
          /workdir/package_hashes
          /workdir/previous_packages.txt
        key: packages-${{ env.REPO_URL }}-${{ env.REPO_BRANCH }}-${{ hashFiles(format('{0}/{1}', github.workspace, env.CONFIG_FILE)) }}
        restore-keys: |
          packages-${{ env.REPO_URL }}-${{ env.REPO_BRANCH }}-

    # æ¢å¤ä¸‹è½½ç¼“å­˜
    - name: æ¢å¤ä¸‹è½½ç¼“å­˜
      uses: actions/cache@v3
      with:
        path: |
          /workdir/openwrt/dl
        key: dl-${{ env.REPO_URL }}-${{ env.REPO_BRANCH }}-${{ hashFiles(format('{0}/{1}', github.workspace, env.CONFIG_FILE)) }}
        restore-keys: |
          dl-${{ env.REPO_URL }}-${{ env.REPO_BRANCH }}-

    # æ¢å¤CCACHEç¼“å­˜
    - name: æ¢å¤CCACHEç¼“å­˜
      uses: actions/cache@v3
      with:
        path: ${{ env.CCACHE_DIR }}
        key: ccache-${{ env.REPO_URL }}-${{ env.REPO_BRANCH }}-${{ hashFiles(format('{0}/{1}', github.workspace, env.CONFIG_FILE)) }}
        restore-keys: |
          ccache-${{ env.REPO_URL }}-${{ env.REPO_BRANCH }}-

    # åˆ›å»ºç¬¦å·é“¾æ¥
    - name: åˆ›å»ºç¬¦å·é“¾æ¥
      run: |
        sudo mkdir -p -m 777 /mnt/openwrt/dl /mnt/openwrt/staging_dir
        [ -d /workdir/openwrt/dl ] || mkdir -p /workdir/openwrt/dl
        [ -d /workdir/openwrt/staging_dir ] || mkdir -p /workdir/openwrt/staging_dir

    - name: åŠ è½½è‡ªå®šä¹‰feeds
      run: |
        [ -e $FEEDS_CONF ] && mv $FEEDS_CONF /workdir/openwrt/feeds.conf.default
        chmod +x $DIY_P1_SH
        cd /workdir/openwrt
        $GITHUB_WORKSPACE/$DIY_P1_SH

    - name: æ›´æ–°feeds
      run: |
        cd /workdir/openwrt
        ./scripts/feeds update -a

    - name: å®‰è£…feeds
      run: |
        cd /workdir/openwrt
        ./scripts/feeds install -a

    - name: åŠ è½½è‡ªå®šä¹‰é…ç½®
      run: |
        [ -e files ] && mv files /workdir/openwrt/files
        if [ ! -e "$CONFIG_FILE" ]; then
          echo "Error: $CONFIG_FILE not found!" >&2
          exit 1
        fi
        mv $CONFIG_FILE /workdir/openwrt/.config
        chmod +x $DIY_P2_SH
        cd /workdir/openwrt
        $GITHUB_WORKSPACE/$DIY_P2_SH

    - name: å¼€å¯SSHè°ƒè¯•
      uses: mxschmitt/action-tmate@v3
      if: github.event.inputs.ssh == 'true'

    - name: ä¸‹è½½è½¯ä»¶åŒ…
      id: package
      run: |
        cd /workdir/openwrt
        make defconfig
        echo "å¼€å§‹ä¸‹è½½è½¯ä»¶åŒ…..."
        
        # æ›´å¯é çš„è½¯ä»¶åŒ…ä¸‹è½½æ–¹æ³•
        make download -j1 || make download -j1 V=s
        
        # é‡è¯•å¤±è´¥çš„ä¸‹è½½
        for i in {1..3}; do
          make download -j1 || true
          find dl -size -1024c -exec ls -l {} \;
          find dl -size -1024c -exec rm -f {} \;
          
          # æ£€æŸ¥æ˜¯å¦æ‰€æœ‰åŒ…éƒ½å·²ä¸‹è½½å®Œæˆ
          if ! grep -q "ERROR: package/.* failed to download" /tmp/download.log 2>/dev/null; then
            echo "æ‰€æœ‰è½¯ä»¶åŒ…ä¸‹è½½æˆåŠŸ!"
            break
          fi
          
          echo "ç¬¬ $i æ¬¡é‡è¯•ä¸‹è½½å¤±è´¥çš„è½¯ä»¶åŒ…..."
          sleep 2
        done

    - name: é…ç½®CCACHE
      run: |
        cd /workdir/openwrt
        echo "é…ç½®CCACHEå‚æ•°"
        mkdir -p ${{ env.CCACHE_DIR }}
        ccache -o cache_dir=${{ env.CCACHE_DIR }}
        ccache -o max_size=10G
        ccache -z

    - name: å¢é‡ç¼–è¯‘å›ºä»¶
      id: compile
      run: |
        cd /workdir/openwrt
        echo -e "$(nproc) çº¿ç¨‹ç¼–è¯‘"
        
        # è®¾ç½®CCACHEç¯å¢ƒå˜é‡
        export CCACHE_DIR=${{ env.CCACHE_DIR }}
        export PATH="/usr/lib/ccache:$PATH"
        
        # å¦‚æœæ˜¯å¼ºåˆ¶å®Œå…¨é‡æ–°ç¼–è¯‘
        if [ "${{ github.event.inputs.clean_build }}" = "true" ]; then
          echo "è¿›è¡Œå®Œå…¨é‡æ–°ç¼–è¯‘..."
          make -j$(nproc) || make -j1 V=s
          echo "status=success" >> $GITHUB_OUTPUT
          exit 0
        fi
        
        # æ£€æŸ¥å·¥å…·é“¾
        if [ ! -d "staging_dir/toolchain-x86_64_gcc-*" ]; then
          echo "å·¥å…·é“¾æœªç¼“å­˜ï¼Œç¼–è¯‘å·¥å…·é“¾..."
          make -j$(nproc) tools/install || make -j1 V=s tools/install
          make -j$(nproc) toolchain/install || make -j1 V=s toolchain/install
        else
          echo "å·¥å…·é“¾å·²ä»ç¼“å­˜æ¢å¤ï¼Œè·³è¿‡ç¼–è¯‘ã€‚"
        fi
        
        # è·å–å½“å‰é…ç½®çš„è½¯ä»¶åŒ…åˆ—è¡¨
        grep "^CONFIG_PACKAGE" .config | sort > /workdir/current_packages.txt
        
        # æ£€æŸ¥å¢é‡ç¼–è¯‘
        if [ ! -f "/workdir/previous_packages.txt" ]; then
          echo "é¦–æ¬¡è¿è¡Œï¼Œç¼–è¯‘æ‰€æœ‰è½¯ä»¶åŒ…..."
          make -j$(nproc) || make -j1 V=s
          cp /workdir/current_packages.txt /workdir/previous_packages.txt
        else
          echo "æ£€æµ‹åˆ°å¢é‡ç¼–è¯‘..."
          
          # æ¯”è¾ƒè½¯ä»¶åŒ…å·®å¼‚
          mkdir -p /workdir/package_hashes
          
          # æ£€æŸ¥å·²æ·»åŠ æˆ–å·²ç§»é™¤çš„è½¯ä»¶åŒ…
          comm -13 /workdir/previous_packages.txt /workdir/current_packages.txt > /workdir/added_packages.txt
          comm -23 /workdir/previous_packages.txt /workdir/current_packages.txt > /workdir/removed_packages.txt
          comm -12 /workdir/previous_packages.txt /workdir/current_packages.txt > /workdir/unchanged_packages.txt
          
          # è®¡ç®—å¹¶æ¯”è¾ƒè½¯ä»¶åŒ…å“ˆå¸Œå€¼ä»¥æ£€æµ‹æ›´æ”¹
          for pkg in $(grep "^CONFIG_PACKAGE" .config | sed 's/CONFIG_PACKAGE_\(.*\)=y/\1/'); do
            pkg_dir=$(find package feeds -type d -name "$pkg" | head -n 1)
            if [ -n "$pkg_dir" ]; then
              find "$pkg_dir" -type f -not -path "*/.git/*" -exec sha256sum {} \; | sort | sha256sum > "/workdir/package_hashes/$pkg.current"
            fi
          done
          
          # æ£€æŸ¥å·²æ›´æ”¹çš„è½¯ä»¶åŒ…
          cat /workdir/added_packages.txt > /workdir/compile_list.txt
          if [ -s /workdir/unchanged_packages.txt ]; then
            for pkg in $(cat /workdir/unchanged_packages.txt | sed 's/CONFIG_PACKAGE_\(.*\)=y/\1/'); do
              if [ -f "/workdir/package_hashes/$pkg.current" ] && [ -f "/workdir/package_hashes/$pkg.previous" ]; then
                if ! cmp -s "/workdir/package_hashes/$pkg.current" "/workdir/package_hashes/$pkg.previous"; then
                  echo "CONFIG_PACKAGE_$pkg=y" >> /workdir/compile_list.txt
                fi
              elif [ -f "/workdir/package_hashes/$pkg.current" ]; then
                echo "CONFIG_PACKAGE_$pkg=y" >> /workdir/compile_list.txt
              fi
              [ -f "/workdir/package_hashes/$pkg.current" ] && mv "/workdir/package_hashes/$pkg.current" "/workdir/package_hashes/$pkg.previous"
            done
          fi
          
          # å¤„ç†å·²ç§»é™¤çš„è½¯ä»¶åŒ…
          if [ -s /workdir/removed_packages.txt ]; then
            echo "æ¸…ç†å·²ç§»é™¤çš„è½¯ä»¶åŒ…..."
            while read -r pkg; do
              pkg_name=$(echo "$pkg" | sed 's/CONFIG_PACKAGE_\(.*\)=y/\1/')
              make package/$pkg_name/clean || echo "è­¦å‘Š: $pkg_name æ¸…ç†å¤±è´¥ï¼Œç»§ç»­æ‰§è¡Œ..."
            done < /workdir/removed_packages.txt
          fi
          
          # ç¼–è¯‘æ–°å¢æˆ–æ›´æ–°çš„è½¯ä»¶åŒ…
          if [ -s /workdir/compile_list.txt ]; then
            echo "ç¼–è¯‘æ–°å¢æˆ–æ›´æ–°çš„è½¯ä»¶åŒ…..."
            
            # é¦–å…ˆå°è¯•ä¸€æ¬¡æ•´ä½“ç¼–è¯‘æ‰€æœ‰éœ€è¦é‡æ–°ç¼–è¯‘çš„åŒ…
            # è¿™æ ·å¯ä»¥æ›´å¥½åœ°å¤„ç†ä¾èµ–å…³ç³»
            if [ $(cat /workdir/compile_list.txt | wc -l) -gt 5 ]; then
              echo "æ£€æµ‹åˆ°å¤§é‡åŒ…éœ€è¦æ›´æ–°ï¼Œæ‰§è¡Œæ•´ä½“ç¼–è¯‘..."
              make -j$(nproc) || make -j1 V=s
            else
              # å¦‚æœåªæœ‰å°‘é‡åŒ…éœ€è¦æ›´æ–°ï¼Œåˆ™é€ä¸ªç¼–è¯‘
              while read -r pkg; do
                pkg_name=$(echo "$pkg" | sed 's/CONFIG_PACKAGE_\(.*\)=y/\1/')
                echo "ç¼–è¯‘è½¯ä»¶åŒ…: $pkg_name"
                
                # å°è¯•3æ¬¡ç¼–è¯‘è¯¥è½¯ä»¶åŒ…
                for attempt in {1..3}; do
                  echo "ç¬¬ $attempt æ¬¡å°è¯•ç¼–è¯‘ $pkg_name..."
                  if make package/$pkg_name/compile -j$(nproc); then
                    echo "$pkg_name ç¼–è¯‘æˆåŠŸ!"
                    break
                  elif [ $attempt -eq 3 ]; then
                    echo "è­¦å‘Š: $pkg_name ç¼–è¯‘å¤±è´¥ï¼Œå°è¯•ä½œä¸ºä¾èµ–é¡¹ç»§ç»­..."
                  else
                    echo "$pkg_name ç¼–è¯‘å¤±è´¥ï¼Œ2ç§’åé‡è¯•..."
                    sleep 2
                  fi
                done
              done < /workdir/compile_list.txt
              
              # æœ€åæ‰§è¡Œä¸€æ¬¡æ•´ä½“ç¼–è¯‘ç¡®ä¿æ‰€æœ‰ä¾èµ–éƒ½æ­£ç¡®å¤„ç†
              echo "æ‰§è¡Œæœ€ç»ˆæ•´ä½“ç¼–è¯‘ç¡®ä¿ä¾èµ–å…³ç³»æ­£ç¡®..."
              make -j$(nproc) || make -j1 V=s
            fi
          else
            echo "æ²¡æœ‰æ–°å¢æˆ–æ›´æ–°çš„è½¯ä»¶åŒ…éœ€è¦ç¼–è¯‘ã€‚"
          fi
          
          # æ£€æŸ¥å†…æ ¸æ›´æ–°
          git fetch origin $REPO_BRANCH
          if [ "$(git rev-parse HEAD)" != "$(git rev-parse origin/$REPO_BRANCH)" ] || \
             [ ! -f "/workdir/feeds_hash" ] || [ "$(sha256sum feeds.conf.default | awk '{print $1}')" != "$(cat /workdir/feeds_hash)" ]; then
            echo "æºä»£ç æˆ–feedså·²æ›´æ–°ï¼Œé‡æ–°ç¼–è¯‘å†…æ ¸..."
            make target/linux/clean
            make target/linux/compile -j$(nproc) || make target/linux/compile -j1 V=s
            sha256sum feeds.conf.default | awk '{print $1}' > /workdir/feeds_hash
          fi
          
          # æ„å»ºç›®æ ‡æ–‡ä»¶ç³»ç»Ÿ
          echo "æ„å»ºç›®æ ‡æ–‡ä»¶ç³»ç»Ÿ..."
          make -j$(nproc) || make -j1 V=s
          cp /workdir/current_packages.txt /workdir/previous_packages.txt
        fi
        
        echo "çŠ¶æ€ï¼šæˆåŠŸ"
        echo "status=success" >> $GITHUB_OUTPUT
        echo "DEVICE_NAME=_$(grep '^CONFIG_TARGET.*DEVICE.*=y' .config | sed -r 's/.*DEVICE_(.*)=y/\1/' | tr '\n' '_')" >> $GITHUB_ENV
        echo "FILE_DATE=_$(date +"%Y%m%d%H%M")" >> $GITHUB_ENV
        
        # æ˜¾ç¤ºCCACHEç»Ÿè®¡ä¿¡æ¯
        ccache -s

    - name: æ£€æŸ¥ç©ºé—´ä½¿ç”¨æƒ…å†µ
      if: (!cancelled())
      run: df -hT

    - name: æ•´ç†æ–‡ä»¶
      id: organize
      if: env.UPLOAD_FIRMWARE == 'true' && !cancelled()
      run: |
        cd /workdir/openwrt/bin/targets/*/*
        rm -rf packages
        mkdir -p firmware
        find . -maxdepth 1 -name "*combined*" -or -name "*sysupgrade*" | xargs -i cp {} ./firmware/
        cp /workdir/openwrt/.config ./firmware/config.txt
        zip -r firmware.zip firmware
        echo "FIRMWARE=$PWD/firmware" >> $GITHUB_ENV
        echo "FIRMWARE_ZIP=$PWD/firmware.zip" >> $GITHUB_ENV
        echo "status=success" >> $GITHUB_OUTPUT

    - name: ä¸Šä¼ å›ºä»¶ç›®å½•
      uses: actions/upload-artifact@main
      if: steps.organize.outputs.status == 'success' && !cancelled()
      with:
        name: OpenWrt_firmware${{ env.DEVICE_NAME }}${{ env.FILE_DATE }}
        path: ${{ env.FIRMWARE }}

    - name: ç”Ÿæˆå‘å¸ƒæ ‡ç­¾
      id: tag
      if: env.UPLOAD_RELEASE == 'true' && !cancelled()
      run: |
        echo "release_tag=$(date +"%Y.%m.%d-%H%M")" >> $GITHUB_OUTPUT
        echo "## OpenWrtå›ºä»¶æ„å»ºå®Œæˆ ğŸ“¦" > release.txt
        echo "ğŸ“… æ„å»ºæ—¶é—´: $(date +"%Y-%m-%d %H:%M")" >> release.txt
        echo "ğŸ“‚ å›ºä»¶ä¸‹è½½" >> release.txt
        echo "âš ï¸ è¯·åœ¨åˆ·æœºå‰å…ˆåšå¥½å¤‡ä»½ï¼" >> release.txt
        echo "status=success" >> $GITHUB_OUTPUT

    - name: ä¸Šä¼ å›ºä»¶åˆ°Releases
      uses: softprops/action-gh-release@v2
      if: steps.tag.outputs.status == 'success' && !cancelled()
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ steps.tag.outputs.release_tag }}
        body_path: release.txt
        files: ${{ env.FIRMWARE }}/*

    - name: åˆ é™¤æ—§çš„å·¥ä½œæµè¿è¡Œè®°å½•
      uses: Mattraks/delete-workflow-runs@v2
      with:
        retain_days: 1
        keep_minimum_runs: 3

    - name: åˆ é™¤æ—§çš„Releases
      uses: dev-drprasad/delete-older-releases@master
      if: env.UPLOAD_RELEASE == 'true' && !cancelled()
      with:
        keep_latest: 3
        delete_tags: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
