name: åŸºäºŽDockerçš„OpenWrtå¢žé‡ç¼–è¯‘

on:
  # å®šæ—¶è¿è¡Œï¼Œæ¯å¤©æ£€æŸ¥æºç æ›´æ–°
  schedule:
    - cron: '0 0 * * *'  # æ¯å¤©åˆå¤œè¿è¡Œä¸€æ¬¡
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      ssh:
        description: 'SSHè°ƒè¯•'
        required: false
        default: 'false'
      clean_build:
        description: 'å®Œå…¨é‡æ–°ç¼–è¯‘'
        required: false
        default: 'false'
      config_file:
        description: 'é…ç½®æ–‡ä»¶'
        required: false
        default: 'å¢žé‡ç¼“å­˜ä¼˜åŒ–.config'
      force_update:
        description: 'å¼ºåˆ¶æ›´æ–°æºç å¹¶ç¼–è¯‘'
        required: false
        default: 'false'

env:
  REPO_URL: https://github.com/coolsnowwolf/lede
  REPO_BRANCH: master
  FEEDS_CONF_URL: https://github.com/tikkacn/openwrt-new-rom/raw/main/feeds.conf.default
  CONFIG_FILE: ${{ github.event.inputs.config_file || 'å¢žé‡ç¼“å­˜ä¼˜åŒ–.config' }}
  DIY_P1_SH: diy-part1.sh
  DIY_P2_SH: diy-part2.sh
  UPLOAD_FIRMWARE: true
  UPLOAD_RELEASE: true
  TZ: Asia/Shanghai
  # ç¼“å­˜ç›®å½•çŽ¯å¢ƒå˜é‡
  CCACHE_DIR: /workdir/ccache
  BUILD_STATE_DIR: /workdir/build_state

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@main

    - name: ä¼˜åŒ–ç£ç›˜ç©ºé—´
      uses: easimon/maximize-build-space@master
      with:
        root-reserve-mb: 10240  # å‡å°‘åˆ°10GB
        swap-size-mb: 1024      # å‡å°swapç©ºé—´
        remove-dotnet: 'true'
        remove-android: 'true'
        remove-haskell: 'true'
        remove-codeql: 'true'
        remove-docker-images: 'true'
        build-mount-path: '/workdir'

    # æ¢å¤æºç ç›®å½•ç¼“å­˜ - æ–°å¢žæ­¥éª¤
    - name: æ¢å¤æºç ç›®å½•ç¼“å­˜
      uses: actions/cache@v3
      id: cache-source
      if: github.event.inputs.clean_build != 'true'
      with:
        path: /workdir/openwrt
        key: source-docker-${{ env.REPO_BRANCH }}-${{ github.run_id }}
        restore-keys: |
          source-docker-${{ env.REPO_BRANCH }}-

    # æ¢å¤CCACHEç¼“å­˜
    - name: æ¢å¤CCACHEç¼“å­˜
      uses: actions/cache@v3
      id: cache-ccache
      with:
        path: /workdir/ccache
        key: ccache-docker-${{ env.REPO_BRANCH }}-${{ hashFiles(env.CONFIG_FILE) }}
        restore-keys: |
          ccache-docker-${{ env.REPO_BRANCH }}-

    # æ¢å¤æž„å»ºçŠ¶æ€ç¼“å­˜
    - name: æ¢å¤æž„å»ºçŠ¶æ€ç¼“å­˜
      uses: actions/cache@v3
      id: cache-state
      if: github.event.inputs.clean_build != 'true'
      with:
        path: /workdir/build_state
        key: state-docker-${{ env.REPO_BRANCH }}-${{ hashFiles(env.CONFIG_FILE) }}
        restore-keys: |
          state-docker-${{ env.REPO_BRANCH }}-

    # æ¢å¤åŽ‹ç¼©çš„ç¼–è¯‘ç¼“å­˜
    - name: æ¢å¤åŽ‹ç¼©çš„ç¼–è¯‘ç¼“å­˜ - bin
      uses: actions/cache@v3
      id: cache-bin
      if: github.event.inputs.clean_build != 'true'
      with:
        path: /workdir/cached_archives/bin.tar.gz
        key: bin-docker-${{ env.REPO_BRANCH }}-${{ hashFiles(env.CONFIG_FILE) }}
        restore-keys: |
          bin-docker-${{ env.REPO_BRANCH }}-

    - name: æ¢å¤åŽ‹ç¼©çš„ç¼–è¯‘ç¼“å­˜ - staging_dir
      uses: actions/cache@v3
      id: cache-staging
      if: github.event.inputs.clean_build != 'true'
      with:
        path: /workdir/cached_archives/staging_dir.tar.gz
        key: staging-docker-${{ env.REPO_BRANCH }}-${{ hashFiles(env.CONFIG_FILE) }}
        restore-keys: |
          staging-docker-${{ env.REPO_BRANCH }}-

    - name: æ¢å¤åŽ‹ç¼©çš„ç¼–è¯‘ç¼“å­˜ - build_dir target
      uses: actions/cache@v3
      id: cache-build-target
      if: github.event.inputs.clean_build != 'true'
      with:
        path: /workdir/cached_archives/build_dir_target.tar.gz
        key: build-target-docker-${{ env.REPO_BRANCH }}-${{ hashFiles(env.CONFIG_FILE) }}
        restore-keys: |
          build-target-docker-${{ env.REPO_BRANCH }}-

    - name: æ¢å¤åŽ‹ç¼©çš„ç¼–è¯‘ç¼“å­˜ - build_dir host
      uses: actions/cache@v3
      id: cache-build-host
      if: github.event.inputs.clean_build != 'true'
      with:
        path: /workdir/cached_archives/build_dir_host.tar.gz
        key: build-host-docker-${{ env.REPO_BRANCH }}-${{ hashFiles(env.CONFIG_FILE) }}
        restore-keys: |
          build-host-docker-${{ env.REPO_BRANCH }}-

    - name: æ¢å¤åŽ‹ç¼©çš„ç¼–è¯‘ç¼“å­˜ - build_dir toolchain
      uses: actions/cache@v3
      id: cache-build-toolchain
      if: github.event.inputs.clean_build != 'true'
      with:
        path: /workdir/cached_archives/build_dir_toolchain.tar.gz
        key: build-toolchain-docker-${{ env.REPO_BRANCH }}-${{ hashFiles(env.CONFIG_FILE) }}
        restore-keys: |
          build-toolchain-docker-${{ env.REPO_BRANCH }}-

    # è§£åŽ‹ç¼“å­˜
    - name: è§£åŽ‹ç¼“å­˜
      if: github.event.inputs.clean_build != 'true'
      run: |
        mkdir -p /workdir/cached_archives /workdir/openwrt/bin /workdir/openwrt/build_dir /workdir/openwrt/staging_dir
        
        # è§£åŽ‹binç¼“å­˜
        if [ -f "/workdir/cached_archives/bin.tar.gz" ]; then
          echo "è§£åŽ‹binç¼“å­˜..."
          tar -xzf /workdir/cached_archives/bin.tar.gz -C /workdir/openwrt
        fi
        
        # è§£åŽ‹staging_dirç¼“å­˜
        if [ -f "/workdir/cached_archives/staging_dir.tar.gz" ]; then
          echo "è§£åŽ‹staging_dirç¼“å­˜..."
          tar -xzf /workdir/cached_archives/staging_dir.tar.gz -C /workdir/openwrt
        fi
        
        # è§£åŽ‹build_dirç¼“å­˜
        if [ -f "/workdir/cached_archives/build_dir_target.tar.gz" ]; then
          echo "è§£åŽ‹targetç¼“å­˜..."
          tar -xzf /workdir/cached_archives/build_dir_target.tar.gz -C /workdir/openwrt
        fi
        
        if [ -f "/workdir/cached_archives/build_dir_host.tar.gz" ]; then
          echo "è§£åŽ‹hostç¼“å­˜..."
          tar -xzf /workdir/cached_archives/build_dir_host.tar.gz -C /workdir/openwrt
        fi
        
        if [ -f "/workdir/cached_archives/build_dir_toolchain.tar.gz" ]; then
          echo "è§£åŽ‹toolchainç¼“å­˜..."
          tar -xzf /workdir/cached_archives/build_dir_toolchain.tar.gz -C /workdir/openwrt
        fi
        
        # è®¾ç½®æƒé™
        chmod -R 777 /workdir/openwrt

    - name: æ‹‰å– Docker é•œåƒ
      run: docker pull ghcr.io/${{ github.repository_owner }}/openwrt-toolchain:latest

    - name: åœ¨Dockerå®¹å™¨ä¸­è¿è¡Œæž„å»ºå’Œæ‰“åŒ…ä»»åŠ¡
      env:
        CLEAN_BUILD: ${{ github.event.inputs.clean_build }}
        FORCE_UPDATE: ${{ github.event.inputs.force_update }}
        SSH_DEBUG: ${{ github.event.inputs.ssh }}
      run: |
        # èŽ·å–å½“å‰ç”¨æˆ·ID
        echo "å½“å‰ç”¨æˆ·ID: $(id -u):$(id -g)"
        
        # è®¾ç½®æƒé™
        chmod 777 -R /workdir
        
        docker run --rm -v ${{ github.workspace }}:/src -v /workdir:/workdir --privileged \
          -e REPO_URL="${REPO_URL}" \
          -e REPO_BRANCH="${REPO_BRANCH}" \
          -e FEEDS_CONF_URL="${FEEDS_CONF_URL}" \
          -e CONFIG_FILE="${CONFIG_FILE}" \
          -e DIY_P1_SH="${DIY_P1_SH}" \
          -e DIY_P2_SH="${DIY_P2_SH}" \
          -e UPLOAD_FIRMWARE="${UPLOAD_FIRMWARE}" \
          -e UPLOAD_RELEASE="${UPLOAD_RELEASE}" \
          -e TZ="${TZ}" \
          -e CCACHE_DIR="${CCACHE_DIR}" \
          -e BUILD_STATE_DIR="${BUILD_STATE_DIR}" \
          -e GITHUB_WORKSPACE="/src" \
          -e GITHUB_ENV="/src/.env" \
          -e GITHUB_OUTPUT="/src/.output" \
          -e CLEAN_BUILD="${CLEAN_BUILD}" \
          -e FORCE_UPDATE="${FORCE_UPDATE}" \
          -e SSH_DEBUG="${SSH_DEBUG}" \
          ghcr.io/${{ github.repository_owner }}/openwrt-toolchain:latest \
          /bin/bash -c "cd /src && chmod +x build-openwrt.sh && sudo -E ./build-openwrt.sh"

    - name: ä¿å­˜çŽ¯å¢ƒå˜é‡
      run: |
        if [ -f .env ]; then
          cat .env >> $GITHUB_ENV
        fi
        if [ -f .output ]; then
          cat .output >> $GITHUB_OUTPUT
        fi

    # ä¿å­˜æºç ç›®å½•ç¼“å­˜ - æ–°å¢žæ­¥éª¤
    - name: ä¿å­˜æºç ç›®å½•ç¼“å­˜
      uses: actions/cache@v3
      if: always() && !cancelled()
      with:
        path: /workdir/openwrt
        key: source-docker-${{ env.REPO_BRANCH }}-${{ github.run_id }}

    # ä¿å­˜CCACHEç¼“å­˜
    - name: ä¿å­˜CCACHEç¼“å­˜
      uses: actions/cache@v3
      if: always() && !cancelled()
      with:
        path: /workdir/ccache
        key: ccache-docker-${{ env.REPO_BRANCH }}-${{ hashFiles(env.CONFIG_FILE) }}

    # ä¿å­˜æž„å»ºçŠ¶æ€ç¼“å­˜
    - name: ä¿å­˜æž„å»ºçŠ¶æ€ç¼“å­˜
      uses: actions/cache@v3
      if: always() && !cancelled()
      with:
        path: /workdir/build_state
        key: state-docker-${{ env.REPO_BRANCH }}-${{ hashFiles(env.CONFIG_FILE) }}

    # ä¿å­˜åŽ‹ç¼©çš„ç¼–è¯‘ç¼“å­˜
    - name: ä¿å­˜åŽ‹ç¼©çš„ç¼–è¯‘ç¼“å­˜ - bin
      uses: actions/cache@v3
      if: always() && !cancelled()
      with:
        path: /workdir/cached_archives/bin.tar.gz
        key: bin-docker-${{ env.REPO_BRANCH }}-${{ hashFiles(env.CONFIG_FILE) }}

    - name: ä¿å­˜åŽ‹ç¼©çš„ç¼–è¯‘ç¼“å­˜ - staging_dir
      uses: actions/cache@v3
      if: always() && !cancelled()
      with:
        path: /workdir/cached_archives/staging_dir.tar.gz
        key: staging-docker-${{ env.REPO_BRANCH }}-${{ hashFiles(env.CONFIG_FILE) }}

    - name: ä¿å­˜åŽ‹ç¼©çš„ç¼–è¯‘ç¼“å­˜ - build_dir target
      uses: actions/cache@v3
      if: always() && !cancelled()
      with:
        path: /workdir/cached_archives/build_dir_target.tar.gz
        key: build-target-docker-${{ env.REPO_BRANCH }}-${{ hashFiles(env.CONFIG_FILE) }}

    - name: ä¿å­˜åŽ‹ç¼©çš„ç¼–è¯‘ç¼“å­˜ - build_dir host
      uses: actions/cache@v3
      if: always() && !cancelled()
      with:
        path: /workdir/cached_archives/build_dir_host.tar.gz
        key: build-host-docker-${{ env.REPO_BRANCH }}-${{ hashFiles(env.CONFIG_FILE) }}

    - name: ä¿å­˜åŽ‹ç¼©çš„ç¼–è¯‘ç¼“å­˜ - build_dir toolchain
      uses: actions/cache@v3
      if: always() && !cancelled()
      with:
        path: /workdir/cached_archives/build_dir_toolchain.tar.gz
        key: build-toolchain-docker-${{ env.REPO_BRANCH }}-${{ hashFiles(env.CONFIG_FILE) }}

    # ä¸Šä¼ å›ºä»¶
    - name: ä¸Šä¼ å›ºä»¶ç›®å½•
      uses: actions/upload-artifact@main
      if: env.UPLOAD_FIRMWARE == 'true' && !cancelled() && env.BUILD_SUCCESS == 'true'
      with:
        name: OpenWrt_firmware${{ env.DEVICE_NAME }}${{ env.FILE_DATE }}
        path: /workdir/firmware

    - name: ç”Ÿæˆå‘å¸ƒæ ‡ç­¾
      id: tag
      if: env.UPLOAD_RELEASE == 'true' && !cancelled() && env.BUILD_SUCCESS == 'true'
      run: |
        echo "RELEASE_TAG=$(date +"%Y.%m.%d-%H%M")" >> $GITHUB_OUTPUT
        echo "## OpenWrtå›ºä»¶æž„å»ºå®Œæˆ ðŸ“¦" > release.txt
        echo "ðŸ“… æž„å»ºæ—¶é—´: $(date +"%Y-%m-%d %H:%M")" >> release.txt
        
        if [ -f /workdir/build_info.txt ]; then
          cat /workdir/build_info.txt >> release.txt
        fi
        
        echo "ðŸ“‚ å›ºä»¶ä¸‹è½½" >> release.txt
        echo "âš ï¸ è¯·åœ¨åˆ·æœºå‰å…ˆåšå¥½å¤‡ä»½ï¼" >> release.txt
        echo "status=success" >> $GITHUB_OUTPUT

    - name: ä¸Šä¼ å›ºä»¶åˆ°Releases
      uses: softprops/action-gh-release@v2
      if: steps.tag.outputs.status == 'success' && env.BUILD_SUCCESS == 'true'
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ steps.tag.outputs.RELEASE_TAG }}
        body_path: release.txt
        files: /workdir/firmware/*

    - name: åˆ é™¤æ—§çš„Releases
      uses: dev-drprasad/delete-older-releases@master
      if: env.UPLOAD_RELEASE == 'true' && !cancelled() && env.BUILD_SUCCESS == 'true'
      with:
        keep_latest: 3
        delete_tags: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
