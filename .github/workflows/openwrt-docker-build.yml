name: åŸºäºDockerçš„OpenWrtå¢é‡ç¼–è¯‘

on:
  # å®šæ—¶è¿è¡Œï¼Œæ¯å¤©æ£€æŸ¥æºç æ›´æ–°
  schedule:
    - cron: '0 0 * * *'  # æ¯å¤©åˆå¤œè¿è¡Œä¸€æ¬¡
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      ssh:
        description: 'SSHè°ƒè¯•'
        required: false
        default: 'false'
      clean_build:
        description: 'å®Œå…¨é‡æ–°ç¼–è¯‘'
        required: false
        default: 'false'
      config_file:
        description: 'é…ç½®æ–‡ä»¶'
        required: false
        default: 'å¢é‡ç¼“å­˜ä¼˜åŒ–.config'
      force_update:
        description: 'å¼ºåˆ¶æ›´æ–°æºç å¹¶ç¼–è¯‘'
        required: false
        default: 'false'

env:
  REPO_URL: https://github.com/coolsnowwolf/lede
  REPO_BRANCH: master
  FEEDS_CONF_URL: https://github.com/tikkacn/openwrt-new-rom/raw/main/feeds.conf.default
  CONFIG_FILE: ${{ github.event.inputs.config_file || 'å¢é‡ç¼“å­˜ä¼˜åŒ–.config' }}
  DIY_P1_SH: diy-part1.sh
  DIY_P2_SH: diy-part2.sh
  UPLOAD_FIRMWARE: true
  UPLOAD_RELEASE: true
  TZ: Asia/Shanghai
  # ç¼“å­˜ç›®å½•ç¯å¢ƒå˜é‡
  CCACHE_DIR: /workdir/ccache
  BUILD_STATE_DIR: /workdir/build_state

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/${{ github.repository_owner }}/openwrt-toolchain:latest
      volumes:
        - /workdir:/workdir
      options: --privileged

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@main

    - name: åˆå§‹åŒ–ç¯å¢ƒ
      run: |
        echo "å½“å‰å·¥ä½œç›®å½•: $(pwd)"
        mkdir -p ${{ env.BUILD_STATE_DIR }} ${{ env.CCACHE_DIR }}
        chmod -R 777 /workdir
        # å‡†å¤‡è‡ªå®šä¹‰è„šæœ¬
        echo '#!/bin/bash' > $GITHUB_WORKSPACE/diy-part1.sh
        echo '# Feeds å·²é€šè¿‡ FEEDS_CONF_URL é…ç½®' >> $GITHUB_WORKSPACE/diy-part1.sh
        chmod +x $GITHUB_WORKSPACE/diy-part1.sh
        echo '#!/bin/bash' > $GITHUB_WORKSPACE/diy-part2.sh
        echo 'sed -i "s/OpenWrt /OpenWrt_AutoBuild /" package/lean/default-settings/files/zzz-default-settings' >> $GITHUB_WORKSPACE/diy-part2.sh
        chmod +x $GITHUB_WORKSPACE/diy-part2.sh
        # æ£€æŸ¥é…ç½®æ–‡ä»¶æ˜¯å¦å­˜åœ¨
        if [ ! -f "$GITHUB_WORKSPACE/$CONFIG_FILE" ]; then
          echo "è­¦å‘Šï¼šé…ç½®æ–‡ä»¶ $CONFIG_FILE ä¸å­˜åœ¨ï¼Œåˆ›å»ºé»˜è®¤é…ç½®æ–‡ä»¶"
          echo "# åˆ›å»ºé»˜è®¤çš„æœ€å°åŒ–é…ç½®æ–‡ä»¶" > $GITHUB_WORKSPACE/$CONFIG_FILE
          echo "CONFIG_TARGET_x86=y" >> $GITHUB_WORKSPACE/$CONFIG_FILE
          echo "CONFIG_TARGET_x86_64=y" >> $GITHUB_WORKSPACE/$CONFIG_FILE
          echo "CONFIG_TARGET_x86_64_DEVICE_generic=y" >> $GITHUB_WORKSPACE/$CONFIG_FILE
          echo "CONFIG_PACKAGE_luci=y" >> $GITHUB_WORKSPACE/$CONFIG_FILE
        fi
        df -h

    # æ¢å¤CCACHEç¼“å­˜
    - name: æ¢å¤CCACHEç¼“å­˜
      uses: actions/cache@v3
      id: cache-ccache
      with:
        path: ${{ env.CCACHE_DIR }}
        key: ccache-docker-${{ env.REPO_BRANCH }}-${{ hashFiles(env.CONFIG_FILE) }}
        restore-keys: |
          ccache-docker-${{ env.REPO_BRANCH }}-

    # æ¢å¤æ„å»ºçŠ¶æ€ç¼“å­˜
    - name: æ¢å¤æ„å»ºçŠ¶æ€ç¼“å­˜
      uses: actions/cache@v3
      id: cache-state
      if: inputs.clean_build != 'true'
      with:
        path: ${{ env.BUILD_STATE_DIR }}
        key: state-docker-${{ env.REPO_BRANCH }}-${{ hashFiles(env.CONFIG_FILE) }}
        restore-keys: |
          state-docker-${{ env.REPO_BRANCH }}-

    - name: å…‹éš†æˆ–æ›´æ–°OpenWrtæºç 
      id: source
      run: |
        # æ£€æŸ¥OpenWrtæ–‡ä»¶å¤¹æ˜¯å¦å­˜åœ¨
        if [ -d "/workdir/openwrt" ]; then
          echo "OpenWrtæºç ç›®å½•å·²å­˜åœ¨ï¼Œæ£€æŸ¥æ›´æ–°..."
          cd /workdir/openwrt
          
          # ä¿å­˜å½“å‰HEADæäº¤å“ˆå¸Œ
          CURRENT_COMMIT=$(git rev-parse HEAD)
          echo "å½“å‰æäº¤: $CURRENT_COMMIT"
          
          # é‡ç½®å¹¶æ›´æ–°æºç 
          git fetch --all
          git reset --hard origin/$REPO_BRANCH
          git clean -fd
          
          # è·å–æ›´æ–°åçš„HEADæäº¤å“ˆå¸Œ
          NEW_COMMIT=$(git rev-parse HEAD)
          echo "æ›´æ–°åæäº¤: $NEW_COMMIT"
          
          # æ£€æŸ¥æ˜¯å¦æœ‰æºç æ›´æ–°
          if [ "$CURRENT_COMMIT" != "$NEW_COMMIT" ] || [ "${{ github.event.inputs.force_update }}" = "true" ]; then
            echo "æºç å·²æ›´æ–°æˆ–å¼ºåˆ¶æ›´æ–°è¢«è§¦å‘ï¼Œéœ€è¦é‡æ–°ç¼–è¯‘"
            echo "source_changed=true" >> $GITHUB_ENV
          else
            echo "æºç æœªå˜æ›´"
            echo "source_changed=false" >> $GITHUB_ENV
          fi
        else
          echo "å…‹éš†æ–°çš„OpenWrtæºç ..."
          git clone --depth 1 $REPO_URL -b $REPO_BRANCH /workdir/openwrt
          cd /workdir/openwrt
          echo "é¦–æ¬¡å…‹éš†ï¼Œéœ€è¦å®Œæ•´ç¼–è¯‘"
          echo "source_changed=true" >> $GITHUB_ENV
        fi
        
        # ç¡®ä¿æ‰€æœ‰è„šæœ¬å¯æ‰§è¡Œ
        find . -type f -name "*.sh" -exec chmod +x {} \;
        
        # ä¸‹è½½feedsé…ç½®
        curl -L -o feeds.conf.default "$FEEDS_CONF_URL" || echo "è­¦å‘Šï¼šæ— æ³•ä¸‹è½½ feeds.conf.defaultï¼Œä½¿ç”¨ä»“åº“é»˜è®¤é…ç½®"
        cat feeds.conf.default
        
        # åˆ›å»ºå¿…è¦çš„ç›®å½•ç»“æ„
        mkdir -p bin/targets bin/packages build_dir staging_dir

    - name: æ£€æŸ¥Feedså˜åŒ–
      id: check-feeds
      run: |
        cd /workdir/openwrt
        mkdir -p ${{ env.BUILD_STATE_DIR }}
        
        # æ›´æ–°feedså¹¶è·å–æœ€æ–°çŠ¶æ€
        ./scripts/feeds update -a
        
        # è®¡ç®—feedså“ˆå¸Œå€¼
        find feeds -type f -name "Makefile" -exec sha256sum {} \; | sort | sha256sum > ${{ env.BUILD_STATE_DIR }}/feeds.sha256
        CURRENT_FEEDS_HASH=$(cat ${{ env.BUILD_STATE_DIR }}/feeds.sha256 | awk '{print $1}')
        PREVIOUS_FEEDS_HASH=$(cat ${{ env.BUILD_STATE_DIR }}/previous_feeds.sha256 2>/dev/null | awk '{print $1}' || echo "")
        
        echo "å½“å‰ feeds å“ˆå¸Œ: $CURRENT_FEEDS_HASH"
        echo "ä¹‹å‰ feeds å“ˆå¸Œ: $PREVIOUS_FEEDS_HASH"
        
        if [ "$CURRENT_FEEDS_HASH" != "$PREVIOUS_FEEDS_HASH" ] || [ "${{ env.source_changed }}" = "true" ]; then
          echo "feeds_changed=true" >> $GITHUB_ENV
          echo "Feeds å·²å˜æ›´æˆ–æºç å·²æ›´æ–°ï¼Œéœ€è¦ç¼–è¯‘æ‰€æœ‰åŒ…"
          # å¼ºåˆ¶ç¼–è¯‘æ‰€æœ‰åŒ…çš„æ–‡ä»¶æ ‡è®°
          touch ${{ env.BUILD_STATE_DIR }}/rebuild_all_packages
        else
          echo "feeds_changed=false" >> $GITHUB_ENV
          echo "Feeds æœªå˜æ›´ï¼Œå¯ä»¥ä½¿ç”¨ç¼“å­˜åŒ…"
          # ç§»é™¤å¼ºåˆ¶ç¼–è¯‘æ‰€æœ‰åŒ…çš„æ–‡ä»¶æ ‡è®°
          rm -f ${{ env.BUILD_STATE_DIR }}/rebuild_all_packages
        fi
        
        # å®‰è£…feeds
        ./scripts/feeds install -a
        
        # ä¿å­˜å½“å‰å“ˆå¸Œå€¼ä¾›ä¸‹æ¬¡æ¯”è¾ƒ
        cp ${{ env.BUILD_STATE_DIR }}/feeds.sha256 ${{ env.BUILD_STATE_DIR }}/previous_feeds.sha256

    # æ¢å¤ç¼–è¯‘ç»“æœç¼“å­˜ï¼ˆä»…å½“feedså’Œæºç æ²¡æœ‰å˜åŒ–æ—¶ï¼‰
    - name: æ¢å¤ç¼–è¯‘ç»“æœç¼“å­˜
      uses: actions/cache@v3
      id: cache-build
      if: inputs.clean_build != 'true' && env.feeds_changed != 'true'
      with:
        path: |
          /workdir/openwrt/bin
          /workdir/openwrt/build_dir
          /workdir/openwrt/staging_dir
        key: build-docker-${{ env.REPO_BRANCH }}-${{ hashFiles(env.CONFIG_FILE) }}
        restore-keys: |
          build-docker-${{ env.REPO_BRANCH }}-

    - name: æ£€æŸ¥ç¼“å­˜æ¢å¤çŠ¶æ€
      run: |
        echo "CONFIG_FILE: ${{ env.CONFIG_FILE }}"
        echo "CCACHEç¼“å­˜æ¢å¤çŠ¶æ€: ${{ steps.cache-ccache.outputs.cache-hit == 'true' && 'æˆåŠŸ' || 'æœªæ‰¾åˆ°ç¼“å­˜' }}"
        echo "æ„å»ºçŠ¶æ€ç¼“å­˜æ¢å¤çŠ¶æ€: ${{ steps.cache-state.outputs.cache-hit == 'true' && 'æˆåŠŸ' || 'æœªæ‰¾åˆ°ç¼“å­˜' }}"
        echo "ç¼–è¯‘ç»“æœç¼“å­˜æ¢å¤çŠ¶æ€: ${{ steps.cache-build.outputs.cache-hit == 'true' && 'æˆåŠŸ' || 'æœªæ‰¾åˆ°ç¼“å­˜' }}"
        echo "æºç å˜æ›´çŠ¶æ€: ${{ env.source_changed }}"
        echo "Feedså˜æ›´çŠ¶æ€: ${{ env.feeds_changed }}"
        
        # æ£€æŸ¥ç›®å½•å¤§å°
        echo "CCACHEç›®å½•å¤§å°: $(du -sh ${{ env.CCACHE_DIR }} 2>/dev/null || echo 'ç›®å½•ä¸å­˜åœ¨æˆ–ä¸ºç©º')"
        echo "ç¼–è¯‘ç»“æœç›®å½•å¤§å°: $(du -sh /workdir/openwrt/bin 2>/dev/null || echo 'ç›®å½•ä¸å­˜åœ¨æˆ–ä¸ºç©º')"
        echo "æ„å»ºç›®å½•å¤§å°: $(du -sh /workdir/openwrt/build_dir 2>/dev/null || echo 'ç›®å½•ä¸å­˜åœ¨æˆ–ä¸ºç©º')"
        echo "æš‚å­˜ç›®å½•å¤§å°: $(du -sh /workdir/openwrt/staging_dir 2>/dev/null || echo 'ç›®å½•ä¸å­˜åœ¨æˆ–ä¸ºç©º')"
        
        ls -la ${{ env.BUILD_STATE_DIR }}/ || echo "æ„å»ºçŠ¶æ€ç›®å½•ä¸ºç©º"
        
        df -h

    - name: é…ç½®ç¼–è¯‘ç¯å¢ƒ
      run: |
        cd /workdir/openwrt
        $GITHUB_WORKSPACE/$DIY_P1_SH
        [ -e $GITHUB_WORKSPACE/files ] && cp -r $GITHUB_WORKSPACE/files ./files
        cp $GITHUB_WORKSPACE/$CONFIG_FILE ./.config
        cp .config .config.input
        $GITHUB_WORKSPACE/$DIY_P2_SH
        echo "CONFIG_AUTOREMOVE=n" >> .config
        echo "CONFIG_AUTOREBUILD=n" >> .config
        make defconfig
        
        # æ£€æŸ¥é…ç½®æ˜¯å¦ä¸¢å¤±è½¯ä»¶åŒ…
        grep "^CONFIG_PACKAGE_.*=y" .config.input > packages_input.txt || true
        grep "^CONFIG_PACKAGE_.*=y" .config > packages_defconfig.txt || true
        comm -23 packages_input.txt packages_defconfig.txt > missing_packages.txt
        if [ -s missing_packages.txt ]; then
          echo "è­¦å‘Šï¼šä»¥ä¸‹åŒ…åœ¨ defconfig åç¼ºå¤±ï¼Œå°†å°è¯•æ¢å¤ï¼š"
          cat missing_packages.txt
          cat missing_packages.txt >> .config
          while read -r line; do
            pkg=$(echo "$line" | sed 's/CONFIG_PACKAGE_\(.*\)=y/\1/')
            echo "å®‰è£…åŒ…: $pkg"
            ./scripts/feeds install "$pkg" || echo "è­¦å‘Šï¼šæ— æ³•å®‰è£… $pkgï¼Œå¯èƒ½ä¸åœ¨ feeds ä¸­"
          done < missing_packages.txt
          make defconfig
        else
          echo "æ‰€æœ‰é…ç½®é¡¹å‡ä¿ç•™ï¼Œæ— ç¼ºå¤±"
        fi
        
        # æ£€æŸ¥é…ç½®å·®å¼‚
        diff .config.input .config > config_diff.txt || echo "é…ç½®æœ‰å·®å¼‚"
        
        # å¦‚æœé…ç½®æœ‰å˜åŒ–ï¼Œéœ€è¦é‡æ–°ç¼–è¯‘
        if [ -s config_diff.txt ]; then
          echo "é…ç½®æœ‰å˜åŒ–ï¼Œå°†åªç¼–è¯‘å˜åŒ–çš„åŒ…"
          # æ‰¾å‡ºæ–°å¢å’Œç§»é™¤çš„åŒ…
          grep "^+CONFIG_PACKAGE_.*=y" config_diff.txt | sed 's/^+CONFIG_PACKAGE_\(.*\)=y/\1/' > added_packages.txt
          grep "^-CONFIG_PACKAGE_.*=y" config_diff.txt | sed 's/^-CONFIG_PACKAGE_\(.*\)=y/\1/' > removed_packages.txt
          
          if [ -s added_packages.txt ]; then
            echo "æ–°å¢çš„åŒ…:"
            cat added_packages.txt
          fi
          
          if [ -s removed_packages.txt ]; then
            echo "ç§»é™¤çš„åŒ…:"
            cat removed_packages.txt
          fi
          
          echo "config_changed=true" >> $GITHUB_ENV
        else
          echo "é…ç½®æ— å˜åŒ–"
          echo "config_changed=false" >> $GITHUB_ENV
        fi
        
        df -h

    - name: å¼€å¯SSHè°ƒè¯•
      uses: mxschmitt/action-tmate@v3
      if: github.event.inputs.ssh == 'true'

    - name: ä¸‹è½½è½¯ä»¶åŒ…
      run: |
        cd /workdir/openwrt
        make download -j8 || make download -j1 V=s
        # é…ç½®CCACHE
        mkdir -p ${{ env.CCACHE_DIR }}
        ccache -o cache_dir=${{ env.CCACHE_DIR }}
        ccache -o max_size=8G
        ccache -z
        df -h

    - name: æ™ºèƒ½ç¼–è¯‘å›ºä»¶
      id: compile
      run: |
        cd /workdir/openwrt
        export CCACHE_DIR=${{ env.CCACHE_DIR }}
        export PATH="/usr/lib/ccache:$PATH"

        cleanup_temp_files() {
          echo "æ¸…ç†ä¸´æ—¶æ–‡ä»¶ä»¥é‡Šæ”¾ç©ºé—´..."
          find /tmp -type f -delete || true
          df -h
        }

        save_cache_info() {
          echo "ä¿å­˜ç¼“å­˜çŠ¶æ€ä¿¡æ¯..."
          mkdir -p ${{ env.BUILD_STATE_DIR }}
          cp .config ${{ env.BUILD_STATE_DIR }}/config.txt
          echo "$(date)" > ${{ env.BUILD_STATE_DIR }}/last_build_time.txt
          echo "ä¿å­˜æ„å»ºçŠ¶æ€å®Œæˆ"
        }

        compile_firmware() {
          # å¼€å§‹æ—¶é—´è®°å½•
          START_TIME=$(date +%s)
          echo "å¼€å§‹ç¼–è¯‘æ—¶é—´: $(date)"
          
          # å†³å®šç¼–è¯‘ç­–ç•¥
          if [ "${{ github.event.inputs.clean_build }}" = "true" ]; then
            # ç”¨æˆ·è¯·æ±‚å®Œå…¨é‡æ–°ç¼–è¯‘
            echo "ç”¨æˆ·è¯·æ±‚å®Œå…¨é‡æ–°ç¼–è¯‘"
            make clean
            make -j$(nproc) V=s || make -j1 V=s
            
          elif [ "${{ env.feeds_changed }}" = "true" ] || [ -f "${{ env.BUILD_STATE_DIR }}/rebuild_all_packages" ]; then
            # Feedså˜æ›´æˆ–æºç å˜æ›´ï¼Œéœ€è¦é‡æ–°ç¼–è¯‘æ‰€æœ‰åŒ…
            echo "Feedsæˆ–æºç å·²å˜æ›´ï¼Œé‡æ–°ç¼–è¯‘æ‰€æœ‰åŒ…"
            make package/clean
            make -j$(nproc) V=s || make -j1 V=s
            
          elif [ "${{ env.config_changed }}" = "true" ]; then
            # é…ç½®æœ‰å˜åŒ–ï¼Œåªç¼–è¯‘å˜åŒ–çš„åŒ…
            echo "é…ç½®æœ‰å˜åŒ–ï¼Œè¿›è¡Œæ™ºèƒ½å¢é‡ç¼–è¯‘"
            
            # ç¼–è¯‘æ–°å¢çš„åŒ…
            if [ -s added_packages.txt ]; then
              echo "ç¼–è¯‘æ–°å¢çš„åŒ…..."
              while read -r pkg; do
                echo "ç¼–è¯‘åŒ…: $pkg"
                make package/$pkg/{clean,compile} -j$(nproc) V=s || make package/$pkg/{clean,compile} -j1 V=s
              done < added_packages.txt
            fi
            
            # ç§»é™¤å·²åˆ é™¤çš„åŒ…
            if [ -s removed_packages.txt ]; then
              echo "æ¸…ç†ç§»é™¤çš„åŒ…..."
              while read -r pkg; do
                echo "æ¸…ç†åŒ…: $pkg"
                make package/$pkg/clean V=s || true
              done < removed_packages.txt
            fi
            
            # æ„å»ºå›ºä»¶
            echo "ç”Ÿæˆæœ€ç»ˆå›ºä»¶..."
            make -j$(nproc) V=s || make -j1 V=s
            
          else
            # æ— å˜åŒ–ï¼Œä»…é‡æ–°ç”Ÿæˆå›ºä»¶
            echo "é…ç½®å’Œfeedséƒ½æœªå˜åŒ–ï¼Œæ‰§è¡Œæœ€å°å¢é‡ç¼–è¯‘..."
            make -j$(nproc) V=s || make -j1 V=s
          fi

          # ç»“æŸæ—¶é—´è®°å½•
          END_TIME=$(date +%s)
          echo "ç»“æŸç¼–è¯‘æ—¶é—´: $(date)"
          echo "æ€»ç¼–è¯‘ç”¨æ—¶: $((END_TIME - START_TIME)) ç§’"
          
          # ä¿å­˜ç¼“å­˜ä¿¡æ¯
          save_cache_info

          if [ $? -eq 0 ]; then
            echo "ç¼–è¯‘æˆåŠŸ"
          else
            echo "ç¼–è¯‘å¤±è´¥"
            exit 1
          fi
        }

        compile_firmware

        echo "DEVICE_NAME=_$(grep '^CONFIG_TARGET.*DEVICE.*=y' .config | sed -r 's/.*DEVICE_(.*)=y/\1/' | tr '\n' '_')" >> $GITHUB_ENV
        echo "FILE_DATE=_$(date +"%Y%m%d%H%M")" >> $GITHUB_ENV
        echo "status=success" >> $GITHUB_OUTPUT
        ccache -s
        df -h

    # ä¿å­˜å„ç§ç¼“å­˜
    - name: ä¿å­˜CCACHEç¼“å­˜
      uses: actions/cache@v3
      if: "!cancelled()"
      with:
        path: ${{ env.CCACHE_DIR }}
        key: ccache-docker-${{ env.REPO_BRANCH }}-${{ hashFiles(env.CONFIG_FILE) }}

    - name: ä¿å­˜æ„å»ºçŠ¶æ€ç¼“å­˜
      uses: actions/cache@v3
      if: "!cancelled()"
      with:
        path: ${{ env.BUILD_STATE_DIR }}
        key: state-docker-${{ env.REPO_BRANCH }}-${{ hashFiles(env.CONFIG_FILE) }}

    - name: ä¿å­˜ç¼–è¯‘ç»“æœç¼“å­˜
      uses: actions/cache@v3
      if: "!cancelled()"
      with:
        path: |
          /workdir/openwrt/bin
          /workdir/openwrt/build_dir
          /workdir/openwrt/staging_dir
        key: build-docker-${{ env.REPO_BRANCH }}-${{ hashFiles(env.CONFIG_FILE) }}

    # æ•´ç†å›ºä»¶
    - name: æ•´ç†æ–‡ä»¶
      id: organize
      if: steps.compile.outputs.status == 'success' && env.UPLOAD_FIRMWARE == 'true' && !cancelled()
      run: |
        cd /workdir/openwrt/bin/targets/*/*
        # æ³¨æ„ï¼šä¸è¦åˆ é™¤å¯èƒ½ç”¨äºç¼“å­˜çš„æ–‡ä»¶
        mkdir -p firmware
        FIRMWARE_FILES=$(find . -maxdepth 1 -name "*combined*" -or -name "*sysupgrade*")
        if [ -z "$FIRMWARE_FILES" ]; then
          echo "è­¦å‘Šï¼šæœªæ‰¾åˆ°å›ºä»¶æ–‡ä»¶ï¼Œä½¿ç”¨æ‰€æœ‰binæ–‡ä»¶"
          FIRMWARE_FILES=$(find . -maxdepth 1 -name "*.bin")
        fi
        if [ -n "$FIRMWARE_FILES" ]; then
          echo "$FIRMWARE_FILES" | xargs -i cp {} ./firmware/
        else
          cp -r * ./firmware/
        fi
        cp /workdir/openwrt/.config ./firmware/config.txt
        zip -r firmware.zip firmware
        echo "FIRMWARE=$PWD/firmware" >> $GITHUB_ENV
        echo "FIRMWARE_ZIP=$PWD/firmware.zip" >> $GITHUB_ENV
        echo "status=success" >> $GITHUB_OUTPUT

    # ä¸Šä¼ å›ºä»¶
    - name: ä¸Šä¼ å›ºä»¶ç›®å½•
      uses: actions/upload-artifact@main
      if: steps.organize.outputs.status == 'success' && !cancelled()
      with:
        name: OpenWrt_firmware${{ env.DEVICE_NAME }}${{ env.FILE_DATE }}
        path: ${{ env.FIRMWARE }}

    - name: ç”Ÿæˆå‘å¸ƒæ ‡ç­¾
      id: tag
      if: steps.organize.outputs.status == 'success' && env.UPLOAD_RELEASE == 'true' && !cancelled()
      run: |
        echo "RELEASE_TAG=$(date +"%Y.%m.%d-%H%M")" >> $GITHUB_OUTPUT
        echo "## OpenWrtå›ºä»¶æ„å»ºå®Œæˆ ğŸ“¦" > release.txt
        echo "ğŸ“… æ„å»ºæ—¶é—´: $(date +"%Y-%m-%d %H:%M")" >> release.txt
        
        # æ·»åŠ æ›´æ–°å†…å®¹ä¿¡æ¯
        if [ "${{ env.feeds_changed }}" = "true" ] || [ "${{ env.source_changed }}" = "true" ]; then
          echo "ğŸ“¢ æ­¤ç‰ˆæœ¬åŒ…å«æºç æˆ–feedsæ›´æ–°" >> release.txt
        fi
        
        if [ "${{ env.config_changed }}" = "true" ]; then
          echo "ğŸ“¢ æ­¤ç‰ˆæœ¬åŒ…å«é…ç½®æ›´æ”¹" >> release.txt
          if [ -s added_packages.txt ]; then
            echo "ğŸ“¦ æ–°å¢è½¯ä»¶åŒ…:" >> release.txt
            cat added_packages.txt | sed 's/^/- /' >> release.txt
          fi
          if [ -s removed_packages.txt ]; then
            echo "ğŸ—‘ï¸ ç§»é™¤è½¯ä»¶åŒ…:" >> release.txt
            cat removed_packages.txt | sed 's/^/- /' >> release.txt
          fi
        fi
        
        echo "ğŸ“‚ å›ºä»¶ä¸‹è½½" >> release.txt
        echo "âš ï¸ è¯·åœ¨åˆ·æœºå‰å…ˆåšå¥½å¤‡ä»½ï¼" >> release.txt
        echo "status=success" >> $GITHUB_OUTPUT

    - name: ä¸Šä¼ å›ºä»¶åˆ°Releases
      uses: softprops/action-gh-release@v2
      if: steps.tag.outputs.status == 'success' && !cancelled()
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ steps.tag.outputs.RELEASE_TAG }}
        body_path: release.txt
        files: ${{ env.FIRMWARE }}/*

    - name: åˆ é™¤æ—§çš„Releases
      uses: dev-drprasad/delete-older-releases@master
      if: env.UPLOAD_RELEASE == 'true' && !cancelled()
      with:
        keep_latest: 3
        delete_tags: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
