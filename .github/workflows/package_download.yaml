name: Download Packages

on:
  workflow_dispatch:

jobs:
  download-packages:
    runs-on: ubuntu-22.04

    steps:
    - name: Restore workspace
      uses: actions/download-artifact@v4
      with:
        name: openwrt-workspace
        path: openwrt

    - name: Download package
      run: |
        cd openwrt
        make defconfig
        make download -j8
        find dl -size -1024c -exec ls -l {} \;
        find dl -size -1024c -exec rm -f {} \;

    - name: Save workspace
      uses: actions/upload-artifact@v4
      with:
        name: openwrt-workspace
        path: openwrt

    - name: Trigger next workflow
      run: |
        curl -X POST \
          -H "Accept: application/vnd.github.v3+json" \
          -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
          https://api.github.com/repos/tikkacn/openwrt-new-rom/actions/workflows/compile-firmware.yaml/dispatches \
          -d '{"ref":"main"}'
