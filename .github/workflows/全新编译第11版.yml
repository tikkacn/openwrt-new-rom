name: å…¨æ–°ç¼–è¯‘Dockerç¬¬11ç‰ˆ(ä¼˜åŒ–ç‰ˆ)

on:
  workflow_dispatch:
    inputs:
      ssh:
        description: 'SSHè°ƒè¯•'
        required: false
        default: 'false'
      clean_build:
        description: 'å®Œå…¨é‡æ–°ç¼–è¯‘'
        required: false
        default: 'false'
      config_file:
        description: 'é…ç½®æ–‡ä»¶'
        required: false
        default: 'å¢žé‡ç¼“å­˜ä¼˜åŒ–.config'

env:
  REPO_URL: https://github.com/coolsnowwolf/lede
  REPO_BRANCH: master
  FEEDS_CONF_URL: https://github.com/tikkacn/openwrt-new-rom/raw/main/feeds.conf.default
  CONFIG_FILE: ${{ github.event.inputs.config_file || 'å¢žé‡ç¼“å­˜ä¼˜åŒ–.config' }}
  DIY_P1_SH: diy-part1.sh
  DIY_P2_SH: diy-part2.sh
  UPLOAD_FIRMWARE: true
  UPLOAD_RELEASE: true
  TZ: Asia/Shanghai
  # Dockerç›¸å…³çŽ¯å¢ƒå˜é‡
  DOCKER_WORK_DIR: /workdir
  # ç¼“å­˜ç›®å½•çŽ¯å¢ƒå˜é‡
  TOOLCHAIN_DIR: /workdir/openwrt/staging_dir
  DL_DIR: /workdir/openwrt/dl
  BUILD_STATE_DIR: /workdir/build_state
  STAMP_DIR: /workdir/openwrt/staging_dir/stamps
  CCACHE_DIR: /workdir/ccache

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@main

    - name: ä¼˜åŒ–ç£ç›˜ç©ºé—´
      uses: easimon/maximize-build-space@master
      with:
        root-reserve-mb: 20480
        swap-size-mb: 5120
        remove-dotnet: 'true'
        remove-android: 'true'
        remove-haskell: 'true'
        remove-codeql: 'true'
        remove-docker-images: 'true'
        build-mount-path: '/workdir'

    - name: é¢å¤–æ¸…ç†ç£ç›˜ç©ºé—´å¹¶æ£€æŸ¥
      run: |
        echo "æ¸…ç†é¢å¤–ç£ç›˜ç©ºé—´..."
        sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /usr/local/share/boost
        sudo rm -rf /usr/share/swift /usr/local/julia* /opt/hostedtoolcache/CodeQL
        docker image prune -a -f || true
        docker system prune -af || true
        sudo apt-get clean
        sudo apt-get autoremove -y
        ROOT_AVAIL=$(df -m /dev/root | tail -1 | awk '{print $4}')
        echo "æ ¹åˆ†åŒºå¯ç”¨ç©ºé—´: ${ROOT_AVAIL}MB"
        if [ "$ROOT_AVAIL" -lt 20480 ]; then
          echo "é”™è¯¯ï¼š/dev/root å¯ç”¨ç©ºé—´ä¸è¶³ 20GB"
          exit 1
        fi
        df -h

    - name: åˆå§‹åŒ–çŽ¯å¢ƒ
      run: |
        # åˆ›å»ºDIYè„šæœ¬ï¼Œä¸ŽåŽŸå§‹ä»£ç ä¿æŒä¸€è‡´
        echo '#!/bin/bash' > $GITHUB_WORKSPACE/diy-part1.sh
        echo '# Feeds å·²é€šè¿‡ FEEDS_CONF_URL é…ç½®' >> $GITHUB_WORKSPACE/diy-part1.sh
        chmod +x $GITHUB_WORKSPACE/diy-part1.sh
        
        echo '#!/bin/bash' > $GITHUB_WORKSPACE/diy-part2.sh
        echo 'sed -i "s/OpenWrt /OpenWrt_AutoBuild /" package/lean/default-settings/files/zzz-default-settings' >> $GITHUB_WORKSPACE/diy-part2.sh
        chmod +x $GITHUB_WORKSPACE/diy-part2.sh
        
        # æ£€æŸ¥é…ç½®æ–‡ä»¶æ˜¯å¦å­˜åœ¨
        if [ ! -f "$GITHUB_WORKSPACE/$CONFIG_FILE" ]; then
          echo "è­¦å‘Šï¼šé…ç½®æ–‡ä»¶ $CONFIG_FILE ä¸å­˜åœ¨ï¼Œåˆ›å»ºé»˜è®¤é…ç½®æ–‡ä»¶"
          echo "# åˆ›å»ºé»˜è®¤çš„æœ€å°åŒ–é…ç½®æ–‡ä»¶" > $GITHUB_WORKSPACE/$CONFIG_FILE
          echo "CONFIG_TARGET_x86=y" >> $GITHUB_WORKSPACE/$CONFIG_FILE
          echo "CONFIG_TARGET_x86_64=y" >> $GITHUB_WORKSPACE/$CONFIG_FILE
          echo "CONFIG_TARGET_x86_64_DEVICE_generic=y" >> $GITHUB_WORKSPACE/$CONFIG_FILE
          echo "CONFIG_PACKAGE_luci=y" >> $GITHUB_WORKSPACE/$CONFIG_FILE
        fi
        
        # åˆ›å»ºDockeré•œåƒ
        cat > Dockerfile << 'EOF'
        FROM ubuntu:22.04

        ARG DEBIAN_FRONTEND=noninteractive

        RUN apt-get update && apt-get install -y \
            ack \
            antlr3 \
            asciidoc \
            autoconf \
            automake \
            autopoint \
            binutils \
            bison \
            build-essential \
            bzip2 \
            ccache \
            clang \
            cmake \
            cpio \
            curl \
            device-tree-compiler \
            flex \
            gawk \
            gcc-multilib \
            g++-multilib \
            gettext \
            genisoimage \
            git \
            gperf \
            haveged \
            help2man \
            intltool \
            libc6-dev-i386 \
            libelf-dev \
            libfuse-dev \
            libglib2.0-dev \
            libgmp3-dev \
            libltdl-dev \
            libmpc-dev \
            libmpfr-dev \
            libncurses5-dev \
            libncursesw5-dev \
            libpython3-dev \
            libreadline-dev \
            libssl-dev \
            libtool \
            llvm \
            lrzsz \
            msmtp \
            ninja-build \
            p7zip \
            p7zip-full \
            patch \
            pkgconf \
            python3 \
            python3-pyelftools \
            python3-setuptools \
            qemu-utils \
            rsync \
            scons \
            squashfs-tools \
            subversion \
            swig \
            texinfo \
            uglifyjs \
            upx-ucl \
            unzip \
            vim \
            wget \
            xmlto \
            xxd \
            zlib1g-dev \
         && apt-get clean \
         && rm -rf /var/lib/apt/lists/*

        # è®¾ç½®å·¥ä½œç›®å½•
        WORKDIR /workdir
        EOF

        # æž„å»ºDockeré•œåƒ
        docker build -t openwrt-builder -f Dockerfile .
        
        # åˆ›å»ºå¿…è¦ç›®å½•
        mkdir -p ${{ env.DOCKER_WORK_DIR }}/openwrt
        mkdir -p ${{ env.BUILD_STATE_DIR }} ${{ env.CCACHE_DIR }}

    # æ¢å¤ä¸‹è½½ç¼“å­˜ - é«˜æ•ˆä¸”å®‰å…¨
    - name: æ¢å¤ä¸‹è½½ç¼“å­˜
      uses: actions/cache@v3
      id: cache-dl
      with:
        path: ${{ env.DL_DIR }}
        key: dl-docker-${{ env.REPO_BRANCH }}-${{ hashFiles('**/feeds.conf.default') }}
        restore-keys: |
          dl-docker-${{ env.REPO_BRANCH }}-

    # CCACHEç¼“å­˜ - ç¼–è¯‘åŠ é€Ÿ
    - name: æ¢å¤CCACHEç¼“å­˜
      uses: actions/cache@v3
      id: cache-ccache
      with:
        path: ${{ env.CCACHE_DIR }}
        key: ccache-docker-${{ env.REPO_BRANCH }}-${{ hashFiles('**/feeds.conf.default') }}
        restore-keys: |
          ccache-docker-${{ env.REPO_BRANCH }}-

    # ä¸»æœºå·¥å…·é“¾ç¼“å­˜ - å…³é”®ä¸”å˜åŒ–å°‘
    - name: æ¢å¤ä¸»æœºå·¥å…·é“¾ç¼“å­˜
      uses: actions/cache@v3
      id: cache-host-tools
      if: inputs.clean_build != 'true'
      with:
        path: ${{ env.TOOLCHAIN_DIR }}/host
        key: host-tools-docker-${{ env.REPO_BRANCH }}-${{ hashFiles('**/feeds.conf.default') }}
        restore-keys: |
          host-tools-docker-${{ env.REPO_BRANCH }}-

    # ç¼–è¯‘çŠ¶æ€ç¼“å­˜ - å°ä½“ç§¯é«˜ä»·å€¼
    - name: æ¢å¤ç¼–è¯‘çŠ¶æ€
      uses: actions/cache@v3
      id: cache-stamps
      if: inputs.clean_build != 'true'
      with:
        path: |
          ${{ env.STAMP_DIR }}
          /workdir/openwrt/staging_dir/target-*/stamps
          /workdir/openwrt/.packageinfo
        key: stamps-docker-${{ env.REPO_BRANCH }}-${{ hashFiles('**/feeds.conf.default') }}
        restore-keys: |
          stamps-docker-${{ env.REPO_BRANCH }}-

    # æž„å»ºçŠ¶æ€ç¼“å­˜
    - name: æ¢å¤æž„å»ºçŠ¶æ€ç¼“å­˜
      uses: actions/cache@v3
      id: cache-state
      if: inputs.clean_build != 'true'
      with:
        path: ${{ env.BUILD_STATE_DIR }}
        key: state-docker-${{ env.REPO_BRANCH }}-${{ hashFiles('**/feeds.conf.default') }}
        restore-keys: |
          state-docker-${{ env.REPO_BRANCH }}-

    - name: å…‹éš†æºä»£ç å¹¶é…ç½®
      run: |
        # åœ¨Dockerå®¹å™¨ä¸­æ‰§è¡Œå…‹éš†æ“ä½œ
        docker run --rm -v $GITHUB_WORKSPACE:/src -v ${{ env.DOCKER_WORK_DIR }}:/workdir openwrt-builder bash -c "\
          git clone --depth 1 $REPO_URL -b $REPO_BRANCH /workdir/openwrt && \
          cd /workdir/openwrt && \
          rm -rf .git && \
          mkdir -p ${{ env.TOOLCHAIN_DIR }} ${{ env.DL_DIR }} ${{ env.BUILD_STATE_DIR }} ${{ env.STAMP_DIR }}"
        
        # å¤åˆ¶é…ç½®æ–‡ä»¶å’Œè‡ªå®šä¹‰è„šæœ¬
        cp $GITHUB_WORKSPACE/$CONFIG_FILE ${{ env.DOCKER_WORK_DIR }}/openwrt/.config
        cp $GITHUB_WORKSPACE/$DIY_P1_SH ${{ env.DOCKER_WORK_DIR }}/
        cp $GITHUB_WORKSPACE/$DIY_P2_SH ${{ env.DOCKER_WORK_DIR }}/
        
        # ä¸‹è½½feedsé…ç½®
        docker run --rm -v ${{ env.DOCKER_WORK_DIR }}:/workdir openwrt-builder bash -c "\
          cd /workdir/openwrt && \
          curl -L -o feeds.conf.default '$FEEDS_CONF_URL' || echo 'è­¦å‘Šï¼šæ— æ³•ä¸‹è½½feedsé…ç½®ï¼Œä½¿ç”¨é»˜è®¤é…ç½®'"
        
        echo "æ£€æŸ¥ç¼“å­˜æ¢å¤çŠ¶æ€ï¼š"
        echo "ä¸‹è½½ç›®å½•ç¼“å­˜æ¢å¤çŠ¶æ€: ${{ steps.cache-dl.outputs.cache-hit == 'true' && 'æˆåŠŸ' || 'æœªæ‰¾åˆ°ç¼“å­˜' }}"
        echo "CCACHEç¼“å­˜æ¢å¤çŠ¶æ€: ${{ steps.cache-ccache.outputs.cache-hit == 'true' && 'æˆåŠŸ' || 'æœªæ‰¾åˆ°ç¼“å­˜' }}"
        echo "ä¸»æœºå·¥å…·é“¾ç¼“å­˜æ¢å¤çŠ¶æ€: ${{ steps.cache-host-tools.outputs.cache-hit == 'true' && 'æˆåŠŸ' || 'æœªæ‰¾åˆ°ç¼“å­˜' }}"
        echo "ç¼–è¯‘çŠ¶æ€ç¼“å­˜æ¢å¤çŠ¶æ€: ${{ steps.cache-stamps.outputs.cache-hit == 'true' && 'æˆåŠŸ' || 'æœªæ‰¾åˆ°ç¼“å­˜' }}"
        echo "æž„å»ºçŠ¶æ€ç¼“å­˜æ¢å¤çŠ¶æ€: ${{ steps.cache-state.outputs.cache-hit == 'true' && 'æˆåŠŸ' || 'æœªæ‰¾åˆ°ç¼“å­˜' }}"
        
        # æ£€æŸ¥ç¼“å­˜å¤§å°
        echo "ä¸‹è½½ç›®å½•å¤§å°: $(du -sh ${{ env.DL_DIR }} 2>/dev/null || echo 'ç›®å½•ä¸å­˜åœ¨æˆ–ä¸ºç©º')"
        echo "CCACHEç›®å½•å¤§å°: $(du -sh ${{ env.CCACHE_DIR }} 2>/dev/null || echo 'ç›®å½•ä¸å­˜åœ¨æˆ–ä¸ºç©º')"
        echo "ä¸»æœºå·¥å…·é“¾ç›®å½•å¤§å°: $(du -sh ${{ env.TOOLCHAIN_DIR }}/host 2>/dev/null || echo 'ç›®å½•ä¸å­˜åœ¨æˆ–ä¸ºç©º')"
        echo "ç¼–è¯‘çŠ¶æ€ç›®å½•å¤§å°: $(du -sh ${{ env.STAMP_DIR }} 2>/dev/null || echo 'ç›®å½•ä¸å­˜åœ¨æˆ–ä¸ºç©º')"

    - name: é…ç½®ç¼–è¯‘çŽ¯å¢ƒ
      run: |
        # åœ¨Dockerå®¹å™¨ä¸­æ‰§è¡Œé…ç½®
        docker run --rm -v ${{ env.DOCKER_WORK_DIR }}:/workdir openwrt-builder bash -c "\
          cd /workdir/openwrt && \
          # è¿è¡Œè‡ªå®šä¹‰è„šæœ¬
          bash /workdir/diy-part1.sh && \
          # æ›´æ–°å¹¶å®‰è£…feeds
          ./scripts/feeds update -a && \
          ./scripts/feeds install -a && \
          # è¿è¡Œç¬¬äºŒä¸ªè‡ªå®šä¹‰è„šæœ¬
          bash /workdir/diy-part2.sh && \
          # ä¼˜åŒ–å¢žé‡ç¼–è¯‘è®¾ç½®
          echo 'CONFIG_AUTOREMOVE=n' >> .config && \
          echo 'CONFIG_AUTOREBUILD=n' >> .config && \
          echo 'CONFIG_ALL_KMODS=n' >> .config && \
          # ç¡®ä¿åŒ…å«å¿…è¦çš„å›ºä»¶ç”Ÿæˆé…ç½®
          if ! grep -q 'CONFIG_TARGET_ROOTFS_SQUASHFS=y' .config; then \
            echo 'CONFIG_TARGET_ROOTFS_SQUASHFS=y' >> .config; \
          fi && \
          if ! grep -q 'CONFIG_TARGET_IMAGES_GZIP=y' .config; then \
            echo 'CONFIG_TARGET_IMAGES_GZIP=y' >> .config; \
          fi && \
          if ! grep -q 'CONFIG_TARGET_ROOTFS_TARGZ=y' .config; then \
            echo 'CONFIG_TARGET_ROOTFS_TARGZ=y' >> .config; \
          fi && \
          # å¯¹äºŽx86å¹³å°å¢žåŠ é¢å¤–çš„é•œåƒé…ç½®
          if grep -q 'CONFIG_TARGET_x86=y' .config; then \
            if ! grep -q 'CONFIG_GRUB_IMAGES=y' .config; then \
              echo 'CONFIG_GRUB_IMAGES=y' >> .config; \
            fi && \
            if ! grep -q 'CONFIG_TARGET_IMAGES_PAD=y' .config; then \
              echo 'CONFIG_TARGET_IMAGES_PAD=y' >> .config; \
            fi; \
          fi && \
          # è®¾ç½®ä¸‹è½½ç›®å½•
          echo 'CONFIG_DOWNLOAD_DIR=\"${{ env.DL_DIR }}\"' >> .config && \
          # è®¾ç½®CCACHE
          mkdir -p ${{ env.CCACHE_DIR }} && \
          echo 'CONFIG_CCACHE=y' >> .config && \
          make defconfig"
        
        # æ˜¾ç¤ºæœ€ç»ˆé…ç½®
        docker run --rm -v ${{ env.DOCKER_WORK_DIR }}:/workdir openwrt-builder bash -c "\
          cd /workdir/openwrt && \
          echo 'æœ€ç»ˆé…ç½®ä¸­çš„é•œåƒç”Ÿæˆé€‰é¡¹:' && \
          grep -E 'CONFIG_TARGET_ROOTFS|CONFIG_TARGET_IMAGES|CONFIG_GRUB|CONFIG_ISO|CONFIG_EFI' .config || echo 'æœªæ‰¾åˆ°é•œåƒç›¸å…³é…ç½®'"

    - name: æ£€æŸ¥æºç å˜åŒ–å’Œé…ç½®å˜åŒ–
      id: check-changes
      run: |
        # åœ¨Dockerå®¹å™¨ä¸­æ‰§è¡Œæ£€æŸ¥
        docker run --rm -v ${{ env.DOCKER_WORK_DIR }}:/workdir openwrt-builder bash -c "\
          cd /workdir/openwrt && \
          mkdir -p ${{ env.BUILD_STATE_DIR }} && \
          # æ£€æŸ¥feedså˜åŒ–
          find feeds -type f -name 'Makefile' -exec sha256sum {} \; | sort | sha256sum > ${{ env.BUILD_STATE_DIR }}/feeds.sha256 && \
          CURRENT_FEEDS_HASH=\$(cat ${{ env.BUILD_STATE_DIR }}/feeds.sha256 | awk '{print \$1}') && \
          PREVIOUS_FEEDS_HASH=\$(cat ${{ env.BUILD_STATE_DIR }}/previous_feeds.sha256 2>/dev/null | awk '{print \$1}' || echo '') && \
          echo 'å½“å‰ feeds å“ˆå¸Œ: '\$CURRENT_FEEDS_HASH && \
          echo 'ä¹‹å‰ feeds å“ˆå¸Œ: '\$PREVIOUS_FEEDS_HASH && \
          # æ£€æŸ¥é…ç½®æ–‡ä»¶å˜åŒ–
          CURRENT_CONFIG_MD5=\$(md5sum .config | awk '{print \$1}') && \
          PREVIOUS_CONFIG_MD5=\$(cat ${{ env.BUILD_STATE_DIR }}/config.md5 2>/dev/null || echo '') && \
          echo 'å½“å‰é…ç½®æ–‡ä»¶MD5: '\$CURRENT_CONFIG_MD5 && \
          echo 'ä¹‹å‰é…ç½®æ–‡ä»¶MD5: '\$PREVIOUS_CONFIG_MD5 && \
          # ç¡®å®šç¼–è¯‘æ–¹å¼
          if [ '${{ github.event.inputs.clean_build }}' = 'true' ]; then \
            echo 'å¼ºåˆ¶å®Œå…¨é‡æ–°ç¼–è¯‘' && \
            echo 'BUILD_MODE=full' > ${{ env.BUILD_STATE_DIR }}/build_mode.env; \
          elif [ '${{ steps.cache-host-tools.outputs.cache-hit }}' != 'true' ]; then \
            echo 'æœªæ‰¾åˆ°ä¸»æœºå·¥å…·é“¾ç¼“å­˜ï¼Œéœ€è¦å®Œå…¨ç¼–è¯‘' && \
            echo 'BUILD_MODE=full' > ${{ env.BUILD_STATE_DIR }}/build_mode.env; \
          elif [ '\$CURRENT_FEEDS_HASH' != '\$PREVIOUS_FEEDS_HASH' ]; then \
            echo 'feeds å·²å˜æ›´ï¼Œéœ€è¦é‡æ–°ç¼–è¯‘' && \
            echo 'BUILD_MODE=packages' > ${{ env.BUILD_STATE_DIR }}/build_mode.env; \
          elif [ '\$CURRENT_CONFIG_MD5' != '\$PREVIOUS_CONFIG_MD5' ]; then \
            echo 'é…ç½®å·²å˜æ›´ï¼Œéœ€è¦é‡æ–°ç¼–è¯‘åŒ…' && \
            echo 'BUILD_MODE=packages' > ${{ env.BUILD_STATE_DIR }}/build_mode.env; \
          else \
            echo 'é…ç½®å’Œæºç å‡æœªå˜æ›´ï¼Œæ‰§è¡Œæœ€å°å¢žé‡ç¼–è¯‘' && \
            echo 'BUILD_MODE=incremental' > ${{ env.BUILD_STATE_DIR }}/build_mode.env; \
          fi && \
          # ä¿å­˜å½“å‰å“ˆå¸Œå€¼ä¾›ä¸‹æ¬¡æ¯”è¾ƒ
          cp ${{ env.BUILD_STATE_DIR }}/feeds.sha256 ${{ env.BUILD_STATE_DIR }}/previous_feeds.sha256 && \
          echo \"\$CURRENT_CONFIG_MD5\" > ${{ env.BUILD_STATE_DIR }}/config.md5"
        
        # è¯»å–ç¼–è¯‘æ¨¡å¼
        BUILD_MODE=$(cat ${{ env.BUILD_STATE_DIR }}/build_mode.env | cut -d '=' -f2)
        echo "BUILD_MODE=$BUILD_MODE" >> $GITHUB_ENV

    - name: å¼€å¯SSHè°ƒè¯•
      uses: mxschmitt/action-tmate@v3
      if: github.event.inputs.ssh == 'true'

    - name: ä¸‹è½½è½¯ä»¶åŒ…
      run: |
        # åœ¨Dockerå®¹å™¨ä¸­æ‰§è¡Œä¸‹è½½
        docker run --rm -v ${{ env.DOCKER_WORK_DIR }}:/workdir openwrt-builder bash -c "\
          cd /workdir/openwrt && \
          # åˆ›å»ºä¸‹è½½é‡è¯•è„šæœ¬
          cat > download_with_retry.sh << 'EOF'
        #!/bin/bash
        set -e
        MAX_RETRIES=3
        RETRY_WAIT=10
        
        retries=0
        until [ \$retries -ge \$MAX_RETRIES ]
        do
          echo \"å°è¯•ä¸‹è½½ï¼Œç¬¬ \$((retries+1)) æ¬¡ï¼Œå…± \$MAX_RETRIES æ¬¡...\"
          if make download -j8 2>&1 | tee download_attempt_\$retries.log; then
            echo \"ä¸‹è½½æˆåŠŸï¼\"
            exit 0
          fi
          retries=\$((retries+1))
          if [ \$retries -lt \$MAX_RETRIES ]; then
            echo \"ä¸‹è½½å¤±è´¥ï¼Œç­‰å¾… \$RETRY_WAIT ç§’åŽé‡è¯•...\"
            sleep \$RETRY_WAIT
          fi
        done
        
        echo \"è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°ï¼Œä¿å­˜æ—¥å¿—ä»¥åˆ†æžå¤±è´¥çš„åŒ…...\"
        # ä¿å­˜æœ€åŽä¸€æ¬¡å°è¯•çš„æ—¥å¿—
        mkdir -p logs
        cp download_attempt_\$((\$retries-1)).log logs/download_failures.log
        exit 1
        EOF
          && \
          chmod +x download_with_retry.sh && \
          # ä½¿ç”¨é‡è¯•è„šæœ¬è¿›è¡Œä¸‹è½½
          ./download_with_retry.sh || make download -j1 V=s && \
          # è®¾ç½®CCACHE
          mkdir -p ${{ env.CCACHE_DIR }} && \
          export CCACHE_DIR=${{ env.CCACHE_DIR }} && \
          ccache -o max_size=2G && \
          ccache -z"
        
        # æ£€æŸ¥ä¸‹è½½ç›®å½•å¤§å°
        echo "ä¸‹è½½ç›®å½•å¤§å°: $(du -sh ${{ env.DL_DIR }} | cut -f1)"

    - name: æ™ºèƒ½ç¼–è¯‘å›ºä»¶
      id: compile
      run: |
        # åœ¨Dockerå®¹å™¨ä¸­æ‰§è¡Œç¼–è¯‘
        docker run --rm -v ${{ env.DOCKER_WORK_DIR }}:/workdir \
          -e CCACHE_DIR=${{ env.CCACHE_DIR }} \
          -e PATH="/usr/lib/ccache:$PATH" \
          openwrt-builder bash -c "\
          cd /workdir/openwrt && \
          export BUILD_MODE=${{ env.BUILD_MODE }} && \
          echo \"ç¼–è¯‘æ¨¡å¼: \$BUILD_MODE\" && \
          
          # å®šä¹‰å‡½æ•°
          cleanup_temp_files() {
            echo \"æ¸…ç†ä¸´æ—¶æ–‡ä»¶ä»¥é‡Šæ”¾ç©ºé—´...\"
            find /tmp -type f -delete || true
            df -h
          } && \
          
          save_cache_info() {
            echo \"ä¿å­˜ç¼“å­˜çŠ¶æ€ä¿¡æ¯...\"
            mkdir -p ${{ env.BUILD_STATE_DIR }}
            cp .config ${{ env.BUILD_STATE_DIR }}/config.txt
            echo \"\$TOOLCHAIN_CONFIG_MD5\" > ${{ env.BUILD_STATE_DIR }}/toolchain.md5
            echo \"\$PACKAGE_CONFIG_MD5\" > ${{ env.BUILD_STATE_DIR }}/package.md5
            echo \"ä¿å­˜æž„å»ºçŠ¶æ€å®Œæˆ\"
          } && \
          
          # ä»…æå–ç›®æ ‡æž¶æž„ç›¸å…³é…ç½®è®¡ç®—å“ˆå¸Œå€¼
          TOOLCHAIN_CONFIG=\$(grep \"^CONFIG_TARGET\" .config | sort) && \
          TOOLCHAIN_CONFIG_MD5=\$(echo \"\$TOOLCHAIN_CONFIG\" | md5sum | awk '{print \$1}') && \
          PREVIOUS_TOOLCHAIN_MD5=\$(cat ${{ env.BUILD_STATE_DIR }}/toolchain.md5 2>/dev/null || echo \"\") && \
          
          # ä»…æå–åŒ…é…ç½®è®¡ç®—å“ˆå¸Œå€¼
          PACKAGE_CONFIG=\$(grep \"^CONFIG_PACKAGE\" .config | sort) && \
          PACKAGE_CONFIG_MD5=\$(echo \"\$PACKAGE_CONFIG\" | md5sum | awk '{print \$1}') && \
          PREVIOUS_PACKAGE_MD5=\$(cat ${{ env.BUILD_STATE_DIR }}/package.md5 2>/dev/null || echo \"\") && \
          
          # æ ¹æ®ç¼–è¯‘æ¨¡å¼æ‰§è¡Œä¸åŒçš„ç¼–è¯‘æµç¨‹
          case \"\$BUILD_MODE\" in
            full)
              echo \"æ‰§è¡Œå®Œå…¨ç¼–è¯‘æµç¨‹...\" && \
              make clean && \
              # ç¼–è¯‘å·¥å…·é“¾
              echo \"ç¼–è¯‘å·¥å…·é“¾...\" && \
              make -j\$(nproc) tools/compile V=s || make -j1 V=s tools/compile && \
              make -j\$(nproc) toolchain/compile V=s || make -j1 V=s toolchain/compile && \
              # ç¼–è¯‘å®Œæ•´å›ºä»¶
              echo \"ç¼–è¯‘å®Œæ•´å›ºä»¶...\" && \
              if ! make -j\$(nproc) V=s; then
                make -j1 V=s
              fi
              ;;
            
            packages)
              echo \"æ‰§è¡ŒåŒ…ç¼–è¯‘æµç¨‹...\" && \
              # ä¸æ¸…ç†å·¥å…·é“¾ï¼Œåªæ¸…ç†åŒ…
              make package/clean V=s || make -j1 V=s package/clean && \
              # ç¼–è¯‘è½¯ä»¶åŒ…
              echo \"ç¼–è¯‘è½¯ä»¶åŒ…...\" && \
              if ! make -j\$(nproc) package/compile V=s; then
                make -j1 V=s package/compile
              fi && \
              # åˆ›å»ºåŒ…ç´¢å¼•
              echo \"åˆ›å»ºåŒ…ç´¢å¼•...\" && \
              make -j\$(nproc) package/index V=s || make -j1 V=s package/index && \
              # ç”Ÿæˆå›ºä»¶
              echo \"ç”Ÿæˆå›ºä»¶é•œåƒ...\" && \
              make -j\$(nproc) target/install V=s || make -j1 V=s target/install
              ;;
            
            incremental)
              echo \"æ‰§è¡ŒçœŸæ­£çš„å¢žé‡ç¼–è¯‘æµç¨‹...\" && \
              # åªç¼–è¯‘å·²ç»å˜åŒ–çš„æ–‡ä»¶ï¼Œå¹¶ç”Ÿæˆæ–°å›ºä»¶
              # é¦–å…ˆï¼Œæ ‡è®°æ‰€æœ‰éœ€è¦é‡æ–°æž„å»ºçš„åŒ…
              find \$(grep ^CONFIG_PACKAGE .config | grep =y | sed -e 's/CONFIG_PACKAGE_\\([^=]*\\)=y/\\1/' | xargs -n1 -i find package -name {}) -type f -name Makefile | xargs touch && \
              # ä½¿ç”¨å¢žé‡ç¼–è¯‘æ¨¡å¼
              if ! make -j\$(nproc) V=s; then
                make -j1 V=s
              fi
              ;;
            
            *)
              echo \"æœªçŸ¥çš„ç¼–è¯‘æ¨¡å¼ï¼Œé»˜è®¤æ‰§è¡Œå®Œå…¨ç¼–è¯‘...\" && \
              if ! make -j\$(nproc) V=s; then
                make -j1 V=s
              fi
              ;;
          esac && \
          
          # æ— è®ºç¼–è¯‘ç»“æžœå¦‚ä½•ï¼Œéƒ½ç¡®ä¿æ‰§è¡Œå›ºä»¶ç”Ÿæˆæ­¥éª¤
          echo \"ç¡®ä¿æ‰§è¡Œå›ºä»¶ç”Ÿæˆæ­¥éª¤ï¼Œæ— è®ºå‰é¢ç¼–è¯‘æ˜¯å¦æˆåŠŸ...\" && \
          make -j\$(nproc) target/install V=s || make -j1 V=s target/install && \
          
          # ä¿å­˜ç¼“å­˜ä¿¡æ¯
          save_cache_info && \
          
          # æ˜¾ç¤ºCCACHEç»Ÿè®¡ä¿¡æ¯
          ccache -s && \
          
          # æ£€æŸ¥å›ºä»¶ç”Ÿæˆç»“æžœ
          echo \"æ£€æŸ¥å›ºä»¶ç”Ÿæˆç»“æžœ:\" && \
          find bin/targets -type f -name \"*.bin\" -o -name \"*combined*\" -o -name \"*sysupgrade*\" | xargs ls -lh || echo \"æ²¡æœ‰æ‰¾åˆ°å›ºä»¶æ–‡ä»¶ï¼\" && \
          
          # è®¾ç½®è®¾å¤‡åç§°çŽ¯å¢ƒå˜é‡
          DEVICE_NAME=_\$(grep '^CONFIG_TARGET.*DEVICE.*=y' .config | sed -r 's/.*DEVICE_(.*)=y/\\1/' | tr '\\n' '_') && \
          echo \"DEVICE_NAME=\$DEVICE_NAME\" > /workdir/device_name.env && \
          
          # è®¾ç½®æ–‡ä»¶æ—¥æœŸçŽ¯å¢ƒå˜é‡
          FILE_DATE=_\$(date +\"%Y%m%d%H%M\") && \
          echo \"FILE_DATE=\$FILE_DATE\" > /workdir/file_date.env && \
          
          echo \"status=success\" > /workdir/compile_status.env"
        
        # è¯»å–çŽ¯å¢ƒå˜é‡
        if [ -f "${{ env.DOCKER_WORK_DIR }}/device_name.env" ]; then
          source ${{ env.DOCKER_WORK_DIR }}/device_name.env
          echo "DEVICE_NAME=$DEVICE_NAME" >> $GITHUB_ENV
        fi
        
        if [ -f "${{ env.DOCKER_WORK_DIR }}/file_date.env" ]; then
          source ${{ env.DOCKER_WORK_DIR }}/file_date.env
          echo "FILE_DATE=$FILE_DATE" >> $GITHUB_ENV
        fi
        
        if [ -f "${{ env.DOCKER_WORK_DIR }}/compile_status.env" ]; then
          source ${{ env.DOCKER_WORK_DIR }}/compile_status.env
          echo "status=$status" >> $GITHUB_OUTPUT
        else
          echo "status=failure" >> $GITHUB_OUTPUT
        fi
        
        # æ˜¾ç¤ºç¼–è¯‘åŽçš„ç£ç›˜ä½¿ç”¨æƒ…å†µ
        df -h

    # ä¸‹è½½ç¼“å­˜ - é«˜æ•ˆä¸”å®‰å…¨
    - name: ä¿å­˜ä¸‹è½½ç¼“å­˜
      uses: actions/cache@v3
      if: "!cancelled() && steps.compile.outputs.status == 'success'"
      with:
        path: ${{ env.DL_DIR }}
        key: dl-docker-${{ env.REPO_BRANCH }}-${{ hashFiles('**/feeds.conf.default') }}

    # CCACHEç¼“å­˜ - ç¼–è¯‘åŠ é€Ÿ
    - name: ä¿å­˜CCACHEç¼“å­˜
      uses: actions/cache@v3
      if: "!cancelled() && steps.compile.outputs.status == 'success'"
      with:
        path: ${{ env.CCACHE_DIR }}
        key: ccache-docker-${{ env.REPO_BRANCH }}-${{ hashFiles('**/feeds.conf.default') }}

    # ä¸»æœºå·¥å…·é“¾ç¼“å­˜ - å…³é”®ä¸”å˜åŒ–å°‘
    - name: ä¿å­˜ä¸»æœºå·¥å…·é“¾ç¼“å­˜
      uses: actions/cache@v3
      if: "!cancelled() && steps.compile.outputs.status == 'success'"
      with:
        path: ${{ env.TOOLCHAIN_DIR }}/host
        key: host-tools-docker-${{ env.REPO_BRANCH }}-${{ hashFiles('**/feeds.conf.default') }}

    # ç¼–è¯‘çŠ¶æ€ç¼“å­˜ - å°ä½“ç§¯é«˜ä»·å€¼
    - name: ä¿å­˜ç¼–è¯‘çŠ¶æ€
      uses: actions/cache@v3
      if: "!cancelled() && steps.compile.outputs.status == 'success'"
      with:
        path: |
          ${{ env.STAMP_DIR }}
          /workdir/openwrt/staging_dir/target-*/stamps
          /workdir/openwrt/.packageinfo
        key: stamps-docker-${{ env.REPO_BRANCH }}-${{ hashFiles('**/feeds.conf.default') }}

    # æž„å»ºçŠ¶æ€ç¼“å­˜
    - name: ä¿å­˜æž„å»ºçŠ¶æ€ç¼“å­˜
      uses: actions/cache@v3
      if: "!cancelled() && steps.compile.outputs.status == 'success'"
      with:
        path: ${{ env.BUILD_STATE_DIR }}
        key: state-docker-${{ env.REPO_BRANCH }}-${{ hashFiles('**/feeds.conf.default') }}

    # æ•´ç†æ–‡ä»¶
    - name: æ•´ç†æ–‡ä»¶
      id: organize
      if: steps.compile.outputs.status == 'success' && env.UPLOAD_FIRMWARE == 'true' && !cancelled()
      run: |
        echo "æœç´¢æ‰€æœ‰å¯èƒ½çš„å›ºä»¶æ–‡ä»¶..."
        # ä½¿ç”¨Dockerå®¹å™¨æŸ¥æ‰¾å›ºä»¶æ–‡ä»¶
        docker run --rm -v ${{ env.DOCKER_WORK_DIR }}:/workdir openwrt-builder bash -c "\
          find /workdir/openwrt/bin -type f -name '*.bin' -o -name '*.img' -o -name '*sysupgrade*' -o -name '*combined*' | \
          xargs -r ls -lh || echo 'æœªæ‰¾åˆ°å¯èƒ½çš„å›ºä»¶æ–‡ä»¶'"
          
        # æ£€æŸ¥æ˜¯å¦æœ‰ç›®æ ‡ç›®å½•
        if [ ! -d "${{ env.DOCKER_WORK_DIR }}/openwrt/bin/targets" ]; then
          echo "é”™è¯¯ï¼šç¼–è¯‘ç›®æ ‡ç›®å½•ä¸å­˜åœ¨ï¼Œå¯èƒ½ç¼–è¯‘å¤±è´¥"
          # åˆ›å»ºä¸€ä¸ªç©ºçš„å›ºä»¶ç›®å½•
          mkdir -p ${{ env.DOCKER_WORK_DIR }}/openwrt/bin/targets/empty/firmware
          echo "FIRMWARE=${{ env.DOCKER_WORK_DIR }}/openwrt/bin/targets/empty/firmware" >> $GITHUB_ENV
          echo "status=success" >> $GITHUB_OUTPUT
          exit 0
        fi
        
        # åœ¨Dockerå®¹å™¨ä¸­æ•´ç†å›ºä»¶æ–‡ä»¶
        docker run --rm -v ${{ env.DOCKER_WORK_DIR }}:/workdir openwrt-builder bash -c "\
          # æŸ¥æ‰¾æ‰€æœ‰ç›®æ ‡ç›®å½•
          TARGET_DIRS=\$(find /workdir/openwrt/bin/targets -mindepth 2 -maxdepth 2 -type d)
          
          if [ -z \"\$TARGET_DIRS\" ]; then
            echo 'è­¦å‘Šï¼šæœªæ‰¾åˆ°å…·ä½“ç›®æ ‡ç›®å½•ï¼Œåˆ›å»ºé€šç”¨ç›®å½•'
            mkdir -p /workdir/openwrt/bin/targets/generic/generic
            TARGET_DIRS='/workdir/openwrt/bin/targets/generic/generic'
          fi
          
          # å¯¹äºŽæ¯ä¸ªç›®æ ‡ç›®å½•ï¼Œå°è¯•æŸ¥æ‰¾å›ºä»¶æ–‡ä»¶
          for TARGET_DIR in \$TARGET_DIRS; do
            echo \"å¤„ç†ç›®æ ‡ç›®å½•: \$TARGET_DIR\"
            cd \"\$TARGET_DIR\"
            
            # åˆ›å»ºå›ºä»¶ç›®å½•å¹¶ç¡®ä¿å®ƒæ˜¯ç©ºçš„
            rm -rf firmware
            mkdir -p firmware
            
            # æŸ¥æ‰¾å›ºä»¶æ–‡ä»¶ - ä½¿ç”¨æ›´å®½æ¾çš„åŒ¹é…è§„åˆ™
            FILES_FOUND=0
            
            # å°è¯•å¤åˆ¶æ ‡å‡†å›ºä»¶æ–‡ä»¶
            for pattern in '*combined*' '*sysupgrade*' '*.img' '*.bin'; do
              echo \"å°è¯•å¤åˆ¶åŒ¹é… \$pattern çš„æ–‡ä»¶...\"
              if find . -maxdepth 1 -name \"\$pattern\" | grep -q .; then
                find . -maxdepth 1 -name \"\$pattern\" -exec cp -f {} ./firmware/ \\;
                FILES_FOUND=1
              fi
            done
            
            # å¦‚æžœæ²¡æœ‰æ‰¾åˆ°æ ‡å‡†å›ºä»¶æ–‡ä»¶ï¼Œå°è¯•å¤åˆ¶æ‰€æœ‰éžæ¸…å•æ–‡ä»¶
            if [ \$FILES_FOUND -eq 0 ]; then
              echo 'æœªæ‰¾åˆ°æ ‡å‡†å›ºä»¶æ–‡ä»¶ï¼Œå°è¯•å¤åˆ¶æ‰€æœ‰å¯èƒ½çš„æ–‡ä»¶...'
              find . -maxdepth 1 -type f -not -name '*.manifest' -not -name '*.txt' -not -name '*.json' \
                -not -name '*.buildinfo' -exec cp -f {} ./firmware/ \\;
            fi
            
            # å¤åˆ¶é…ç½®æ–‡ä»¶
            if [ -f '/workdir/openwrt/.config' ]; then
              cp -f /workdir/openwrt/.config ./firmware/config.txt
            fi
            
            # æ£€æŸ¥æ˜¯å¦æˆåŠŸå¤åˆ¶äº†ä»»ä½•æ–‡ä»¶
            if [ -n \"\$(ls -A firmware)\" ]; then
              echo \"æˆåŠŸå¤åˆ¶å›ºä»¶æ–‡ä»¶åˆ° \$TARGET_DIR/firmware\"
              echo \"å›ºä»¶å†…å®¹:\"
              ls -lh firmware/
              
              echo \"FIRMWARE=\$TARGET_DIR/firmware\" > /workdir/firmware_path.env
              echo \"status=success\" > /workdir/organize_status.env
              break
            else
              echo \"è­¦å‘Š: \$TARGET_DIR ä¸­æœªæ‰¾åˆ°å¯ç”¨å›ºä»¶æ–‡ä»¶\"
            fi
          done
          
          # å¦‚æžœæ²¡æœ‰æ‰¾åˆ°ä»»ä½•å›ºä»¶æ–‡ä»¶ï¼Œä½¿ç”¨ç´§æ€¥å¤‡ç”¨æ–¹æ³•
          if [ ! -f '/workdir/firmware_path.env' ]; then
            echo 'è­¦å‘Šï¼šæœªèƒ½åœ¨ä»»ä½•ç›®æ ‡ç›®å½•ä¸­æ‰¾åˆ°å›ºä»¶æ–‡ä»¶ï¼Œä½¿ç”¨ç´§æ€¥å¤‡ç”¨æ–¹æ³•'
            BACKUP_DIR='/workdir/openwrt/bin/targets/generic/backup_firmware'
            mkdir -p \"\$BACKUP_DIR/firmware\"
            
            # å¤åˆ¶æ‰€æœ‰binç›®å½•ä¸‹çš„éžåŒ…æ–‡ä»¶
            find /workdir/openwrt/bin -type f -not -path '*/packages/*' -exec cp -f {} \"\$BACKUP_DIR/firmware/\" \\;
            
            # ç¡®ä¿è‡³å°‘æœ‰ä¸€ä¸ªé…ç½®æ–‡ä»¶
            if [ -f '/workdir/openwrt/.config' ]; then
              cp -f /workdir/openwrt/.config \"\$BACKUP_DIR/firmware/config.txt\"
            else
              echo '# ç´§æ€¥å¤‡ç”¨é…ç½®' > \"\$BACKUP_DIR/firmware/config.txt\"
            fi
            
            echo \"FIRMWARE=\$BACKUP_DIR/firmware\" > /workdir/firmware_path.env
            echo \"status=success\" > /workdir/organize_status.env
          fi
          
          # åˆ›å»ºå›ºä»¶åŽ‹ç¼©åŒ…
          if [ -f '/workdir/firmware_path.env' ]; then
            source /workdir/firmware_path.env
            cd \$(dirname \"\$FIRMWARE\")
            zip -r firmware.zip \$(basename \"\$FIRMWARE\")
            echo \"FIRMWARE_ZIP=\$(dirname \"\$FIRMWARE\")/firmware.zip\" >> /workdir/firmware_path.env
          fi"
        
        # è¯»å–çŽ¯å¢ƒå˜é‡
        if [ -f "${{ env.DOCKER_WORK_DIR }}/firmware_path.env" ]; then
          source ${{ env.DOCKER_WORK_DIR }}/firmware_path.env
          echo "FIRMWARE=$FIRMWARE" >> $GITHUB_ENV
          if [ -n "$FIRMWARE_ZIP" ]; then
            echo "FIRMWARE_ZIP=$FIRMWARE_ZIP" >> $GITHUB_ENV
          fi
        fi
        
        if [ -f "${{ env.DOCKER_WORK_DIR }}/organize_status.env" ]; then
          source ${{ env.DOCKER_WORK_DIR }}/organize_status.env
          echo "status=$status" >> $GITHUB_OUTPUT
        else
          echo "status=failure" >> $GITHUB_OUTPUT
        fi

    # ä¸Šä¼ å›ºä»¶
    - name: ä¸Šä¼ å›ºä»¶ç›®å½•
      uses: actions/upload-artifact@main
      if: steps.organize.outputs.status == 'success' && !cancelled()
      with:
        name: OpenWrt_firmware${{ env.DEVICE_NAME }}${{ env.FILE_DATE }}
        path: ${{ env.FIRMWARE }}

    - name: ç”Ÿæˆå‘å¸ƒæ ‡ç­¾
      id: tag
      if: steps.organize.outputs.status == 'success' && env.UPLOAD_RELEASE == 'true' && !cancelled()
      run: |
        echo "RELEASE_TAG=$(date +"%Y.%m.%d-%H%M")" >> $GITHUB_OUTPUT
        echo "## OpenWrtå›ºä»¶æž„å»ºå®Œæˆ ðŸ“¦" > release.txt
        echo "ðŸ“… æž„å»ºæ—¶é—´: $(date +"%Y-%m-%d %H:%M")" >> release.txt
        echo "ðŸ“‚ å›ºä»¶ä¸‹è½½" >> release.txt
        echo "âš ï¸ è¯·åœ¨åˆ·æœºå‰å…ˆåšå¥½å¤‡ä»½ï¼" >> release.txt
        echo "status=success" >> $GITHUB_OUTPUT

    - name: ä¸Šä¼ å›ºä»¶åˆ°Releases
      uses: softprops/action-gh-release@v2
      if: steps.tag.outputs.status == 'success' && !cancelled()
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ steps.tag.outputs.RELEASE_TAG }}
        body_path: release.txt
        files: ${{ env.FIRMWARE }}/*

    - name: åˆ é™¤æ—§çš„Releases
      uses: dev-drprasad/delete-older-releases@master
      if: env.UPLOAD_RELEASE == 'true' && !cancelled()
      with:
        keep_latest: 3
        delete_tags: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
