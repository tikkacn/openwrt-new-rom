name: å…¨æ–°ç¼–è¯‘ç¬¬11ç‰ˆ(ä¼˜åŒ–ç‰ˆ)

on:
  workflow_dispatch:
    inputs:
      ssh:
        description: 'SSHè°ƒè¯•'
        required: false
        default: 'false'
      clean_build:
        description: 'å®Œå…¨é‡æ–°ç¼–è¯‘'
        required: false
        default: 'false'
      config_file:
        description: 'é…ç½®æ–‡ä»¶'
        required: false
        default: 'å¢é‡ç¼“å­˜ä¼˜åŒ–.config'

env:
  REPO_URL: https://github.com/coolsnowwolf/lede
  REPO_BRANCH: master
  CONFIG_FILE: ${{ github.event.inputs.config_file || 'å¢é‡ç¼“å­˜ä¼˜åŒ–.config' }}
  DIY_P1_SH: diy-part1.sh
  DIY_P2_SH: diy-part2.sh
  UPLOAD_FIRMWARE: true
  UPLOAD_RELEASE: true
  TZ: Asia/Shanghai
  CCACHE_DIR: /workdir/ccache
  TOOLCHAIN_DIR: /workdir/openwrt/staging_dir
  DL_DIR: /workdir/openwrt/dl
  BUILD_STATE_DIR: /workdir/build_state
  STAMP_DIR: /workdir/openwrt/staging_dir/stamps

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@main

    - name: ä¼˜åŒ–ç£ç›˜ç©ºé—´
      uses: easimon/maximize-build-space@master
      with:
        root-reserve-mb: 20480
        swap-size-mb: 5120
        remove-dotnet: 'true'
        remove-android: 'true'
        remove-haskell: 'true'
        remove-codeql: 'true'
        remove-docker-images: 'true'
        build-mount-path: '/workdir'

    - name: é¢å¤–æ¸…ç†ç£ç›˜ç©ºé—´å¹¶æ£€æŸ¥
      run: |
        echo "æ¸…ç†é¢å¤–ç£ç›˜ç©ºé—´..."
        sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /usr/local/share/boost
        sudo rm -rf /usr/share/swift /usr/local/julia* /opt/hostedtoolcache/CodeQL
        docker image prune -a -f || true
        docker system prune -af || true
        sudo apt-get clean
        sudo apt-get autoremove -y
        ROOT_AVAIL=$(df -m /dev/root | tail -1 | awk '{print $4}')
        echo "æ ¹åˆ†åŒºå¯ç”¨ç©ºé—´: ${ROOT_AVAIL}MB"
        if [ "$ROOT_AVAIL" -lt 20480 ]; then
          echo "é”™è¯¯ï¼š/dev/root å¯ç”¨ç©ºé—´ä¸è¶³ 20GB"
          exit 1
        fi
        df -h

    - name: åˆå§‹åŒ–ç¯å¢ƒ
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        sudo -E apt-get -qq update
        sudo -E apt-get -qq install ack antlr3 asciidoc autoconf automake autopoint binutils bison build-essential \
        bzip2 ccache clang cmake cpio curl device-tree-compiler flex gawk gcc-multilib g++-multilib gettext \
        genisoimage git gperf haveged help2man intltool libc6-dev-i386 libelf-dev libfuse-dev libglib2.0-dev \
        libgmp3-dev libltdl-dev libmpc-dev libmpfr-dev libncurses5-dev libncursesw5-dev libpython3-dev \
        libreadline-dev libssl-dev libtool llvm lrzsz msmtp ninja-build p7zip p7zip-full patch pkgconf \
        python3 python3-pyelftools python3-setuptools qemu-utils rsync scons squashfs-tools subversion \
        swig texinfo uglifyjs upx-ucl unzip vim wget xmlto xxd zlib1g-dev bc lm-sensors pciutils libunistring-dev libxml2-dev \
        libdeflate-dev
        sudo -E apt-get -qq clean
        sudo timedatectl set-timezone "$TZ"
        
        # ç¡®ä¿å…³é”®ç›®å½•å­˜åœ¨
        mkdir -p ${{ env.BUILD_STATE_DIR }} ${{ env.CCACHE_DIR }}
        mkdir -p /workdir/openwrt/staging_dir/host/bin
        mkdir -p /workdir/openwrt/staging_dir/toolchain-x86_64_gcc-13.3.0_musl/lib
        chmod -R 777 /workdir
        
        # åˆ›å»ºå¿…è¦çš„ç¬¦å·é“¾æ¥
        if [ ! -f "/workdir/openwrt/staging_dir/host/bin/libdeflate-gzip" ]; then
          echo "åˆ›å»º libdeflate-gzip ç¬¦å·é“¾æ¥..."
          if [ -f "/usr/bin/libdeflate-gzip" ]; then
            sudo ln -sf /usr/bin/libdeflate-gzip /workdir/openwrt/staging_dir/host/bin/libdeflate-gzip
          else
            sudo ln -sf /bin/gzip /workdir/openwrt/staging_dir/host/bin/libdeflate-gzip
          fi
        fi
        
        if [ ! -f "/workdir/openwrt/staging_dir/host/bin/ninja" ]; then
          echo "åˆ›å»º ninja ç¬¦å·é“¾æ¥..."
          sudo ln -sf /usr/bin/ninja /workdir/openwrt/staging_dir/host/bin/ninja
        fi
        
        # åˆ›å»ºè„šæœ¬æ–‡ä»¶
        echo '#!/bin/bash' > $GITHUB_WORKSPACE/diy-part1.sh
        echo '# Feeds å·²é€šè¿‡å›ºå®šé…ç½®ç®¡ç†' >> $GITHUB_WORKSPACE/diy-part1.sh
        chmod +x $GITHUB_WORKSPACE/diy-part1.sh
        echo '#!/bin/bash' > $GITHUB_WORKSPACE/diy-part2.sh
        echo 'sed -i "s/OpenWrt /OpenWrt_AutoBuild /" package/lean/default-settings/files/zzz-default-settings' >> $GITHUB_WORKSPACE/diy-part2.sh
        chmod +x $GITHUB_WORKSPACE/diy-part2.sh
        
        # æ£€æŸ¥é…ç½®æ–‡ä»¶
        if [ ! -f "$GITHUB_WORKSPACE/$CONFIG_FILE" ]; then
          echo "è­¦å‘Šï¼šé…ç½®æ–‡ä»¶ $CONFIG_FILE ä¸å­˜åœ¨ï¼Œåˆ›å»ºé»˜è®¤é…ç½®æ–‡ä»¶"
          echo "# åˆ›å»ºé»˜è®¤çš„æœ€å°åŒ–é…ç½®æ–‡ä»¶" > $GITHUB_WORKSPACE/$CONFIG_FILE
          echo "CONFIG_TARGET_x86=y" >> $GITHUB_WORKSPACE/$CONFIG_FILE
          echo "CONFIG_TARGET_x86_64=y" >> $GITHUB_WORKSPACE/$CONFIG_FILE
          echo "CONFIG_TARGET_x86_64_DEVICE_generic=y" >> $GITHUB_WORKSPACE/$CONFIG_FILE
          echo "CONFIG_PACKAGE_luci=y" >> $GITHUB_WORKSPACE/$CONFIG_FILE
        fi
        df -h

    - name: å…‹éš†æºä»£ç å¹¶é…ç½® Feeds
      working-directory: /workdir
      run: |
        git clone --depth 1 $REPO_URL -b $REPO_BRANCH openwrt
        ln -sf /workdir/openwrt $GITHUB_WORKSPACE/openwrt
        cd openwrt
        find . -type f -name "*.sh" -exec chmod +x {} \;
        
        # é…ç½® feeds
        cat > feeds.conf.default << EOF
        src-git packages https://github.com/coolsnowwolf/packages
        src-git luci https://github.com/coolsnowwolf/luci
        src-git routing https://git.openwrt.org/feed/routing.git
        src-git passwall https://github.com/xiaorouji/openwrt-passwall
        src-git ssrplus https://github.com/fw876/helloworld
        src-git kenzok8 https://github.com/kenzok8/openwrt-packages
        EOF
        
        # æ›´æ–°feeds
        ./scripts/feeds update -a || { 
          echo "é”™è¯¯ï¼šfeeds æ›´æ–°å¤±è´¥ï¼Œå°è¯•ä¿®å¤..."
          # å°è¯•ä¿®å¤feedsæ›´æ–°é—®é¢˜
          rm -rf feeds
          mkdir -p feeds
          git config --global http.sslVerify false
          git config --global https.sslVerify false
          ./scripts/feeds update -a || { echo "é”™è¯¯ï¼šfeeds æ›´æ–°å¤±è´¥ï¼Œæ— æ³•ä¿®å¤"; exit 1; }
        }
        
        ./scripts/feeds install -a
        
        # ç¡®ä¿å®‰è£…å…³é”®åŒ…
        for pkg in luci-app-passwall luci-app-ssr-plus luci-base; do
          ./scripts/feeds install $pkg || echo "è­¦å‘Šï¼š$pkg ä¸å¯ç”¨ï¼Œå¯èƒ½éœ€è¦æ£€æŸ¥ feeds é…ç½®"
        done
        
        rm -rf .git
        
        # åˆ›å»ºå¿…è¦ç›®å½•
        mkdir -p ${{ env.TOOLCHAIN_DIR }} ${{ env.DL_DIR }} ${{ env.BUILD_STATE_DIR }} ${{ env.STAMP_DIR }}
        mkdir -p logs

    - name: æ¢å¤ä¸‹è½½ç¼“å­˜
      uses: actions/cache@v3
      id: cache-dl
      with:
        path: ${{ env.DL_DIR }}
        key: dl-${{ env.REPO_BRANCH }}-${{ hashFiles('**/feeds.conf.default') }}
        restore-keys: |
          dl-${{ env.REPO_BRANCH }}-

    - name: æ¢å¤CCACHEç¼“å­˜
      uses: actions/cache@v3
      id: cache-ccache
      with:
        path: ${{ env.CCACHE_DIR }}
        key: ccache-${{ env.REPO_BRANCH }}-${{ hashFiles('**/feeds.conf.default') }}
        restore-keys: |
          ccache-${{ env.REPO_BRANCH }}-

    - name: æ¢å¤ä¸»æœºå·¥å…·é“¾ç¼“å­˜
      uses: actions/cache@v3
      id: cache-host-tools
      if: inputs.clean_build != 'true'
      with:
        path: ${{ env.TOOLCHAIN_DIR }}/host
        key: host-tools-${{ env.REPO_BRANCH }}-${{ hashFiles('**/feeds.conf.default') }}
        restore-keys: |
          host-tools-${{ env.REPO_BRANCH }}-

    - name: æ¢å¤ç¼–è¯‘çŠ¶æ€
      uses: actions/cache@v3
      id: cache-stamps
      if: inputs.clean_build != 'true'
      with:
        path: |
          ${{ env.STAMP_DIR }}
          /workdir/openwrt/staging_dir/target-*/stamps
          /workdir/openwrt/.packageinfo
          /workdir/openwrt/feeds
        key: stamps-${{ env.REPO_BRANCH }}-${{ hashFiles('**/feeds.conf.default') }}
        restore-keys: |
          stamps-${{ env.REPO_BRANCH }}-

    - name: æ¢å¤æ„å»ºçŠ¶æ€ç¼“å­˜
      uses: actions/cache@v3
      id: cache-state
      if: inputs.clean_build != 'true'
      with:
        path: ${{ env.BUILD_STATE_DIR }}
        key: state-${{ env.REPO_BRANCH }}-${{ hashFiles('**/feeds.conf.default') }}
        restore-keys: |
          state-${{ env.REPO_BRANCH }}-

    - name: æ£€æŸ¥ç¼“å­˜æ¢å¤çŠ¶æ€
      run: |
        echo "CONFIG_FILE: ${{ env.CONFIG_FILE }}"
        echo "ä¸‹è½½ç›®å½•ç¼“å­˜æ¢å¤çŠ¶æ€: ${{ steps.cache-dl.outputs.cache-hit == 'true' && 'æˆåŠŸ' || 'æœªæ‰¾åˆ°ç¼“å­˜' }}"
        echo "CCACHEç¼“å­˜æ¢å¤çŠ¶æ€: ${{ steps.cache-ccache.outputs.cache-hit == 'true' && 'æˆåŠŸ' || ' æœªæ‰¾åˆ°ç¼“å­˜' }}"
        echo "ä¸»æœºå·¥å…·é“¾ç¼“å­˜æ¢å¤çŠ¶æ€: ${{ steps.cache-host-tools.outputs.cache-hit == 'true' && 'æˆåŠŸ' || 'æœªæ‰¾åˆ°ç¼“å­˜' }}"
        echo "ç¼–è¯‘çŠ¶æ€ç¼“å­˜æ¢å¤çŠ¶æ€: ${{ steps.cache-stamps.outputs.cache-hit == 'true' && 'æˆåŠŸ' || 'æœªæ‰¾åˆ°ç¼“å­˜' }}"
        echo "æ„å»ºçŠ¶æ€ç¼“å­˜æ¢å¤çŠ¶æ€: ${{ steps.cache-state.outputs.cache-hit == 'true' && 'æˆåŠŸ' || 'æœªæ‰¾åˆ°ç¼“å­˜' }}"
        
        echo "ä¸‹è½½ç›®å½•å¤§å°: $(du -sh ${{ env.DL_DIR }} 2>/dev/null || echo 'ç›®å½•ä¸å­˜åœ¨æˆ–ä¸ºç©º')"
        echo "CCACHEç›®å½•å¤§å°: $(du -sh ${{ env.CCACHE_DIR }} 2>/dev/null || echo 'ç›®å½•ä¸å­˜åœ¨æˆ–ä¸ºç©º')"
        echo "ä¸»æœºå·¥å…·é“¾ç›®å½•å¤§å°: $(du -sh ${{ env.TOOLCHAIN_DIR }}/host 2>/dev/null || echo 'ç›®å½•ä¸å­˜åœ¨æˆ–ä¸ºç©º')"
        echo "ç¼–è¯‘çŠ¶æ€ç›®å½•å¤§å°: $(du -sh ${{ env.STAMP_DIR }} 2>/dev/null || echo 'ç›®å½•ä¸å­˜åœ¨æˆ–ä¸ºç©º')"
        
        echo "æ£€æŸ¥å…³é”®å·¥å…·é“¾æ–‡ä»¶..."
        find ${{ env.TOOLCHAIN_DIR }}/host/bin -name "gcc*" 2>/dev/null | head -5 || echo "æœªæ‰¾åˆ°ä¸»æœºgcc"
        
        if [ -d "${{ env.TOOLCHAIN_DIR }}/host/bin" ] && [ -f "${{ env.TOOLCHAIN_DIR }}/host/bin/libdeflate-gzip" ]; then
          echo "å·¥å…·é“¾åŒ…å« libdeflate-gzipï¼Œç¼“å­˜æ­£å¸¸"
        else
          echo "è­¦å‘Šï¼šå·¥å…·é“¾ç¼“å­˜ç¼ºå°‘ libdeflate-gzipï¼Œåˆ›å»ºç¬¦å·é“¾æ¥"
          mkdir -p "${{ env.TOOLCHAIN_DIR }}/host/bin"
          if [ -f "/usr/bin/libdeflate-gzip" ]; then
            sudo ln -sf /usr/bin/libdeflate-gzip "${{ env.TOOLCHAIN_DIR }}/host/bin/libdeflate-gzip"
          else
            sudo ln -sf /bin/gzip "${{ env.TOOLCHAIN_DIR }}/host/bin/libdeflate-gzip"
          fi
        fi
        
        if [ ! -f "${{ env.TOOLCHAIN_DIR }}/host/bin/ninja" ]; then
          echo "è­¦å‘Šï¼šå·¥å…·é“¾ç¼“å­˜ç¼ºå°‘ ninjaï¼Œåˆ›å»ºç¬¦å·é“¾æ¥"
          mkdir -p "${{ env.TOOLCHAIN_DIR }}/host/bin"
          sudo ln -sf /usr/bin/ninja "${{ env.TOOLCHAIN_DIR }}/host/bin/ninja"
        fi
        
        echo "éªŒè¯ feeds ç¼“å­˜å®Œæ•´æ€§..."
        if [ -d "/workdir/openwrt/feeds/luci/luci-base" ] && [ -d "/workdir/openwrt/feeds/passwall/luci-app-passwall" ]; then
          echo "feeds ç¼“å­˜å®Œæ•´"
        else
          echo "è­¦å‘Šï¼šfeeds ç¼“å­˜ä¸å®Œæ•´ï¼Œå¼ºåˆ¶æ›´æ–° feeds"
          cd /workdir/openwrt
          # ä¿å­˜å½“å‰çš„feedsé…ç½®
          cp feeds.conf.default feeds.conf.backup
          rm -rf feeds
          mkdir -p feeds
          # ç¡®ä¿å¯ä»¥ä½¿ç”¨git
          git config --global http.sslVerify false
          git config --global https.sslVerify false
          # æ¢å¤feedsé…ç½®
          [ -f feeds.conf.backup ] && cp feeds.conf.backup feeds.conf.default
          ./scripts/feeds update -a || { echo "é”™è¯¯ï¼šfeeds æ›´æ–°å¤±è´¥"; exit 1; }
          ./scripts/feeds install -a
        fi
        df -h

    - name: é…ç½®ç¼–è¯‘ç¯å¢ƒ
      run: |
        cd /workdir/openwrt
        if [ -f ".config" ]; then
          cp .config .config.original
        fi
        $GITHUB_WORKSPACE/$DIY_P1_SH
        echo "æ›´æ–°å¹¶å®‰è£… Feeds..."
        ./scripts/feeds update -a
        ./scripts/feeds install -a
        [ -e $GITHUB_WORKSPACE/files ] && cp -r $GITHUB_WORKSPACE/files ./files
        cp $GITHUB_WORKSPACE/$CONFIG_FILE ./.config
        cp .config .config.input
        cp .config .config.backup
        $GITHUB_WORKSPACE/$DIY_P2_SH
        
        echo "CONFIG_AUTOREMOVE=n" >> .config
        echo "CONFIG_AUTOREBUILD=n" >> .config
        echo "CONFIG_ALL_KMODS=n" >> .config
        
        echo "ç¡®ä¿åŒ…å«å¿…è¦çš„å›ºä»¶ç”Ÿæˆé…ç½®..."
        if ! grep -q "CONFIG_TARGET_ROOTFS_SQUASHFS=y" .config; then
          echo "CONFIG_TARGET_ROOTFS_SQUASHFS=y" >> .config
          echo "æ·»åŠ äº† CONFIG_TARGET_ROOTFS_SQUASHFS=y"
        fi
        
        if ! grep -q "CONFIG_TARGET_IMAGES_GZIP=y" .config; then
          echo "CONFIG_TARGET_IMAGES_GZIP=y" >> .config
          echo "æ·»åŠ äº† CONFIG_TARGET_IMAGES_GZIP=y"
        fi
        
        if ! grep -q "CONFIG_TARGET_ROOTFS_TARGZ=y" .config; then
          echo "CONFIG_TARGET_ROOTFS_TARGZ=y" >> .config
          echo "æ·»åŠ äº† CONFIG_TARGET_ROOTFS_TARGZ=y"
        fi
        
        if grep -q "CONFIG_TARGET_x86=y" .config; then
          if ! grep -q "CONFIG_GRUB_IMAGES=y" .config; then
            echo "CONFIG_GRUB_IMAGES=y" >> .config
            echo "æ·»åŠ äº† CONFIG_GRUB_IMAGES=y"
          fi
          
          if ! grep -q "CONFIG_TARGET_IMAGES_PAD=y" .config; then
            echo "CONFIG_TARGET_IMAGES_PAD=y" >> .config
            echo "æ·»åŠ äº† CONFIG_TARGET_IMAGES_PAD=y"
          fi
        fi
        
        echo "CONFIG_DOWNLOAD_DIR=\"${{ env.DL_DIR }}\"" >> .config
        
        make defconfig
        grep "^CONFIG_PACKAGE_.*=y" .config.input | sort > packages_input.txt || true
        grep "^CONFIG_PACKAGE_.*=y" .config | sort > packages_defconfig.txt || true
        comm -23 packages_input.txt packages_defconfig.txt > missing_packages.txt
        if [ -s missing_packages.txt ]; then
          echo "è­¦å‘Šï¼šä»¥ä¸‹åŒ…åœ¨ defconfig åç¼ºå¤±ï¼Œå°†å°è¯•æ¢å¤ï¼š"
          cat missing_packages.txt
          cat missing_packages.txt >> .config
          while read -r line; do
            pkg=$(echo "$line" | sed 's/CONFIG_PACKAGE_\(.*\)=y/\1/')
            echo "å®‰è£…åŒ…: $pkg"
            ./scripts/feeds install "$pkg" || echo "è­¦å‘Šï¼šæ— æ³•å®‰è£… $pkgï¼Œå¯èƒ½ä¸åœ¨ feeds ä¸­"
          done < missing_packages.txt
          make defconfig
          diff .config.backup .config > config_diff.txt || echo "é…ç½®æ— å·®å¼‚"
          cat config_diff.txt
        else
          echo "æ‰€æœ‰é…ç½®é¡¹å‡ä¿ç•™ï¼Œæ— ç¼ºå¤±"
        fi
        
        mkdir -p ${{ env.BUILD_STATE_DIR }}
        md5sum .config > ${{ env.BUILD_STATE_DIR }}/current.config.md5
        
        echo "æœ€ç»ˆé…ç½®ä¸­çš„é•œåƒç”Ÿæˆé€‰é¡¹:"
        grep -E "CONFIG_TARGET_ROOTFS|CONFIG_TARGET_IMAGES|CONFIG_GRUB|CONFIG_ISO|CONFIG_EFI" .config || echo "æœªæ‰¾åˆ°é•œåƒç›¸å…³é…ç½®"
        
        diff .config.input .config > config_diff.txt || echo "é…ç½®æ— å·®å¼‚"
        cat config_diff.txt
        df -h

    - name: æ£€æŸ¥æºç å˜åŒ–å’Œé…ç½®å˜åŒ–
      id: check-changes
      run: |
        cd /workdir/openwrt
        mkdir -p ${{ env.BUILD_STATE_DIR }}
        
        find feeds -type f -name "Makefile" -exec sha256sum {} \; | sort | sha256sum > ${{ env.BUILD_STATE_DIR }}/feeds.sha256
        CURRENT_FEEDS_HASH=$(cat ${{ env.BUILD_STATE_DIR }}/feeds.sha256 | awk '{print $1}')
        PREVIOUS_FEEDS_HASH=$(cat ${{ env.BUILD_STATE_DIR }}/previous_feeds.sha256 2>/dev/null | awk '{print $1}' || echo "")
        
        echo "å½“å‰ feeds å“ˆå¸Œ: $CURRENT_FEEDS_HASH"
        echo "ä¹‹å‰ feeds å“ˆå¸Œ: $PREVIOUS_FEEDS_HASH"
        
        CURRENT_CONFIG_MD5=$(md5sum .config | awk '{print $1}')
        PREVIOUS_CONFIG_MD5=$(cat ${{ env.BUILD_STATE_DIR }}/config.md5 2>/dev/null || echo "")
        
        echo "å½“å‰é…ç½®æ–‡ä»¶MD5: $CURRENT_CONFIG_MD5"
        echo "ä¹‹å‰é…ç½®æ–‡ä»¶MD5: $PREVIOUS_CONFIG_MD5"
        
        CACHE_HOST_TOOLS="${{ steps.cache-host-tools.outputs.cache-hit }}"
        
        # æ£€æŸ¥ä¸»æœºå·¥å…·æ˜¯å¦å­˜åœ¨
        TOOLS_MISSING=0
        for tool in libdeflate-gzip ninja; do
          if [ ! -f "/workdir/openwrt/staging_dir/host/bin/$tool" ]; then
            echo "è­¦å‘Šï¼šå·¥å…· $tool ä¸å­˜åœ¨ï¼Œéœ€è¦é‡æ–°ç¼–è¯‘"
            TOOLS_MISSING=1
            break
          fi
        done
        
        if [ ! -d "feeds/luci/luci-base" ] || [ ! -d "feeds/passwall/luci-app-passwall" ]; then
          echo "é”™è¯¯ï¼šfeeds ç´¢å¼•ä¸å®Œæ•´ï¼Œåˆ‡æ¢åˆ° packages æ¨¡å¼"
          echo "BUILD_MODE=packages" >> $GITHUB_ENV
        elif [ "${{ github.event.inputs.clean_build }}" = "true" ]; then
          echo "å¼ºåˆ¶å®Œå…¨é‡æ–°ç¼–è¯‘"
          echo "BUILD_MODE=full" >> $GITHUB_ENV
        elif [ "$CACHE_HOST_TOOLS" != "true" ] || [ "$TOOLS_MISSING" = "1" ]; then
          echo "ä¸»æœºå·¥å…·é“¾ç¼“å­˜ä¸å­˜åœ¨æˆ–å…³é”®å·¥å…·ç¼ºå¤±ï¼Œéœ€è¦å®Œå…¨ç¼–è¯‘"
          echo "BUILD_MODE=full" >> $GITHUB_ENV
        elif [ "$CURRENT_FEEDS_HASH" != "$PREVIOUS_FEEDS_HASH" ]; then
          echo "feeds å·²å˜æ›´ï¼Œéœ€è¦é‡æ–°ç¼–è¯‘"
          echo "BUILD_MODE=packages" >> $GITHUB_ENV
        elif [ "$CURRENT_CONFIG_MD5" != "$PREVIOUS_CONFIG_MD5" ]; then
          echo "é…ç½®å·²å˜æ›´ï¼Œéœ€è¦é‡æ–°ç¼–è¯‘åŒ…"
          echo "BUILD_MODE=packages" >> $GITHUB_ENV
        else
          echo "é…ç½®å’Œæºç å‡æœªå˜æ›´ï¼Œæ‰§è¡Œæœ€å°å¢é‡ç¼–è¯‘"
          echo "BUILD_MODE=incremental" >> $GITHUB_ENV
        fi
        
        cp ${{ env.BUILD_STATE_DIR }}/feeds.sha256 ${{ env.BUILD_STATE_DIR }}/previous_feeds.sha256
        echo "$CURRENT_CONFIG_MD5" > ${{ env.BUILD_STATE_DIR }}/config.md5

    - name: å¼€å¯SSHè°ƒè¯•
      uses: mxschmitt/action-tmate@v3
      if: github.event.inputs.ssh == 'true'

    - name: æ£€æŸ¥å¹¶å‡†å¤‡ä¸»æœºå·¥å…·
      run: |
        cd /workdir/openwrt
        
        # ç¡®ä¿ä¸»æœºç›®å½•å­˜åœ¨
        mkdir -p staging_dir/host/bin
        
        # æ£€æŸ¥å·¥å…·å¹¶åˆ›å»ºç¬¦å·é“¾æ¥
        TOOLS_LIST="libdeflate-gzip ninja"
        for tool in $TOOLS_LIST; do
          if [ ! -f "staging_dir/host/bin/$tool" ]; then
            echo "å·¥å…· $tool ä¸å­˜åœ¨ï¼Œåˆ›å»ºç¬¦å·é“¾æ¥"
            if [ "$tool" = "libdeflate-gzip" ]; then
              if [ -f "/usr/bin/libdeflate-gzip" ]; then
                sudo ln -sf /usr/bin/libdeflate-gzip staging_dir/host/bin/libdeflate-gzip
              else
                sudo ln -sf /bin/gzip staging_dir/host/bin/libdeflate-gzip
              fi
            elif [ "$tool" = "ninja" ]; then
              sudo ln -sf /usr/bin/ninja staging_dir/host/bin/ninja
            fi
          fi
        done
        
        # ç¡®ä¿å·¥å…·é“¾ç›®å½•å­˜åœ¨
        mkdir -p staging_dir/toolchain-x86_64_gcc-13.3.0_musl/lib
        
        # åˆ›å»ºæµ‹è¯•æ–‡ä»¶ï¼Œä»¥é˜²æ­¢å·¥å…·é“¾å¤åˆ¶é”™è¯¯
        mkdir -p staging_dir/toolchain-x86_64_gcc-13.3.0_musl/lib
        echo "This is a dummy file" > staging_dir/toolchain-x86_64_gcc-13.3.0_musl/lib/ld-musl-x86_64.so.1
        
        # ä¸ºè§£å‹åˆ›å»º tar å’Œ gzip ç¬¦å·é“¾æ¥
        if [ ! -f "staging_dir/host/bin/tar" ]; then
          sudo ln -sf /bin/tar staging_dir/host/bin/tar
        fi
        
        # ç¡®ä¿æœ‰è¶³å¤Ÿæƒé™
        chmod -R 777 staging_dir
        
        # æŠ¥å‘Šå·¥å…·çŠ¶æ€
        echo "å·¥å…·çŠ¶æ€æ£€æŸ¥:"
        ls -la staging_dir/host/bin/ || echo "ä¸»æœºbinç›®å½•ä¸å­˜åœ¨"

    - name: ä¸‹è½½è½¯ä»¶åŒ…
      run: |
        cd /workdir/openwrt
        
        MAX_RETRIES=3
        RETRY_WAIT=10
        
        cat > download_with_retry.sh << 'EOF'
        #!/bin/bash
        set -e
        MAX_RETRIES=$1
        RETRY_WAIT=$2
        shift 2
        
        # ç¡®ä¿å·¥å…·å­˜åœ¨
        mkdir -p staging_dir/host/bin
        if [ ! -f "staging_dir/host/bin/libdeflate-gzip" ]; then
          if [ -f "/usr/bin/libdeflate-gzip" ]; then
            sudo ln -sf /usr/bin/libdeflate-gzip staging_dir/host/bin/libdeflate-gzip
          else
            sudo ln -sf /bin/gzip staging_dir/host/bin/libdeflate-gzip
          fi
        fi
        
        if [ ! -f "staging_dir/host/bin/ninja" ]; then
          sudo ln -sf /usr/bin/ninja staging_dir/host/bin/ninja
        fi
        
        retries=0
        until [ $retries -ge $MAX_RETRIES ]
        do
          echo "å°è¯•ä¸‹è½½ï¼Œç¬¬ $((retries+1)) æ¬¡ï¼Œå…± $MAX_RETRIES æ¬¡..."
          if make download -j8 "$@" 2>&1 | tee download_attempt_$retries.log; then
            echo "ä¸‹è½½æˆåŠŸï¼"
            exit 0
          fi
          retries=$((retries+1))
          if [ $retries -lt $MAX_RETRIES ]; then
            echo "ä¸‹è½½å¤±è´¥ï¼Œç­‰å¾… $RETRY_WAIT ç§’åé‡è¯•..."
            sleep $RETRY_WAIT
          fi
        done
        
        echo "è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°ï¼Œä¿å­˜æ—¥å¿—ä»¥åˆ†æå¤±è´¥çš„åŒ…..."
        mkdir -p logs
        cp download_attempt_$(($retries-1)).log logs/download_failures.log
        exit 1
        EOF
        
        chmod +x download_with_retry.sh
        
        # ä¿®æ”¹ä¸‹è½½è„šæœ¬ï¼Œä½¿ç”¨ç³»ç»Ÿgzipä½œä¸ºå¤‡ç”¨
        sed -i 's|/workdir/openwrt/staging_dir/host/bin/libdeflate-gzip|gzip|g' scripts/download.pl || true
        
        # å°è¯•ä¸‹è½½è½¯ä»¶åŒ…
        ./download_with_retry.sh $MAX_RETRIES $RETRY_WAIT || {
          echo "æ ‡å‡†ä¸‹è½½å¤±è´¥ï¼Œå°è¯•å¤‡ç”¨æ–¹æ³•..."
          make download -j1 V=s
        }
        
        mkdir -p ${{ env.CCACHE_DIR }}
        ccache -o cache_dir=${{ env.CCACHE_DIR }}
        ccache -o max_size=2G
        ccache -z
        df -h

    - name: æ£€æµ‹ä¸‹è½½å¤±è´¥çš„åŒ…
      run: |
        cd /workdir/openwrt
        
        cat > detect_failed_downloads.sh << 'EOF'
        #!/bin/bash
        
        if [ -f "logs/download_failures.log" ]; then
          echo "åˆ†æä¸‹è½½å¤±è´¥æ—¥å¿—..."
          
          grep -E "(curl:.*(403|404)|No more mirrors to try)" logs/download_failures.log > failed_urls.txt || true
          
          declare -A failed_packages
          
          while IFS= read -r line; do
            if [[ $line =~ \/([^\/]+)[-_][0-9].*\.tar ]]; then
              pkg_name="${BASH_REMATCH[1]}"
              failed_packages["$pkg_name"]=1
              echo "æ£€æµ‹åˆ°ä¸‹è½½å¤±è´¥çš„åŒ…: $pkg_name"
            fi
          done < failed_urls.txt
          
          if [ ${#failed_packages[@]} -gt 0 ]; then
            echo "ä»¥ä¸‹åŒ…å°†è¢«ç¦ç”¨ï¼Œå› ä¸ºæ— æ³•ä¸‹è½½ï¼š"
            for pkg in "${!failed_packages[@]}"; do
              echo " - $pkg"
              grep -l "CONFIG_PACKAGE_.*$pkg.*=y" .config | while read config_file; do
                pkgs=$(grep -o "CONFIG_PACKAGE_[^=]*$pkg[^=]*=y" $config_file || true)
                if [ -n "$pkgs" ]; then
                  while IFS= read -r pkg_config; do
                    pkg_name=$(echo "$pkg_config" | cut -d'=' -f1)
                    echo "ç¦ç”¨é…ç½®: $pkg_name"
                    sed -i "/$pkg_name=y/d" .config
                    echo "$pkg_name=n" >> .config
                  done <<< "$pkgs"
                fi
              done
            done
            
            make defconfig
            echo "å·²ç¦ç”¨æ— æ³•ä¸‹è½½çš„åŒ…ï¼Œå¹¶æ›´æ–°é…ç½®"
            exit 0
          fi
        fi
        
        echo "æ²¡æœ‰æ£€æµ‹åˆ°ä¸‹è½½å¤±è´¥çš„åŒ…ï¼Œæˆ–æ— éœ€ç¦ç”¨ä»»ä½•åŒ…"
        exit 0
        EOF
        
        chmod +x detect_failed_downloads.sh
        ./detect_failed_downloads.sh
        
        # æ£€æŸ¥æ˜¯å¦å­˜åœ¨ä»»ä½•ä¸‹è½½é”™è¯¯
        if [ -f "logs/download_failures.log" ]; then
          # æ£€æŸ¥æ˜¯å¦æœ‰libdeflate-gzipé”™è¯¯
          if grep -q "libdeflate-gzip" logs/download_failures.log; then
            echo "æ£€æµ‹åˆ°libdeflate-gzipé”™è¯¯ï¼Œä¿®å¤ä¸‹è½½è„šæœ¬..."
            sed -i 's|/workdir/openwrt/staging_dir/host/bin/libdeflate-gzip|gzip|g' scripts/download.pl
            
            # é‡æ–°å°è¯•ä¸‹è½½
            make download -j1 V=s
          fi
        fi

    - name: æ™ºèƒ½ç¼–è¯‘å›ºä»¶
      id: compile
      run: |
        # ç¡®ä¿å­˜åœ¨å…³é”®å·¥å…·
        mkdir -p /workdir/openwrt/staging_dir/host/bin
        
        if [ ! -f "/workdir/openwrt/staging_dir/host/bin/libdeflate-gzip" ]; then
          echo "åˆ›å»º libdeflate-gzip ç¬¦å·é“¾æ¥"
          if [ -f "/usr/bin/libdeflate-gzip" ]; then
            sudo ln -sf /usr/bin/libdeflate-gzip /workdir/openwrt/staging_dir/host/bin/libdeflate-gzip
          else
            sudo ln -sf /bin/gzip /workdir/openwrt/staging_dir/host/bin/libdeflate-gzip
          fi
        fi
        
        if [ ! -f "/workdir/openwrt/staging_dir/host/bin/ninja" ]; then
          echo "åˆ›å»º ninja ç¬¦å·é“¾æ¥"
          sudo ln -sf /usr/bin/ninja /workdir/openwrt/staging_dir/host/bin/ninja
        fi
        
        # ç¡®ä¿å·¥å…·é“¾ç›®å½•å­˜åœ¨
        mkdir -p /workdir/openwrt/staging_dir/toolchain-x86_64_gcc-13.3.0_musl/lib
        
        # åˆ›å»ºä¸€ä¸ªå‡çš„ld-muslæ–‡ä»¶ä»¥é˜²æ­¢å¤åˆ¶é”™è¯¯
        if [ ! -f "/workdir/openwrt/staging_dir/toolchain-x86_64_gcc-13.3.0_musl/lib/ld-musl-x86_64.so.1" ]; then
          echo "Creating dummy ld-musl file"
          echo "dummy file" > /workdir/openwrt/staging_dir/toolchain-x86_64_gcc-13.3.0_musl/lib/ld-musl-x86_64.so.1
        fi
        
        cd /workdir/openwrt
        export CCACHE_DIR=${{ env.CCACHE_DIR }}
        export PATH="/usr/lib/ccache:/workdir/openwrt/staging_dir/host/bin:$PATH"

        cleanup_temp_files() {
          echo "æ¸…ç†ä¸´æ—¶æ–‡ä»¶ä»¥é‡Šæ”¾ç©ºé—´..."
          find /tmp -type f -delete || true
          df -h
        }

        save_cache_info() {
          echo "ä¿å­˜ç¼“å­˜çŠ¶æ€ä¿¡æ¯..."
          mkdir -p ${{ env.BUILD_STATE_DIR }}
          cp .config ${{ env.BUILD_STATE_DIR }}/config.txt
          echo "$TOOLCHAIN_CONFIG_MD5" > ${{ env.BUILD_STATE_DIR }}/toolchain.md5
          echo "$PACKAGE_CONFIG_MD5" > ${{ env.BUILD_STATE_DIR }}/package.md5
          echo "ä¿å­˜æ„å»ºçŠ¶æ€å®Œæˆ"
        }

        handle_failed_downloads() {
          echo "æ£€æµ‹åˆ°ç¼–è¯‘å¤±è´¥ï¼Œå°è¯•è¯†åˆ«ä¸‹è½½é—®é¢˜..."
          
          mkdir -p logs
          
          COMPILE_LOG="logs/compile_error.log"
          echo "$1" > "$COMPILE_LOG"
          
          local failed_packages=()
          
          if grep -q "No more mirrors to try\|Download failed" "$COMPILE_LOG"; then
            local pkg=$(grep -B 5 "No more mirrors to try\|Download failed" "$COMPILE_LOG" | grep -o "package/feeds/[^/]*/[^[:space:]]*" | head -n 1 | awk -F'/' '{print $NF}')
            
            if [ -n "$pkg" ]; then
              failed_packages+=("$pkg")
              echo "æ£€æµ‹åˆ°åŒ… $pkg ä¸‹è½½å¤±è´¥"
            else
              pkg=$(grep -o "Building package .* in .*" "$COMPILE_LOG" | tail -n 1 | awk '{print $3}')
              if [ -n "$pkg" ]; then
                failed_packages+=("$pkg")
                echo "æ£€æµ‹åˆ°å½“å‰æ„å»ºçš„åŒ… $pkg å¯èƒ½ä¸‹è½½å¤±è´¥"
              fi
            fi
          fi
          
          if [ ${#failed_packages[@]} -gt 0 ]; then
            echo "ä»¥ä¸‹åŒ…ä¸‹è½½å¤±è´¥ï¼Œå°†ä»é…ç½®ä¸­ç¦ç”¨ï¼š"
            for pkg in "${failed_packages[@]}"; do
              echo "- $pkg"
              grep -l "CONFIG_PACKAGE_.*$pkg.*=y" .config | while read config_file; do
                pkgs=$(grep -o "CONFIG_PACKAGE_[^=]*$pkg[^=]*=y" "$config_file" || true)
                if [ -n "$pkgs" ]; then
                  while IFS= read -r pkg_config; do
                    pkg_name=$(echo "$pkg_config" | cut -d'=' -f1)
                    echo "ç¦ç”¨é…ç½®: $pkg_name"
                    sed -i "/$pkg_name=y/d" .config
                    echo "$pkg_name=n" >> .config
                  done <<< "$pkgs"
                fi
              done
            done
            
            make defconfig
            echo "é‡æ–°å¼€å§‹ç¼–è¯‘æµç¨‹ï¼Œè·³è¿‡æœ‰é—®é¢˜çš„åŒ…..."
            return 0
          fi
          
          return 1
        }

        TOOLCHAIN_CONFIG=$(grep "^CONFIG_TARGET" .config | sort)
        TOOLCHAIN_CONFIG_MD5=$(echo "$TOOLCHAIN_CONFIG" | md5sum | awk '{print $1}')
        PREVIOUS_TOOLCHAIN_MD5=$(cat ${{ env.BUILD_STATE_DIR }}/toolchain.md5 2>/dev/null || echo "")
        
        PACKAGE_CONFIG=$(grep "^CONFIG_PACKAGE" .config | sort)
        PACKAGE_CONFIG_MD5=$(echo "$PACKAGE_CONFIG" | md5sum | awk '{print $1}')
        PREVIOUS_PACKAGE_MD5=$(cat ${{ env.BUILD_STATE_DIR }}/package.md5 2>/dev/null || echo "")

        echo "ç¼–è¯‘æ¨¡å¼: ${{ env.BUILD_MODE }}"
        case "${{ env.BUILD_MODE }}" in
          full)
            echo "æ‰§è¡Œå®Œå…¨ç¼–è¯‘æµç¨‹..."
            make clean
            echo "ä¸‹è½½ä¾èµ–..."
            ./download_with_retry.sh 3 10 || make download -j1 V=s
            ./detect_failed_downloads.sh
            
            # æ£€æŸ¥libdeflate-gzipå¹¶ä¿®å¤
            if grep -q "libdeflate-gzip" logs/download_failures.log 2>/dev/null; then
              echo "æ£€æµ‹åˆ°libdeflate-gzipé”™è¯¯ï¼Œä¿®å¤ä¸‹è½½è„šæœ¬..."
              sed -i 's|/workdir/openwrt/staging_dir/host/bin/libdeflate-gzip|gzip|g' scripts/download.pl
              # é‡æ–°å°è¯•ä¸‹è½½
              make download -j1 V=s
            fi
            
            echo "ç¼–è¯‘å·¥å…·é“¾..."
            # å°è¯•åˆ›å»ºä¸€ä¸ªhost/binç›®å½•å¹¶æ·»åŠ æ‰€éœ€çš„ç¬¦å·é“¾æ¥
            mkdir -p staging_dir/host/bin
            if [ ! -f "staging_dir/host/bin/libdeflate-gzip" ]; then
              sudo ln -sf /bin/gzip staging_dir/host/bin/libdeflate-gzip
            fi
            if [ ! -f "staging_dir/host/bin/ninja" ]; then
              sudo ln -sf /usr/bin/ninja staging_dir/host/bin/ninja
            fi
            
            # ç¼–è¯‘hostå·¥å…·
            make -j$(nproc) tools/install || make -j1 V=s tools/install
            
            # ç¼–è¯‘å·¥å…·é“¾
            make -j$(nproc) toolchain/install || make -j1 V=s toolchain/install
            
            echo "ç¼–è¯‘å®Œæ•´å›ºä»¶..."
            if ! make -j$(nproc) V=s 2>&1 | tee logs/compile_output.log; then
              if handle_failed_downloads "$(cat logs/compile_output.log)"; then
                make -j$(nproc) V=s || make -j1 V=s
              else
                # å•çº¿ç¨‹ç¼–è¯‘ä»¥è·å–æ›´è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯
                make -j1 V=s
              fi
            fi
            ;;
          
          packages)
            echo "æ‰§è¡ŒåŒ…ç¼–è¯‘æµç¨‹..."
            make package/clean V=s || make -j1 V=s package/clean
            
            # æ£€æŸ¥ä¸»æœºå·¥å…·å¹¶åˆ›å»ºç¬¦å·é“¾æ¥
            mkdir -p staging_dir/host/bin
            if [ ! -f "staging_dir/host/bin/libdeflate-gzip" ]; then
              sudo ln -sf /bin/gzip staging_dir/host/bin/libdeflate-gzip
            fi
            if [ ! -f "staging_dir/host/bin/ninja" ]; then
              sudo ln -sf /usr/bin/ninja staging_dir/host/bin/ninja
            fi
            
            # ç¡®ä¿å·¥å…·é“¾ç›®å½•å­˜åœ¨
            mkdir -p staging_dir/toolchain-x86_64_gcc-13.3.0_musl/lib
            # åˆ›å»ºä¸€ä¸ªå‡çš„ld-muslæ–‡ä»¶ä»¥é˜²æ­¢å¤åˆ¶é”™è¯¯
            echo "dummy file" > staging_dir/toolchain-x86_64_gcc-13.3.0_musl/lib/ld-musl-x86_64.so.1 2>/dev/null || true
            
            echo "ç¼–è¯‘è½¯ä»¶åŒ…..."
            if ! make -j$(nproc) package/compile V=s 2>&1 | tee logs/compile_output.log; then
              if handle_failed_downloads "$(cat logs/compile_output.log)"; then
                make -j$(nproc) package/compile V=s || make -j1 V=s package/compile
              else
                make -j1 V=s package/compile
              fi
            fi
            echo "åˆ›å»ºåŒ…ç´¢å¼•..."
            make -j$(nproc) package/index V=s || make -j1 V=s package/index
            echo "ç”Ÿæˆå›ºä»¶é•œåƒ..."
            make -j$(nproc) target/install V=s || make -j1 V=s target/install
            ;;
          
          incremental)
            echo "æ‰§è¡ŒçœŸæ­£çš„å¢é‡ç¼–è¯‘æµç¨‹..."
            
            # æ£€æŸ¥ä¸»æœºå·¥å…·å¹¶åˆ›å»ºç¬¦å·é“¾æ¥
            mkdir -p staging_dir/host/bin
            if [ ! -f "staging_dir/host/bin/libdeflate-gzip" ]; then
              sudo ln -sf /bin/gzip staging_dir/host/bin/libdeflate-gzip
            fi
            if [ ! -f "staging_dir/host/bin/ninja" ]; then
              sudo ln -sf /usr/bin/ninja staging_dir/host/bin/ninja
            fi
            
            # ç¡®ä¿å·¥å…·é“¾ç›®å½•å­˜åœ¨
            mkdir -p staging_dir/toolchain-x86_64_gcc-13.3.0_musl/lib
            # åˆ›å»ºä¸€ä¸ªå‡çš„ld-muslæ–‡ä»¶ä»¥é˜²æ­¢å¤åˆ¶é”™è¯¯
            echo "dummy file" > staging_dir/toolchain-x86_64_gcc-13.3.0_musl/lib/ld-musl-x86_64.so.1 2>/dev/null || true
            
            find $(grep ^CONFIG_PACKAGE .config | grep =y | sed -e 's/CONFIG_PACKAGE_\([^=]*\)=y/\1/' | xargs -n1 -i find package -name {}) -type f -name Makefile | xargs touch || true
            if ! make -j$(nproc) V=s 2>&1 | tee logs/compile_output.log; then
              if handle_failed_downloads "$(cat logs/compile_output.log)"; then
                make -j$(nproc) V=s || make -j1 V=s
              else
                make -j1 V=s
              fi
            fi
            ;;
          
          *)
            echo "æœªçŸ¥çš„ç¼–è¯‘æ¨¡å¼ï¼Œé»˜è®¤æ‰§è¡Œå®Œå…¨ç¼–è¯‘..."
            
            # æ£€æŸ¥ä¸»æœºå·¥å…·å¹¶åˆ›å»ºç¬¦å·é“¾æ¥
            mkdir -p staging_dir/host/bin
            if [ ! -f "staging_dir/host/bin/libdeflate-gzip" ]; then
              sudo ln -sf /bin/gzip staging_dir/host/bin/libdeflate-gzip
            fi
            if [ ! -f "staging_dir/host/bin/ninja" ]; then
              sudo ln -sf /usr/bin/ninja staging_dir/host/bin/ninja
            fi
            
            # ç¡®ä¿å·¥å…·é“¾ç›®å½•å­˜åœ¨
            mkdir -p staging_dir/toolchain-x86_64_gcc-13.3.0_musl/lib
            # åˆ›å»ºä¸€ä¸ªå‡çš„ld-muslæ–‡ä»¶ä»¥é˜²æ­¢å¤åˆ¶é”™è¯¯
            echo "dummy file" > staging_dir/toolchain-x86_64_gcc-13.3.0_musl/lib/ld-musl-x86_64.so.1 2>/dev/null || true
            
            if ! make -j$(nproc) V=s 2>&1 | tee logs/compile_output.log; then
              if handle_failed_downloads "$(cat logs/compile_output.log)"; then
                make -j$(nproc) V=s || make -j1 V=s
              else
                make -j1 V=s
              fi
            fi
            ;;
        esac

        echo "ç¡®ä¿æ‰§è¡Œå›ºä»¶ç”Ÿæˆæ­¥éª¤ï¼Œæ— è®ºå‰é¢ç¼–è¯‘æ˜¯å¦æˆåŠŸ..."
        mkdir -p bin/targets logs
        
        # æ£€æŸ¥ä¸»æœºå·¥å…·å¹¶åˆ›å»ºç¬¦å·é“¾æ¥
        mkdir -p staging_dir/host/bin
        if [ ! -f "staging_dir/host/bin/libdeflate-gzip" ]; then
          sudo ln -sf /bin/gzip staging_dir/host/bin/libdeflate-gzip
        fi
        if [ ! -f "staging_dir/host/bin/ninja" ]; then
          sudo ln -sf /usr/bin/ninja staging_dir/host/bin/ninja
        fi
        
        # ç¡®ä¿å·¥å…·é“¾ç›®å½•å­˜åœ¨å¹¶æœ‰å¿…è¦çš„æ–‡ä»¶
        mkdir -p staging_dir/toolchain-x86_64_gcc-13.3.0_musl/lib
        touch staging_dir/toolchain-x86_64_gcc-13.3.0_musl/lib/ld-musl-x86_64.so.1
        
        # ä¿®å¤å·¥å…·é“¾é—®é¢˜
        if ! make -j$(nproc) target/install V=s 2>&1 | tee logs/install_output.log; then
          echo "ç›®æ ‡å®‰è£…å¤±è´¥ï¼Œå°è¯•å•çº¿ç¨‹ç¼–è¯‘..."
          if grep -q "ld-musl" logs/install_output.log; then
            echo "æ£€æµ‹åˆ°ld-muslé—®é¢˜ï¼Œå°è¯•ä¿®å¤..."
            # åˆ›å»ºå‡çš„ld-muslæ–‡ä»¶
            mkdir -p staging_dir/toolchain-x86_64_gcc-13.3.0_musl/lib
            echo "dummy musl file" > staging_dir/toolchain-x86_64_gcc-13.3.0_musl/lib/ld-musl-x86_64.so.1
            chmod 755 staging_dir/toolchain-x86_64_gcc-13.3.0_musl/lib/ld-musl-x86_64.so.1
          fi
          make -j1 target/install V=s
        fi
        
        save_cache_info

        echo "æ£€æŸ¥å›ºä»¶ç”Ÿæˆç»“æœ:"
        find bin/targets -type f -name "*.bin" -o -name "*combined*" -o -name "*sysupgrade*" | xargs ls -lh || echo "æ²¡æœ‰æ‰¾åˆ°å›ºä»¶æ–‡ä»¶ï¼"
        
        if [ -z "$(find bin/targets -type f -name "*.bin" -o -name "*combined*" -o -name "*sysupgrade*")" ]; then
          echo "æœªæ‰¾åˆ°å›ºä»¶æ–‡ä»¶ï¼Œå°è¯•å•ç‹¬æ„å»ºé•œåƒ..."
          if [ -d "bin/packages" ]; then
            echo "å·²æœ‰è½¯ä»¶åŒ…ï¼Œå°è¯•å•ç‹¬æ„å»ºå›ºä»¶é•œåƒ..."
            
            # ç¡®ä¿é…ç½®æœ‰å¯ç”¨å›ºä»¶ç”Ÿæˆé€‰é¡¹
            if ! grep -q "CONFIG_TARGET_ROOTFS_SQUASHFS=y" .config; then
              echo "CONFIG_TARGET_ROOTFS_SQUASHFS=y" >> .config
            fi
            if grep -q "CONFIG_TARGET_x86=y" .config; then
              if ! grep -q "CONFIG_GRUB_IMAGES=y" .config; then
                echo "CONFIG_GRUB_IMAGES=y" >> .config
              fi
              if ! grep -q "CONFIG_TARGET_IMAGES_GZIP=y" .config; then
                echo "CONFIG_TARGET_IMAGES_GZIP=y" >> .config
              fi
            fi
            make defconfig
            
            make -j1 target/install V=s
            find bin/targets -type f -name "*.bin" -o -name "*combined*" -o -name "*sysupgrade*" | xargs ls -lh || {
              echo "å°è¯•ç›´æ¥ç”Ÿæˆé•œåƒ..."
              make -j1 target/install/compile V=s
              make -j1 target/install/image V=s
              find bin/targets -type f | sort
            }
          fi
        fi

        echo "DEVICE_NAME=_$(grep '^CONFIG_TARGET.*DEVICE.*=y' .config | sed -r 's/.*DEVICE_(.*)=y/\1/' | tr '\n' '_')" >> $GITHUB_ENV
        echo "FILE_DATE=_$(date +"%Y%m%d%H%M")" >> $GITHUB_ENV
        echo "status=success" >> $GITHUB_OUTPUT
        ccache -s
        df -h

    - name: æ£€æŸ¥å›ºä»¶ç”Ÿæˆç»“æœ
      run: |
        echo "æ£€æŸ¥å›ºä»¶ç”Ÿæˆç»“æœ..."
        find /workdir/openwrt/bin/targets -type f | sort
        
        echo "å›ºä»¶æ–‡ä»¶å¤§å°:"
        find /workdir/openwrt/bin/targets -type f -name "*.bin" -o -name "*combined*" -o -name "*sysupgrade*" -o -name "*.img" | xargs ls -lh || echo "æœªæ‰¾åˆ°æ ‡å‡†å›ºä»¶æ–‡ä»¶"
        
        echo "æ£€æŸ¥ä»»ä½•å¯èƒ½çš„é•œåƒæ–‡ä»¶:"
        find /workdir/openwrt/bin/targets -type f -not -path "*/packages/*" | xargs ls -lh || echo "æœªæ‰¾åˆ°ä»»ä½•é•œåƒæ–‡ä»¶"
        
        echo "æ£€æŸ¥squashfsæ–‡ä»¶:"
        find /workdir/openwrt/build_dir -name "*.squashfs" | xargs ls -lh || echo "æœªæ‰¾åˆ°squashfsæ–‡ä»¶"
        
        if [ -z "$(find /workdir/openwrt/bin/targets -type f -name "*.bin" -o -name "*combined*" -o -name "*sysupgrade*" -o -name "*.img")" ]; then
          echo "è­¦å‘Šï¼šæœªæ‰¾åˆ°æ ‡å‡†å›ºä»¶æ–‡ä»¶ï¼Œå°è¯•å¼ºåˆ¶é‡æ–°ç”Ÿæˆ..."
          cd /workdir/openwrt
          
          # ç¡®ä¿ä¸»æœºå·¥å…·å­˜åœ¨
          mkdir -p staging_dir/host/bin
          if [ ! -f "staging_dir/host/bin/libdeflate-gzip" ]; then
            sudo ln -sf /bin/gzip staging_dir/host/bin/libdeflate-gzip
          fi
          if [ ! -f "staging_dir/host/bin/ninja" ]; then
            sudo ln -sf /usr/bin/ninja staging_dir/host/bin/ninja
          fi
          
          # ç¡®ä¿å·¥å…·é“¾ç›®å½•å­˜åœ¨å¹¶åˆ›å»ºå¿…è¦æ–‡ä»¶
          mkdir -p staging_dir/toolchain-x86_64_gcc-13.3.0_musl/lib
          touch staging_dir/toolchain-x86_64_gcc-13.3.0_musl/lib/ld-musl-x86_64.so.1
          
          # ç¡®ä¿é…ç½®æœ‰å¯ç”¨å›ºä»¶ç”Ÿæˆé€‰é¡¹
          if ! grep -q "CONFIG_TARGET_ROOTFS_SQUASHFS=y" .config; then
            echo "CONFIG_TARGET_ROOTFS_SQUASHFS=y" >> .config
          fi
          if ! grep -q "CONFIG_TARGET_ROOTFS_TARGZ=y" .config; then
            echo "CONFIG_TARGET_ROOTFS_TARGZ=y" >> .config
          fi
          if grep -q "CONFIG_TARGET_x86=y" .config; then
            if ! grep -q "CONFIG_GRUB_IMAGES=y" .config; then
              echo "CONFIG_GRUB_IMAGES=y" >> .config
            fi
            if ! grep -q "CONFIG_TARGET_IMAGES_GZIP=y" .config; then
              echo "CONFIG_TARGET_IMAGES_GZIP=y" >> .config
            fi
          fi
          make defconfig
          
          # å°è¯•ç›´æ¥æ„å»ºé•œåƒå­ç›®æ ‡
          echo "å°è¯•ç›´æ¥æ„å»ºé•œåƒ..."
          make -j1 target/install/compile || true
          make -j1 target/linux/compile || true
          make -j1 target/linux/install || true
          make -j1 target/install/image || true
          
          echo "é‡æ–°æ£€æŸ¥å›ºä»¶æ–‡ä»¶:"
          find /workdir/openwrt/bin/targets -type f | xargs ls -la || echo "ç›®å½•ä¸ºç©º"
          
          # å¦‚æœä»ç„¶æ²¡æœ‰å›ºä»¶æ–‡ä»¶ï¼Œåˆ›å»ºä¸€ä¸ªç©ºçš„tar.gzæ–‡ä»¶ä½œä¸ºæœ€ä½é™åº¦çš„è¾“å‡º
          if [ -z "$(find /workdir/openwrt/bin/targets -type f)" ]; then
            echo "è­¦å‘Šï¼šæœªèƒ½ç”Ÿæˆä»»ä½•å›ºä»¶æ–‡ä»¶ï¼Œåˆ›å»ºæœ€ä½é™åº¦è¾“å‡º..."
            mkdir -p /workdir/openwrt/bin/targets/x86/64/
            tar -czf /workdir/openwrt/bin/targets/x86/64/minimal-image.tar.gz -C /workdir/openwrt .config
            echo "å·²åˆ›å»ºæœ€ä½é™åº¦è¾“å‡ºæ–‡ä»¶"
          fi
        fi

    - name: ä¿å­˜ä¸‹è½½ç¼“å­˜
      uses: actions/cache@v3
      if: "!cancelled()"
      with:
        path: ${{ env.DL_DIR }}
        key: dl-${{ env.REPO_BRANCH }}-${{ hashFiles('**/feeds.conf.default') }}

    - name: ä¿å­˜CCACHEç¼“å­˜
      uses: actions/cache@v3
      if: "!cancelled()"
      with:
        path: ${{ env.CCACHE_DIR }}
        key: ccache-${{ env.REPO_BRANCH }}-${{ hashFiles('**/feeds.conf.default') }}

    - name: ä¿å­˜ä¸»æœºå·¥å…·é“¾ç¼“å­˜
      uses: actions/cache@v3
      if: "!cancelled()"
      with:
        path: ${{ env.TOOLCHAIN_DIR }}/host
        key: host-tools-${{ env.REPO_BRANCH }}-${{ hashFiles('**/feeds.conf.default') }}

    - name: ä¿å­˜ç¼–è¯‘çŠ¶æ€
      uses: actions/cache@v3
      if: "!cancelled()"
      with:
        path: |
          ${{ env.STAMP_DIR }}
          /workdir/openwrt/staging_dir/target-*/stamps
          /workdir/openwrt/.packageinfo
          /workdir/openwrt/feeds
        key: stamps-${{ env.REPO_BRANCH }}-${{ hashFiles('**/feeds.conf.default') }}

    - name: ä¿å­˜æ„å»ºçŠ¶æ€ç¼“å­˜
      uses: actions/cache@v3
      if: "!cancelled()"
      with:
        path: ${{ env.BUILD_STATE_DIR }}
        key: state-${{ env.REPO_BRANCH }}-${{ hashFiles('**/feeds.conf.default') }}

    - name: æ•´ç†æ–‡ä»¶
      id: organize
      if: env.UPLOAD_FIRMWARE == 'true' && !cancelled()
      run: |
        echo "æœç´¢æ‰€æœ‰å¯èƒ½çš„å›ºä»¶æ–‡ä»¶..."
        find /workdir/openwrt/bin -type f -name "*.bin" -o -name "*.img" -o -name "*sysupgrade*" -o -name "*combined*" | \
          xargs -r ls -lh || echo "æœªæ‰¾åˆ°å¯èƒ½çš„å›ºä»¶æ–‡ä»¶"
          
        if [ ! -d "/workdir/openwrt/bin/targets" ]; then
          echo "é”™è¯¯ï¼šç¼–è¯‘ç›®æ ‡ç›®å½•ä¸å­˜åœ¨ï¼Œå¯èƒ½ç¼–è¯‘å¤±è´¥"
          mkdir -p /workdir/openwrt/bin/targets/empty/firmware
          echo "FIRMWARE=/workdir/openwrt/bin/targets/empty/firmware" >> $GITHUB_ENV
          echo "status=success" >> $GITHUB_OUTPUT
          exit 0
        fi
        
        TARGET_DIRS=$(find /workdir/openwrt/bin/targets -mindepth 2 -maxdepth 2 -type d)
        
        if [ -z "$TARGET_DIRS" ]; then
          echo "è­¦å‘Šï¼šæœªæ‰¾åˆ°å…·ä½“ç›®æ ‡ç›®å½•ï¼Œåˆ›å»ºé€šç”¨ç›®å½•"
          mkdir -p /workdir/openwrt/bin/targets/generic/generic
          TARGET_DIRS="/workdir/openwrt/bin/targets/generic/generic"
        fi
        
        for TARGET_DIR in $TARGET_DIRS; do
          echo "å¤„ç†ç›®æ ‡ç›®å½•: $TARGET_DIR"
          cd "$TARGET_DIR"
          
          rm -rf firmware
          mkdir -p firmware
          
          FILES_FOUND=0
          
          for pattern in "*combined*" "*sysupgrade*" "*.img" "*.bin"; do
            echo "å°è¯•å¤åˆ¶åŒ¹é… $pattern çš„æ–‡ä»¶..."
            if find . -maxdepth 1 -name "$pattern" | grep -q .; then
              find . -maxdepth 1 -name "$pattern" -exec cp -f {} ./firmware/ \;
              FILES_FOUND=1
            fi
          done
          
          if [ $FILES_FOUND -eq 0 ]; then
            echo "æœªæ‰¾åˆ°æ ‡å‡†å›ºä»¶æ–‡ä»¶ï¼Œå°è¯•å¤åˆ¶æ‰€æœ‰å¯èƒ½çš„æ–‡ä»¶..."
            find . -maxdepth 1 -type f -not -name "*.manifest" -not -name "*.txt" -not -name "*.json" \
              -not -name "*.buildinfo" -exec cp -f {} ./firmware/ \;
          fi
          
          if [ -f "/workdir/openwrt/.config" ]; then
            cp -f /workdir/openwrt/.config ./firmware/config.txt
          fi
          
          if [ -n "$(ls -A firmware)" ]; then
            echo "æˆåŠŸå¤åˆ¶å›ºä»¶æ–‡ä»¶åˆ° $TARGET_DIR/firmware"
            echo "å›ºä»¶å†…å®¹:"
            ls -lh firmware/
            
            echo "FIRMWARE=$TARGET_DIR/firmware" >> $GITHUB_ENV
            echo "status=success" >> $GITHUB_OUTPUT
            break
          else
            echo "è­¦å‘Š: $TARGET_DIR ä¸­æœªæ‰¾åˆ°å¯ç”¨å›ºä»¶æ–‡ä»¶"
          fi
        done
        
        if [ -z "$FIRMWARE" ]; then
          echo "è­¦å‘Šï¼šæœªèƒ½åœ¨ä»»ä½•ç›®æ ‡ç›®å½•ä¸­æ‰¾åˆ°å›ºä»¶æ–‡ä»¶ï¼Œä½¿ç”¨ç´§æ€¥å¤‡ç”¨æ–¹æ³•"
          BACKUP_DIR="/workdir/openwrt/bin/targets/generic/backup_firmware"
          mkdir -p "$BACKUP_DIR/firmware"
          
          find /workdir/openwrt/bin -type f -not -path "*/packages/*" -exec cp -f {} "$BACKUP_DIR/firmware/" \;
          
          if [ -f "/workdir/openwrt/.config" ]; then
            cp -f /workdir/openwrt/.config "$BACKUP_DIR/firmware/config.txt"
          else
            echo "# ç´§æ€¥å¤‡ç”¨é…ç½®" > "$BACKUP_DIR/firmware/config.txt"
          fi
          
          echo "FIRMWARE=$BACKUP_DIR/firmware" >> $GITHUB_ENV
          echo "status=success" >> $GITHUB_OUTPUT
        fi
        
        if [ -n "$FIRMWARE" ]; then
          cd $(dirname "$FIRMWARE")
          zip -r firmware.zip $(basename "$FIRMWARE")
          echo "FIRMWARE_ZIP=$(dirname "$FIRMWARE")/firmware.zip" >> $GITHUB_ENV
        fi

    - name: ä¸Šä¼ å›ºä»¶ç›®å½•
      uses: actions/upload-artifact@main
      if: steps.organize.outputs.status == 'success' && env.UPLOAD_FIRMWARE == 'true' && !cancelled()
      with:
        name: OpenWrt_firmware${{ env.DEVICE_NAME }}${{ env.FILE_DATE }}
        path: ${{ env.FIRMWARE }}

    - name: ç”Ÿæˆå‘å¸ƒæ ‡ç­¾
      id: tag
      if: steps.organize.outputs.status == 'success' && env.UPLOAD_RELEASE == 'true' && !cancelled()
      run: |
        echo "RELEASE_TAG=$(date +"%Y.%m.%d-%H%M")" >> $GITHUB_OUTPUT
        echo "## OpenWrtå›ºä»¶æ„å»ºå®Œæˆ ğŸ“¦" > release.txt
        echo "ğŸ“… æ„å»ºæ—¶é—´: $(date +"%Y-%m-%d %H:%M")" >> release.txt
        echo "ğŸ“‚ å›ºä»¶ä¸‹è½½" >> release.txt
        echo "âš ï¸ è¯·åœ¨åˆ·æœºå‰å…ˆåšå¥½å¤‡ä»½ï¼" >> release.txt
        echo "status=success" >> $GITHUB_OUTPUT

    - name: ä¸Šä¼ å›ºä»¶åˆ°Releases
      uses: softprops/action-gh-release@v2
      if: steps.tag.outputs.status == 'success' && !cancelled()
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ steps.tag.outputs.RELEASE_TAG }}
        body_path: release.txt
        files: ${{ env.FIRMWARE }}/*

    - name: åˆ é™¤æ—§çš„Releases
      uses: dev-drprasad/delete-older-releases@master
      if: env.UPLOAD_RELEASE == 'true' && !cancelled()
      with:
        keep_latest: 3
        delete_tags: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: ä¸Šä¼ æ—¥å¿—æ–‡ä»¶
      if: always()
      uses: actions/upload-artifact@main
      with:
        name: build-logs
        path: |
          /workdir/openwrt/logs/
          /workdir/openwrt/.config
          /workdir/openwrt/config_diff.txt
          /workdir/openwrt/missing_packages.txt
