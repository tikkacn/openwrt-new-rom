name: å…¨æ–°ç¼–è¯‘ç¬¬å…«ç‰ˆ

on:
  workflow_dispatch:
    inputs:
      ssh:
        description: 'SSHè°ƒè¯•'
        required: false
        default: 'false'
      clean_build:
        description: 'å®Œå…¨é‡æ–°ç¼–è¯‘'
        required: false
        default: 'false'
      config_file:
        description: 'é…ç½®æ–‡ä»¶'
        required: false
        default: 'å¢é‡ç¼“å­˜ä¼˜åŒ–.config'

env:
  REPO_URL: https://github.com/coolsnowwolf/lede
  REPO_BRANCH: master
  FEEDS_CONF_URL: https://github.com/tikkacn/openwrt-new-rom/raw/main/feeds.conf.default
  CONFIG_FILE: ${{ github.event.inputs.config_file || 'å¢é‡ç¼“å­˜ä¼˜åŒ–.config' }}
  DIY_P1_SH: diy-part1.sh
  DIY_P2_SH: diy-part2.sh
  UPLOAD_FIRMWARE: true
  UPLOAD_RELEASE: true
  TZ: Asia/Shanghai
  CCACHE_DIR: /workdir/ccache
  # ç¼“å­˜ç›®å½•ç¯å¢ƒå˜é‡
  TOOLCHAIN_DIR: /workdir/openwrt/staging_dir
  PACKAGES_DIR: /workdir/openwrt/bin/targets
  BUILD_STATE_DIR: /workdir/build_state

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@main

    - name: ä¼˜åŒ–ç£ç›˜ç©ºé—´
      uses: easimon/maximize-build-space@master
      with:
        root-reserve-mb: 20480
        swap-size-mb: 5120
        remove-dotnet: 'true'
        remove-android: 'true'
        remove-haskell: 'true'
        remove-codeql: 'true'
        remove-docker-images: 'true'
        build-mount-path: '/workdir'

    - name: é¢å¤–æ¸…ç†ç£ç›˜ç©ºé—´å¹¶æ£€æŸ¥
      run: |
        echo "æ¸…ç†é¢å¤–ç£ç›˜ç©ºé—´..."
        sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /usr/local/share/boost
        sudo rm -rf /usr/share/swift /usr/local/julia* /opt/hostedtoolcache/CodeQL
        docker image prune -a -f || true
        docker system prune -af || true
        sudo apt-get clean
        sudo apt-get autoremove -y
        ROOT_AVAIL=$(df -m /dev/root | tail -1 | awk '{print $4}')
        echo "æ ¹åˆ†åŒºå¯ç”¨ç©ºé—´: ${ROOT_AVAIL}MB"
        if [ "$ROOT_AVAIL" -lt 20480 ]; then
          echo "é”™è¯¯ï¼š/dev/root å¯ç”¨ç©ºé—´ä¸è¶³ 20GB"
          exit 1
        fi
        df -h

    - name: åˆå§‹åŒ–ç¯å¢ƒ
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        sudo -E apt-get -qq update
        sudo -E apt-get -qq install ack antlr3 asciidoc autoconf automake autopoint binutils bison build-essential \
        bzip2 ccache cmake cpio curl device-tree-compiler fastjar flex gawk gettext gcc-multilib g++-multilib \
        git gperf haveged help2man intltool libc6-dev-i386 libelf-dev libglib2.0-dev libgmp3-dev libltdl-dev \
        libmpc-dev libmpfr-dev libncurses5-dev libncursesw5-dev libreadline-dev libssl-dev libtool lrzsz \
        mkisofs msmtp nano ninja-build p7zip p7zip-full patch pkgconf python2.7 python3 python3-pyelftools \
        libpython3-dev qemu-utils rsync scons squashfs-tools subversion swig texinfo uglifyjs upx-ucl unzip \
        vim wget xmlto xxd zlib1g-dev python3-setuptools jq bc lm-sensors pciutils
        sudo -E apt-get -qq clean
        sudo timedatectl set-timezone "$TZ"
        mkdir -p ${{ env.BUILD_STATE_DIR }} ${{ env.CCACHE_DIR }}
        chmod -R 777 /workdir
        echo '#!/bin/bash' > $GITHUB_WORKSPACE/diy-part1.sh
        echo '# Feeds å·²é€šè¿‡ FEEDS_CONF_URL é…ç½®' >> $GITHUB_WORKSPACE/diy-part1.sh
        chmod +x $GITHUB_WORKSPACE/diy-part1.sh
        echo '#!/bin/bash' > $GITHUB_WORKSPACE/diy-part2.sh
        echo 'sed -i "s/OpenWrt /OpenWrt_AutoBuild /" package/lean/default-settings/files/zzz-default-settings' >> $GITHUB_WORKSPACE/diy-part2.sh
        chmod +x $GITHUB_WORKSPACE/diy-part2.sh
        if [ ! -f "$GITHUB_WORKSPACE/$CONFIG_FILE" ]; then
          echo "è­¦å‘Šï¼šé…ç½®æ–‡ä»¶ $CONFIG_FILE ä¸å­˜åœ¨ï¼Œåˆ›å»ºé»˜è®¤é…ç½®æ–‡ä»¶"
          echo "# åˆ›å»ºé»˜è®¤çš„æœ€å°åŒ–é…ç½®æ–‡ä»¶" > $GITHUB_WORKSPACE/$CONFIG_FILE
          echo "CONFIG_TARGET_x86=y" >> $GITHUB_WORKSPACE/$CONFIG_FILE
          echo "CONFIG_TARGET_x86_64=y" >> $GITHUB_WORKSPACE/$CONFIG_FILE
          echo "CONFIG_TARGET_x86_64_DEVICE_generic=y" >> $GITHUB_WORKSPACE/$CONFIG_FILE
          echo "CONFIG_PACKAGE_luci=y" >> $GITHUB_WORKSPACE/$CONFIG_FILE
        fi
        df -h

    - name: å…‹éš†æºä»£ç å¹¶é…ç½® Feeds
      working-directory: /workdir
      run: |
        git clone --depth 1 $REPO_URL -b $REPO_BRANCH openwrt
        ln -sf /workdir/openwrt $GITHUB_WORKSPACE/openwrt
        cd openwrt
        find . -type f -name "*.sh" -exec chmod +x {} \;
        curl -L -o feeds.conf.default "$FEEDS_CONF_URL" || echo "è­¦å‘Šï¼šæ— æ³•ä¸‹è½½ feeds.conf.defaultï¼Œä½¿ç”¨ä»“åº“é»˜è®¤é…ç½®"
        cat feeds.conf.default
        rm -rf .git
        # åˆ›å»ºå¿…è¦çš„ç›®å½•ç»“æ„ä»¥ç¡®ä¿ç¼“å­˜æ­£å¸¸å·¥ä½œ
        mkdir -p ${{ env.PACKAGES_DIR }} ${{ env.TOOLCHAIN_DIR }} ${{ env.BUILD_STATE_DIR }}

    # ä½¿ç”¨å›ºå®šç¼“å­˜é”®æœ€å¤§åŒ–å‘½ä¸­ç‡
    # æ¢å¤ç¼–è¯‘åŒ…ç¼“å­˜
    - name: æ¢å¤ç¼–è¯‘åŒ…ç¼“å­˜
      uses: actions/cache@v3
      id: cache-packages
      if: inputs.clean_build != 'true'
      with:
        path: ${{ env.PACKAGES_DIR }}
        key: packages-${{ env.REPO_BRANCH }}-fixed-cache

    # æ¢å¤å·¥å…·é“¾ç¼“å­˜
    - name: æ¢å¤å·¥å…·é“¾ç¼“å­˜
      uses: actions/cache@v3
      id: cache-toolchain
      if: inputs.clean_build != 'true'
      with:
        path: ${{ env.TOOLCHAIN_DIR }}
        key: toolchain-${{ env.REPO_BRANCH }}-fixed-cache

    # æ¢å¤CCACHEç¼“å­˜
    - name: æ¢å¤CCACHEç¼“å­˜
      uses: actions/cache@v3
      id: cache-ccache
      with:
        path: ${{ env.CCACHE_DIR }}
        key: ccache-${{ env.REPO_BRANCH }}-fixed-cache

    # æ¢å¤æ„å»ºçŠ¶æ€ç¼“å­˜
    - name: æ¢å¤æ„å»ºçŠ¶æ€ç¼“å­˜
      uses: actions/cache@v3
      id: cache-state
      if: inputs.clean_build != 'true'
      with:
        path: ${{ env.BUILD_STATE_DIR }}
        key: state-${{ env.REPO_BRANCH }}-fixed-cache

    - name: æ£€æŸ¥ç¼“å­˜æ¢å¤çŠ¶æ€
      run: |
        echo "CONFIG_FILE: ${{ env.CONFIG_FILE }}"
        echo "ç¼–è¯‘åŒ…ç¼“å­˜æ¢å¤çŠ¶æ€: ${{ steps.cache-packages.outputs.cache-hit == 'true' && 'æˆåŠŸ' || 'æœªæ‰¾åˆ°ç¼“å­˜' }}"
        echo "å·¥å…·é“¾ç¼“å­˜æ¢å¤çŠ¶æ€: ${{ steps.cache-toolchain.outputs.cache-hit == 'true' && 'æˆåŠŸ' || 'æœªæ‰¾åˆ°ç¼“å­˜' }}"
        echo "CCACHEç¼“å­˜æ¢å¤çŠ¶æ€: ${{ steps.cache-ccache.outputs.cache-hit == 'true' && 'æˆåŠŸ' || 'æœªæ‰¾åˆ°ç¼“å­˜' }}"
        echo "æ„å»ºçŠ¶æ€ç¼“å­˜æ¢å¤çŠ¶æ€: ${{ steps.cache-state.outputs.cache-hit == 'true' && 'æˆåŠŸ' || 'æœªæ‰¾åˆ°ç¼“å­˜' }}"
        ls -la ${{ env.BUILD_STATE_DIR }}/ || echo "æ„å»ºçŠ¶æ€ç›®å½•ä¸ºç©º"
        if [ -f "${{ env.BUILD_STATE_DIR }}/config.md5" ]; then
          echo "ä¹‹å‰MD5: $(cat ${{ env.BUILD_STATE_DIR }}/config.md5)"
        fi
        mkdir -p ${{ env.PACKAGES_DIR }} ${{ env.TOOLCHAIN_DIR }}
        if [ -d "${{ env.TOOLCHAIN_DIR }}/host/bin" ] && [ -f "${{ env.TOOLCHAIN_DIR }}/host/bin/libdeflate-gzip" ]; then
          echo "å·¥å…·é“¾åŒ…å« libdeflate-gzipï¼Œç¼“å­˜æ­£å¸¸"
        else
          echo "è­¦å‘Šï¼šå·¥å…·é“¾ç¼“å­˜ç¼ºå°‘ libdeflate-gzip"
        fi
        df -h

    - name: é…ç½®ç¼–è¯‘ç¯å¢ƒ
      run: |
        cd /workdir/openwrt
        if [ -f ".config" ]; then
          cp .config .config.original
        fi
        $GITHUB_WORKSPACE/$DIY_P1_SH
        echo "æ›´æ–°å¹¶å®‰è£… Feeds..."
        ./scripts/feeds update -a
        ./scripts/feeds install -a
        [ -e $GITHUB_WORKSPACE/files ] && cp -r $GITHUB_WORKSPACE/files ./files
        cp $GITHUB_WORKSPACE/$CONFIG_FILE ./.config
        cp .config .config.input
        $GITHUB_WORKSPACE/$DIY_P2_SH
        echo "CONFIG_AUTOREMOVE=n" >> .config
        echo "CONFIG_AUTOREBUILD=n" >> .config
        make defconfig
        grep "^CONFIG_PACKAGE_.*=y" .config.input > packages_input.txt || true
        grep "^CONFIG_PACKAGE_.*=y" .config > packages_defconfig.txt || true
        comm -23 packages_input.txt packages_defconfig.txt > missing_packages.txt
        if [ -s missing_packages.txt ]; then
          echo "è­¦å‘Šï¼šä»¥ä¸‹åŒ…åœ¨ defconfig åç¼ºå¤±ï¼Œå°†å°è¯•æ¢å¤ï¼š"
          cat missing_packages.txt
          cat missing_packages.txt >> .config
          while read -r line; do
            pkg=$(echo "$line" | sed 's/CONFIG_PACKAGE_\(.*\)=y/\1/')
            echo "å®‰è£…åŒ…: $pkg"
            ./scripts/feeds install "$pkg" || echo "è­¦å‘Šï¼šæ— æ³•å®‰è£… $pkgï¼Œå¯èƒ½ä¸åœ¨ feeds ä¸­"
          done < missing_packages.txt
          make defconfig
        else
          echo "æ‰€æœ‰é…ç½®é¡¹å‡ä¿ç•™ï¼Œæ— ç¼ºå¤±"
        fi
        diff .config.input .config > config_diff.txt || echo "é…ç½®æ— å·®å¼‚"
        cat config_diff.txt
        df -h

    - name: æ£€æŸ¥æºç å˜åŒ–
      id: check-source
      run: |
        cd /workdir/openwrt
        mkdir -p ${{ env.BUILD_STATE_DIR }}
        
        # 1. æ£€æŸ¥feedsæºç å˜åŒ–
        find feeds -type f -name "Makefile" -exec sha256sum {} \; | sort | sha256sum > ${{ env.BUILD_STATE_DIR }}/feeds.sha256
        CURRENT_FEEDS_HASH=$(cat ${{ env.BUILD_STATE_DIR }}/feeds.sha256 | awk '{print $1}')
        PREVIOUS_FEEDS_HASH=$(cat ${{ env.BUILD_STATE_DIR }}/previous_feeds.sha256 2>/dev/null | awk '{print $1}' || echo "")
        
        # 2. æ£€æŸ¥æ ¸å¿ƒæºç å˜åŒ–ï¼ˆåŒ…æ‹¬packageç›®å½•å’Œä¸»è¦ç³»ç»Ÿæ–‡ä»¶ï¼‰
        find package target tools -type f -name "Makefile" -o -name "*.mk" | sort | xargs sha256sum 2>/dev/null | sha256sum > ${{ env.BUILD_STATE_DIR }}/core.sha256
        CURRENT_CORE_HASH=$(cat ${{ env.BUILD_STATE_DIR }}/core.sha256 | awk '{print $1}')
        PREVIOUS_CORE_HASH=$(cat ${{ env.BUILD_STATE_DIR }}/previous_core.sha256 2>/dev/null | awk '{print $1}' || echo "")
        
        # è®°å½•å„ä¸ªæºç çš„å˜åŒ–çŠ¶æ€
        echo "å½“å‰ feeds å“ˆå¸Œ: $CURRENT_FEEDS_HASH"
        echo "ä¹‹å‰ feeds å“ˆå¸Œ: $PREVIOUS_FEEDS_HASH"
        echo "å½“å‰æ ¸å¿ƒæºç å“ˆå¸Œ: $CURRENT_CORE_HASH"
        echo "ä¹‹å‰æ ¸å¿ƒæºç å“ˆå¸Œ: $PREVIOUS_CORE_HASH"
        
        # è®¾ç½®æºç å˜åŒ–æ ‡å¿—
        if [ "$CURRENT_FEEDS_HASH" != "$PREVIOUS_FEEDS_HASH" ]; then
          echo "feeds_changed=true" >> $GITHUB_ENV
          echo "Feeds æºç å·²å˜æ›´"
          # ä¿å­˜å“ªäº›feedsåŒ…å‘ç”Ÿäº†å˜åŒ–
          mkdir -p ${{ env.BUILD_STATE_DIR }}/diff
          if [ -f "${{ env.BUILD_STATE_DIR }}/previous_feeds.sha256" ]; then
            find feeds -type f -name "Makefile" -exec sha256sum {} \; | sort > ${{ env.BUILD_STATE_DIR }}/diff/current_feeds_files.sha256
            cat ${{ env.BUILD_STATE_DIR }}/previous_feeds_detailed.sha256 2>/dev/null > ${{ env.BUILD_STATE_DIR }}/diff/previous_feeds_files.sha256 || touch ${{ env.BUILD_STATE_DIR }}/diff/previous_feeds_files.sha256
            diff -u ${{ env.BUILD_STATE_DIR }}/diff/previous_feeds_files.sha256 ${{ env.BUILD_STATE_DIR }}/diff/current_feeds_files.sha256 | grep "^+" | grep -v "++" | cut -d' ' -f3- > ${{ env.BUILD_STATE_DIR }}/diff/changed_feeds_files.txt || true
          fi
        else
          echo "feeds_changed=false" >> $GITHUB_ENV
          echo "Feeds æºç æœªå˜æ›´"
        fi
        
        if [ "$CURRENT_CORE_HASH" != "$PREVIOUS_CORE_HASH" ]; then
          echo "core_changed=true" >> $GITHUB_ENV
          echo "æ ¸å¿ƒæºç å·²å˜æ›´"
          # ä¿å­˜å“ªäº›æ ¸å¿ƒåŒ…å‘ç”Ÿäº†å˜åŒ–
          mkdir -p ${{ env.BUILD_STATE_DIR }}/diff
          if [ -f "${{ env.BUILD_STATE_DIR }}/previous_core.sha256" ]; then
            find package target tools -type f -name "Makefile" -o -name "*.mk" | sort | xargs sha256sum 2>/dev/null > ${{ env.BUILD_STATE_DIR }}/diff/current_core_files.sha256
            cat ${{ env.BUILD_STATE_DIR }}/previous_core_detailed.sha256 2>/dev/null > ${{ env.BUILD_STATE_DIR }}/diff/previous_core_files.sha256 || touch ${{ env.BUILD_STATE_DIR }}/diff/previous_core_files.sha256
            diff -u ${{ env.BUILD_STATE_DIR }}/diff/previous_core_files.sha256 ${{ env.BUILD_STATE_DIR }}/diff/current_core_files.sha256 | grep "^+" | grep -v "++" | cut -d' ' -f3- > ${{ env.BUILD_STATE_DIR }}/diff/changed_core_files.txt || true
          fi
        else
          echo "core_changed=false" >> $GITHUB_ENV
          echo "æ ¸å¿ƒæºç æœªå˜æ›´"
        fi
        
        # ä¿å­˜å½“å‰å“ˆå¸Œå€¼ç”¨äºä¸‹æ¬¡æ¯”è¾ƒ
        cp ${{ env.BUILD_STATE_DIR }}/feeds.sha256 ${{ env.BUILD_STATE_DIR }}/previous_feeds.sha256
        find feeds -type f -name "Makefile" -exec sha256sum {} \; | sort > ${{ env.BUILD_STATE_DIR }}/previous_feeds_detailed.sha256
        
        cp ${{ env.BUILD_STATE_DIR }}/core.sha256 ${{ env.BUILD_STATE_DIR }}/previous_core.sha256
        find package target tools -type f -name "Makefile" -o -name "*.mk" | sort | xargs sha256sum 2>/dev/null > ${{ env.BUILD_STATE_DIR }}/previous_core_detailed.sha256

    - name: æ¢å¤å·²ç¼–è¯‘è½¯ä»¶åŒ…
      if: steps.cache-packages.outputs.cache-hit == 'true'
      run: |
        cd /workdir/openwrt
        mkdir -p bin/targets
        if [ "${{ env.feeds_changed }}" = "true" ] && [ "${{ env.core_changed }}" = "true" ]; then
          echo "Feedså’Œæ ¸å¿ƒæºç å‡æœ‰æ›´æ–°ï¼Œä½†ä»ä¼šå°è¯•åˆ©ç”¨å·²æœ‰ç¼“å­˜"
        elif [ "${{ env.feeds_changed }}" = "true" ]; then
          echo "Feedsæºç æœ‰æ›´æ–°ï¼Œä½†ä»ä¼šå°è¯•åˆ©ç”¨å·²æœ‰ç¼“å­˜"
        elif [ "${{ env.core_changed }}" = "true" ]; then
          echo "æ ¸å¿ƒæºç æœ‰æ›´æ–°ï¼Œä½†ä»ä¼šå°è¯•åˆ©ç”¨å·²æœ‰ç¼“å­˜"
        else
          echo "æºç æœªå˜æ›´ï¼Œå°†æœ€å¤§åŒ–åˆ©ç”¨ç¼“å­˜"
        fi
        find ${{ env.PACKAGES_DIR }} -type f | wc -l

    - name: å¼€å¯SSHè°ƒè¯•
      uses: mxschmitt/action-tmate@v3
      if: github.event.inputs.ssh == 'true'

    - name: ä¸‹è½½è½¯ä»¶åŒ…
      run: |
        cd /workdir/openwrt
        make download -j8 || make download -j1 V=s
        mkdir -p ${{ env.CCACHE_DIR }}
        ccache -o cache_dir=${{ env.CCACHE_DIR }}
        ccache -o max_size=8G  # å¢åŠ CCACHEå¤§å°
        ccache -z
        df -h

    - name: æ™ºèƒ½ç¼–è¯‘å›ºä»¶
      id: compile
      run: |
        cd /workdir/openwrt
        export CCACHE_DIR=${{ env.CCACHE_DIR }}
        export PATH="/usr/lib/ccache:$PATH"

        cleanup_temp_files() {
          echo "æ¸…ç†ä¸´æ—¶æ–‡ä»¶ä»¥é‡Šæ”¾ç©ºé—´..."
          find /tmp -type f -delete || true
          df -h
        }

        save_cache_info() {
          echo "ä¿å­˜ç¼“å­˜çŠ¶æ€ä¿¡æ¯..."
          mkdir -p ${{ env.BUILD_STATE_DIR }}
          cp .config ${{ env.BUILD_STATE_DIR }}/config.txt
          echo "$TOOLCHAIN_MD5" > ${{ env.BUILD_STATE_DIR }}/toolchain.md5
          echo "$PACKAGE_MD5" > ${{ env.BUILD_STATE_DIR }}/package.md5
          # ä¿å­˜å½“å‰é…ç½®çš„è½¯ä»¶åŒ…åˆ—è¡¨ä¾›ä¸‹æ¬¡å¢é‡ç¼–è¯‘ä½¿ç”¨
          grep "^CONFIG_PACKAGE_.*=y" .config > ${{ env.BUILD_STATE_DIR }}/current_packages.txt
          echo "ä¿å­˜æ„å»ºçŠ¶æ€å®Œæˆ"
        }

        # ä»è·¯å¾„æå–åŒ…åçš„å‡½æ•°
        extract_package_name() {
          local filepath=$1
          # ç§»é™¤åŒ…çš„ç‰ˆæœ¬å·å’Œåç¼€
          basename "$filepath" | sed 's/-.*//'
        }

        # æå–å˜æ›´çš„åŒ…åˆ—è¡¨çš„å‡½æ•°
        find_changed_packages() {
          local changed_files=$1
          local packages=""
          
          if [ -f "$changed_files" ]; then
            while read -r file; do
              # æ ¹æ®æ–‡ä»¶è·¯å¾„æå–åŒ…å
              if [[ "$file" =~ feeds/([^/]*)/([^/]*)/Makefile ]]; then
                # å¯¹äºfeedsä¸­çš„åŒ…ï¼Œç›´æ¥ä½¿ç”¨feeds/xxx/packageç»“æ„
                local feed="${BASH_REMATCH[1]}"
                local package="${BASH_REMATCH[2]}"
                packages="$packages $package"
              elif [[ "$file" =~ package/([^/]*)/([^/]*)/Makefile ]]; then
                # å¯¹äºæ ¸å¿ƒåŒ…ï¼Œä½¿ç”¨package/category/packageç»“æ„
                local category="${BASH_REMATCH[1]}"
                local package="${BASH_REMATCH[2]}"
                packages="$packages $package"
              fi
            done < "$changed_files"
          fi
          
          echo "$packages" | tr ' ' '\n' | sort | uniq | tr '\n' ' '
        }

        # æ‰¾å‡ºé…ç½®æ–‡ä»¶ä¸­æ–°å¢çš„åŒ…
        find_config_changes() {
          if [ -f "${{ env.BUILD_STATE_DIR }}/current_packages.txt" ]; then
            # æ¯”è¾ƒå½“å‰é…ç½®å’Œä¸Šæ¬¡é…ç½®ï¼Œæå–æ–°å¢çš„åŒ…
            diff -u ${{ env.BUILD_STATE_DIR }}/current_packages.txt .config | grep "^+CONFIG_PACKAGE_" | grep -v "+++" | sed 's/+CONFIG_PACKAGE_\(.*\)=y/\1/' || echo ""
          else
            # å¦‚æœæ²¡æœ‰ä¸Šæ¬¡çš„é…ç½®è®°å½•ï¼Œè¿”å›æ‰€æœ‰å¯ç”¨çš„åŒ…
            grep "^CONFIG_PACKAGE_.*=y" .config | sed 's/CONFIG_PACKAGE_\(.*\)=y/\1/' || echo ""
          fi
        }

        # æ™ºèƒ½ç¼–è¯‘å™¨ï¼Œæ ¹æ®å˜æ›´æƒ…å†µå†³å®šç¼–è¯‘ç­–ç•¥
        smart_compile() {
          local source_changed=$1
          local config_changed=$2
          
          if [ "$source_changed" = "true" ] || [ "$config_changed" = "true" ]; then
            # æœ‰æºç æˆ–é…ç½®å˜æ›´
            
            if [ $DO_FULL_BUILD -eq 1 ]; then
              # å·¥å…·é“¾é…ç½®å˜åŒ–ï¼Œéœ€è¦å…¨é‡ç¼–è¯‘
              echo "å·¥å…·é“¾é…ç½®æœ‰å˜åŒ–ï¼Œæ‰§è¡Œå…¨é‡ç¼–è¯‘..."
              # ä¸‹è½½ä¾èµ–
              make download -j8 V=s || make download -j1 V=s
              # ç¼–è¯‘å·¥å…·é“¾
              echo "ç¼–è¯‘å·¥å…·é“¾..."
              make -j$(nproc) tools/compile V=s || make -j1 V=s tools/compile
              make -j$(nproc) toolchain/compile V=s || make -j1 V=s toolchain/compile
              # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
              cleanup_temp_files
              # ç¼–è¯‘å®Œæ•´å›ºä»¶
              echo "ç¼–è¯‘å®Œæ•´å›ºä»¶..."
              make -j$(nproc) V=s || make -j1 V=s
              
            else
              # åªæœ‰åŒ…é…ç½®æˆ–æºç å˜åŒ–ï¼Œå°è¯•å¢é‡ç¼–è¯‘
              echo "æ£€æµ‹å˜æ›´çš„åŒ…å¹¶æ‰§è¡Œå¢é‡ç¼–è¯‘..."
              
              # æ”¶é›†æ‰€æœ‰éœ€è¦é‡æ–°ç¼–è¯‘çš„åŒ…
              local packages_to_rebuild=""
              
              # 1. å…ˆæ£€æŸ¥é…ç½®å˜æ›´å¯¼è‡´çš„æ–°å¢åŒ…
              if [ "$config_changed" = "true" ]; then
                local new_packages=$(find_config_changes)
                if [ -n "$new_packages" ]; then
                  echo "é…ç½®å˜æ›´å¯¼è‡´æ–°å¢ä»¥ä¸‹åŒ…: $new_packages"
                  packages_to_rebuild="$packages_to_rebuild $new_packages"
                fi
              fi
              
              # 2. æ£€æŸ¥æºç å˜æ›´çš„åŒ…
              if [ "${{ env.feeds_changed }}" = "true" ]; then
                local changed_feeds_packages=$(find_changed_packages "${{ env.BUILD_STATE_DIR }}/diff/changed_feeds_files.txt")
                if [ -n "$changed_feeds_packages" ]; then
                  echo "Feedsæºç å˜æ›´æ¶‰åŠä»¥ä¸‹åŒ…: $changed_feeds_packages"
                  packages_to_rebuild="$packages_to_rebuild $changed_feeds_packages"
                fi
              fi
              
              if [ "${{ env.core_changed }}" = "true" ]; then
                local changed_core_packages=$(find_changed_packages "${{ env.BUILD_STATE_DIR }}/diff/changed_core_files.txt")
                if [ -n "$changed_core_packages" ]; then
                  echo "æ ¸å¿ƒæºç å˜æ›´æ¶‰åŠä»¥ä¸‹åŒ…: $changed_core_packages"
                  packages_to_rebuild="$packages_to_rebuild $changed_core_packages"
                fi
              fi
              
              # å»é‡å¹¶å¤„ç†æœ€ç»ˆçš„åŒ…åˆ—è¡¨
              packages_to_rebuild=$(echo "$packages_to_rebuild" | tr ' ' '\n' | sort | uniq | tr '\n' ' ')
              
              if [ -n "$packages_to_rebuild" ]; then
                echo "ä»¥ä¸‹åŒ…éœ€è¦é‡æ–°ç¼–è¯‘: $packages_to_rebuild"
                
                # åªé‡æ–°ç¼–è¯‘å˜æ›´çš„åŒ…
                for pkg in $packages_to_rebuild; do
                  echo "æ¸…ç†å¹¶ç¼–è¯‘åŒ…: $pkg"
                  # å°è¯•æ¸…ç†å•ä¸ªåŒ…ï¼Œå¦‚æœå¤±è´¥ä¹Ÿä¸ä¸­æ–­
                  make package/$pkg/clean V=s || echo "æ¸…ç† $pkg å¤±è´¥ï¼Œå¯èƒ½æ˜¯æ–°åŒ…æˆ–è·¯å¾„ä¸æ ‡å‡†"
                  # å°è¯•ç¼–è¯‘å•ä¸ªåŒ…
                  make package/$pkg/compile V=s || echo "ç¼–è¯‘ $pkg å¤±è´¥ï¼Œå°è¯•å…¶ä»–ç¼–è¯‘æ–¹å¼"
                done
                
                # ç¡®ä¿æ‰€æœ‰ä¾èµ–éƒ½è¢«æ­£ç¡®ç¼–è¯‘
                echo "ç¡®ä¿æ‰€æœ‰ä¾èµ–éƒ½è¢«æ­£ç¡®ç¼–è¯‘..."
                make -j$(nproc) package/compile V=s || make -j1 V=s package/compile
                
              else
                echo "æœªæ£€æµ‹åˆ°å…·ä½“éœ€è¦é‡å»ºçš„åŒ…ï¼Œä½†æœ‰å˜æ›´å‘ç”Ÿï¼Œæ‰§è¡Œå®Œæ•´è½¯ä»¶åŒ…ç¼–è¯‘..."
                make -j$(nproc) package/compile V=s || make -j1 V=s package/compile
              fi
              
              # æ›´æ–°åŒ…ç´¢å¼•å¹¶ç”Ÿæˆå›ºä»¶
              echo "æ›´æ–°åŒ…ç´¢å¼•å¹¶ç”Ÿæˆå›ºä»¶..."
              make -j$(nproc) package/index V=s || make -j1 V=s package/index
              make -j$(nproc) target/install V=s || make -j1 V=s target/install
            fi
            
          else
            # æ²¡æœ‰æºç æˆ–é…ç½®å˜æ›´ï¼Œå¯èƒ½æ˜¯å…¶ä»–å› ç´ è§¦å‘çš„æ„å»º
            echo "æœªæ£€æµ‹åˆ°æºç æˆ–é…ç½®å˜æ›´ï¼Œæ‰§è¡Œæœ€å°åŒ–æ„å»º..."
            # ç¡®ä¿ç¼–è¯‘ç¯å¢ƒæ­£å¸¸
            make -j$(nproc) package/index V=s || make -j1 V=s package/index
            make -j$(nproc) target/install V=s || make -j1 V=s target/install
          fi
        }

        # ä¸»ç¼–è¯‘æµç¨‹
        compile_firmware() {
          # æ£€æŸ¥å·¥å…·é“¾é…ç½®å˜åŒ–
          TOOLCHAIN_CONFIG=$(grep "^CONFIG_TARGET" .config | sort)
          TOOLCHAIN_MD5=$(echo "$TOOLCHAIN_CONFIG" | md5sum | awk '{print $1}')
          PREVIOUS_TOOLCHAIN_MD5=$(cat ${{ env.BUILD_STATE_DIR }}/toolchain.md5 2>/dev/null || echo "")
          
          # æ£€æŸ¥è½¯ä»¶åŒ…é…ç½®å˜åŒ–
          PACKAGE_CONFIG=$(grep "^CONFIG_PACKAGE" .config | sort)
          PACKAGE_MD5=$(echo "$PACKAGE_CONFIG" | md5sum | awk '{print $1}')
          PREVIOUS_PACKAGE_MD5=$(cat ${{ env.BUILD_STATE_DIR }}/package.md5 2>/dev/null || echo "")
          
          # å†³å®šç¼–è¯‘ç­–ç•¥
          DO_FULL_BUILD=0
          DO_PACKAGE_BUILD=0
          
          # æ£€æŸ¥æ˜¯å¦éœ€è¦å®Œå…¨é‡å»º
          if [ -z "$PREVIOUS_TOOLCHAIN_MD5" ] || [ "$TOOLCHAIN_MD5" != "$PREVIOUS_TOOLCHAIN_MD5" ] || [ "${{ github.event.inputs.clean_build }}" = "true" ]; then
            echo "å·¥å…·é“¾é…ç½®å˜åŒ–æˆ–é¦–æ¬¡ç¼–è¯‘æˆ–å¼ºåˆ¶å®Œå…¨é‡å»ºï¼Œéœ€è¦å…¨é‡ç¼–è¯‘"
            DO_FULL_BUILD=1
          elif [ -z "$PREVIOUS_PACKAGE_MD5" ] || [ "$PACKAGE_MD5" != "$PREVIOUS_PACKAGE_MD5" ]; then
            echo "è½¯ä»¶åŒ…é…ç½®å˜åŒ–ï¼Œéœ€è¦æ›´æ–°è½¯ä»¶åŒ…"
            DO_PACKAGE_BUILD=1
          else
            echo "é…ç½®æœªå˜ï¼Œæ£€æŸ¥æºç å˜åŒ–..."
          fi
          
          # æºç æ˜¯å¦å˜æ›´
          SOURCE_CHANGED="false"
          if [ "${{ env.feeds_changed }}" = "true" ] || [ "${{ env.core_changed }}" = "true" ]; then
            SOURCE_CHANGED="true"
          fi
          
          # é…ç½®æ˜¯å¦å˜æ›´
          CONFIG_CHANGED="false"
          if [ $DO_PACKAGE_BUILD -eq 1 ]; then
            CONFIG_CHANGED="true"
          fi
          
          # æ‰§è¡Œæ™ºèƒ½ç¼–è¯‘
          smart_compile "$SOURCE_CHANGED" "$CONFIG_CHANGED"
          
          # ä¿å­˜ç¼“å­˜ä¿¡æ¯
          save_cache_info
          
          if [ $? -eq 0 ]; then
            echo "ç¼–è¯‘æˆåŠŸ"
          else
            echo "ç¼–è¯‘å¤±è´¥"
            exit 1
          fi
        }

        # æ‰§è¡Œç¼–è¯‘
        compile_firmware

        echo "DEVICE_NAME=_$(grep '^CONFIG_TARGET.*DEVICE.*=y' .config | sed -r 's/.*DEVICE_(.*)=y/\1/' | tr '\n' '_')" >> $GITHUB_ENV
        echo "FILE_DATE=_$(date +"%Y%m%d%H%M")" >> $GITHUB_ENV
        echo "status=success" >> $GITHUB_OUTPUT
        
        # æ˜¾ç¤ºç¼–è¯‘ç¼“å­˜çŠ¶æ€
        ccache -s
        df -h
        

    # é¦–å…ˆä¿å­˜ç¼“å­˜ï¼Œç„¶åå†è¿›è¡Œæ¸…ç†å’Œæ‰“åŒ…æ­¥éª¤
    - name: å¤‡ä»½ç¼–è¯‘ç¼“å­˜
      if: "!cancelled()"
      run: |
        echo "ç¼–è¯‘å®Œæˆï¼Œå¤‡ä»½ç¼“å­˜æ•°æ®..."
        
        # åœ¨å¤‡ä»½ä¹‹å‰å…ˆç¡®è®¤ç¼“å­˜ç›®å½•çŠ¶æ€
        echo "å·¥å…·é“¾ç›®å½•å¤§å°: $(du -sh ${{ env.TOOLCHAIN_DIR }} | cut -f1)"
        echo "CCACHE ç›®å½•å¤§å°: $(du -sh ${{ env.CCACHE_DIR }} | cut -f1)"
        echo "ç¼–è¯‘åŒ…ç›®å½•å¤§å°: $(du -sh ${{ env.PACKAGES_DIR }} | cut -f1)"
        echo "æ„å»ºçŠ¶æ€ç›®å½•å¤§å°: $(du -sh ${{ env.BUILD_STATE_DIR }} | cut -f1)"
        
        # ç¡®ä¿æ„å»ºçŠ¶æ€ç›®å½•åŒ…å«æ—¶é—´æˆ³ä¿¡æ¯
        mkdir -p ${{ env.BUILD_STATE_DIR }}
        echo "ç¼“å­˜åˆ›å»ºæ—¶é—´: $(date)" > ${{ env.BUILD_STATE_DIR }}/cache_timestamp.txt
        echo "è¿è¡ŒID: ${{ github.run_id }}" >> ${{ env.BUILD_STATE_DIR }}/cache_timestamp.txt
        echo "æ„å»ºåˆ†æ”¯: ${{ env.REPO_BRANCH }}" >> ${{ env.BUILD_STATE_DIR }}/cache_timestamp.txt
        
        # å°†å½“å‰çš„ç¼“å­˜å†…å®¹å­˜æ¡£ä»¥ç¡®ä¿ä¸è¢«åç»­æ­¥éª¤ä¿®æ”¹
        echo "å¤‡ä»½ç¼“å­˜ç›®å½•å®Œæˆ"

    # åˆ†å¼€ä¿å­˜å„ä¸ªç¼“å­˜ï¼Œä½¿å…¶åœ¨ Web ç•Œé¢ä¸­ç‹¬ç«‹æ˜¾ç¤º
    - name: ä¿å­˜å·¥å…·é“¾ç¼“å­˜
      uses: actions/cache@v3
      if: "!cancelled()"
      with:
        path: ${{ env.TOOLCHAIN_DIR }}
        key: toolchain-${{ env.REPO_BRANCH }}-fixed-cache
    
    - name: ä¿å­˜ç¼–è¯‘åŒ…ç¼“å­˜
      uses: actions/cache@v3
      if: "!cancelled()"
      with:
        path: ${{ env.PACKAGES_DIR }}
        key: packages-${{ env.REPO_BRANCH }}-fixed-cache
    
    - name: ä¿å­˜æ„å»ºçŠ¶æ€ç¼“å­˜
      uses: actions/cache@v3
      if: "!cancelled()"
      with:
        path: ${{ env.BUILD_STATE_DIR }}
        key: state-${{ env.REPO_BRANCH }}-fixed-cache
    
    - name: ä¿å­˜CCACHEç¼“å­˜
      uses: actions/cache@v3
      if: "!cancelled()"
      with:
        path: ${{ env.CCACHE_DIR }}
        key: ccache-${{ env.REPO_BRANCH }}-fixed-cache

    - name: éªŒè¯ç¼“å­˜å·²ä¿å­˜
      if: "!cancelled()"
      run: |
        echo "å·²å®Œæˆæ‰€æœ‰ç¼“å­˜ä¿å­˜ï¼Œç°åœ¨å¯ä»¥å®‰å…¨åœ°è¿›è¡Œåç»­æ–‡ä»¶æ•´ç†å’Œæ¸…ç†æ“ä½œ"
        # æ˜¾ç¤ºç¼“å­˜æ—¶é—´æˆ³
        if [ -f "${{ env.BUILD_STATE_DIR }}/cache_timestamp.txt" ]; then
          echo "ç¼“å­˜æ—¶é—´æˆ³å†…å®¹:"
          cat ${{ env.BUILD_STATE_DIR }}/cache_timestamp.txt
        fi
        df -h

    # ç°åœ¨å¯ä»¥å®‰å…¨åœ°è¿›è¡Œæ–‡ä»¶æ•´ç†å’Œä¸Šä¼ 
    - name: æ•´ç†æ–‡ä»¶
      id: organize
      if: steps.compile.outputs.status == 'success' && env.UPLOAD_FIRMWARE == 'true' && !cancelled()
      run: |
        cd /workdir/openwrt/bin/targets/*/*
        # æ³¨æ„ï¼šä¸è¦åˆ é™¤å¯èƒ½ç”¨äºç¼“å­˜çš„æ–‡ä»¶
        mkdir -p firmware
        FIRMWARE_FILES=$(find . -maxdepth 1 -name "*combined*" -or -name "*sysupgrade*")
        if [ -z "$FIRMWARE_FILES" ]; then
          echo "è­¦å‘Šï¼šæœªæ‰¾åˆ°å›ºä»¶æ–‡ä»¶ï¼Œä½¿ç”¨æ‰€æœ‰binæ–‡ä»¶"
          FIRMWARE_FILES=$(find . -maxdepth 1 -name "*.bin")
        fi
        if [ -n "$FIRMWARE_FILES" ]; then
          echo "$FIRMWARE_FILES" | xargs -i cp {} ./firmware/
        else
          cp -r * ./firmware/
        fi
        cp /workdir/openwrt/.config ./firmware/config.txt
        zip -r firmware.zip firmware
        echo "FIRMWARE=$PWD/firmware" >> $GITHUB_ENV
        echo "FIRMWARE_ZIP=$PWD/firmware.zip" >> $GITHUB_ENV
        echo "status=success" >> $GITHUB_OUTPUT

    # ä¸Šä¼ å›ºä»¶
    - name: ä¸Šä¼ å›ºä»¶ç›®å½•
      uses: actions/upload-artifact@main
      if: steps.organize.outputs.status == 'success' && !cancelled()
      with:
        name: OpenWrt_firmware${{ env.DEVICE_NAME }}${{ env.FILE_DATE }}
        path: ${{ env.FIRMWARE }}

    - name: ç”Ÿæˆå‘å¸ƒæ ‡ç­¾
      id: tag
      if: steps.organize.outputs.status == 'success' && env.UPLOAD_RELEASE == 'true' && !cancelled()
      run: |
        echo "RELEASE_TAG=$(date +"%Y.%m.%d-%H%M")" >> $GITHUB_OUTPUT
        echo "## OpenWrtå›ºä»¶æ„å»ºå®Œæˆ ğŸ“¦" > release.txt
        echo "ğŸ“… æ„å»ºæ—¶é—´: $(date +"%Y-%m-%d %H:%M")" >> release.txt
        echo "ğŸ“‚ å›ºä»¶ä¸‹è½½" >> release.txt
        echo "âš ï¸ è¯·åœ¨åˆ·æœºå‰å…ˆåšå¥½å¤‡ä»½ï¼" >> release.txt
        echo "status=success" >> $GITHUB_OUTPUT

    - name: ä¸Šä¼ å›ºä»¶åˆ°Releases
      uses: softprops/action-gh-release@v2
      if: steps.tag.outputs.status == 'success' && !cancelled()
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ steps.tag.outputs.RELEASE_TAG }}
        body_path: release.txt
        files: ${{ env.FIRMWARE }}/*

    - name: åˆ é™¤æ—§çš„Releases
      uses: dev-drprasad/delete-older-releases@master
      if: env.UPLOAD_RELEASE == 'true' && !cancelled()
      with:
        keep_latest: 3
        delete_tags: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
