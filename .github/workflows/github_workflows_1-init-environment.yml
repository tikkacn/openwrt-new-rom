name: "1. Init OpenWrt Build Environment"

on:
  workflow_dispatch:
  push:
    paths:
      - '.config'
      - 'diy-part1.sh'
      - 'diy-part2.sh'
  schedule:
    - cron: 0 16 * * *

env:
  TZ: Asia/Shanghai

jobs:
  init:
    runs-on: ubuntu-22.04

    steps:
    - name: Free Disk Space
      uses: jlumbroso/free-disk-space@main
      with:
        tool-cache: false
        android: true
        dotnet: true
        haskell: true
        large-packages: true
        swap-storage: true
        docker-images: true

    - name: Initialization environment
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        sudo rm -rf /etc/apt/sources.list.d/* /usr/share/dotnet /usr/local/lib/android /opt/ghc
        sudo -E apt-get -qq update
        sudo -E apt-get -qq install $(curl -fsSL git.io/depends-ubuntu-2204)
        sudo -E apt-get -qq autoremove --purge
        sudo -E apt-get -qq clean
        sudo timedatectl set-timezone "$TZ"
        
    - name: Check Build Environment
      run: |
        echo "System Information:"
        uname -a
        echo "Available Storage:"
        df -h
        echo "Memory Status:"
        free -h
        echo "Current Tools:"
        make --version
        gcc --version
        g++ --version
        
    - name: Delete workflow runs
      uses: Mattraks/delete-workflow-runs@v2
      with:
        retain_days: 1
        keep_minimum_runs: 3