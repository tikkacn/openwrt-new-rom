name: å…¨æ–°ç¼–è¯‘ç¬¬ä¹ç‰ˆ(ä¿®å¤ç¼“å­˜è­¦å‘Š)

on:
  workflow_dispatch:
    inputs:
      ssh:
        description: 'SSHè°ƒè¯•'
        required: false
        default: 'false'
      clean_build:
        description: 'å®Œå…¨é‡æ–°ç¼–è¯‘'
        required: false
        default: 'false'
      config_file:
        description: 'é…ç½®æ–‡ä»¶'
        required: false
        default: 'å¢žé‡ç¼“å­˜ä¼˜åŒ–.config'

env:
  REPO_URL: https://github.com/coolsnowwolf/lede
  REPO_BRANCH: master
  FEEDS_CONF_URL: https://github.com/tikkacn/openwrt-new-rom/raw/main/feeds.conf.default
  CONFIG_FILE: ${{ github.event.inputs.config_file || 'å¢žé‡ç¼“å­˜ä¼˜åŒ–.config' }}
  DIY_P1_SH: diy-part1.sh
  DIY_P2_SH: diy-part2.sh
  UPLOAD_FIRMWARE: true
  UPLOAD_RELEASE: true
  TZ: Asia/Shanghai
  WORKDIR: /workdir
  CACHE_ARTIFACTS: true # è®¾ç½®ä¸ºtrueä»¥å¯ç”¨æž„å»ºç‰©å­˜å‚¨è€Œä¸æ˜¯ç¼“å­˜

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@main

    - name: ä¼˜åŒ–ç£ç›˜ç©ºé—´
      uses: easimon/maximize-build-space@master
      with:
        root-reserve-mb: 20480
        swap-size-mb: 8192
        remove-dotnet: 'true'
        remove-android: 'true'
        remove-haskell: 'true'
        remove-codeql: 'true'
        remove-docker-images: 'true'
        build-mount-path: '/workdir'

    - name: åˆå§‹åŒ–çŽ¯å¢ƒ
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        sudo -E apt-get -qq update
        sudo -E apt-get -qq install -y ack antlr3 asciidoc autoconf automake autopoint binutils bison build-essential \
        bzip2 ccache clang cmake cpio curl device-tree-compiler flex gawk gcc-multilib g++-multilib gettext \
        genisoimage git gperf haveged help2man intltool libc6-dev-i386 libelf-dev libfuse-dev libglib2.0-dev \
        libgmp3-dev libltdl-dev libmpc-dev libmpfr-dev libncurses5-dev libncursesw5-dev libpython3-dev \
        libreadline-dev libssl-dev libtool llvm lrzsz msmtp ninja-build p7zip p7zip-full patch pkgconf \
        python3 python3-pyelftools python3-setuptools qemu-utils rsync scons squashfs-tools subversion \
        swig texinfo uglifyjs upx-ucl unzip vim wget xmlto xxd zlib1g-dev
        sudo -E apt-get -qq clean
        sudo timedatectl set-timezone "$TZ"
        chmod -R 777 /workdir
        df -h
        
        # è®¾ç½®æ—¥æœŸå˜é‡ä¾›åŽç»­ä½¿ç”¨
        echo "DATE_TAG=$(date +"%Y%m%d%H%M")" >> $GITHUB_ENV

    - name: è®¡ç®—æž„å»ºæŒ‡çº¹
      id: fingerprint
      run: |
        # åˆ›å»ºé…ç½®æ–‡ä»¶å‰¯æœ¬ï¼ˆå¦‚æžœä¸å­˜åœ¨åˆ™åˆ›å»ºé»˜è®¤é…ç½®ï¼‰
        CONFIG_PATH="$GITHUB_WORKSPACE/$CONFIG_FILE"
        if [ ! -f "$CONFIG_PATH" ]; then
          echo "CONFIG_TARGET_x86=y" > "$CONFIG_PATH"
          echo "CONFIG_TARGET_x86_64=y" >> "$CONFIG_PATH"
          echo "CONFIG_TARGET_x86_64_DEVICE_generic=y" >> "$CONFIG_PATH"
          echo "CONFIG_PACKAGE_luci=y" >> "$CONFIG_PATH"
        fi
        
        # è®¡ç®—é…ç½®æ–‡ä»¶MD5å’Œç‰ˆæœ¬ID
        CONFIG_MD5=$(md5sum "$CONFIG_PATH" | awk '{print $1}')
        CONFIG_MD5_SHORT=${CONFIG_MD5:0:8}
        echo "CONFIG_MD5=$CONFIG_MD5" >> $GITHUB_OUTPUT
        echo "CONFIG_MD5_SHORT=$CONFIG_MD5_SHORT" >> $GITHUB_ENV
        
        # è®¾ç½®æž„å»ºID
        BUILD_ID="${REPO_BRANCH}-${CONFIG_MD5:0:8}-$(date +"%Y%m%d")"
        echo "BUILD_ID=$BUILD_ID" >> $GITHUB_OUTPUT
        echo "BUILD_ID=$BUILD_ID" >> $GITHUB_ENV

    # ä½¿ç”¨artifactä¸‹è½½ä¸Šä¸€æ¬¡ç¼–è¯‘çš„é‡è¦ç»„ä»¶
    - name: ä¸‹è½½CCACHE
      uses: dawidd6/action-download-artifact@v2
      if: env.CACHE_ARTIFACTS == 'true' && inputs.clean_build != 'true'
      with:
        name: ccache-${{ env.BUILD_ID }}
        path: ${{ env.WORKDIR }}/ccache
        workflow: ${{ github.workflow }}
        workflow_conclusion: success
        if_no_artifact_found: ignore
    
    - name: ä¸‹è½½å·¥å…·é“¾
      uses: dawidd6/action-download-artifact@v2
      if: env.CACHE_ARTIFACTS == 'true' && inputs.clean_build != 'true'
      with:
        name: toolchain-${{ env.BUILD_ID }}
        path: ${{ env.WORKDIR }}/toolchain
        workflow: ${{ github.workflow }}
        workflow_conclusion: success
        if_no_artifact_found: ignore
    
    - name: ä¸‹è½½æž„å»ºç›®å½•
      uses: dawidd6/action-download-artifact@v2
      if: env.CACHE_ARTIFACTS == 'true' && inputs.clean_build != 'true'
      with:
        name: build-dir-${{ env.BUILD_ID }}
        path: ${{ env.WORKDIR }}/build_dir
        workflow: ${{ github.workflow }}
        workflow_conclusion: success
        if_no_artifact_found: ignore
    
    - name: ä¸‹è½½ä¸‹è½½ç¼“å­˜
      uses: dawidd6/action-download-artifact@v2
      if: env.CACHE_ARTIFACTS == 'true' && inputs.clean_build != 'true'
      with:
        name: dl-${{ env.BUILD_ID }}
        path: ${{ env.WORKDIR }}/dl
        workflow: ${{ github.workflow }}
        workflow_conclusion: success
        if_no_artifact_found: ignore

    # ä½¿ç”¨ä¼ ç»Ÿç¼“å­˜ä½œä¸ºå¤‡ç”¨
    - name: æ¢å¤CCACHEç¼“å­˜
      uses: actions/cache@v3
      id: cache-ccache
      if: env.CACHE_ARTIFACTS != 'true' || inputs.clean_build == 'true'
      with:
        path: |
          ${{ env.WORKDIR }}/ccache
        key: ccache-${{ env.REPO_BRANCH }}-${{ steps.fingerprint.outputs.CONFIG_MD5 }}-v9
        restore-keys: |
          ccache-${{ env.REPO_BRANCH }}-

    - name: æ£€æŸ¥ç¼“å­˜æ¢å¤çŠ¶æ€
      run: |
        echo "ç¼“å­˜çŠ¶æ€æ£€æŸ¥ï¼š"
        
        for dir in ccache toolchain build_dir dl; do
          if [ -d "${{ env.WORKDIR }}/$dir" ] && [ "$(ls -A ${{ env.WORKDIR }}/$dir 2>/dev/null)" ]; then
            SIZE=$(du -sh ${{ env.WORKDIR }}/$dir | cut -f1)
            echo "$dir ç›®å½•å­˜åœ¨ï¼Œå¤§å°: $SIZE"
            
            # åˆ—å‡ºä¸€äº›å…³é”®æ–‡ä»¶ä»¥éªŒè¯å†…å®¹
            if [ "$dir" = "toolchain" ]; then
              echo "å·¥å…·é“¾å†…å®¹:"
              find ${{ env.WORKDIR }}/$dir -name "gcc" -type f | head -5
            elif [ "$dir" = "ccache" ]; then
              echo "CCACHEå†…å®¹:"
              ls -la ${{ env.WORKDIR }}/$dir | head -5
            fi
          else
            echo "$dir ç›®å½•ä¸å­˜åœ¨æˆ–ä¸ºç©º"
            mkdir -p ${{ env.WORKDIR }}/$dir
          fi
        done

    - name: å…‹éš†æºä»£ç 
      working-directory: ${{ env.WORKDIR }}
      run: |
        if [ ! -d "openwrt" ]; then
          git clone --depth 1 $REPO_URL -b $REPO_BRANCH openwrt
        fi
        ln -sf ${{ env.WORKDIR }}/openwrt $GITHUB_WORKSPACE/openwrt
        cd openwrt
        
        # åˆ›å»ºå¹¶é“¾æŽ¥å·¥å…·é“¾ç›®å½•
        mkdir -p staging_dir
        if [ -d "${{ env.WORKDIR }}/toolchain" ] && [ "$(ls -A ${{ env.WORKDIR }}/toolchain 2>/dev/null)" ]; then
          echo "æ¢å¤å·¥å…·é“¾..."
          rsync -a ${{ env.WORKDIR }}/toolchain/ staging_dir/
        fi
        
        # åˆ›å»ºå¹¶é“¾æŽ¥æž„å»ºç›®å½•
        if [ -d "${{ env.WORKDIR }}/build_dir" ] && [ "$(ls -A ${{ env.WORKDIR }}/build_dir 2>/dev/null)" ]; then
          echo "æ¢å¤æž„å»ºç›®å½•..."
          ln -sf ${{ env.WORKDIR }}/build_dir build_dir
        else
          mkdir -p build_dir
        fi
        
        # åˆ›å»ºå¹¶é“¾æŽ¥ä¸‹è½½ç›®å½•
        if [ -d "${{ env.WORKDIR }}/dl" ] && [ "$(ls -A ${{ env.WORKDIR }}/dl 2>/dev/null)" ]; then
          echo "æ¢å¤ä¸‹è½½ç›®å½•..."
          ln -sf ${{ env.WORKDIR }}/dl dl
        else
          mkdir -p dl
        fi
        
        # é…ç½®feeds
        curl -L -o feeds.conf.default "$FEEDS_CONF_URL" || echo "ä½¿ç”¨ä»“åº“é»˜è®¤feedsé…ç½®"

    - name: é…ç½®ç¼–è¯‘çŽ¯å¢ƒ
      run: |
        cd ${{ env.WORKDIR }}/openwrt
        
        # åˆ›å»ºdiyè„šæœ¬
        echo '#!/bin/bash' > $GITHUB_WORKSPACE/diy-part1.sh
        echo '# Feeds å·²é€šè¿‡ FEEDS_CONF_URL é…ç½®' >> $GITHUB_WORKSPACE/diy-part1.sh
        chmod +x $GITHUB_WORKSPACE/diy-part1.sh
        
        echo '#!/bin/bash' > $GITHUB_WORKSPACE/diy-part2.sh
        echo 'sed -i "s/OpenWrt /OpenWrt_AutoBuild /" package/lean/default-settings/files/zzz-default-settings' >> $GITHUB_WORKSPACE/diy-part2.sh
        chmod +x $GITHUB_WORKSPACE/diy-part2.sh
        
        # æ‰§è¡Œdiyè„šæœ¬
        $GITHUB_WORKSPACE/$DIY_P1_SH
        
        # æ›´æ–°feeds
        ./scripts/feeds update -a
        ./scripts/feeds install -a
        
        # åº”ç”¨é…ç½®
        cp $GITHUB_WORKSPACE/$CONFIG_FILE ./.config
        $GITHUB_WORKSPACE/$DIY_P2_SH
        
        # ä¼˜åŒ–ç¼–è¯‘é…ç½®
        echo "CONFIG_CCACHE=y" >> .config
        echo "CONFIG_DEVEL=y" >> .config
        echo "CONFIG_AUTOREMOVE=n" >> .config
        echo "CONFIG_AUTOREBUILD=n" >> .config
        
        # å›ºä»¶ç”Ÿæˆé…ç½®
        echo "CONFIG_TARGET_ROOTFS_SQUASHFS=y" >> .config
        if grep -q "CONFIG_TARGET_x86=y" .config; then
          echo "CONFIG_GRUB_IMAGES=y" >> .config
          echo "CONFIG_TARGET_IMAGES_GZIP=y" >> .config
        fi
        
        make defconfig

    - name: é…ç½®CCACHE
      run: |
        mkdir -p ${{ env.WORKDIR }}/ccache
        export CCACHE_DIR=${{ env.WORKDIR }}/ccache
        ccache -o cache_dir=$CCACHE_DIR
        ccache -o compression=true
        ccache -o compression_level=6
        ccache -o max_size=5G
        ccache -o hash_dir=false
        ccache -o sloppiness=file_macro,locale,include_file_mtime,include_file_ctime,time_macros,file_stat_matches_ctime
        ccache -z
        echo "CCACHE_DIR=$CCACHE_DIR" >> $GITHUB_ENV
        echo "PATH=/usr/lib/ccache:$PATH" >> $GITHUB_ENV

    - name: å¼€å¯SSHè°ƒè¯•
      uses: mxschmitt/action-tmate@v3
      if: github.event.inputs.ssh == 'true'

    - name: æ™ºèƒ½ç¼–è¯‘å›ºä»¶
      id: compile
      run: |
        cd ${{ env.WORKDIR }}/openwrt
        
        # è®¾ç½®çŽ¯å¢ƒå˜é‡
        export CCACHE_DIR=${{ env.WORKDIR }}/ccache
        export PATH="/usr/lib/ccache:$PATH"
        
        # æ£€æŸ¥æ˜¯å¦éœ€è¦å®Œæ•´ç¼–è¯‘
        NEED_FULL_BUILD=false
        
        # æ£€æŸ¥å·¥å…·é“¾æ˜¯å¦å®Œæ•´
        if [ ! -f "staging_dir/host/bin/gcc" ] || [ ! -d "staging_dir/toolchain"* ]; then
          NEED_FULL_BUILD=true
          echo "å·¥å…·é“¾ä¸å®Œæ•´ï¼Œéœ€è¦å®Œæ•´ç¼–è¯‘"
        fi
        
        if [ "${{ inputs.clean_build }}" = "true" ]; then
          NEED_FULL_BUILD=true
          echo "å¼ºåˆ¶å®Œæ•´ç¼–è¯‘"
        fi
        
        # ä¸‹è½½ä¾èµ–
        echo "ä¸‹è½½ä¾èµ–åŒ…..."
        make download -j8 || make download -j1 V=s
        
        # ç¡®ä¿dlç›®å½•å†…å®¹ä¿å­˜åˆ°ç¼“å­˜
        if [ -d "dl" ] && [ "$(ls -A dl 2>/dev/null)" ]; then
          echo "ä¿å­˜dlç›®å½•åˆ°ç¼“å­˜..."
          mkdir -p ${{ env.WORKDIR }}/dl_temp
          # åªå¤åˆ¶å°äºŽ2MBçš„æ–‡ä»¶ä»¥ç¡®ä¿ä¸è¶…è¿‡é™åˆ¶
          find dl -type f -size -2M -exec cp -p {} ${{ env.WORKDIR }}/dl_temp/ \;
          
          # æ˜¾ç¤ºå¤‡ä»½å¤§å°
          echo "ä¸‹è½½ç¼“å­˜å¤§å°: $(du -sh ${{ env.WORKDIR }}/dl_temp | cut -f1)"
          
          # ä¿å­˜ä¸€ä¸ªç¤ºä¾‹æ–‡ä»¶ä»¥ç¡®ä¿ç›®å½•ä¸ä¸ºç©º
          mkdir -p ${{ env.WORKDIR }}/dl
          touch ${{ env.WORKDIR }}/dl/cache_marker.txt
          echo "æ­¤æ–‡ä»¶ç”¨äºŽç¡®ä¿ç¼“å­˜ç›®å½•ä¸ä¸ºç©º" > ${{ env.WORKDIR }}/dl/cache_marker.txt
          
          # å¤åˆ¶æ–‡ä»¶åˆ°ç¼“å­˜ç›®å½•
          cp -a ${{ env.WORKDIR }}/dl_temp/* ${{ env.WORKDIR }}/dl/ 2>/dev/null || true
          rm -rf ${{ env.WORKDIR }}/dl_temp
        fi
        
        # ç¼–è¯‘è¿‡ç¨‹
        if [ "$NEED_FULL_BUILD" = "true" ]; then
          echo "æ‰§è¡Œå®Œæ•´ç¼–è¯‘..."
          
          # ç¼–è¯‘å·¥å…·é“¾
          make -j$(nproc) tools/compile || make -j1 tools/compile
          make -j$(nproc) toolchain/compile || make -j1 toolchain/compile
          
          # å¤‡ä»½å·¥å…·é“¾åˆ°ç¼“å­˜ç›®å½•
          echo "å¤‡ä»½å·¥å…·é“¾..."
          mkdir -p ${{ env.WORKDIR }}/toolchain
          cp -a staging_dir/* ${{ env.WORKDIR }}/toolchain/
          
          # å®Œæ•´ç¼–è¯‘
          make -j$(nproc) || make -j1
        else
          echo "æ‰§è¡Œå¢žé‡ç¼–è¯‘..."
          make -j$(nproc) || make -j1
        fi
        
        echo "ç¼–è¯‘å®Œæˆï¼Œæ˜¾ç¤ºCCACHEç»Ÿè®¡:"
        ccache -s
        
        echo "status=success" >> $GITHUB_OUTPUT

    - name: æ£€æŸ¥ç¼–è¯‘ç»“æžœ
      if: always()
      run: |
        cd ${{ env.WORKDIR }}/openwrt
        echo "æŸ¥æ‰¾å›ºä»¶æ–‡ä»¶..."
        find bin/targets -type f -name "*.bin" -o -name "*combined*" -o -name "*sysupgrade*" | xargs ls -lh || echo "æœªæ‰¾åˆ°å›ºä»¶æ–‡ä»¶"
        
        # æ˜¾ç¤ºå„ç›®å½•å¤§å°
        echo "ç›®å½•å¤§å°ï¼š"
        for dir in staging_dir build_dir bin dl; do
          if [ -d "$dir" ]; then
            echo "${dir}: $(du -sh $dir | cut -f1)"
          fi
        done
        
        # æ£€æŸ¥CCACHEç›®å½•å¤§å°
        echo "CCACHEç›®å½•å¤§å°: $(du -sh ${{ env.WORKDIR }}/ccache | cut -f1)"
        
        # æ˜¾ç¤ºå¯ç”¨ç©ºé—´
        df -h

    # ä½¿ç”¨æ—§ç‰ˆçš„upload-artifact
    - name: å­˜å‚¨CCACHE
      uses: actions/upload-artifact@main
      if: env.CACHE_ARTIFACTS == 'true' && steps.compile.outputs.status == 'success' && !cancelled()
      with:
        name: ccache-${{ env.BUILD_ID }}
        path: ${{ env.WORKDIR }}/ccache
        retention-days: 5

    - name: å¤‡ä»½é‡è¦å·¥å…·é“¾æ–‡ä»¶
      if: env.CACHE_ARTIFACTS == 'true' && steps.compile.outputs.status == 'success' && !cancelled()
      run: |
        cd ${{ env.WORKDIR }}/openwrt
        
        if [ -d "staging_dir" ]; then
          echo "å¤‡ä»½å…³é”®å·¥å…·é“¾æ–‡ä»¶..."
          
          # ç¡®ä¿å·¥å…·é“¾ç¼“å­˜ç›®å½•å­˜åœ¨
          mkdir -p ${{ env.WORKDIR }}/toolchain
          
          # å¤‡ä»½å…³é”®å¯æ‰§è¡Œæ–‡ä»¶å’Œå¤´æ–‡ä»¶
          echo "å¤‡ä»½ä¸»æœºå·¥å…·é“¾..."
          if [ -d "staging_dir/host/bin" ]; then
            mkdir -p ${{ env.WORKDIR }}/toolchain/staging_dir/host/bin
            rsync -a staging_dir/host/bin/ ${{ env.WORKDIR }}/toolchain/staging_dir/host/bin/
          fi
          
          # å¤‡ä»½äº¤å‰ç¼–è¯‘å·¥å…·é“¾
          for dir in staging_dir/toolchain-*; do
            if [ -d "$dir" ]; then
              base_dir=$(basename $dir)
              echo "å¤‡ä»½äº¤å‰ç¼–è¯‘å·¥å…·é“¾: $base_dir"
              mkdir -p ${{ env.WORKDIR }}/toolchain/staging_dir/$base_dir/bin
              rsync -a $dir/bin/ ${{ env.WORKDIR }}/toolchain/staging_dir/$base_dir/bin/ || true
            fi
          done
          
          # ç”Ÿæˆä¸€ä¸ªæ ‡è®°æ–‡ä»¶ï¼Œç¡®ä¿ç›®å½•ä¸ä¸ºç©º
          echo "å·¥å…·é“¾ç¼“å­˜ç‰ˆæœ¬: $(date)" > ${{ env.WORKDIR }}/toolchain/version.txt
          
          # æ˜¾ç¤ºå¤‡ä»½å¤§å°
          echo "å·¥å…·é“¾å¤‡ä»½å¤§å°: $(du -sh ${{ env.WORKDIR }}/toolchain | cut -f1)"
        fi

    - name: å­˜å‚¨å·¥å…·é“¾
      uses: actions/upload-artifact@main
      if: env.CACHE_ARTIFACTS == 'true' && steps.compile.outputs.status == 'success' && !cancelled()
      with:
        name: toolchain-${{ env.BUILD_ID }}
        path: ${{ env.WORKDIR }}/toolchain
        retention-days: 5

    - name: å¤‡ä»½å…³é”®æž„å»ºæ–‡ä»¶
      if: env.CACHE_ARTIFACTS == 'true' && steps.compile.outputs.status == 'success' && !cancelled()
      run: |
        cd ${{ env.WORKDIR }}/openwrt
        
        # ç¡®ä¿æž„å»ºç¼“å­˜ç›®å½•ä¸ä¸ºç©º
        mkdir -p ${{ env.WORKDIR }}/build_dir
        echo "æž„å»ºç¼“å­˜ç‰ˆæœ¬: $(date)" > ${{ env.WORKDIR }}/build_dir/version.txt
        
        if [ -d "build_dir" ]; then
          echo "å¤‡ä»½å…³é”®æž„å»ºæ–‡ä»¶..."
          
          # å¤‡ä»½ä¸»æœºæž„å»ºæ ‡è®°
          if [ -d "build_dir/host" ]; then
            mkdir -p ${{ env.WORKDIR }}/build_dir/host
            echo "å¤‡ä»½ä¸»æœºæž„å»ºçŠ¶æ€..." > ${{ env.WORKDIR }}/build_dir/host/status.txt
            find build_dir/host -name ".built" -o -name ".configured" | \
              xargs tar cf - 2>/dev/null | tar xf - -C ${{ env.WORKDIR }} 2>/dev/null || true
          fi
          
          # å¤‡ä»½å·¥å…·é“¾æž„å»ºæ ‡è®°
          for dir in build_dir/toolchain-*; do
            if [ -d "$dir" ]; then
              base_dir=$(basename $dir)
              mkdir -p ${{ env.WORKDIR }}/build_dir/$base_dir
              echo "å¤‡ä»½å·¥å…·é“¾æž„å»ºçŠ¶æ€: $base_dir" > ${{ env.WORKDIR }}/build_dir/$base_dir/status.txt
              find $dir -name ".built" -o -name ".configured" | \
                xargs tar cf - 2>/dev/null | tar xf - -C ${{ env.WORKDIR }} 2>/dev/null || true
            fi
          done
        fi
        
        # æ˜¾ç¤ºå¤‡ä»½å¤§å°
        echo "æž„å»ºç›®å½•å¤‡ä»½å¤§å°: $(du -sh ${{ env.WORKDIR }}/build_dir | cut -f1)"

    - name: å­˜å‚¨æž„å»ºç›®å½•
      uses: actions/upload-artifact@main
      if: env.CACHE_ARTIFACTS == 'true' && steps.compile.outputs.status == 'success' && !cancelled()
      with:
        name: build-dir-${{ env.BUILD_ID }}
        path: ${{ env.WORKDIR }}/build_dir
        retention-days: 5

    - name: å­˜å‚¨ä¸‹è½½ç¼“å­˜
      uses: actions/upload-artifact@main
      if: env.CACHE_ARTIFACTS == 'true' && steps.compile.outputs.status == 'success' && !cancelled()
      with:
        name: dl-${{ env.BUILD_ID }}
        path: ${{ env.WORKDIR }}/dl
        retention-days: 5

    - name: æ•´ç†å›ºä»¶æ–‡ä»¶
      id: organize
      if: steps.compile.outputs.status == 'success' && !cancelled()
      run: |
        cd ${{ env.WORKDIR }}/openwrt/bin/targets/*/*
        rm -rf packages
        echo "FIRMWARE=$PWD" >> $GITHUB_ENV
        echo "status=success" >> $GITHUB_OUTPUT

    - name: ä¸Šä¼ å›ºä»¶
      uses: actions/upload-artifact@main
      if: steps.organize.outputs.status == 'success' && !cancelled()
      with:
        name: OpenWrt_firmware_${{ env.CONFIG_MD5_SHORT }}_${{ env.DATE_TAG }}
        path: ${{ env.FIRMWARE }}

    - name: ç”Ÿæˆå‘å¸ƒæ ‡ç­¾
      id: tag
      if: steps.organize.outputs.status == 'success' && env.UPLOAD_RELEASE == 'true' && !cancelled()
      run: |
        echo "RELEASE_TAG=$(date +"%Y.%m.%d-%H%M")" >> $GITHUB_OUTPUT
        echo "## OpenWrtå›ºä»¶æž„å»ºå®Œæˆ ðŸ“¦" > release.txt
        echo "ðŸ“… æž„å»ºæ—¶é—´: $(date +"%Y-%m-%d %H:%M")" >> release.txt
        echo "âš ï¸ è¯·åœ¨åˆ·æœºå‰å…ˆåšå¥½å¤‡ä»½ï¼" >> release.txt
        echo "status=success" >> $GITHUB_OUTPUT

    - name: ä¸Šä¼ å›ºä»¶åˆ°Release
      uses: softprops/action-gh-release@v2
      if: steps.tag.outputs.status == 'success' && !cancelled()
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ steps.tag.outputs.RELEASE_TAG }}
        body_path: release.txt
        files: ${{ env.FIRMWARE }}/*

    - name: åˆ é™¤æ—§çš„Releases
      uses: dev-drprasad/delete-older-releases@master
      if: env.UPLOAD_RELEASE == 'true' && !cancelled()
      with:
        keep_latest: 3
        delete_tags: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
