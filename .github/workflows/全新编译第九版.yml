name: å…¨æ–°ç¼–è¯‘ç¬¬ä¹ç‰ˆ(ä¼˜åŒ–ç¼“å­˜å¤§å°)

on:
  workflow_dispatch:
    inputs:
      ssh:
        description: 'SSHè°ƒè¯•'
        required: false
        default: 'false'
      clean_build:
        description: 'å®Œå…¨é‡æ–°ç¼–è¯‘'
        required: false
        default: 'false'
      config_file:
        description: 'é…ç½®æ–‡ä»¶'
        required: false
        default: 'å¢žé‡ç¼“å­˜ä¼˜åŒ–.config'

env:
  REPO_URL: https://github.com/coolsnowwolf/lede
  REPO_BRANCH: master
  FEEDS_CONF_URL: https://github.com/tikkacn/openwrt-new-rom/raw/main/feeds.conf.default
  CONFIG_FILE: ${{ github.event.inputs.config_file || 'å¢žé‡ç¼“å­˜ä¼˜åŒ–.config' }}
  DIY_P1_SH: diy-part1.sh
  DIY_P2_SH: diy-part2.sh
  UPLOAD_FIRMWARE: true
  UPLOAD_RELEASE: true
  TZ: Asia/Shanghai
  WORKDIR: /workdir

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@main

    - name: ä¼˜åŒ–ç£ç›˜ç©ºé—´
      uses: easimon/maximize-build-space@master
      with:
        root-reserve-mb: 20480
        swap-size-mb: 8192
        remove-dotnet: 'true'
        remove-android: 'true'
        remove-haskell: 'true'
        remove-codeql: 'true'
        remove-docker-images: 'true'
        build-mount-path: '/workdir'

    - name: åˆå§‹åŒ–çŽ¯å¢ƒ
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        sudo -E apt-get -qq update
        sudo -E apt-get -qq install -y ack antlr3 asciidoc autoconf automake autopoint binutils bison build-essential \
        bzip2 ccache clang cmake cpio curl device-tree-compiler flex gawk gcc-multilib g++-multilib gettext \
        genisoimage git gperf haveged help2man intltool libc6-dev-i386 libelf-dev libfuse-dev libglib2.0-dev \
        libgmp3-dev libltdl-dev libmpc-dev libmpfr-dev libncurses5-dev libncursesw5-dev libpython3-dev \
        libreadline-dev libssl-dev libtool llvm lrzsz msmtp ninja-build p7zip p7zip-full patch pkgconf \
        python3 python3-pyelftools python3-setuptools qemu-utils rsync scons squashfs-tools subversion \
        swig texinfo uglifyjs upx-ucl unzip vim wget xmlto xxd zlib1g-dev
        sudo -E apt-get -qq clean
        sudo timedatectl set-timezone "$TZ"
        chmod -R 777 /workdir
        df -h

    - name: è®¡ç®—æž„å»ºæŒ‡çº¹
      id: fingerprint
      run: |
        # åˆ›å»ºé…ç½®æ–‡ä»¶å‰¯æœ¬ï¼ˆå¦‚æžœä¸å­˜åœ¨åˆ™åˆ›å»ºé»˜è®¤é…ç½®ï¼‰
        CONFIG_PATH="$GITHUB_WORKSPACE/$CONFIG_FILE"
        if [ ! -f "$CONFIG_PATH" ]; then
          echo "CONFIG_TARGET_x86=y" > "$CONFIG_PATH"
          echo "CONFIG_TARGET_x86_64=y" >> "$CONFIG_PATH"
          echo "CONFIG_TARGET_x86_64_DEVICE_generic=y" >> "$CONFIG_PATH"
          echo "CONFIG_PACKAGE_luci=y" >> "$CONFIG_PATH"
        fi
        
        # è®¡ç®—é…ç½®æ–‡ä»¶MD5
        CONFIG_MD5=$(md5sum "$CONFIG_PATH" | awk '{print $1}')
        echo "CONFIG_MD5=$CONFIG_MD5" >> $GITHUB_OUTPUT
        
        # åˆ›å»ºç”¨äºŽç¼“å­˜çš„å”¯ä¸€æŒ‡çº¹
        CACHE_KEY_PREFIX="${REPO_BRANCH}-${CONFIG_MD5:0:8}"
        echo "CACHE_KEY_PREFIX=$CACHE_KEY_PREFIX" >> $GITHUB_OUTPUT

    # ä¼˜åŒ–ç¼“å­˜ç­–ç•¥ï¼Œåˆ†å¤šä¸ªå°ç¼“å­˜ä»¥æ»¡è¶³10GBé™åˆ¶
    - name: æ¢å¤å·¥å…·é“¾æ ¸å¿ƒç¼“å­˜
      uses: actions/cache@v3
      id: cache-toolchain-core
      if: inputs.clean_build != 'true'
      with:
        path: |
          ${{ env.WORKDIR }}/toolchain-core
        key: toolchain-core-${{ steps.fingerprint.outputs.CACHE_KEY_PREFIX }}-v6
        restore-keys: |
          toolchain-core-${{ env.REPO_BRANCH }}-

    - name: æ¢å¤å·¥å…·é“¾åº“ç¼“å­˜
      uses: actions/cache@v3
      id: cache-toolchain-libs
      if: inputs.clean_build != 'true'
      with:
        path: |
          ${{ env.WORKDIR }}/toolchain-libs
        key: toolchain-libs-${{ steps.fingerprint.outputs.CACHE_KEY_PREFIX }}-v6
        restore-keys: |
          toolchain-libs-${{ env.REPO_BRANCH }}-

    - name: æ¢å¤å·¥å…·é“¾å¤´æ–‡ä»¶ç¼“å­˜
      uses: actions/cache@v3
      id: cache-toolchain-headers
      if: inputs.clean_build != 'true'
      with:
        path: |
          ${{ env.WORKDIR }}/toolchain-headers
        key: toolchain-headers-${{ steps.fingerprint.outputs.CACHE_KEY_PREFIX }}-v6
        restore-keys: |
          toolchain-headers-${{ env.REPO_BRANCH }}-

    - name: æ¢å¤æž„å»ºç¼“å­˜ï¼ˆåŸºç¡€ï¼‰
      uses: actions/cache@v3
      id: cache-build-base
      if: inputs.clean_build != 'true'
      with:
        path: |
          ${{ env.WORKDIR }}/build-base
        key: build-base-${{ steps.fingerprint.outputs.CACHE_KEY_PREFIX }}-v6
        restore-keys: |
          build-base-${{ env.REPO_BRANCH }}-

    - name: æ¢å¤åŒ…ç¼“å­˜
      uses: actions/cache@v3
      id: cache-packages
      if: inputs.clean_build != 'true'
      with:
        path: |
          ${{ env.WORKDIR }}/packages-cache
        key: packages-${{ steps.fingerprint.outputs.CACHE_KEY_PREFIX }}-v6
        restore-keys: |
          packages-${{ env.REPO_BRANCH }}-

    - name: æ¢å¤ä¸‹è½½ç¼“å­˜
      uses: actions/cache@v3
      id: cache-dl
      if: inputs.clean_build != 'true'
      with:
        path: |
          ${{ env.WORKDIR }}/dl
        key: dl-${{ steps.fingerprint.outputs.CACHE_KEY_PREFIX }}-v6
        restore-keys: |
          dl-${{ env.REPO_BRANCH }}-

    - name: æ¢å¤CCACHEç¼“å­˜
      uses: actions/cache@v3
      id: cache-ccache
      with:
        path: |
          ${{ env.WORKDIR }}/ccache
        key: ccache-${{ steps.fingerprint.outputs.CACHE_KEY_PREFIX }}-v6
        restore-keys: |
          ccache-${{ env.REPO_BRANCH }}-

    - name: æ£€æŸ¥ç¼“å­˜æ¢å¤çŠ¶æ€
      run: |
        echo "ç¼“å­˜æ¢å¤çŠ¶æ€ï¼š"
        echo "å·¥å…·é“¾æ ¸å¿ƒç¼“å­˜: ${{ steps.cache-toolchain-core.outputs.cache-hit == 'true' && 'å‘½ä¸­' || 'æœªå‘½ä¸­' }}"
        echo "å·¥å…·é“¾åº“ç¼“å­˜: ${{ steps.cache-toolchain-libs.outputs.cache-hit == 'true' && 'å‘½ä¸­' || 'æœªå‘½ä¸­' }}"
        echo "å·¥å…·é“¾å¤´æ–‡ä»¶ç¼“å­˜: ${{ steps.cache-toolchain-headers.outputs.cache-hit == 'true' && 'å‘½ä¸­' || 'æœªå‘½ä¸­' }}"
        echo "æž„å»ºåŸºç¡€ç¼“å­˜: ${{ steps.cache-build-base.outputs.cache-hit == 'true' && 'å‘½ä¸­' || 'æœªå‘½ä¸­' }}"
        echo "åŒ…ç¼“å­˜: ${{ steps.cache-packages.outputs.cache-hit == 'true' && 'å‘½ä¸­' || 'æœªå‘½ä¸­' }}"
        echo "ä¸‹è½½ç¼“å­˜: ${{ steps.cache-dl.outputs.cache-hit == 'true' && 'å‘½ä¸­' || 'æœªå‘½ä¸­' }}"
        echo "CCACHEç¼“å­˜: ${{ steps.cache-ccache.outputs.cache-hit == 'true' && 'å‘½ä¸­' || 'æœªå‘½ä¸­' }}"
        
        # æ˜¾ç¤ºç¼“å­˜ç›®å½•å¤§å°
        for dir in toolchain-core toolchain-libs toolchain-headers build-base packages-cache dl ccache; do
          if [ -d "${{ env.WORKDIR }}/$dir" ]; then
            echo "${dir}ç›®å½•å¤§å°: $(du -sh ${{ env.WORKDIR }}/$dir | cut -f1)"
          else
            echo "${dir}ç›®å½•ä¸å­˜åœ¨"
          fi
        done

    - name: å…‹éš†æºä»£ç 
      working-directory: ${{ env.WORKDIR }}
      run: |
        if [ ! -d "openwrt" ]; then
          git clone --depth 1 $REPO_URL -b $REPO_BRANCH openwrt
        fi
        ln -sf ${{ env.WORKDIR }}/openwrt $GITHUB_WORKSPACE/openwrt
        cd openwrt
        
        # æ¢å¤å·¥å…·é“¾
        mkdir -p staging_dir
        if [ -d "${{ env.WORKDIR }}/toolchain-core" ]; then
          echo "æ¢å¤å·¥å…·é“¾æ ¸å¿ƒ..."
          cp -a ${{ env.WORKDIR }}/toolchain-core/* staging_dir/ 2>/dev/null || true
        fi
        if [ -d "${{ env.WORKDIR }}/toolchain-libs" ]; then
          echo "æ¢å¤å·¥å…·é“¾åº“..."
          cp -a ${{ env.WORKDIR }}/toolchain-libs/* staging_dir/ 2>/dev/null || true
        fi
        if [ -d "${{ env.WORKDIR }}/toolchain-headers" ]; then
          echo "æ¢å¤å·¥å…·é“¾å¤´æ–‡ä»¶..."
          cp -a ${{ env.WORKDIR }}/toolchain-headers/* staging_dir/ 2>/dev/null || true
        fi
        
        # æ¢å¤æž„å»ºç›®å½•
        if [ -d "${{ env.WORKDIR }}/build-base" ]; then
          echo "æ¢å¤æž„å»ºåŸºç¡€..."
          mkdir -p build_dir
          cp -a ${{ env.WORKDIR }}/build-base/* build_dir/ 2>/dev/null || true
        fi
        
        # æ¢å¤åŒ…ç›®å½•
        if [ -d "${{ env.WORKDIR }}/packages-cache" ]; then
          echo "æ¢å¤åŒ…ç¼“å­˜..."
          mkdir -p bin
          cp -a ${{ env.WORKDIR }}/packages-cache/* bin/ 2>/dev/null || true
        fi
        
        # æ¢å¤ä¸‹è½½ç›®å½•
        if [ -d "${{ env.WORKDIR }}/dl" ]; then
          echo "æ¢å¤ä¸‹è½½ç›®å½•..."
          ln -sfn ${{ env.WORKDIR }}/dl dl
        fi
        
        # é…ç½®feeds
        curl -L -o feeds.conf.default "$FEEDS_CONF_URL" || echo "ä½¿ç”¨ä»“åº“é»˜è®¤feedsé…ç½®"

    - name: é…ç½®ç¼–è¯‘çŽ¯å¢ƒ
      run: |
        cd ${{ env.WORKDIR }}/openwrt
        
        # åˆ›å»ºdiyè„šæœ¬
        echo '#!/bin/bash' > $GITHUB_WORKSPACE/diy-part1.sh
        echo '# Feeds å·²é€šè¿‡ FEEDS_CONF_URL é…ç½®' >> $GITHUB_WORKSPACE/diy-part1.sh
        chmod +x $GITHUB_WORKSPACE/diy-part1.sh
        
        echo '#!/bin/bash' > $GITHUB_WORKSPACE/diy-part2.sh
        echo 'sed -i "s/OpenWrt /OpenWrt_AutoBuild /" package/lean/default-settings/files/zzz-default-settings' >> $GITHUB_WORKSPACE/diy-part2.sh
        chmod +x $GITHUB_WORKSPACE/diy-part2.sh
        
        # æ‰§è¡Œdiyè„šæœ¬
        $GITHUB_WORKSPACE/$DIY_P1_SH
        
        # æ›´æ–°feeds
        ./scripts/feeds update -a
        ./scripts/feeds install -a
        
        # åº”ç”¨é…ç½®
        cp $GITHUB_WORKSPACE/$CONFIG_FILE ./.config
        $GITHUB_WORKSPACE/$DIY_P2_SH
        
        # ä¼˜åŒ–ç¼–è¯‘é…ç½®
        echo "CONFIG_CCACHE=y" >> .config
        echo "CONFIG_DEVEL=y" >> .config
        echo "CONFIG_AUTOREMOVE=n" >> .config
        echo "CONFIG_AUTOREBUILD=n" >> .config
        echo "CONFIG_IB=y" >> .config
        echo "CONFIG_SDK=y" >> .config
        
        # å›ºä»¶ç”Ÿæˆé…ç½®
        echo "CONFIG_TARGET_ROOTFS_SQUASHFS=y" >> .config
        if grep -q "CONFIG_TARGET_x86=y" .config; then
          echo "CONFIG_GRUB_IMAGES=y" >> .config
          echo "CONFIG_TARGET_IMAGES_GZIP=y" >> .config
        fi
        
        make defconfig

    - name: é…ç½®CCACHE
      run: |
        mkdir -p ${{ env.WORKDIR }}/ccache
        export CCACHE_DIR=${{ env.WORKDIR }}/ccache
        ccache -o cache_dir=$CCACHE_DIR
        ccache -o compression=true
        ccache -o compression_level=6
        ccache -o max_size=5G  # å‡å°åˆ°5Gä»¥é€‚åº”10GBé™åˆ¶
        ccache -o hash_dir=false
        ccache -o sloppiness=file_macro,locale,include_file_mtime,include_file_ctime,time_macros,file_stat_matches_ctime
        ccache -z
        echo "CCACHE_DIR=$CCACHE_DIR" >> $GITHUB_ENV
        echo "PATH=/usr/lib/ccache:$PATH" >> $GITHUB_ENV

    - name: å¼€å¯SSHè°ƒè¯•
      uses: mxschmitt/action-tmate@v3
      if: github.event.inputs.ssh == 'true'

    - name: æ™ºèƒ½ç¼–è¯‘å›ºä»¶
      id: compile
      run: |
        cd ${{ env.WORKDIR }}/openwrt
        
        # è®¾ç½®çŽ¯å¢ƒå˜é‡
        export CCACHE_DIR=${{ env.WORKDIR }}/ccache
        export PATH="/usr/lib/ccache:$PATH"
        
        # æ£€æŸ¥æ˜¯å¦éœ€è¦å®Œæ•´ç¼–è¯‘
        NEED_FULL_BUILD=false
        TOOLCHAIN_COMPLETE=false
        
        # æ£€æŸ¥å·¥å…·é“¾æ˜¯å¦å®Œæ•´
        if [ -f "staging_dir/host/bin/gcc" ] && [ -d "staging_dir/toolchain"* ]; then
          TOOLCHAIN_COMPLETE=true
        fi
        
        if [ "${{ inputs.clean_build }}" = "true" ] || [ "$TOOLCHAIN_COMPLETE" = "false" ]; then
          NEED_FULL_BUILD=true
          echo "éœ€è¦å®Œæ•´ç¼–è¯‘..."
        fi
        
        # ä¸‹è½½ä¾èµ–
        echo "ä¸‹è½½ä¾èµ–åŒ…..."
        make download -j8 || make download -j1 V=s
        
        if [ "$NEED_FULL_BUILD" = "true" ]; then
          echo "æ‰§è¡Œå®Œæ•´ç¼–è¯‘..."
          
          # ç¼–è¯‘å·¥å…·é“¾
          make -j$(nproc) tools/compile V=s || make -j1 V=s tools/compile
          make -j$(nproc) toolchain/compile V=s || make -j1 V=s toolchain/compile
          
          # å®Œæ•´ç¼–è¯‘
          make -j$(nproc) V=s || make -j1 V=s
        else
          echo "æ‰§è¡Œå¢žé‡ç¼–è¯‘..."
          
          # åªç¼–è¯‘å¿…è¦éƒ¨åˆ†
          make -j$(nproc) V=s || make -j1 V=s
        fi
        
        echo "status=success" >> $GITHUB_OUTPUT
        ccache -s

    - name: å¤‡ä»½ç¼“å­˜
      if: always()
      run: |
        cd ${{ env.WORKDIR }}/openwrt
        
        # å¤‡ä»½å·¥å…·é“¾ï¼ˆåˆ†æˆå¤šä¸ªå°ç¼“å­˜ï¼‰
        if [ -d "staging_dir" ]; then
          # å¤‡ä»½æ ¸å¿ƒå·¥å…·é“¾
          mkdir -p ${{ env.WORKDIR }}/toolchain-core
          for dir in staging_dir/host staging_dir/toolchain-*; do
            if [ -d "$dir" ]; then
              # åªå¤‡ä»½binå’Œlibç›®å½•çš„æ ¸å¿ƒæ–‡ä»¶
              mkdir -p ${{ env.WORKDIR }}/toolchain-core/$(basename $dir)
              if [ -d "$dir/bin" ]; then
                cp -a $dir/bin ${{ env.WORKDIR }}/toolchain-core/$(basename $dir)/
              fi
              if [ -d "$dir/lib" ]; then
                cp -a $dir/lib ${{ env.WORKDIR }}/toolchain-core/$(basename $dir)/
              fi
            fi
          done
          
          # å¤‡ä»½å·¥å…·é“¾åº“
          mkdir -p ${{ env.WORKDIR }}/toolchain-libs
          find staging_dir -path "*/lib/*.so*" -o -path "*/lib/*.a" | tar cf - -T - | tar xf - -C ${{ env.WORKDIR }}/toolchain-libs
          
          # å¤‡ä»½å·¥å…·é“¾å¤´æ–‡ä»¶
          mkdir -p ${{ env.WORKDIR }}/toolchain-headers
          find staging_dir -path "*/include/*" | tar cf - -T - | tar xf - -C ${{ env.WORKDIR }}/toolchain-headers
        fi
        
        # å¤‡ä»½æž„å»ºç›®å½•ï¼ˆåªä¿ç•™å¿…è¦æ–‡ä»¶ï¼‰
        if [ -d "build_dir" ]; then
          mkdir -p ${{ env.WORKDIR }}/build-base
          # åªå¤‡ä»½hostç›®å½•å’Œå·¥å…·é“¾æž„å»ºç›®å½•
          if [ -d "build_dir/host" ]; then
            cp -a build_dir/host ${{ env.WORKDIR }}/build-base/
          fi
          for dir in build_dir/toolchain-*; do
            if [ -d "$dir" ]; then
              mkdir -p ${{ env.WORKDIR }}/build-base/$(basename $dir)
              # åªå¤åˆ¶ç¼–è¯‘åŽçš„äºŒè¿›åˆ¶æ–‡ä»¶
              find $dir -type f -executable | tar cf - -T - | tar xf - -C ${{ env.WORKDIR }}/build-base/$(basename $dir)
            fi
          done
        fi
        
        # å¤‡ä»½åŒ…ç›®å½•
        if [ -d "bin" ]; then
          mkdir -p ${{ env.WORKDIR }}/packages-cache
          cp -a bin/* ${{ env.WORKDIR }}/packages-cache/
        fi
        
        # æ˜¾ç¤ºç¼“å­˜å¤§å°
        echo "ç¼“å­˜å¤§å°ï¼š"
        for dir in toolchain-core toolchain-libs toolchain-headers build-base packages-cache dl ccache; do
          if [ -d "${{ env.WORKDIR }}/$dir" ]; then
            echo "${dir}: $(du -sh ${{ env.WORKDIR }}/$dir | cut -f1)"
          fi
        done

    - name: æ•´ç†å›ºä»¶æ–‡ä»¶
      id: organize
      if: steps.compile.outputs.status == 'success' && !cancelled()
      run: |
        cd ${{ env.WORKDIR }}/openwrt/bin/targets/*/*
        rm -rf packages
        echo "FIRMWARE=$PWD" >> $GITHUB_ENV
        echo "status=success" >> $GITHUB_OUTPUT

    - name: è®¾ç½®æ—¥æœŸå˜é‡
      id: date
      if: steps.organize.outputs.status == 'success' && !cancelled()
      run: echo "TODAY=$(date +'%Y%m%d%H%M')" >> $GITHUB_OUTPUT

    - name: ä¸Šä¼ å›ºä»¶
      uses: actions/upload-artifact@main
      if: steps.organize.outputs.status == 'success' && !cancelled()
      with:
        name: OpenWrt_firmware_${{ steps.fingerprint.outputs.CONFIG_MD5 }}_${{ steps.date.outputs.TODAY }}
        path: ${{ env.FIRMWARE }}

    - name: ç”Ÿæˆå‘å¸ƒæ ‡ç­¾
      id: tag
      if: steps.organize.outputs.status == 'success' && env.UPLOAD_RELEASE == 'true' && !cancelled()
      run: |
        echo "RELEASE_TAG=$(date +"%Y.%m.%d-%H%M")" >> $GITHUB_OUTPUT
        echo "## OpenWrtå›ºä»¶æž„å»ºå®Œæˆ ðŸ“¦" > release.txt
        echo "ðŸ“… æž„å»ºæ—¶é—´: $(date +"%Y-%m-%d %H:%M")" >> release.txt
        echo "âš ï¸ è¯·åœ¨åˆ·æœºå‰å…ˆåšå¥½å¤‡ä»½ï¼" >> release.txt
        echo "status=success" >> $GITHUB_OUTPUT

    - name: ä¸Šä¼ å›ºä»¶åˆ°Release
      uses: softprops/action-gh-release@v2
      if: steps.tag.outputs.status == 'success' && !cancelled()
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ steps.tag.outputs.RELEASE_TAG }}
        body_path: release.txt
        files: ${{ env.FIRMWARE }}/*

    - name: åˆ é™¤æ—§çš„Releases
      uses: dev-drprasad/delete-older-releases@master
      if: env.UPLOAD_RELEASE == 'true' && !cancelled()
      with:
        keep_latest: 3
        delete_tags: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
