name: å…¨æ–°ç¼–è¯‘ç¬¬å››ç‰ˆ

on:
  repository_dispatch:
  workflow_dispatch:
    inputs:
      ssh:
        description: 'SSHè°ƒè¯•'
        required: false
        default: 'false'
      clean_build:
        description: 'æ¸…ç†ç¼“å­˜å¹¶å®Œå…¨é‡æ–°ç¼–è¯‘'
        required: false
        default: 'false'
      config_file:
        description: 'é…ç½®æ–‡ä»¶'
        required: false
        default: 'å¢é‡ç¼“å­˜ä¼˜åŒ–.config'

env:
  REPO_URL: https://github.com/coolsnowwolf/lede
  REPO_BRANCH: master
  FEEDS_CONF: feeds.conf.default
  CONFIG_FILE: ${{ github.event.inputs.config_file || 'å¢é‡ç¼“å­˜ä¼˜åŒ–.config' }}
  DIY_P1_SH: diy-part1.sh
  DIY_P2_SH: diy-part2.sh
  UPLOAD_BIN_DIR: false
  UPLOAD_FIRMWARE: true
  UPLOAD_RELEASE: true
  TZ: Asia/Shanghai
  CCACHE_DIR: /workdir/ccache

jobs:
  build:
    runs-on: ubuntu-22.04
    if: github.event.repository.owner.id == github.event.sender.id || !github.event.sender.id

    steps:
      - name: æ˜¾ç¤ºç£ç›˜ç©ºé—´ä½¿ç”¨æƒ…å†µ(ä¼˜åŒ–å‰)
        run: |
          echo "ä¼˜åŒ–å‰ç£ç›˜ç©ºé—´æƒ…å†µï¼š"
          df -hT

      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@main

      - name: ä¼˜åŒ–ç£ç›˜ç©ºé—´
        uses: easimon/maximize-build-space@master
        with:
          root-reserve-mb: 2048
          swap-size-mb: 1
          remove-dotnet: 'true'
          remove-android: 'true'
          remove-haskell: 'true'
          remove-codeql: 'true'
          remove-docker-images: 'true'
          build-mount-path: '/workdir'

      - name: æ¸…ç†Dockerèµ„æº
        run: |
          sudo docker image prune --all --force
          sudo rm -rf /etc/apt/sources.list.d/* /usr/share/dotnet /usr/local/lib/android /opt/ghc /usr/local/share/boost /opt/hostedtoolcache/CodeQL

      - name: æ˜¾ç¤ºç£ç›˜ç©ºé—´ä½¿ç”¨æƒ…å†µ(ä¼˜åŒ–å)
        run: |
          echo "ä¼˜åŒ–åç£ç›˜ç©ºé—´æƒ…å†µï¼š"
          df -hT
          echo "å·¥ä½œç›®å½•ç©ºé—´æƒ…å†µï¼š"
          df -hT /workdir

      - name: åˆå§‹åŒ–ç¯å¢ƒ
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          sudo -E apt-get -qq update
          sudo -E apt-get -qq install $(curl -fsSL https://raw.githubusercontent.com/coolsnowwolf/lede/master/prereq-build.mk | grep -o 'package-y += .*' | sed 's/package-y += //g')
          sudo -E apt-get -qq install ack antlr3 asciidoc autoconf automake autopoint binutils bison build-essential \
            bzip2 ccache cmake cpio curl device-tree-compiler fastjar flex gawk gettext gcc-multilib g++-multilib \
            git gperf haveged help2man intltool libc6-dev-i386 libelf-dev libglib2.0-dev libgmp3-dev libltdl-dev \
            libmpc-dev libmpfr-dev libncurses5-dev libncursesw5-dev libreadline-dev libssl-dev libtool lrzsz \
            mkisofs msmtp nano ninja-build p7zip p7zip-full patch pkgconf python2.7 python3 python3-pyelftools \
            libpython3-dev qemu-utils rsync scons squashfs-tools subversion swig texinfo uglifyjs upx-ucl unzip \
            vim wget xmlto xxd zlib1g-dev python3-setuptools jq
          sudo -E apt-get -qq autoremove --purge
          sudo -E apt-get -qq clean
          sudo timedatectl set-timezone "$TZ"
          echo "WORKDIR=/workdir" >> $GITHUB_ENV

      - name: å‡†å¤‡ç¼“å­˜ç›®å½•
        run: |
          # åˆ›å»ºå¹¶è®¾ç½®æ­£ç¡®æƒé™
          mkdir -p /workdir/package_info
          mkdir -p /workdir/dl_cache
          mkdir -p ${{ env.CCACHE_DIR }}
          mkdir -p /workdir/build_state
          chmod -R 777 /workdir

      - name: å…‹éš†æºä»£ç 
        working-directory: /workdir
        run: |
          df -hT $PWD
          git clone --depth 1 $REPO_URL -b $REPO_BRANCH openwrt
          ln -sf /workdir/openwrt $GITHUB_WORKSPACE/openwrt
          cd openwrt
          echo "é¡¹ç›®ç‰ˆæœ¬: $(git rev-parse HEAD)" > /workdir/source_version.txt
          find . -type f -name "*.sh" -exec chmod +x {} \;

      - name: æ¢å¤åŒ…å“ˆå¸Œä¿¡æ¯ç¼“å­˜
        uses: actions/cache@v3
        id: cache-package-info
        if: inputs.clean_build != 'true'
        with:
          path: |
            /workdir/package_info
            /workdir/build_state
          key: package-info-${{ env.REPO_URL }}-${{ env.REPO_BRANCH }}
          restore-keys: |
            package-info-${{ env.REPO_URL }}-${{ env.REPO_BRANCH }}

      - name: æ¢å¤å·¥å…·é“¾ç¼“å­˜
        uses: actions/cache@v3
        id: cache-toolchain
        if: inputs.clean_build != 'true'
        with:
          path: |
            /workdir/openwrt/staging_dir/toolchain-*
            /workdir/openwrt/staging_dir/host
            /workdir/openwrt/build_dir/toolchain-*
          key: toolchain-${{ env.REPO_URL }}-${{ env.REPO_BRANCH }}
          restore-keys: |
            toolchain-${{ env.REPO_URL }}-${{ env.REPO_BRANCH }}

      - name: æ¢å¤ç›®æ ‡æ„å»ºç¼“å­˜
        uses: actions/cache@v3
        id: cache-target-build
        if: inputs.clean_build != 'true'
        with:
          path: |
            /workdir/openwrt/staging_dir/target-*
            /workdir/openwrt/build_dir/target-*
            /workdir/openwrt/build_dir/hostpkg
            /workdir/openwrt/tmp
            /workdir/openwrt/.config.old
          key: target-build-${{ env.REPO_URL }}-${{ env.REPO_BRANCH }}-${{ hashFiles(format('{0}/{1}', github.workspace, env.CONFIG_FILE)) }}
          restore-keys: |
            target-build-${{ env.REPO_URL }}-${{ env.REPO_BRANCH }}-

      - name: æ¢å¤å·²ç¼–è¯‘åŒ…ç¼“å­˜
        uses: actions/cache@v3
        id: cache-packages
        if: inputs.clean_build != 'true'
        with:
          path: |
            /workdir/openwrt/bin/packages
            /workdir/openwrt/bin/targets/*/packages
          key: packages-bin-${{ env.REPO_URL }}-${{ env.REPO_BRANCH }}-${{ hashFiles(format('{0}/{1}', github.workspace, env.CONFIG_FILE)) }}
          restore-keys: |
            packages-bin-${{ env.REPO_URL }}-${{ env.REPO_BRANCH }}-

      - name: æ¢å¤ä¸‹è½½ç¼“å­˜
        uses: actions/cache@v3
        id: cache-dl
        with:
          path: |
            /workdir/dl_cache
          key: dl-${{ env.REPO_URL }}-${{ env.REPO_BRANCH }}
          restore-keys: |
            dl-${{ env.REPO_URL }}-${{ env.REPO_BRANCH }}

      - name: æ¢å¤CCACHEç¼“å­˜
        uses: actions/cache@v3
        with:
          path: ${{ env.CCACHE_DIR }}
          key: ccache-${{ env.REPO_URL }}-${{ env.REPO_BRANCH }}
          restore-keys: |
            ccache-${{ env.REPO_URL }}-${{ env.REPO_BRANCH }}

      - name: æ£€æŸ¥ç¼“å­˜æ¢å¤çŠ¶æ€
        run: |
          echo "åŒ…å“ˆå¸Œä¿¡æ¯ç¼“å­˜æ¢å¤çŠ¶æ€: ${{ steps.cache-package-info.outputs.cache-hit == 'true' && 'æˆåŠŸ' || 'æœªæ‰¾åˆ°ç¼“å­˜' }}"
          echo "å·¥å…·é“¾ç¼“å­˜æ¢å¤çŠ¶æ€: ${{ steps.cache-toolchain.outputs.cache-hit == 'true' && 'æˆåŠŸ' || 'æœªæ‰¾åˆ°ç¼“å­˜' }}"
          echo "ç›®æ ‡æ„å»ºç¼“å­˜æ¢å¤çŠ¶æ€: ${{ steps.cache-target-build.outputs.cache-hit == 'true' && 'æˆåŠŸ' || 'æœªæ‰¾åˆ°ç¼“å­˜' }}"
          echo "å·²ç¼–è¯‘åŒ…ç¼“å­˜æ¢å¤çŠ¶æ€: ${{ steps.cache-packages.outputs.cache-hit == 'true' && 'æˆåŠŸ' || 'æœªæ‰¾åˆ°ç¼“å­˜' }}"
          echo "ä¸‹è½½ç¼“å­˜æ¢å¤çŠ¶æ€: ${{ steps.cache-dl.outputs.cache-hit == 'true' && 'æˆåŠŸ' || 'æœªæ‰¾åˆ°ç¼“å­˜' }}"
          
          # æ£€æŸ¥ç›®å½•å¤§å°
          echo "å·¥å…·é“¾ç¼“å­˜å¤§å°:"
          du -sh /workdir/openwrt/staging_dir/toolchain-* 2>/dev/null || echo "ç›®å½•ä¸å­˜åœ¨"
          echo "ç›®æ ‡æ„å»ºç¼“å­˜å¤§å°:"
          du -sh /workdir/openwrt/build_dir/target-* 2>/dev/null || echo "ç›®å½•ä¸å­˜åœ¨"
          echo "å·²ç¼–è¯‘åŒ…ç¼“å­˜å¤§å°:"
          du -sh /workdir/openwrt/bin/packages 2>/dev/null || echo "ç›®å½•ä¸å­˜åœ¨"
          
          # æ£€æŸ¥åŒ…å“ˆå¸Œä¿¡æ¯
          if [ -f "/workdir/package_info/package_hashes.json" ]; then
            echo "å“ˆå¸Œæ–‡ä»¶å­˜åœ¨ï¼Œæ˜¾ç¤ºå‰10è¡Œå†…å®¹:"
            head -n 10 /workdir/package_info/package_hashes.json
            echo "å“ˆå¸Œæ–‡ä»¶å¤§å°: $(du -h /workdir/package_info/package_hashes.json | cut -f1)"
            echo "å“ˆå¸Œæ¡ç›®æ•°é‡: $(grep -c ":" /workdir/package_info/package_hashes.json)"
          else
            echo "å“ˆå¸Œæ–‡ä»¶ä¸å­˜åœ¨ï¼Œå°†åœ¨é¦–æ¬¡ç¼–è¯‘æ—¶åˆ›å»º"
          fi

      - name: å‡†å¤‡ä¸‹è½½ç¼“å­˜
        run: |
          mkdir -p /workdir/openwrt/dl
          if [ -d "/workdir/dl_cache" ] && [ "$(ls -A /workdir/dl_cache)" ]; then
            echo "å¤åˆ¶ä¸‹è½½ç¼“å­˜åˆ°dlç›®å½•..."
            cp -r /workdir/dl_cache/* /workdir/openwrt/dl/ || true
          fi
          chmod -R 755 /workdir/openwrt/dl

      - name: åŠ è½½è‡ªå®šä¹‰feeds
        run: |
          [ -e $FEEDS_CONF ] && mv $FEEDS_CONF /workdir/openwrt/feeds.conf.default
          chmod +x $DIY_P1_SH
          cd /workdir/openwrt
          $GITHUB_WORKSPACE/$DIY_P1_SH

      - name: æ›´æ–°feeds
        run: |
          cd /workdir/openwrt
          ./scripts/feeds update -a

      - name: å®‰è£…feeds
        run: |
          cd /workdir/openwrt
          ./scripts/feeds install -a

      - name: åŠ è½½è‡ªå®šä¹‰é…ç½®
        run: |
          [ -e files ] && mv files /workdir/openwrt/files
          if [ ! -e "$CONFIG_FILE" ]; then
            echo "Error: $CONFIG_FILE not found!" >&2
            exit 1
          fi
          mv $CONFIG_FILE /workdir/openwrt/.config
          chmod +x $DIY_P2_SH
          cd /workdir/openwrt
          $GITHUB_WORKSPACE/$DIY_P2_SH

      - name: å¼€å¯SSHè°ƒè¯•
        uses: mxschmitt/action-tmate@v3
        if: github.event.inputs.ssh == 'true'

      - name: é…ç½®å¢é‡ç¼–è¯‘é€‰é¡¹
        run: |
          cd /workdir/openwrt
          # ç¦ç”¨è‡ªåŠ¨é‡å»ºå’Œè‡ªåŠ¨ç§»é™¤
          echo "CONFIG_AUTOREMOVE=n" >> .config
          echo "CONFIG_AUTOREBUILD=n" >> .config
          # åº”ç”¨é…ç½®
          make defconfig

      - name: éªŒè¯ç¼“å­˜åŒ…
        if: steps.cache-packages.outputs.cache-hit == 'true' && inputs.clean_build != 'true'
        run: |
          cd /workdir/openwrt
          
          # æå–æ‰€æœ‰éœ€è¦çš„åŒ…
          grep "^CONFIG_PACKAGE_" .config | sed 's/CONFIG_PACKAGE_\(.*\)=y/\1/' > /tmp/needed_packages.txt
          
          # æ£€æŸ¥å“ªäº›åŒ…å·²å­˜åœ¨
          mkdir -p /workdir/build_state
          echo "æ£€æŸ¥å·²æœ‰åŒ…..."
          > /workdir/build_state/missing_packages.txt
          > /workdir/build_state/existing_packages.txt
          
          for pkg in $(cat /tmp/needed_packages.txt); do
            if find bin/packages -name "*${pkg}*.ipk" | grep -q .; then
              echo "$pkg: å·²å­˜åœ¨"
              echo "$pkg" >> /workdir/build_state/existing_packages.txt
            else
              echo "$pkg: éœ€è¦ç¼–è¯‘"
              echo "$pkg" >> /workdir/build_state/missing_packages.txt
            fi
          done
          
          TOTAL_PKGS=$(cat /tmp/needed_packages.txt | wc -l)
          EXISTING_PKGS=$(cat /workdir/build_state/existing_packages.txt | wc -l)
          MISSING_PKGS=$(cat /workdir/build_state/missing_packages.txt | wc -l)
          
          echo "æ€»åŒ…æ•°: $TOTAL_PKGS"
          echo "å·²å­˜åœ¨åŒ…æ•°: $EXISTING_PKGS"
          echo "ç¼ºå¤±åŒ…æ•°: $MISSING_PKGS"
          
          # è®¡ç®—ç¼“å­˜å‘½ä¸­ç‡
          if [ $TOTAL_PKGS -gt 0 ]; then
            HIT_RATE=$((EXISTING_PKGS * 100 / TOTAL_PKGS))
            echo "ç¼“å­˜å‘½ä¸­ç‡: ${HIT_RATE}%"
            echo "CACHE_HIT_RATE=${HIT_RATE}" >> $GITHUB_ENV
          else
            echo "æœªæ‰¾åˆ°éœ€è¦çš„åŒ…"
            echo "CACHE_HIT_RATE=0" >> $GITHUB_ENV
          fi

      - name: ä¸‹è½½è½¯ä»¶åŒ…
        id: package
        run: |
          cd /workdir/openwrt
          make defconfig
          echo "å¼€å§‹ä¸‹è½½è½¯ä»¶åŒ…..."
          make download -j8 || make download -j1 V=s
          
          # å¤‡ä»½ä¸‹è½½çš„åŒ…åˆ°ç¼“å­˜ç›®å½•
          echo "å¤‡ä»½ä¸‹è½½çš„åŒ…åˆ°ç¼“å­˜ç›®å½•..."
          mkdir -p /workdir/dl_cache
          cp -rf /workdir/openwrt/dl/* /workdir/dl_cache/ || true

      - name: é…ç½®CCACHE
        run: |
          cd /workdir/openwrt
          echo "é…ç½®CCACHEå‚æ•°"
          mkdir -p ${{ env.CCACHE_DIR }}
          ccache -o cache_dir=${{ env.CCACHE_DIR }}
          ccache -o max_size=5G
          ccache -z

      - name: æ£€æŸ¥æ„å»ºç¯å¢ƒå’Œç›®å½•ç»“æ„
        run: |
          cd /workdir/openwrt
          
          # æ£€æŸ¥ç›®å½•ç»“æ„
          echo "æ£€æŸ¥ç›®å½•ç»“æ„..."
          find bin -type d | sort
          find staging_dir -maxdepth 2 -type d | sort
          find build_dir -maxdepth 2 -type d | sort
          
          # æ£€æŸ¥å·¥å…·é“¾
          if [ -d "staging_dir/toolchain-"* ]; then
            echo "å·¥å…·é“¾å·²å­˜åœ¨:"
            ls -la staging_dir/toolchain-*/ | head -10
          else
            echo "å·¥å…·é“¾ä¸å­˜åœ¨ï¼Œå°†åœ¨ç¼–è¯‘é˜¶æ®µåˆ›å»º"
          fi
          
          # æ£€æŸ¥å·²ç¼–è¯‘çš„åŒ…
          if [ -d "bin/packages" ]; then
            echo "å·²ç¼–è¯‘çš„åŒ…æ•°é‡:"
            find bin/packages -name "*.ipk" | wc -l
            echo "åŒ…ç¤ºä¾‹:"
            find bin/packages -name "*.ipk" | head -5
          else
            echo "æ²¡æœ‰æ‰¾åˆ°å·²ç¼–è¯‘çš„åŒ…"
          fi

      - name: æ™ºèƒ½å¢é‡ç¼–è¯‘å›ºä»¶
        id: compile
        run: |
          cd /workdir/openwrt
          
          # è®¾ç½®CCACHEç¯å¢ƒå˜é‡
          export CCACHE_DIR=${{ env.CCACHE_DIR }}
          export PATH="/usr/lib/ccache:$PATH"
          
          # å¦‚æœæ˜¯å¼ºåˆ¶å®Œå…¨é‡æ–°ç¼–è¯‘
          if [ "${{ github.event.inputs.clean_build }}" = "true" ]; then
            echo "è¿›è¡Œå®Œå…¨é‡æ–°ç¼–è¯‘..."
            make -j$(nproc) || make -j1 V=s
            echo "status=success" >> $GITHUB_OUTPUT
            
            # æ¸…ç©ºæ—§çš„å“ˆå¸Œæ–‡ä»¶
            rm -f /workdir/package_info/package_hashes.json
            mkdir -p /workdir/package_info
            
            # æ›´æ–°åŒ…å“ˆå¸Œ
            ./scripts/update_package_hashes.sh
            
            exit 0
          fi
          
          # æå–å½“å‰é…ç½®çš„æ‰€æœ‰åŒ…
          mkdir -p /workdir/package_list
          grep "^CONFIG_PACKAGE" .config | sort > /workdir/package_list/current_packages.txt
          
          # åˆ›å»ºåŒ…å“ˆå¸Œç®¡ç†è„šæœ¬
          mkdir -p /workdir/package_info
          
          # åˆ›å»ºåŒ…å“ˆå¸Œæ›´æ–°è„šæœ¬
          cat << 'EOF' > ./scripts/update_package_hashes.sh
          #!/bin/bash
          
          # åˆ›å»ºæ–°çš„å“ˆå¸Œæ–‡ä»¶
          echo "{" > /workdir/package_info/new_hashes.json
          
          # å¤„ç†æ‰€æœ‰åŒ…
          for PKG in $(grep "^CONFIG_PACKAGE" .config | sed 's/CONFIG_PACKAGE_\(.*\)=y/\1/'); do
            PKG_DIR=$(find package feeds -type d -name "$PKG" | head -n 1)
            if [ -n "$PKG_DIR" ]; then
              # è®¡ç®—å½“å‰æºç å“ˆå¸Œ
              CUR_HASH=$(find "$PKG_DIR" -type f -not -path "*/.git/*" -exec sha256sum {} \; | sort | sha256sum | awk '{print $1}')
              echo "  \"$PKG\": \"$CUR_HASH\"," >> /workdir/package_info/new_hashes.json
            fi
          done
          
          # å®Œæˆæ–°å“ˆå¸Œæ–‡ä»¶
          sed -i '$ s/,$//' /workdir/package_info/new_hashes.json
          echo "}" >> /workdir/package_info/new_hashes.json
          
          # æ›´æ–°å“ˆå¸Œæ–‡ä»¶
          mv /workdir/package_info/new_hashes.json /workdir/package_info/package_hashes.json
          EOF
          
          chmod +x ./scripts/update_package_hashes.sh
          
          # åŠ è½½å’Œæ›´æ–°åŒ…å“ˆå¸Œ
          NEED_FULL_BUILD=0
          
          if [ ! -f "/workdir/package_info/package_hashes.json" ]; then
            echo "é¦–æ¬¡è¿è¡Œï¼Œåˆ›å»ºåŒ…å“ˆå¸Œæ–‡ä»¶..."
            echo "{}" > /workdir/package_info/package_hashes.json
            NEED_FULL_BUILD=1
          fi
          
          # æå–å“ˆå¸Œåˆ°ä¸´æ—¶æ–‡ä»¶ä»¥ä¾¿æ›´å®¹æ˜“å¤„ç†
          if [ -f "/workdir/package_info/package_hashes.json" ]; then
            # å°†JSONè½¬æ¢ä¸ºkey:valueæ ¼å¼ä¾¿äºå¤„ç†
            cat /workdir/package_info/package_hashes.json | grep '"' | sed 's/[",]//g' | sed 's/^ *//g' | tr ':' ' ' > /workdir/package_info/hash_list.txt || true
          fi
          
          # æ£€æŸ¥æ˜¯å¦å­˜åœ¨ç¼–è¯‘çŠ¶æ€
          if [ -f "/workdir/build_state/compiled_config.md5" ]; then
            CURRENT_CONFIG_MD5=$(md5sum .config | awk '{print $1}')
            PREVIOUS_CONFIG_MD5=$(cat /workdir/build_state/compiled_config.md5)
            
            if [ "$CURRENT_CONFIG_MD5" != "$PREVIOUS_CONFIG_MD5" ]; then
              echo "é…ç½®æ–‡ä»¶å·²æ›´æ”¹ï¼Œè®°å½•å·®å¼‚..."
              # å¦‚æœé…ç½®å·®å¼‚è¾ƒå¤§ï¼Œå¯èƒ½éœ€è¦å®Œæ•´æ„å»º
              CONFIG_DIFF_COUNT=$(diff -y --suppress-common-lines <(grep "^CONFIG_" .config | sort) <(grep "^CONFIG_" /workdir/build_state/previous_config | sort 2>/dev/null || echo "") | wc -l)
              echo "é…ç½®å·®å¼‚é¡¹: $CONFIG_DIFF_COUNT"
              
              if [ $CONFIG_DIFF_COUNT -gt 50 ]; then
                echo "é…ç½®å˜åŒ–è¾ƒå¤§ï¼Œå»ºè®®å®Œæ•´æ„å»º"
                NEED_FULL_BUILD=1
              fi
            else
              echo "é…ç½®æ–‡ä»¶æœªæ›´æ”¹"
            fi
          else
            echo "æœªæ‰¾åˆ°å…ˆå‰çš„ç¼–è¯‘çŠ¶æ€ï¼Œå°†è¿›è¡Œå®Œæ•´æ„å»º"
            NEED_FULL_BUILD=1
          fi
          
          if [ "$NEED_FULL_BUILD" = "1" ] || [ ! -f "/workdir/package_list/previous_packages.txt" ]; then
            echo "é¦–æ¬¡è¿è¡Œæˆ–éœ€è¦å®Œæ•´æ„å»º..."
            make -j$(nproc) || make -j1 V=s
            
            # æ›´æ–°åŒ…å“ˆå¸Œ
            ./scripts/update_package_hashes.sh
            
            # ä¿å­˜å½“å‰åŒ…åˆ—è¡¨å’Œé…ç½®
            cp /workdir/package_list/current_packages.txt /workdir/package_list/previous_packages.txt
            mkdir -p /workdir/build_state
            cp .config /workdir/build_state/previous_config
            md5sum .config | awk '{print $1}' > /workdir/build_state/compiled_config.md5
          else
            echo "æ£€æµ‹å¢é‡ç¼–è¯‘..."
            
            # æ¯”è¾ƒåŒ…åˆ—è¡¨å·®å¼‚
            comm -13 /workdir/package_list/previous_packages.txt /workdir/package_list/current_packages.txt > /workdir/package_list/added_packages.txt
            comm -23 /workdir/package_list/previous_packages.txt /workdir/package_list/current_packages.txt > /workdir/package_list/removed_packages.txt
            
            # ç”Ÿæˆç¼–è¯‘åˆ—è¡¨
            > /workdir/package_list/to_compile.txt
            
            # æ·»åŠ æ–°å¢çš„åŒ…
            if [ -s "/workdir/package_list/added_packages.txt" ]; then
              cat /workdir/package_list/added_packages.txt >> /workdir/package_list/to_compile.txt
              echo "æ£€æµ‹åˆ°æ–°å¢çš„åŒ…ï¼Œå°†è¿›è¡Œç¼–è¯‘ã€‚"
            fi
            
            # æ£€æŸ¥å·²æœ‰åŒ…ä¸­æºç å˜åŒ–çš„åŒ…
            echo "æ£€æŸ¥æºç å˜åŒ–..."
            for PKG in $(grep "^CONFIG_PACKAGE" .config | sed 's/CONFIG_PACKAGE_\(.*\)=y/\1/'); do
              # è·³è¿‡å·²æ·»åŠ çš„åŒ…
              if grep -q "CONFIG_PACKAGE_${PKG}=y" /workdir/package_list/added_packages.txt 2>/dev/null; then
                continue
              fi
              
              PKG_DIR=$(find package feeds -type d -name "$PKG" | head -n 1)
              if [ -n "$PKG_DIR" ]; then
                # è®¡ç®—å½“å‰æºç å“ˆå¸Œ
                CUR_HASH=$(find "$PKG_DIR" -type f -not -path "*/.git/*" -exec sha256sum {} \; | sort | sha256sum | awk '{print $1}')
                
                # æ£€æŸ¥å†å²å“ˆå¸Œ
                if grep -q "^\"$PKG\" " /workdir/package_info/hash_list.txt 2>/dev/null; then
                  PREV_HASH=$(grep "^\"$PKG\" " /workdir/package_info/hash_list.txt | awk '{print $2}')
                  
                  if [ "$CUR_HASH" != "$PREV_HASH" ]; then
                    echo "CONFIG_PACKAGE_${PKG}=y" >> /workdir/package_list/to_compile.txt
                    echo "åŒ… $PKG æºç æœ‰å˜åŒ–ï¼Œå°†é‡æ–°ç¼–è¯‘"
                  else
                    echo "åŒ… $PKG æºç æ— å˜åŒ–ï¼Œè·³è¿‡ç¼–è¯‘"
                  fi
                else
                  echo "CONFIG_PACKAGE_${PKG}=y" >> /workdir/package_list/to_compile.txt
                  echo "åŒ… $PKG æ²¡æœ‰å†å²å“ˆå¸Œï¼Œå°†è¿›è¡Œç¼–è¯‘"
                fi
              fi
            done
            
            # åˆ¤æ–­æ˜¯å¦æœ‰å¾ªç¯ä¾èµ–é—®é¢˜éœ€è¦ä¿®å¤
            if grep -q "recursive dependency" .config 2>/dev/null; then
              echo "æ£€æµ‹åˆ°é…ç½®ä¸­å­˜åœ¨å¾ªç¯ä¾èµ–é—®é¢˜ï¼Œå°è¯•ä¿®å¤..."
              # è‡ªåŠ¨ç¦ç”¨å¯èƒ½å¼•èµ·å¾ªç¯ä¾èµ–çš„åŒ…
              if grep -q "CONFIG_PACKAGE_baresip-mod-avcodec=y" .config; then
                echo "ç¦ç”¨ baresip-mod-avcodec ä»¥è§£å†³å¾ªç¯ä¾èµ–..."
                sed -i 's/CONFIG_PACKAGE_baresip-mod-avcodec=y/CONFIG_PACKAGE_baresip-mod-avcodec=n/' .config
              fi
              if grep -q "CONFIG_PACKAGE_baresip-mod-avformat=y" .config; then
                echo "ç¦ç”¨ baresip-mod-avformat ä»¥è§£å†³å¾ªç¯ä¾èµ–..."
                sed -i 's/CONFIG_PACKAGE_baresip-mod-avformat=y/CONFIG_PACKAGE_baresip-mod-avformat=n/' .config
              fi
              # é‡æ–°ç”Ÿæˆé…ç½®
              make defconfig
            fi
            
            # æ·»åŠ ç¼ºå¤±çš„åŒ…åˆ°ç¼–è¯‘åˆ—è¡¨
            if [ -f "/workdir/build_state/missing_packages.txt" ]; then
              if [ -s "/workdir/build_state/missing_packages.txt" ]; then
                echo "æ·»åŠ ç¼ºå¤±çš„åŒ…åˆ°ç¼–è¯‘åˆ—è¡¨..."
                while read PKG; do
                  echo "CONFIG_PACKAGE_${PKG}=y" >> /workdir/package_list/to_compile.txt
                done < /workdir/build_state/missing_packages.txt
              fi
            fi
            
            # å»é™¤é‡å¤é¡¹
            sort -u /workdir/package_list/to_compile.txt -o /workdir/package_list/to_compile.txt
            
            # åˆ¤æ–­æ˜¯å¦éœ€è¦å®Œæ•´æ„å»º
            if [ $(cat /workdir/package_list/to_compile.txt | wc -l) -gt $(grep "^CONFIG_PACKAGE" .config | wc -l | awk '{print int($1/3)}') ]; then
              echo "éœ€è¦é‡æ–°ç¼–è¯‘çš„åŒ…è¶…è¿‡ä¸‰åˆ†ä¹‹ä¸€ï¼Œå°†è¿›è¡Œå®Œæ•´æ„å»º..."
              make -j$(nproc) || make -j1 V=s
            else
              # è¿›è¡Œå¢é‡ç¼–è¯‘
              echo "æ‰§è¡Œå¢é‡ç¼–è¯‘..."
              
              # ç¡®ä¿å·¥å…·é“¾å¯ç”¨
              if [ ! -d "staging_dir/toolchain-"* ]; then
                echo "å·¥å…·é“¾ä¸å­˜åœ¨ï¼Œç¼–è¯‘å·¥å…·é“¾..."
                make -j$(nproc) tools/install || make -j1 V=s tools/install
                make -j$(nproc) toolchain/install || make -j1 V=s toolchain/install
              fi
              
              # æ™ºèƒ½å¤„ç†å·²åˆ é™¤çš„åŒ…
              if [ -s "/workdir/package_list/removed_packages.txt" ]; then
                echo "æ¸…ç†å·²åˆ é™¤çš„åŒ…..."
                while read -r PKG; do
                  PKG_NAME=$(echo "$PKG" | sed 's/CONFIG_PACKAGE_\(.*\)=y/\1/')
                  echo "æ¸…ç†åŒ…: $PKG_NAME"
                  make package/${PKG_NAME}/clean || echo "è­¦å‘Š: æ¸…ç† $PKG_NAME å¤±è´¥"
                done < /workdir/package_list/removed_packages.txt
              fi
              
              # æ™ºèƒ½ç¼–è¯‘éœ€è¦æ›´æ–°çš„åŒ…
              if [ -s "/workdir/package_list/to_compile.txt" ]; then
                echo "å¼€å§‹ç¼–è¯‘éœ€è¦æ›´æ–°çš„åŒ…..."
                
                # åˆ†æ‰¹ç¼–è¯‘ï¼Œé¿å…ä¾èµ–é—®é¢˜
                TOTAL_PKGS=$(cat /workdir/package_list/to_compile.txt | wc -l)
                if [ $TOTAL_PKGS -le 5 ]; then
                  # å°‘é‡åŒ…å•ç‹¬ç¼–è¯‘
                  while read -r PKG; do
                    PKG_NAME=$(echo "$PKG" | sed 's/CONFIG_PACKAGE_\(.*\)=y/\1/')
                    echo "ç¼–è¯‘å•ä¸ªåŒ…: $PKG_NAME"
                    make package/${PKG_NAME}/{clean,compile} V=s || {
                      echo "è­¦å‘Š: åŒ… $PKG_NAME ç¼–è¯‘å¤±è´¥ï¼Œå°è¯•ä¾èµ–æ–¹å¼ç¼–è¯‘"
                      make package/${PKG_NAME}/compile V=s || echo "è­¦å‘Š: åŒ… $PKG_NAME å†æ¬¡ç¼–è¯‘å¤±è´¥"
                    }
                  done < /workdir/package_list/to_compile.txt
                else
                  # æ‰¹é‡åŒ…ä¸€æ¬¡ç¼–è¯‘
                  echo "æ‰¹é‡ç¼–è¯‘å¤šä¸ªåŒ…..."
                  make -j$(nproc) || make -j1 V=s
                fi
              else
                echo "æ²¡æœ‰åŒ…éœ€è¦æ›´æ–°ï¼Œè·³è¿‡ç¼–è¯‘æ­¥éª¤"
              fi
              
              # æœ€åç¡®ä¿æ‰€æœ‰å†…å®¹æ­£ç¡®ç”Ÿæˆ
              echo "æœ€ç»ˆæ„å»ºå›ºä»¶..."
              make -j$(nproc) || make -j1 V=s
            fi
            
            # æ›´æ–°åŒ…å“ˆå¸Œ
            ./scripts/update_package_hashes.sh
            
            # ä¿å­˜å½“å‰åŒ…åˆ—è¡¨å’Œé…ç½®
            cp /workdir/package_list/current_packages.txt /workdir/package_list/previous_packages.txt
            mkdir -p /workdir/build_state
            cp .config /workdir/build_state/previous_config
            md5sum .config | awk '{print $1}' > /workdir/build_state/compiled_config.md5
          fi
          
          # æ˜¾ç¤ºå“ˆå¸Œæ–‡ä»¶çŠ¶æ€
          echo "å“ˆå¸Œæ–‡ä»¶çŠ¶æ€:"
          ls -la /workdir/package_info/
          
          if [ -f "/workdir/package_info/package_hashes.json" ]; then
            echo "å“ˆå¸Œæ–‡ä»¶å†…å®¹ç»Ÿè®¡:"
            grep -c ":" /workdir/package_info/package_hashes.json
          fi
          
          # æ£€æŸ¥ç¼–è¯‘ç»“æœ
          echo "ç¼–è¯‘ç»“æœç»Ÿè®¡:"
          find bin/packages -name "*.ipk" | wc -l
          
          echo "çŠ¶æ€ï¼šæˆåŠŸ"
          echo "status=success" >> $GITHUB_OUTPUT
          echo "DEVICE_NAME=_$(grep '^CONFIG_TARGET.*DEVICE.*=y' .config | sed -r 's/.*DEVICE_(.*)=y/\1/' | tr '\n' '_')" >> $GITHUB_ENV
          echo "FILE_DATE=_$(date +"%Y%m%d%H%M")" >> $GITHUB_ENV
          
          # æ˜¾ç¤ºCCACHEç»Ÿè®¡ä¿¡æ¯
          ccache -s

      - name: æ£€æŸ¥ç¼–è¯‘åç›®å½•å¤§å°
        run: |
          echo "ç¼–è¯‘åç›®å½•å¤§å°ç»Ÿè®¡:"
          du -sh /workdir/openwrt/staging_dir/toolchain-* || echo "å·¥å…·é“¾ç›®å½•ä¸å­˜åœ¨"
          du -sh /workdir/openwrt/staging_dir/target-* || echo "ç›®æ ‡ç›®å½•ä¸å­˜åœ¨"
          du -sh /workdir/openwrt/build_dir/target-* || echo "æ„å»ºç›®å½•ä¸å­˜åœ¨"
          du -sh /workdir/openwrt/bin || echo "binç›®å½•ä¸å­˜åœ¨"
          
          # æ£€æŸ¥æ˜¯å¦æœ‰è¿‡å¤§çš„æ–‡ä»¶ï¼Œå¯èƒ½å¯¼è‡´ç¼“å­˜é—®é¢˜
          echo "æŸ¥æ‰¾å¤§æ–‡ä»¶ï¼š"
          find /workdir/openwrt/staging_dir /workdir/openwrt/build_dir -type f -size +100M | head -10

      - name: æ•´ç†æ–‡ä»¶
        id: organize
        if: env.UPLOAD_FIRMWARE == 'true' && !cancelled()
        run: |
          cd /workdir/openwrt/bin/targets/*/*
          rm -rf packages
          mkdir -p firmware
          find . -maxdepth 1 -name "*combined*" -or -name "*sysupgrade*" | xargs -i cp {} ./firmware/
          cp /workdir/openwrt/.config ./firmware/config.txt
          zip -r firmware.zip firmware
          echo "FIRMWARE=$PWD/firmware" >> $GITHUB_ENV
          echo "FIRMWARE_ZIP=$PWD/firmware.zip" >> $GITHUB_ENV
          echo "status=success" >> $GITHUB_OUTPUT

      - name: ä¸Šä¼ å›ºä»¶ç›®å½•
        uses: actions/upload-artifact@main
        if: steps.organize.outputs.status == 'success' && !cancelled()
        with:
          name: OpenWrt_firmware${{ env.DEVICE_NAME }}${{ env.FILE_DATE }}
          path: ${{ env.FIRMWARE }}

      - name: ç”Ÿæˆå‘å¸ƒæ ‡ç­¾
        id: tag
        if: env.UPLOAD_RELEASE == 'true' && !cancelled()
        run: |
          echo "release_tag=$(date +"%Y.%m.%d-%H%M")" >> $GITHUB_OUTPUT
          echo "## OpenWrtå›ºä»¶æ„å»ºå®Œæˆ ğŸ“¦" > release.txt
          echo "ğŸ“… æ„å»ºæ—¶é—´: $(date +"%Y-%m-%d %H:%M")" >> release.txt
          echo "ğŸ“‚ å›ºä»¶ä¸‹è½½" >> release.txt
          echo "âš ï¸ è¯·åœ¨åˆ·æœºå‰å…ˆåšå¥½å¤‡ä»½ï¼" >> release.txt
          echo "status=success" >> $GITHUB_OUTPUT

      - name: ä¸Šä¼ å›ºä»¶åˆ°Releases
        uses: softprops/action-gh-release@v2
        if: steps.tag.outputs.status == 'success' && !cancelled()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.tag.outputs.release_tag }}
          body_path: release.txt
          files: ${{ env.FIRMWARE }}/*

      - name: åˆ é™¤æ—§çš„å·¥ä½œæµè¿è¡Œè®°å½•
        uses: Mattraks/delete-workflow-runs@v2
        with:
          retain_days: 1
          keep_minimum_runs: 3

      - name: åˆ é™¤æ—§çš„Releases
        uses: dev-drprasad/delete-older-releases@master
        if: env.UPLOAD_RELEASE == 'true' && !cancelled()
        with:
          keep_latest: 3
          delete_tags: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
