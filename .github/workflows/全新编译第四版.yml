name: å…¨æ–°ç¼–è¯‘ç¬¬å››ç‰ˆ

on:
  workflow_dispatch:
    inputs:
      ssh:
        description: 'SSHè°ƒè¯•'
        required: false
        default: 'false'
      clean_build:
        description: 'å®Œå…¨é‡æ–°ç¼–è¯‘'
        required: false
        default: 'false'
      config_file:
        description: 'é…ç½®æ–‡ä»¶'
        required: false
        default: 'å¢žé‡ç¼“å­˜ä¼˜åŒ–.config'

env:
  REPO_URL: https://github.com/coolsnowwolf/lede
  REPO_BRANCH: master
  CONFIG_FILE: ${{ github.event.inputs.config_file || 'å¢žé‡ç¼“å­˜ä¼˜åŒ–.config' }}
  DIY_P1_SH: diy-part1.sh
  DIY_P2_SH: diy-part2.sh
  UPLOAD_FIRMWARE: true
  UPLOAD_RELEASE: true
  TZ: Asia/Shanghai
  CCACHE_DIR: /workdir/ccache

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@main

    - name: ä¼˜åŒ–ç£ç›˜ç©ºé—´
      uses: easimon/maximize-build-space@master
      with:
        root-reserve-mb: 2048
        swap-size-mb: 1
        remove-dotnet: 'true'
        remove-android: 'true'
        build-mount-path: '/workdir'

    - name: åˆå§‹åŒ–çŽ¯å¢ƒ
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        sudo -E apt-get -qq update
        sudo -E apt-get -qq install $(curl -fsSL https://raw.githubusercontent.com/coolsnowwolf/lede/master/prereq-build.mk | grep -o 'package-y += .*' | sed 's/package-y += //g')
        sudo -E apt-get -qq install ack antlr3 asciidoc autoconf automake autopoint binutils bison build-essential \
        bzip2 ccache cmake cpio curl device-tree-compiler fastjar flex gawk gettext gcc-multilib g++-multilib \
        git gperf haveged help2man intltool libc6-dev-i386 libelf-dev libglib2.0-dev libgmp3-dev libltdl-dev \
        libmpc-dev libmpfr-dev libncurses5-dev libncursesw5-dev libreadline-dev libssl-dev libtool lrzsz \
        mkisofs msmtp nano ninja-build p7zip p7zip-full patch pkgconf python2.7 python3 python3-pyelftools \
        libpython3-dev qemu-utils rsync scons squashfs-tools subversion swig texinfo uglifyjs upx-ucl unzip \
        vim wget xmlto xxd zlib1g-dev python3-setuptools jq
        sudo timedatectl set-timezone "$TZ"
        mkdir -p /workdir/package_cache /workdir/build_state ${{ env.CCACHE_DIR }}
        chmod -R 777 /workdir

    - name: å…‹éš†æºä»£ç 
      working-directory: /workdir
      run: |
        git clone --depth 1 $REPO_URL -b $REPO_BRANCH openwrt
        ln -sf /workdir/openwrt $GITHUB_WORKSPACE/openwrt
        cd openwrt
        find . -type f -name "*.sh" -exec chmod +x {} \;

    # æ¸…ç†æ—§ç¼“å­˜
    - name: æ¸…ç†æ—§ç¼“å­˜
      uses: actions/github-script@v6
      if: inputs.clean_build != 'true'
      with:
        script: |
          const caches = await github.rest.actions.getActionsCacheList({
            owner: context.repo.owner,
            repo: context.repo.repo
          });
          
          // ä¸ºæ¯ç§ç¼“å­˜ç±»åž‹ä¿ç•™æœ€æ–°çš„ä¸€ä¸ª
          const latestCaches = {};
          
          for (const cache of caches.data.actions_caches) {
            // ä»Žç¼“å­˜é”®ä¸­æå–ç¼“å­˜ç±»åž‹
            let cacheType = '';
            if (cache.key.startsWith('packages-')) cacheType = 'packages';
            else if (cache.key.startsWith('toolchain-')) cacheType = 'toolchain';
            else if (cache.key.startsWith('ccache-')) cacheType = 'ccache';
            else if (cache.key.startsWith('state-')) cacheType = 'state';
            else continue; // è·³è¿‡å…¶ä»–ç±»åž‹çš„ç¼“å­˜
            
            if (!latestCaches[cacheType] || new Date(cache.created_at) > new Date(latestCaches[cacheType].created_at)) {
              latestCaches[cacheType] = cache;
            }
          }
          
          // åˆ é™¤éžæœ€æ–°çš„ç¼“å­˜
          for (const cache of caches.data.actions_caches) {
            const cacheType = Object.values(latestCaches).find(c => c.id === cache.id);
            if (!cacheType && (
                cache.key.startsWith('packages-') || 
                cache.key.startsWith('toolchain-') || 
                cache.key.startsWith('ccache-') || 
                cache.key.startsWith('state-')
              )) {
              console.log(`åˆ é™¤æ—§ç¼“å­˜: ${cache.key}`);
              await github.rest.actions.deleteActionsCacheById({
                owner: context.repo.owner,
                repo: context.repo.repo,
                cache_id: cache.id
              });
            }
          }

    # æ¢å¤ç¼–è¯‘åŒ…ç¼“å­˜ - æœ€é«˜ä¼˜å…ˆçº§ç¼“å­˜
    - name: æ¢å¤ç¼–è¯‘åŒ…ç¼“å­˜
      uses: actions/cache@v3
      id: cache-packages
      if: inputs.clean_build != 'true'
      with:
        path: |
          /workdir/package_cache
          /workdir/openwrt/bin/packages
          /workdir/openwrt/bin/targets/*/packages
          /workdir/openwrt/staging_dir/target-*/packages
          /workdir/openwrt/staging_dir/target-*/stamp
        key: packages-${{ github.run_id }}
        restore-keys: |
          packages-

    # æ¢å¤å·¥å…·é“¾ç¼“å­˜ - æ¬¡è¦ä¼˜å…ˆçº§
    - name: æ¢å¤å·¥å…·é“¾ç¼“å­˜
      uses: actions/cache@v3
      id: cache-toolchain
      if: inputs.clean_build != 'true'
      with:
        path: |
          /workdir/openwrt/staging_dir/toolchain-*
          /workdir/openwrt/staging_dir/host
        key: toolchain-${{ github.run_id }}
        restore-keys: |
          toolchain-

    # æ¢å¤CCACHEç¼“å­˜ - åŠ é€Ÿç¼–è¯‘
    - name: æ¢å¤CCACHEç¼“å­˜
      uses: actions/cache@v3
      id: cache-ccache
      with:
        path: ${{ env.CCACHE_DIR }}
        key: ccache-${{ github.run_id }}
        restore-keys: |
          ccache-

    # æ¢å¤æž„å»ºçŠ¶æ€
    - name: æ¢å¤æž„å»ºçŠ¶æ€
      uses: actions/cache@v3
      id: cache-state
      if: inputs.clean_build != 'true'
      with:
        path: /workdir/build_state
        key: state-${{ github.run_id }}
        restore-keys: |
          state-

    # æ£€æŸ¥ç¼“å­˜æ¢å¤çŠ¶æ€
    - name: æ£€æŸ¥ç¼“å­˜æ¢å¤çŠ¶æ€
      run: |
        echo "ç¼–è¯‘åŒ…ç¼“å­˜æ¢å¤çŠ¶æ€: ${{ steps.cache-packages.outputs.cache-hit == 'true' && 'æˆåŠŸ' || 'æœªæ‰¾åˆ°ç¼“å­˜' }}"
        echo "å·¥å…·é“¾ç¼“å­˜æ¢å¤çŠ¶æ€: ${{ steps.cache-toolchain.outputs.cache-hit == 'true' && 'æˆåŠŸ' || 'æœªæ‰¾åˆ°ç¼“å­˜' }}"
        echo "CCACHEç¼“å­˜æ¢å¤çŠ¶æ€: ${{ steps.cache-ccache.outputs.cache-hit == 'true' && 'æˆåŠŸ' || 'æœªæ‰¾åˆ°ç¼“å­˜' }}"
        echo "æž„å»ºçŠ¶æ€ç¼“å­˜æ¢å¤çŠ¶æ€: ${{ steps.cache-state.outputs.cache-hit == 'true' && 'æœªæ‰¾åˆ°ç¼“å­˜' }}"
        
        # æ£€æŸ¥ç›®å½•å¤§å°
        if [ -d "/workdir/openwrt/staging_dir/toolchain-"* ]; then
          echo "å·¥å…·é“¾ç¼“å­˜å¤§å°:"
          du -sh /workdir/openwrt/staging_dir/toolchain-*
        else
          echo "å·¥å…·é“¾ç›®å½•ä¸å­˜åœ¨"
        fi
        
        if [ -d "/workdir/openwrt/bin/packages" ]; then
          echo "ç¼–è¯‘åŒ…ç¼“å­˜å¤§å°:"
          du -sh /workdir/openwrt/bin/packages
        else
          echo "ç¼–è¯‘åŒ…ç›®å½•ä¸å­˜åœ¨"
        fi
        
        # æ¢å¤å·²ç¼“å­˜çš„åŒ…åˆ°å¯¹åº”ä½ç½®
        if [ -d "/workdir/package_cache" ] && [ "$(ls -A /workdir/package_cache)" ]; then
          echo "ä»Žç¼“å­˜æ¢å¤ç¼–è¯‘åŒ…..."
          mkdir -p /workdir/openwrt/bin/packages
          mkdir -p /workdir/openwrt/staging_dir/target-*/packages
          cp -r /workdir/package_cache/* /workdir/openwrt/ || true
        fi

    # é…ç½®ç¼–è¯‘çŽ¯å¢ƒ
    - name: é…ç½®ç¼–è¯‘çŽ¯å¢ƒ
      run: |
        # åŠ è½½è‡ªå®šä¹‰feeds
        [ -e $FEEDS_CONF ] && mv $FEEDS_CONF /workdir/openwrt/feeds.conf.default
        chmod +x $DIY_P1_SH
        cd /workdir/openwrt
        $GITHUB_WORKSPACE/$DIY_P1_SH
        
        # æ›´æ–°feeds
        ./scripts/feeds update -a
        ./scripts/feeds install -a
        
        # åŠ è½½è‡ªå®šä¹‰é…ç½®
        [ -e files ] && mv files /workdir/openwrt/files
        if [ ! -e "$CONFIG_FILE" ]; then
          echo "é”™è¯¯: æ‰¾ä¸åˆ°é…ç½®æ–‡ä»¶ $CONFIG_FILE" >&2
          exit 1
        fi
        mv $CONFIG_FILE /workdir/openwrt/.config
        chmod +x $DIY_P2_SH
        cd /workdir/openwrt
        $GITHUB_WORKSPACE/$DIY_P2_SH
        
        # ç¦ç”¨è‡ªåŠ¨é‡å»ºå’Œè‡ªåŠ¨ç§»é™¤
        echo "CONFIG_AUTOREMOVE=n" >> .config
        echo "CONFIG_AUTOREBUILD=n" >> .config
        # åº”ç”¨é…ç½®
        make defconfig
        
        # åˆ›å»ºåŒ…è·Ÿè¸ªè„šæœ¬
        mkdir -p /workdir/build_state
        grep "^CONFIG_PACKAGE_" .config | sort > /workdir/build_state/current_packages.txt
        if [ -f "/workdir/build_state/previous_packages.txt" ]; then
          echo "å¯¹æ¯”å½“å‰åŒ…ä¸Žä¸Šæ¬¡ç¼–è¯‘çš„å·®å¼‚:"
          comm -3 /workdir/build_state/current_packages.txt /workdir/build_state/previous_packages.txt | wc -l
        else
          echo "é¦–æ¬¡ç¼–è¯‘ï¼Œåˆ›å»ºåŒ…åˆ—è¡¨"
        fi

    - name: å¼€å¯SSHè°ƒè¯•
      uses: mxschmitt/action-tmate@v3
      if: github.event.inputs.ssh == 'true'

    # ä¸‹è½½è½¯ä»¶åŒ…
    - name: ä¸‹è½½è½¯ä»¶åŒ…
      run: |
        cd /workdir/openwrt
        make download -j8 || make download -j1 V=s
        
        # é…ç½®CCACHE
        mkdir -p ${{ env.CCACHE_DIR }}
        ccache -o cache_dir=${{ env.CCACHE_DIR }}
        ccache -o max_size=5G
        ccache -z

    # æ™ºèƒ½ç¼–è¯‘å›ºä»¶
    - name: æ™ºèƒ½ç¼–è¯‘å›ºä»¶
      id: compile
      run: |
        cd /workdir/openwrt
        export CCACHE_DIR=${{ env.CCACHE_DIR }}
        export PATH="/usr/lib/ccache:$PATH"
        
        # å®šä¹‰ç¼–è¯‘å‡½æ•°
        compile_firmware() {
          make -j$(nproc) || make -j1 V=s
          if [ $? -eq 0 ]; then
            echo "ç¼–è¯‘æˆåŠŸ"
            # ä¿å­˜ç¼–è¯‘åŽçš„åŒ…åˆ°ç¼“å­˜ç›®å½•
            mkdir -p /workdir/package_cache
            if [ -d "bin/packages" ]; then
              echo "å¤‡ä»½ç¼–è¯‘åŒ…åˆ°ç¼“å­˜..."
              cp -r bin/packages /workdir/package_cache/
            fi
            if [ -d "bin/targets" ]; then
              mkdir -p /workdir/package_cache/bin
              cp -r bin/targets /workdir/package_cache/bin/
            fi
            if [ -d "staging_dir/target-"* ]; then
              mkdir -p /workdir/package_cache/staging_dir
              cp -r staging_dir/target-* /workdir/package_cache/staging_dir/
            fi
            # ä¿å­˜å½“å‰åŒ…é…ç½®
            cp /workdir/build_state/current_packages.txt /workdir/build_state/previous_packages.txt
            # ä¿å­˜é…ç½®æ–‡ä»¶MD5
            md5sum .config > /workdir/build_state/config.md5
            return 0
          else
            echo "ç¼–è¯‘å¤±è´¥"
            return 1
          fi
        }
        
        # å†³å®šæ˜¯å¦è¿›è¡Œå…¨é‡ç¼–è¯‘
        DO_FULL_BUILD=0
        if [ "${{ github.event.inputs.clean_build }}" = "true" ]; then
          echo "ç”¨æˆ·è¯·æ±‚å®Œå…¨é‡æ–°ç¼–è¯‘"
          DO_FULL_BUILD=1
        elif [ ! -f "/workdir/build_state/previous_packages.txt" ]; then
          echo "é¦–æ¬¡ç¼–è¯‘ï¼Œéœ€è¦å…¨é‡æž„å»º"
          DO_FULL_BUILD=1
        elif [ ! -f "/workdir/build_state/config.md5" ]; then
          echo "æœªæ‰¾åˆ°ä¹‹å‰çš„é…ç½®MD5ï¼Œéœ€è¦å…¨é‡æž„å»º"
          DO_FULL_BUILD=1
        else
          # æ£€æŸ¥é…ç½®å˜åŒ–
          CURRENT_MD5=$(md5sum .config | awk '{print $1}')
          PREVIOUS_MD5=$(cat /workdir/build_state/config.md5 | awk '{print $1}')
          if [ "$CURRENT_MD5" != "$PREVIOUS_MD5" ]; then
            echo "é…ç½®å·²æ›´æ”¹ï¼Œéœ€è¦å…¨é‡æž„å»º"
            DO_FULL_BUILD=1
          else
            echo "é…ç½®æœªæ›´æ”¹ï¼Œå¯ä»¥å¢žé‡æž„å»º"
          fi
        fi
        
        # æ‰§è¡Œç¼–è¯‘
        if [ $DO_FULL_BUILD -eq 1 ]; then
          echo "æ‰§è¡Œå…¨é‡ç¼–è¯‘..."
          compile_firmware
        else
          echo "æ‰§è¡Œå¢žé‡ç¼–è¯‘..."
          
          # ç¡®ä¿å·¥å…·é“¾å¯ç”¨
          if [ ! -d "staging_dir/toolchain-"* ]; then
            echo "ç¼–è¯‘å·¥å…·é“¾..."
            make -j$(nproc) tools/install
            make -j$(nproc) toolchain/install
          fi
          
          compile_firmware
        fi
        
        # æ¸…ç†å¤§æ–‡ä»¶ï¼Œå‡å°‘ç¼“å­˜ä½“ç§¯
        echo "æ¸…ç†å¤§åž‹ä¸­é—´æ–‡ä»¶ä»¥å‡å°‘ç¼“å­˜å¤§å°..."
        find build_dir -name "*.o" -delete || true
        find build_dir -name "*.a" -delete || true
        
        echo "DEVICE_NAME=_$(grep '^CONFIG_TARGET.*DEVICE.*=y' .config | sed -r 's/.*DEVICE_(.*)=y/\1/' | tr '\n' '_')" >> $GITHUB_ENV
        echo "FILE_DATE=_$(date +"%Y%m%d%H%M")" >> $GITHUB_ENV
        
        # æ˜¾ç¤ºCCACHEç»Ÿè®¡ä¿¡æ¯
        ccache -s

    # æ•´ç†æ–‡ä»¶
    - name: æ•´ç†æ–‡ä»¶
      id: organize
      if: env.UPLOAD_FIRMWARE == 'true' && !cancelled()
      run: |
        cd /workdir/openwrt/bin/targets/*/*
        rm -rf packages
        mkdir -p firmware
        find . -maxdepth 1 -name "*combined*" -or -name "*sysupgrade*" | xargs -i cp {} ./firmware/
        cp /workdir/openwrt/.config ./firmware/config.txt
        zip -r firmware.zip firmware
        echo "FIRMWARE=$PWD/firmware" >> $GITHUB_ENV
        echo "FIRMWARE_ZIP=$PWD/firmware.zip" >> $GITHUB_ENV
        echo "status=success" >> $GITHUB_OUTPUT

    # ä¸Šä¼ å›ºä»¶ç›®å½•
    - name: ä¸Šä¼ å›ºä»¶ç›®å½•
      uses: actions/upload-artifact@main
      if: steps.organize.outputs.status == 'success' && !cancelled()
      with:
        name: OpenWrt_firmware${{ env.DEVICE_NAME }}${{ env.FILE_DATE }}
        path: ${{ env.FIRMWARE }}

    # ç”Ÿæˆå‘å¸ƒæ ‡ç­¾
    - name: ç”Ÿæˆå‘å¸ƒæ ‡ç­¾
      id: tag
      if: env.UPLOAD_RELEASE == 'true' && !cancelled()
      run: |
        echo "release_tag=$(date +"%Y.%m.%d-%H%M")" >> $GITHUB_OUTPUT
        echo "## OpenWrtå›ºä»¶æž„å»ºå®Œæˆ ðŸ“¦" > release.txt
        echo "ðŸ“… æž„å»ºæ—¶é—´: $(date +"%Y-%m-%d %H:%M")" >> release.txt
        echo "ðŸ“‚ å›ºä»¶ä¸‹è½½" >> release.txt
        echo "âš ï¸ è¯·åœ¨åˆ·æœºå‰å…ˆåšå¥½å¤‡ä»½ï¼" >> release.txt
        echo "status=success" >> $GITHUB_OUTPUT

    # ä¸Šä¼ å›ºä»¶åˆ°Releases
    - name: ä¸Šä¼ å›ºä»¶åˆ°Releases
      uses: softprops/action-gh-release@v2
      if: steps.tag.outputs.status == 'success' && !cancelled()
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ steps.tag.outputs.release_tag }}
        body_path: release.txt
        files: ${{ env.FIRMWARE }}/*

    # åˆ é™¤æ—§çš„Releases
    - name: åˆ é™¤æ—§çš„Releases
      uses: dev-drprasad/delete-older-releases@master
      if: env.UPLOAD_RELEASE == 'true' && !cancelled()
      with:
        keep_latest: 3
        delete_tags: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
