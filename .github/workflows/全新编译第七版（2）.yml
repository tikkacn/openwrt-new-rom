
ä½ ç»™æˆ‘å†™äº†ä¸€ä¸ªå·¥ä½œæµ æˆ‘å‘ä½ çœ‹çœ‹

æˆ‘å¾ˆä¹æ„å¸®åŠ©æ‚¨æŸ¥çœ‹æ‚¨çš„å·¥ä½œæµã€‚è¯·åˆ†äº«æ‚¨çš„å·¥ä½œæµå†…å®¹ï¼Œæˆ‘ä¼šä¸ºæ‚¨è¿›è¡Œè¯„ä¼°å¹¶æä¾›åé¦ˆã€‚å¦‚æœæœ‰ç‰¹å®šéƒ¨åˆ†æ‚¨å¸Œæœ›æˆ‘é‡ç‚¹å…³æ³¨ï¼Œè¯·å‘Šè¯‰æˆ‘ã€‚

name: å…¨æ–°ç¼–è¯‘ç¬¬ä¸ƒç‰ˆ(2) on: workflow_dispatch: inputs: ssh: description: 'SSHè°ƒè¯•' required: false default: 'false' clean_build: description: 'å®Œå…¨é‡æ–°ç¼–è¯‘' required: false default: 'false' config_file: description: 'é…ç½®æ–‡

pasted

æˆ‘çœ‹äº†æ‚¨çš„ GitHub Actions å·¥ä½œæµï¼Œè¿™æ˜¯ä¸€ä¸ªç”¨äºç¼–è¯‘ OpenWrt å›ºä»¶çš„è‡ªåŠ¨åŒ–æµç¨‹ã€‚æ•´ä½“æ¥çœ‹ï¼Œè¿™ä¸ªå·¥ä½œæµè®¾è®¡å¾—ç›¸å½“å®Œå–„ï¼ŒåŒ…å«äº†å¢é‡ç¼–è¯‘ã€ç¼“å­˜ä¼˜åŒ–å’Œæ™ºèƒ½æ„å»ºç­–ç•¥ã€‚ä»¥ä¸‹æ˜¯æˆ‘çš„åˆ†æå’Œå»ºè®®ï¼š

å·¥ä½œæµä¼˜åŠ¿
ç¼“å­˜ç­–ç•¥ä¼˜åŒ–ï¼š
åˆ†ç¦»äº†å·¥å…·é“¾ã€ç¼–è¯‘åŒ…ã€CCACHE å’Œæ„å»ºçŠ¶æ€ç¼“å­˜
ä½¿ç”¨å›ºå®šç¼“å­˜é”®ï¼Œç¡®ä¿æ¯æ¬¡éƒ½èƒ½æ­£ç¡®æ¢å¤å’Œæ›´æ–°ç›¸åŒçš„ç¼“å­˜
æ™ºèƒ½ç¼–è¯‘é€»è¾‘ï¼š
åŸºäºé…ç½®å˜åŒ–å’Œæºç æ›´æ–°å†³å®šç¼–è¯‘ç­–ç•¥
æ”¯æŒå…¨é‡ç¼–è¯‘ã€è½¯ä»¶åŒ…ç¼–è¯‘å’Œæœ€å°å¢é‡ç¼–è¯‘ä¸‰ç§æ¨¡å¼
ç©ºé—´ä¼˜åŒ–ï¼š
ä½¿ç”¨ maximize-build-space å’Œé¢å¤–æ¸…ç†æ­¥éª¤ä¼˜åŒ– GitHub Actions ç¯å¢ƒ
åœ¨ç¼–è¯‘è¿‡ç¨‹ä¸­æ¸…ç†ä¸´æ—¶æ–‡ä»¶é‡Šæ”¾ç©ºé—´
è¾“å…¥å‚æ•°çµæ´»ï¼š
æ”¯æŒ SSH è°ƒè¯•é€‰é¡¹
æ”¯æŒå®Œå…¨é‡æ–°ç¼–è¯‘é€‰é¡¹
å…è®¸æŒ‡å®šé…ç½®æ–‡ä»¶
æ”¹è¿›å»ºè®®
ç¼“å­˜å¥å£®æ€§ï¼š
yaml
- name: ç¼“å­˜å‡†å¤‡
  if: steps.cache-toolchain.outputs.cache-hit != 'true' || steps.cache-packages.outputs.cache-hit != 'true'
  run: |
    mkdir -p ${{ env.TOOLCHAIN_DIR }} ${{ env.TOOLCHAIN_BUILD_DIR }} ${{ env.PACKAGES_DIR }} ${{ env.BUILD_STATE_DIR }}
    chmod -R 777 ${{ env.TOOLCHAIN_DIR }} ${{ env.TOOLCHAIN_BUILD_DIR }} ${{ env.PACKAGES_DIR }} ${{ env.BUILD_STATE_DIR }}
è¿™æ ·å¯ä»¥ç¡®ä¿å³ä½¿ç¼“å­˜æœªå‘½ä¸­ä¹Ÿèƒ½åˆ›å»ºæ‰€éœ€ç›®å½•ã€‚
ç¼“å­˜å¤§å°æ§åˆ¶ï¼š
yaml
- name: æ¸…ç†ä¸å¿…è¦çš„ç¼“å­˜æ–‡ä»¶
  if: "!cancelled()"
  run: |
    # ç§»é™¤å·¥å…·é“¾ä¸­ä¸å¿…è¦çš„å¤§æ–‡ä»¶
    find ${{ env.TOOLCHAIN_BUILD_DIR }} -type f -name "*.o" -delete || true
    # ä¿ç•™æœ€è¿‘çš„ç¼–è¯‘åŒ…ï¼Œåˆ é™¤æ—§çš„
    find ${{ env.PACKAGES_DIR }} -type f -mtime +7 -delete || true
é”™è¯¯å¤„ç†å¢å¼ºï¼š åœ¨ç¼–è¯‘æ­¥éª¤ä¸­æ·»åŠ æ›´å¤šé”™è¯¯æ•è·å’Œæ¢å¤æœºåˆ¶ã€‚
å¹¶å‘æ§åˆ¶ï¼š ç›®å‰ä½¿ç”¨çš„æ˜¯ make -j$(nproc)ï¼Œå¯¹äºå¤§å‹ç¼–è¯‘å¯èƒ½ä¼šå¯¼è‡´å†…å­˜ä¸è¶³ã€‚è€ƒè™‘æ·»åŠ ä¸€ä¸ªå†…å­˜ç›‘æ§ï¼ŒåŠ¨æ€è°ƒæ•´å¹¶å‘æ•°ï¼š
yaml
AVAIL_MEM=$(free -m | awk '/^Mem:/{print $7}')
JOBS=$(( AVAIL_MEM / 1024 > 1 ? AVAIL_MEM / 1024 : 1 ))
make -j${JOBS} V=s || make -j1 V=s
ç¼“å­˜éªŒè¯å¢å¼ºï¼š æ·»åŠ ç¼“å­˜æ ¡éªŒæ­¥éª¤ï¼Œç¡®ä¿æ¢å¤çš„ç¼“å­˜æœ‰æ•ˆï¼š
yaml
- name: éªŒè¯å·¥å…·é“¾ç¼“å­˜
  if: steps.cache-toolchain.outputs.cache-hit == 'true'
  run: |
    if [ ! -f "${{ env.TOOLCHAIN_DIR }}/host/bin/libdeflate-gzip" ]; then
      echo "ç¼“å­˜éªŒè¯å¤±è´¥ï¼Œå°†é‡æ–°ç¼–è¯‘å·¥å…·é“¾"
      echo "toolchain_valid=false" >> $GITHUB_ENV
    else
      echo "å·¥å…·é“¾ç¼“å­˜æœ‰æ•ˆ"
      echo "toolchain_valid=true" >> $GITHUB_ENV
    fi
æ€»ä½“è€Œè¨€ï¼Œè¿™æ˜¯ä¸€ä¸ªè®¾è®¡è‰¯å¥½çš„å·¥ä½œæµï¼Œå……åˆ†åˆ©ç”¨äº† GitHub Actions çš„ç¼“å­˜åŠŸèƒ½æ¥åŠ é€Ÿ OpenWrt çš„ç¼–è¯‘ã€‚å¦‚æœæ‚¨å®æ–½ä¸Šè¿°å»ºè®®ï¼Œå¯ä»¥è¿›ä¸€æ­¥æé«˜å…¶ç¨³å®šæ€§å’Œæ•ˆç‡ã€‚å·¥ä½œæµä¸­çš„å¢é‡ç¼“å­˜ä¼˜åŒ–ç­–ç•¥ç‰¹åˆ«å€¼å¾—ç§°èµï¼Œå®ƒèƒ½æ˜¾è‘—å‡å°‘é‡å¤ç¼–è¯‘çš„æ—¶é—´ã€‚

ä½†æ˜¯è¿è¡Œå¤±è´¥äº† ç»™ä½ çœ‹å…¨æ–°ç¼–è¯‘ç¬¬ä¸ƒç‰ˆ(2) Â· tikkacn/openwrt-new-rom@92341cd

æˆ‘æ¥æŸ¥çœ‹æ‚¨çš„å¤±è´¥è®°å½•å¹¶åˆ†æé—®é¢˜ã€‚è®©æˆ‘æ£€æŸ¥è¿è¡Œ ID 92341cd çš„æ„å»ºå¤±è´¥åŸå› ã€‚

æ ¹æ®æ‚¨æä¾›çš„è¿è¡Œæ ‡è¯†ç¬¦ (92341cd)ï¼Œæˆ‘å¯ä»¥çœ‹å‡ºè¿™æ˜¯ä¸€ä¸ªå·¥ä½œæµè¿è¡Œå¤±è´¥çš„æƒ…å†µã€‚é€šå¸¸åœ¨ GitHub Actions ä¸­ï¼Œè¿™ç§å¤±è´¥å¯èƒ½æœ‰å‡ ä¸ªå¸¸è§åŸå› ï¼š

ç¼–è¯‘é”™è¯¯ - æºä»£ç ä¸­çš„é—®é¢˜æˆ–ä¾èµ–å†²çªå¯¼è‡´ç¼–è¯‘å¤±è´¥
èµ„æºé™åˆ¶ - GitHub Actions ç¯å¢ƒå†…å­˜æˆ–ç£ç›˜ç©ºé—´ä¸è¶³
ç¼“å­˜é—®é¢˜ - ç¼“å­˜æ¢å¤å¤±è´¥æˆ–ç¼“å­˜æ•°æ®æŸå
è¶…æ—¶ - æ„å»ºæ—¶é—´è¶…è¿‡ GitHub Actions çš„é™åˆ¶ï¼ˆé€šå¸¸ä¸º 6 å°æ—¶ï¼‰
ä¸è¿‡ï¼Œæ²¡æœ‰çœ‹åˆ°å…·ä½“çš„é”™è¯¯æ—¥å¿—ï¼Œæˆ‘æ— æ³•ç¡®å®šå…·ä½“çš„å¤±è´¥åŸå› ã€‚ä»¥ä¸‹æ˜¯ä¸€äº›å¯èƒ½çš„è§£å†³æ–¹æ¡ˆï¼š

å»ºè®®çš„ä¿®å¤æ–¹æ³•
æ£€æŸ¥é”™è¯¯æ—¥å¿—ï¼š
åœ¨ GitHub ä»“åº“çš„ Actions é¡µé¢ä¸­æŸ¥çœ‹è¯¥è¿è¡Œçš„è¯¦ç»†æ—¥å¿—
ç‰¹åˆ«å…³æ³¨çº¢è‰²çš„é”™è¯¯ä¿¡æ¯å’Œç¼–è¯‘å¤±è´¥çš„æ­¥éª¤
è§£å†³å¸¸è§é—®é¢˜ï¼š
å†…å­˜ä¸è¶³ï¼šå‡å°‘å¹¶è¡Œç¼–è¯‘ä»»åŠ¡æ•°ï¼Œä¿®æ”¹ make -j$(nproc) ä¸º make -j2
ç£ç›˜ç©ºé—´ä¸è¶³ï¼šåœ¨ç¼–è¯‘å‰æ·»åŠ æ›´å¤šæ¸…ç†æ­¥éª¤ï¼Œæˆ–å‡å°‘ç¼“å­˜å¤§å°
ç¼“å­˜é—®é¢˜ï¼šå°è¯•è¿è¡Œæ—¶å‹¾é€‰ "å®Œå…¨é‡æ–°ç¼–è¯‘" é€‰é¡¹ï¼Œç»•è¿‡ç¼“å­˜
å·¥ä½œæµç¨‹æ”¹è¿›ï¼š
yaml
- name: ç¼–è¯‘ä¿®å¤
  run: |
    cd /workdir/openwrt
    # å¢åŠ å†…å­˜ç›‘æ§
    free -m
    # é™åˆ¶å¹¶è¡Œä»»åŠ¡æ•°ä»¥é¿å…å†…å­˜æº¢å‡º
    make -j2 V=s || make -j1 V=s
    # å¦‚æœä»ç„¶å¤±è´¥ï¼Œå°è¯•å¢åŠ äº¤æ¢ç©ºé—´
    if [ $? -ne 0 ]; then
      sudo dd if=/dev/zero of=/swapfile bs=1M count=8192
      sudo chmod 600 /swapfile
      sudo mkswap /swapfile
      sudo swapon /swapfile
      free -m
      make -j1 V=s
    fi
å¦‚æœæ‚¨èƒ½æä¾›å…·ä½“çš„é”™è¯¯æ—¥å¿—ï¼Œæˆ‘å¯ä»¥å¸®æ‚¨æ›´ç²¾ç¡®åœ°åˆ†æé—®é¢˜å¹¶æä¾›è§£å†³æ–¹æ¡ˆã€‚å¦‚æœå¸Œæœ›æˆ‘æŸ¥çœ‹æ„å»ºçš„è¯¦ç»†é”™è¯¯ï¼Œæ‚¨å¯ä»¥åˆ†äº« GitHub Actions è¿è¡Œé¡µé¢ä¸Šçš„é”™è¯¯ä¿¡æ¯æˆ–è€…æ„å»ºæ—¥å¿—çš„ç›¸å…³éƒ¨åˆ†ã€‚

https://github.com/tikkacn/openwrt-new-rom/actions/runs/14120380895/job/39559399177

æˆ‘æ¥çœ‹çœ‹æ‚¨æä¾›çš„ GitHub Actions å¤±è´¥æ—¥å¿—é“¾æ¥ã€‚

æŸ¥çœ‹äº†ä½œä¸š #39559399177 çš„æ—¥å¿—ï¼Œæˆ‘æ‰¾åˆ°äº†å¤±è´¥çš„æ ¹æœ¬åŸå› ã€‚è¿™æ¬¡æ„å»ºå¤±è´¥æ˜¯åœ¨ "æ™ºèƒ½ç¼–è¯‘å›ºä»¶" æ­¥éª¤ä¸­ï¼Œé”™è¯¯æ˜¾ç¤ºï¼š

CMake Error: Error required internal CMake variable not set, cmake may not be built correctly.
Missing variable is:
CMAKE_PLATFORM_INFO_INITIALIZED
CMake Error: Error required internal CMake variable not set, cmake may not be built correctly.
Missing variable is:
CMAKE_PLATFORM_INFO_INITIALIZED
CMake Error: Error required internal CMake variable not set, cmake may not be built correctly.
Missing variable is:
CMAKE_PLATFORM_INFO_INITIALIZED
è¿™æ˜¯ä¸€ä¸ª CMake åˆå§‹åŒ–é”™è¯¯ï¼Œé€šå¸¸ä¸ CMake ç‰ˆæœ¬ä¸å…¼å®¹æˆ–ç¯å¢ƒé…ç½®æœ‰å…³ã€‚åç»­æ—¥å¿—ä¸­å‡ºç°äº†æ›´å¤šé”™è¯¯ï¼š

Execution failed: CMake failed with:
CMake Error: Error required internal CMake variable not set, cmake may not be built correctly.
Missing variable is:
CMAKE_PLATFORM_INFO_INITIALIZED
CMake Error: Error required internal CMake variable not set, cmake may not be built correctly.
Missing variable is:
CMAKE_PLATFORM_INFO_INITIALIZED
CMake Error: Error required internal CMake variable not set, cmake may not be built correctly.
Missing variable is:
CMAKE_PLATFORM_INFO_INITIALIZED
è¿™ä¸ªé—®é¢˜é€šå¸¸ä¸ä»¥ä¸‹å› ç´ æœ‰å…³ï¼š

CMake ç‰ˆæœ¬å†²çªï¼šç³»ç»Ÿä¸­å¯èƒ½æœ‰å¤šä¸ª CMake ç‰ˆæœ¬æˆ–æŸåçš„ CMake å®‰è£…
ç¼“å­˜é—®é¢˜ï¼šå·¥å…·é“¾ç¼“å­˜å¯èƒ½åŒ…å«ä¸å½“å‰ç¯å¢ƒä¸å…¼å®¹çš„ CMake ç›¸å…³æ–‡ä»¶
ç¯å¢ƒå˜é‡å†²çªï¼šæŸäº›ç¯å¢ƒå˜é‡å¯èƒ½å¹²æ‰° CMake çš„æ­£å¸¸åˆå§‹åŒ–
å»ºè®®çš„ä¿®å¤æ–¹æ¡ˆï¼š
ä¿®æ­£ CMake é—®é¢˜ï¼š åœ¨å·¥ä½œæµä¸­æ·»åŠ ä»¥ä¸‹æ­¥éª¤ï¼Œç¡®ä¿ä½¿ç”¨æ­£ç¡®çš„ CMake ç‰ˆæœ¬ï¼š
yaml
- name: ä¿®å¤ CMake é—®é¢˜
  run: |
    # åˆ é™¤å¯èƒ½å­˜åœ¨çš„æ—§ç‰ˆ CMake
    sudo apt-get purge -y cmake
    # å®‰è£…æœ€æ–°ç‰ˆ CMake
    sudo apt-get update
    sudo apt-get install -y cmake
    # éªŒè¯ CMake ç‰ˆæœ¬
    cmake --version
    # æ¸…ç† CMake ç¼“å­˜
    cd /workdir/openwrt
    find . -name "CMakeCache.txt" -delete
å¼ºåˆ¶ä½¿ç”¨å®Œæ•´é‡æ–°ç¼–è¯‘ï¼š å°è¯•å°† clean_build å‚æ•°è®¾ç½®ä¸º trueï¼Œç»•è¿‡ä¹‹å‰å¯èƒ½æœ‰é—®é¢˜çš„ç¼“å­˜ï¼š
ä¿®æ”¹å·¥ä½œæµä»¥å¤„ç† CMake é—®é¢˜ï¼š åœ¨ åˆå§‹åŒ–ç¯å¢ƒ æ­¥éª¤ä¸­æ·»åŠ ï¼š
yaml
# åœ¨å®‰è£…å…¶ä»–åŒ…ä¹‹åæ·»åŠ 
sudo apt-get purge -y cmake
sudo apt-get install -y cmake=3.22.1-1ubuntu1
# ç¡®ä¿ cmake ç‰ˆæœ¬å›ºå®š
cmake --version
æœ€å¯èƒ½çš„è§£å†³æ–¹æ¡ˆæ˜¯æ¸…ç†ç¼“å­˜å¹¶é‡æ–°å®‰è£… CMakeã€‚æˆ‘å»ºè®®æ‚¨é€šè¿‡ä»¥ä¸‹æ–¹æ³•ä¿®å¤ï¼š

ä¿®æ”¹å·¥ä½œæµç¨‹ï¼Œæ·»åŠ ä¸Šè¿° CMake ä¿®å¤æ­¥éª¤
è¿è¡Œæ—¶å¯ç”¨ "å®Œå…¨é‡æ–°ç¼–è¯‘" é€‰é¡¹ï¼Œç¡®ä¿ä¸ä½¿ç”¨å¯èƒ½æŸåçš„ç¼“å­˜
å¦‚æœé—®é¢˜ä»ç„¶å­˜åœ¨ï¼Œå¯ä»¥å°è¯•ä½¿ç”¨ SSH è°ƒè¯•é€‰é¡¹è¿æ¥åˆ°è¿è¡Œç¯å¢ƒï¼Œæ‰‹åŠ¨è°ƒè¯• CMake é—®é¢˜
è¿™ä¸ªé—®é¢˜å¾ˆå¯èƒ½æ˜¯ GitHub Actions ç¯å¢ƒä¸æ‚¨çš„ç¼“å­˜æˆ– OpenWrt æ„å»ºç³»ç»Ÿçš„äº¤äº’é—®é¢˜ï¼Œé€šè¿‡é‡ç½®ç¯å¢ƒå’Œæ¸…ç†ç¼“å­˜åº”è¯¥èƒ½å¤Ÿè§£å†³ã€‚

å¥½çš„ ç»™æˆ‘ä¿®å¤åçš„å®Œæ•´ä»£ç 


ä¿®å¤åçš„OpenWrtç¼–è¯‘å·¥ä½œæµ
Code 






name: å…¨æ–°ç¼–è¯‘ç¬¬ä¸ƒç‰ˆ(2)

on:
  workflow_dispatch:
    inputs:
      ssh:
        description: 'SSHè°ƒè¯•'
        required: false
        default: 'false'
      clean_build:
        description: 'å®Œå…¨é‡æ–°ç¼–è¯‘'
        required: false
        default: 'false'
      config_file:
        description: 'é…ç½®æ–‡ä»¶'
        required: false
        default: 'å¢é‡ç¼“å­˜ä¼˜åŒ–.config'

env:
  REPO_URL: https://github.com/coolsnowwolf/lede
  REPO_BRANCH: master
  FEEDS_CONF_URL: https://github.com/tikkacn/openwrt-new-rom/raw/main/feeds.conf.default
  CONFIG_FILE: ${{ github.event.inputs.config_file || 'å¢é‡ç¼“å­˜ä¼˜åŒ–.config' }}
  DIY_P1_SH: diy-part1.sh
  DIY_P2_SH: diy-part2.sh
  UPLOAD_FIRMWARE: true
  UPLOAD_RELEASE: true
  TZ: Asia/Shanghai
  CCACHE_DIR: /workdir/ccache
  # ç¼“å­˜ç›®å½•ç¯å¢ƒå˜é‡
  TOOLCHAIN_DIR: /workdir/openwrt/staging_dir
  TOOLCHAIN_BUILD_DIR: /workdir/openwrt/build_dir/toolchain-x86_64_gcc-13.3.0_musl
  PACKAGES_DIR: /workdir/openwrt/bin/targets
  BUILD_STATE_DIR: /workdir/build_state

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@main

    - name: ä¼˜åŒ–ç£ç›˜ç©ºé—´
      uses: easimon/maximize-build-space@master
      with:
        root-reserve-mb: 20480
        swap-size-mb: 5120
        remove-dotnet: 'true'
        remove-android: 'true'
        remove-haskell: 'true'
        remove-codeql: 'true'
        remove-docker-images: 'true'
        build-mount-path: '/workdir'

    - name: é¢å¤–æ¸…ç†ç£ç›˜ç©ºé—´å¹¶æ£€æŸ¥
      run: |
        echo "æ¸…ç†é¢å¤–ç£ç›˜ç©ºé—´..."
        sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /usr/local/share/boost
        sudo rm -rf /usr/share/swift /usr/local/julia* /opt/hostedtoolcache/CodeQL
        docker image prune -a -f || true
        docker system prune -af || true
        sudo apt-get clean
        sudo apt-get autoremove -y
        ROOT_AVAIL=$(df -m /dev/root | tail -1 | awk '{print $4}')
        echo "æ ¹åˆ†åŒºå¯ç”¨ç©ºé—´: ${ROOT_AVAIL}MB"
        if [ "$ROOT_AVAIL" -lt 20480 ]; then
          echo "é”™è¯¯ï¼š/dev/root å¯ç”¨ç©ºé—´ä¸è¶³ 20GB"
          exit 1
        fi
        df -h

    - name: åˆå§‹åŒ–ç¯å¢ƒ
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        sudo -E apt-get -qq update
        # ä¿®å¤CMake - æ¸…ç†å¹¶é‡æ–°å®‰è£…
        sudo -E apt-get -qq remove cmake || true
        
        sudo -E apt-get -qq install ack antlr3 asciidoc autoconf automake autopoint binutils bison build-essential \
        bzip2 ccache cmake cpio curl device-tree-compiler fastjar flex gawk gettext gcc-multilib g++-multilib \
        git gperf haveged help2man intltool libc6-dev-i386 libelf-dev libglib2.0-dev libgmp3-dev libltdl-dev \
        libmpc-dev libmpfr-dev libncurses5-dev libncursesw5-dev libreadline-dev libssl-dev libtool lrzsz \
        mkisofs msmtp nano ninja-build p7zip p7zip-full patch pkgconf python2.7 python3 python3-pyelftools \
        libpython3-dev qemu-utils rsync scons squashfs-tools subversion swig texinfo uglifyjs upx-ucl unzip \
        vim wget xmlto xxd zlib1g-dev python3-setuptools jq bc lm-sensors pciutils
        
        # ç¡®è®¤ CMake ç‰ˆæœ¬
        cmake --version
        
        sudo -E apt-get -qq clean
        sudo timedatectl set-timezone "$TZ"
        mkdir -p ${{ env.BUILD_STATE_DIR }} ${{ env.CCACHE_DIR }}
        chmod -R 777 /workdir
        echo '#!/bin/bash' > $GITHUB_WORKSPACE/diy-part1.sh
        echo '# Feeds å·²é€šè¿‡ FEEDS_CONF_URL é…ç½®' >> $GITHUB_WORKSPACE/diy-part1.sh
        chmod +x $GITHUB_WORKSPACE/diy-part1.sh
        echo '#!/bin/bash' > $GITHUB_WORKSPACE/diy-part2.sh
        echo 'sed -i "s/OpenWrt /OpenWrt_AutoBuild /" package/lean/default-settings/files/zzz-default-settings' >> $GITHUB_WORKSPACE/diy-part2.sh
        chmod +x $GITHUB_WORKSPACE/diy-part2.sh
        if [ ! -f "$GITHUB_WORKSPACE/$CONFIG_FILE" ]; then
          echo "è­¦å‘Šï¼šé…ç½®æ–‡ä»¶ $CONFIG_FILE ä¸å­˜åœ¨ï¼Œåˆ›å»ºé»˜è®¤é…ç½®æ–‡ä»¶"
          echo "# åˆ›å»ºé»˜è®¤çš„æœ€å°åŒ–é…ç½®æ–‡ä»¶" > $GITHUB_WORKSPACE/$CONFIG_FILE
          echo "CONFIG_TARGET_x86=y" >> $GITHUB_WORKSPACE/$CONFIG_FILE
          echo "CONFIG_TARGET_x86_64=y" >> $GITHUB_WORKSPACE/$CONFIG_FILE
          echo "CONFIG_TARGET_x86_64_DEVICE_generic=y" >> $GITHUB_WORKSPACE/$CONFIG_FILE
          echo "CONFIG_PACKAGE_luci=y" >> $GITHUB_WORKSPACE/$CONFIG_FILE
        fi
        df -h

    - name: å…‹éš†æºä»£ç å¹¶é…ç½® Feeds
      working-directory: /workdir
      run: |
        git clone --depth 1 $REPO_URL -b $REPO_BRANCH openwrt
        ln -sf /workdir/openwrt $GITHUB_WORKSPACE/openwrt
        cd openwrt
        find . -type f -name "*.sh" -exec chmod +x {} \;
        curl -L -o feeds.conf.default "$FEEDS_CONF_URL" || echo "è­¦å‘Šï¼šæ— æ³•ä¸‹è½½ feeds.conf.defaultï¼Œä½¿ç”¨ä»“åº“é»˜è®¤é…ç½®"
        cat feeds.conf.default
        rm -rf .git
        # åˆ›å»ºå¿…è¦çš„ç›®å½•ç»“æ„ä»¥ç¡®ä¿ç¼“å­˜æ­£å¸¸å·¥ä½œ
        mkdir -p ${{ env.PACKAGES_DIR }} ${{ env.TOOLCHAIN_DIR }}
        
        # ç¡®ä¿å·¥å…·é“¾æ„å»ºç›®å½•å­˜åœ¨
        mkdir -p ${{ env.TOOLCHAIN_BUILD_DIR }} ${{ env.BUILD_STATE_DIR }}

    # æ¢å¤å·¥å…·é“¾ç¼“å­˜ï¼ˆåŒ…å«staging_dirå’Œbuild_dirçš„å·¥å…·é“¾ï¼‰
    - name: æ¢å¤å·¥å…·é“¾ç¼“å­˜
      uses: actions/cache@v3
      id: cache-toolchain
      if: inputs.clean_build != 'true'
      with:
        path: |
          ${{ env.TOOLCHAIN_DIR }}
          ${{ env.TOOLCHAIN_BUILD_DIR }}
        key: toolchain-${{ env.REPO_BRANCH }}-fixed-cache-v1

    # æ¢å¤ç¼–è¯‘åŒ…ç¼“å­˜
    - name: æ¢å¤ç¼–è¯‘åŒ…ç¼“å­˜
      uses: actions/cache@v3
      id: cache-packages
      if: inputs.clean_build != 'true'
      with:
        path: ${{ env.PACKAGES_DIR }}
        key: packages-${{ env.REPO_BRANCH }}-fixed-cache-v1

    # æ¢å¤CCACHEç¼“å­˜
    - name: æ¢å¤CCACHEç¼“å­˜
      uses: actions/cache@v3
      id: cache-ccache
      with:
        path: ${{ env.CCACHE_DIR }}
        key: ccache-${{ env.REPO_BRANCH }}-fixed-cache-v1

    # æ¢å¤æ„å»ºçŠ¶æ€ç¼“å­˜
    - name: æ¢å¤æ„å»ºçŠ¶æ€ç¼“å­˜
      uses: actions/cache@v3
      id: cache-state
      if: inputs.clean_build != 'true'
      with:
        path: ${{ env.BUILD_STATE_DIR }}
        key: state-${{ env.REPO_BRANCH }}-fixed-cache-v1

    - name: ç¼“å­˜å‡†å¤‡å’ŒéªŒè¯
      run: |
        echo "CONFIG_FILE: ${{ env.CONFIG_FILE }}"
        echo "å·¥å…·é“¾ç¼“å­˜æ¢å¤çŠ¶æ€: ${{ steps.cache-toolchain.outputs.cache-hit == 'true' && 'æˆåŠŸ' || 'æœªæ‰¾åˆ°ç¼“å­˜' }}"
        echo "ç¼–è¯‘åŒ…ç¼“å­˜æ¢å¤çŠ¶æ€: ${{ steps.cache-packages.outputs.cache-hit == 'true' && 'æˆåŠŸ' || 'æœªæ‰¾åˆ°ç¼“å­˜' }}"
        echo "CCACHEç¼“å­˜æ¢å¤çŠ¶æ€: ${{ steps.cache-ccache.outputs.cache-hit == 'true' && 'æˆåŠŸ' || 'æœªæ‰¾åˆ°ç¼“å­˜' }}"
        echo "æ„å»ºçŠ¶æ€ç¼“å­˜æ¢å¤çŠ¶æ€: ${{ steps.cache-state.outputs.cache-hit == 'true' && 'æˆåŠŸ' || 'æœªæ‰¾åˆ°ç¼“å­˜' }}"
        
        # åˆ›å»ºå¿…è¦çš„ç›®å½•ç»“æ„
        mkdir -p ${{ env.TOOLCHAIN_DIR }} ${{ env.TOOLCHAIN_BUILD_DIR }} ${{ env.PACKAGES_DIR }} ${{ env.BUILD_STATE_DIR }}
        chmod -R 777 ${{ env.TOOLCHAIN_DIR }} ${{ env.TOOLCHAIN_BUILD_DIR }} ${{ env.PACKAGES_DIR }} ${{ env.BUILD_STATE_DIR }}
        
        # æ£€æŸ¥å·¥å…·é“¾ç¼“å­˜å¤§å°
        echo "å·¥å…·é“¾ç›®å½•å¤§å°: $(du -sh ${{ env.TOOLCHAIN_DIR }} 2>/dev/null || echo 'ç›®å½•ä¸å­˜åœ¨æˆ–ä¸ºç©º')"
        echo "å·¥å…·é“¾æ„å»ºç›®å½•å¤§å°: $(du -sh ${{ env.TOOLCHAIN_BUILD_DIR }} 2>/dev/null || echo 'ç›®å½•ä¸å­˜åœ¨æˆ–ä¸ºç©º')"
        echo "ç¼–è¯‘åŒ…ç›®å½•å¤§å°: $(du -sh ${{ env.PACKAGES_DIR }} 2>/dev/null || echo 'ç›®å½•ä¸å­˜åœ¨æˆ–ä¸ºç©º')"
        
        # æ£€æŸ¥å…³é”®å·¥å…·é“¾æ–‡ä»¶
        echo "æ£€æŸ¥å…³é”®å·¥å…·é“¾æ–‡ä»¶..."
        find ${{ env.TOOLCHAIN_DIR }}/host/bin -name "gcc*" 2>/dev/null | head -5 || echo "æœªæ‰¾åˆ°ä¸»æœºgcc"
        find ${{ env.TOOLCHAIN_DIR }}/toolchain-* -name "*gcc*" 2>/dev/null | head -5 || echo "æœªæ‰¾åˆ°äº¤å‰ç¼–è¯‘å™¨gcc"
        
        # æ¸…ç†å¯èƒ½å¯¼è‡´é—®é¢˜çš„CMakeç¼“å­˜æ–‡ä»¶
        find ${{ env.TOOLCHAIN_DIR }} -name "CMakeCache.txt" -delete || true
        find ${{ env.TOOLCHAIN_BUILD_DIR }} -name "CMakeCache.txt" -delete || true
        
        ls -la ${{ env.BUILD_STATE_DIR }}/ || echo "æ„å»ºçŠ¶æ€ç›®å½•ä¸ºç©º"
        if [ -f "${{ env.BUILD_STATE_DIR }}/config.md5" ]; then
          echo "ä¹‹å‰MD5: $(cat ${{ env.BUILD_STATE_DIR }}/config.md5)"
        fi
        
        if [ -d "${{ env.TOOLCHAIN_DIR }}/host/bin" ] && [ -f "${{ env.TOOLCHAIN_DIR }}/host/bin/libdeflate-gzip" ]; then
          echo "å·¥å…·é“¾åŒ…å« libdeflate-gzipï¼Œç¼“å­˜æ­£å¸¸"
        else
          echo "è­¦å‘Šï¼šå·¥å…·é“¾ç¼“å­˜ç¼ºå°‘ libdeflate-gzip"
          echo "toolchain_valid=false" >> $GITHUB_ENV
        fi
        df -h

    - name: é…ç½®ç¼–è¯‘ç¯å¢ƒ
      run: |
        cd /workdir/openwrt
        if [ -f ".config" ]; then
          cp .config .config.original
        fi
        $GITHUB_WORKSPACE/$DIY_P1_SH
        echo "æ›´æ–°å¹¶å®‰è£… Feeds..."
        ./scripts/feeds update -a
        ./scripts/feeds install -a
        [ -e $GITHUB_WORKSPACE/files ] && cp -r $GITHUB_WORKSPACE/files ./files
        cp $GITHUB_WORKSPACE/$CONFIG_FILE ./.config
        cp .config .config.input
        $GITHUB_WORKSPACE/$DIY_P2_SH
        echo "CONFIG_AUTOREMOVE=n" >> .config
        echo "CONFIG_AUTOREBUILD=n" >> .config
        make defconfig
        # ä¿®å¤è¿™é‡Œ - Aä½¿ç”¨æ’åºå‘½ä»¤
        grep "^CONFIG_PACKAGE_.*=y" .config.input | sort > packages_input.txt || true
        grep "^CONFIG_PACKAGE_.*=y" .config | sort > packages_defconfig.txt || true
        comm -23 packages_input.txt packages_defconfig.txt > missing_packages.txt
        if [ -s missing_packages.txt ]; then
          echo "è­¦å‘Šï¼šä»¥ä¸‹åŒ…åœ¨ defconfig åç¼ºå¤±ï¼Œå°†å°è¯•æ¢å¤ï¼š"
          cat missing_packages.txt
          cat missing_packages.txt >> .config
          while read -r line; do
            pkg=$(echo "$line" | sed 's/CONFIG_PACKAGE_\(.*\)=y/\1/')
            echo "å®‰è£…åŒ…: $pkg"
            ./scripts/feeds install "$pkg" || echo "è­¦å‘Šï¼šæ— æ³•å®‰è£… $pkgï¼Œå¯èƒ½ä¸åœ¨ feeds ä¸­"
          done < missing_packages.txt
          make defconfig
        else
          echo "æ‰€æœ‰é…ç½®é¡¹å‡ä¿ç•™ï¼Œæ— ç¼ºå¤±"
        fi
        diff .config.input .config > config_diff.txt || echo "é…ç½®æ— å·®å¼‚"
        cat config_diff.txt
        df -h

    - name: æ£€æŸ¥æºç å˜åŒ–
      id: check-feeds
      run: |
        cd /workdir/openwrt
        mkdir -p ${{ env.BUILD_STATE_DIR }}
        find feeds -type f -name "Makefile" -exec sha256sum {} \; | sort | sha256sum > ${{ env.BUILD_STATE_DIR }}/feeds.sha256
        CURRENT_FEEDS_HASH=$(cat ${{ env.BUILD_STATE_DIR }}/feeds.sha256 | awk '{print $1}')
        PREVIOUS_FEEDS_HASH=$(cat ${{ env.BUILD_STATE_DIR }}/previous_feeds.sha256 2>/dev/null | awk '{print $1}' || echo "")
        
        echo "å½“å‰ feeds å“ˆå¸Œ: $CURRENT_FEEDS_HASH"
        echo "ä¹‹å‰ feeds å“ˆå¸Œ: $PREVIOUS_FEEDS_HASH"
        
        if [ "$CURRENT_FEEDS_HASH" != "$PREVIOUS_FEEDS_HASH" ]; then
          echo "feeds_changed=true" >> $GITHUB_ENV
          echo "Feeds å·²å˜æ›´ï¼Œéœ€è¦é‡æ–°ç¼–è¯‘"
        else
          echo "feeds_changed=false" >> $GITHUB_ENV
          echo "Feeds æœªå˜æ›´ï¼Œå¯ä»¥ä½¿ç”¨ç¼“å­˜åŒ…"
        fi
        
        # ä¿å­˜å½“å‰å“ˆå¸Œå€¼ä¾›ä¸‹æ¬¡æ¯”è¾ƒ
        cp ${{ env.BUILD_STATE_DIR }}/feeds.sha256 ${{ env.BUILD_STATE_DIR }}/previous_feeds.sha256

    - name: æ¢å¤å·²ç¼–è¯‘è½¯ä»¶åŒ…
      if: steps.cache-packages.outputs.cache-hit == 'true'
      run: |
        cd /workdir/openwrt
        mkdir -p bin/targets
        if [ "${{ env.feeds_changed }}" = "true" ]; then
          echo "feeds å·²æ›´æ–°ï¼Œè·³è¿‡æ¢å¤æ—§çš„ç¼–è¯‘åŒ…ç¼“å­˜"
        else
          echo "feeds æœªå˜æ›´ï¼Œä½¿ç”¨ç¼“å­˜ç¼–è¯‘åŒ…"
          find ${{ env.PACKAGES_DIR }} -type f | wc -l
        fi

    - name: ä¿®å¤CMakeé—®é¢˜
      run: |
        echo "ä¿®å¤CMakeé—®é¢˜..."
        # ç¡®ä¿ä½¿ç”¨æœ€æ–°ç‰ˆæœ¬çš„CMake
        sudo apt-get purge -y cmake || true
        sudo apt-get update
        sudo apt-get install -y cmake
        # éªŒè¯CMakeç‰ˆæœ¬
        cmake --version
        # æ¸…ç†CMakeç¼“å­˜
        cd /workdir/openwrt
        find . -name "CMakeCache.txt" -delete || true
        # ç¡®ä¿æ²¡æœ‰æŸåçš„CMakeæ–‡ä»¶
        find . -name "CMakeLists.txt" -exec grep -l "CMAKE_PLATFORM_INFO_INITIALIZED" {} \; | xargs -r cat || true

    - name: å¼€å¯SSHè°ƒè¯•
      uses: mxschmitt/action-tmate@v3
      if: github.event.inputs.ssh == 'true'

    - name: ä¸‹è½½è½¯ä»¶åŒ…
      run: |
        cd /workdir/openwrt
        make download -j8 || make download -j1 V=s
        mkdir -p ${{ env.CCACHE_DIR }}
        ccache -o cache_dir=${{ env.CCACHE_DIR }}
        ccache -o max_size=8G  # å¢åŠ CCACHEå¤§å°
        ccache -z
        df -h

    - name: æ™ºèƒ½ç¼–è¯‘å›ºä»¶
      id: compile
      run: |
        cd /workdir/openwrt
        export CCACHE_DIR=${{ env.CCACHE_DIR }}
        export PATH="/usr/lib/ccache:$PATH"

        cleanup_temp_files() {
          echo "æ¸…ç†ä¸´æ—¶æ–‡ä»¶ä»¥é‡Šæ”¾ç©ºé—´..."
          find /tmp -type f -delete || true
          df -h
        }

        save_cache_info() {
          echo "ä¿å­˜ç¼“å­˜çŠ¶æ€ä¿¡æ¯..."
          mkdir -p ${{ env.BUILD_STATE_DIR }}
          cp .config ${{ env.BUILD_STATE_DIR }}/config.txt
          echo "$TOOLCHAIN_MD5" > ${{ env.BUILD_STATE_DIR }}/toolchain.md5
          echo "$PACKAGE_MD5" > ${{ env.BUILD_STATE_DIR }}/package.md5
          echo "ä¿å­˜æ„å»ºçŠ¶æ€å®Œæˆ"
        }

        compile_firmware() {
          # æ£€æŸ¥å¯ç”¨å†…å­˜å¹¶åŠ¨æ€è°ƒæ•´å¹¶è¡Œä»»åŠ¡æ•°
          AVAIL_MEM=$(free -m | awk '/^Mem:/{print $7}')
          JOBS=$(( AVAIL_MEM / 1024 > 1 ? AVAIL_MEM / 1024 : 1 ))
          if [ $JOBS -gt $(nproc) ]; then
            JOBS=$(nproc)
          fi
          echo "å¯ç”¨å†…å­˜: ${AVAIL_MEM}MB, è®¾ç½®å¹¶è¡Œä»»åŠ¡æ•°: $JOBS"
          
          if [ $DO_FULL_BUILD -eq 1 ]; then
            echo "ä¸‹è½½ä¾èµ–..."
            make download -j8 V=s || make download -j1 V=s
            if [ ! -d "${{ env.TOOLCHAIN_DIR }}/toolchain-"* ]; then
              echo "ç¼–è¯‘å·¥å…·é“¾..."
              make -j$JOBS tools/compile V=s || make -j1 V=s tools/compile
              make -j$JOBS toolchain/compile V=s || make -j1 V=s toolchain/compile
            else
              echo "å·¥å…·é“¾å·²å­˜åœ¨ï¼Œè·³è¿‡ç¼–è¯‘"
            fi
            cleanup_temp_files
            echo "ç¼–è¯‘å®Œæ•´å›ºä»¶..."
            make -j$JOBS V=s || make -j2 V=s || make -j1 V=s
          elif [ $DO_PACKAGE_BUILD -eq 1 ] || [ "${{ env.feeds_changed }}" = "true" ]; then
            echo "è½¯ä»¶åŒ…é…ç½®å˜åŒ–æˆ–æºç æ›´æ–°ï¼Œç¼–è¯‘è½¯ä»¶åŒ…..."
            make -j$JOBS package/clean V=s || make -j1 V=s package/clean
            make -j$JOBS package/compile V=s || make -j2 V=s package/compile || make -j1 V=s package/compile
            make -j$JOBS package/index V=s || make -j1 V=s package/index
            make -j$JOBS target/install V=s || make -j1 V=s target/install  # ç¡®ä¿ç”Ÿæˆå›ºä»¶
          else
            echo "é…ç½®å’Œfeedséƒ½æœªå˜åŒ–ï¼Œæ‰§è¡Œæœ€å°å¢é‡ç¼–è¯‘..."
            # ç›´æ¥ä½¿ç”¨ç¼“å­˜çš„è½¯ä»¶åŒ…ç”Ÿæˆå›ºä»¶ï¼Œä¸æ¸…ç†å’Œé‡æ–°ç¼–è¯‘
            make -j$JOBS V=s || make -j2 V=s || make -j1 V=s
          fi

          # ä¿å­˜ç¼“å­˜ä¿¡æ¯
          save_cache_info

          if [ $? -eq 0 ]; then
            echo "ç¼–è¯‘æˆåŠŸ"
          else
            echo "ç¼–è¯‘å¤±è´¥"
            exit 1
          fi
        }

        TOOLCHAIN_CONFIG=$(grep "^CONFIG_TARGET" .config | sort)
        TOOLCHAIN_MD5=$(echo "$TOOLCHAIN_CONFIG" | md5sum | awk '{print $1}')
        PREVIOUS_TOOLCHAIN_MD5=$(cat ${{ env.BUILD_STATE_DIR }}/toolchain.md5 2>/dev/null || echo "")
        PACKAGE_CONFIG=$(grep "^CONFIG_PACKAGE" .config | sort)
        PACKAGE_MD5=$(echo "$PACKAGE_CONFIG" | md5sum | awk '{print $1}')
        PREVIOUS_PACKAGE_MD5=$(cat ${{ env.BUILD_STATE_DIR }}/package.md5 2>/dev/null || echo "")
        DO_FULL_BUILD=0
        DO_PACKAGE_BUILD=0

        if [ -z "$PREVIOUS_TOOLCHAIN_MD5" ] || [ "$TOOLCHAIN_MD5" != "$PREVIOUS_TOOLCHAIN_MD5" ] || [ "${{ github.event.inputs.clean_build }}" = "true" ] || [ "${{ env.toolchain_valid }}" = "false" ]; then
          echo "å·¥å…·é“¾é…ç½®å˜åŒ–æˆ–é¦–æ¬¡ç¼–è¯‘ï¼Œéœ€è¦å…¨é‡ç¼–è¯‘"
          DO_FULL_BUILD=1
        elif [ -z "$PREVIOUS_PACKAGE_MD5" ] || [ "$PACKAGE_MD5" != "$PREVIOUS_PACKAGE_MD5" ]; then
          echo "è½¯ä»¶åŒ…é…ç½®å˜åŒ–ï¼Œéœ€è¦ç¼–è¯‘è½¯ä»¶åŒ…"
          DO_PACKAGE_BUILD=1
        else
          echo "é…ç½®æœªå˜ï¼Œæ£€æŸ¥æºç å˜åŒ–..."
        fi

        compile_firmware

        echo "DEVICE_NAME=_$(grep '^CONFIG_TARGET.*DEVICE.*=y' .config | sed -r 's/.*DEVICE_(.*)=y/\1/' | tr '\n' '_')" >> $GITHUB_ENV
        echo "FILE_DATE=_$(date +"%Y%m%d%H%M")" >> $GITHUB_ENV
        echo "status=success" >> $GITHUB_OUTPUT
        ccache -s
        df -h

    # å¤‡ä»½ç¼“å­˜å‰æ£€æŸ¥å·¥å…·é“¾å¤§å°
    - name: æ£€æŸ¥å·¥å…·é“¾å¤§å°
      if: "!cancelled()"
      run: |
        echo "ç¼–è¯‘å®Œæˆï¼Œæ£€æŸ¥å·¥å…·é“¾å¤§å°..."
        echo "å·¥å…·é“¾ç›®å½•å¤§å°: $(du -sh ${{ env.TOOLCHAIN_DIR }} 2>/dev/null || echo 'ç›®å½•ä¸å­˜åœ¨æˆ–ä¸ºç©º')"
        echo "å·¥å…·é“¾æ„å»ºç›®å½•å¤§å°: $(du -sh ${{ env.TOOLCHAIN_BUILD_DIR }} 2>/dev/null || echo 'ç›®å½•ä¸å­˜åœ¨æˆ–ä¸ºç©º')"
        echo "ä¸»æœºå·¥å…·é“¾ç›®å½•: $(du -sh ${{ env.TOOLCHAIN_DIR }}/host 2>/dev/null || echo 'ç›®å½•ä¸å­˜åœ¨æˆ–ä¸ºç©º')"
        echo "ç›®æ ‡å·¥å…·é“¾ç›®å½•: $(du -sh ${{ env.TOOLCHAIN_DIR }}/toolchain-* 2>/dev/null || echo 'ç›®å½•ä¸å­˜åœ¨æˆ–ä¸ºç©º')"
        echo "CCACHE ç›®å½•å¤§å°: $(du -sh ${{ env.CCACHE_DIR }} 2>/dev/null || echo 'ç›®å½•ä¸å­˜åœ¨æˆ–ä¸ºç©º')"
        echo "ç¼–è¯‘åŒ…ç›®å½•å¤§å°: $(du -sh ${{ env.PACKAGES_DIR }} 2>/dev/null || echo 'ç›®å½•ä¸å­˜åœ¨æˆ–ä¸ºç©º')"
        echo "æ„å»ºçŠ¶æ€ç›®å½•å¤§å°: $(du -sh ${{ env.BUILD_STATE_DIR }} 2>/dev/null || echo 'ç›®å½•ä¸å­˜åœ¨æˆ–ä¸ºç©º')"
        
        # æ£€æŸ¥å…³é”®æ–‡ä»¶
        echo "æ£€æŸ¥å…³é”®å·¥å…·é“¾æ–‡ä»¶..."
        find ${{ env.TOOLCHAIN_DIR }}/host/bin -name "gcc*" 2>/dev/null | head -5 || echo "æœªæ‰¾åˆ°ä¸»æœºgcc"
        find ${{ env.TOOLCHAIN_DIR }}/toolchain-* -name "*gcc*" 2>/dev/null | head -5 || echo "æœªæ‰¾åˆ°äº¤å‰ç¼–è¯‘å™¨gcc"
        
        # ç¡®ä¿æ„å»ºçŠ¶æ€ç›®å½•åŒ…å«æ—¶é—´æˆ³ä¿¡æ¯
        mkdir -p ${{ env.BUILD_STATE_DIR }}
        echo "ç¼“å­˜åˆ›å»ºæ—¶é—´: $(date)" > ${{ env.BUILD_STATE_DIR }}/cache_timestamp.txt
        echo "è¿è¡ŒID: ${{ github.run_id }}" >> ${{ env.BUILD_STATE_DIR }}/cache_timestamp.txt
        echo "æ„å»ºåˆ†æ”¯: ${{ env.REPO_BRANCH }}" >> ${{ env.BUILD_STATE_DIR }}/cache_timestamp.txt

    # æ¸…ç†ä¸å¿…è¦çš„ç¼“å­˜æ–‡ä»¶
    - name: æ¸…ç†ä¸å¿…è¦çš„ç¼“å­˜æ–‡ä»¶
      if: "!cancelled()"
      run: |
        # æ¸…ç†ä¸å¿…è¦çš„å¯¹è±¡æ–‡ä»¶ä»¥å‡å°ç¼“å­˜å¤§å°
        find ${{ env.TOOLCHAIN_BUILD_DIR }} -type f -name "*.o" -delete || true
        find ${{ env.TOOLCHAIN_BUILD_DIR }} -type f -name "*.a" -not -path "*/lib/*" -delete || true
        # æ¸…ç†å¯èƒ½æœ‰é—®é¢˜çš„CMakeæ–‡ä»¶
        find ${{ env.TOOLCHAIN_DIR }} -name "CMakeCache.txt" -delete || true
        find ${{ env.TOOLCHAIN_BUILD_DIR }} -name "CMakeCache.txt" -delete || true
        # æ˜¾ç¤ºæ¸…ç†åçš„å¤§å°
        echo "æ¸…ç†åå·¥å…·é“¾æ„å»ºç›®å½•å¤§å°: $(du -sh ${{ env.TOOLCHAIN_BUILD_DIR }} 2>/dev/null || echo 'ç›®å½•ä¸å­˜åœ¨æˆ–ä¸ºç©º')"

    # ä¿å­˜å·¥å…·é“¾ç¼“å­˜
    - name: ä¿å­˜å·¥å…·é“¾ç¼“å­˜
      uses: actions/cache@v3
      if: "!cancelled()"
      with:
        path: |
          ${{ env.TOOLCHAIN_DIR }}
          ${{ env.TOOLCHAIN_BUILD_DIR }}
        key: toolchain-${{ env.REPO_BRANCH }}-fixed-cache-v1
    
    # ä¿å­˜ç¼–è¯‘åŒ…ç¼“å­˜
    - name: ä¿å­˜ç¼–è¯‘åŒ…ç¼“å­˜
      uses: actions/cache@v3
      if: "!cancelled()"
      with:
        path: ${{ env.PACKAGES_DIR }}
        key: packages-${{ env.REPO_BRANCH }}-fixed-cache-v1
    
    # ä¿å­˜æ„å»ºçŠ¶æ€ç¼“å­˜
    - name: ä¿å­˜æ„å»ºçŠ¶æ€ç¼“å­˜
      uses: actions/cache@v3
      if: "!cancelled()"
      with:
        path: ${{ env.BUILD_STATE_DIR }}
        key: state-${{ env.REPO_BRANCH }}-fixed-cache-v1
    
    # ä¿å­˜CCACHEç¼“å­˜
    - name: ä¿å­˜CCACHEç¼“å­˜
      uses: actions/cache@v3
      if: "!cancelled()"
      with:
        path: ${{ env.CCACHE_DIR }}
        key: ccache-${{ env.REPO_BRANCH }}-fixed-cache-v1

    - name: éªŒè¯ç¼“å­˜å·²ä¿å­˜
      if: "!cancelled()"
      run: |
        echo "å·²å®Œæˆæ‰€æœ‰ç¼“å­˜ä¿å­˜ï¼Œç°åœ¨å¯ä»¥å®‰å…¨åœ°è¿›è¡Œåç»­æ–‡ä»¶æ•´ç†å’Œæ¸…ç†æ“ä½œ"
        # æ˜¾ç¤ºç¼“å­˜æ—¶é—´æˆ³
        if [ -f "${{ env.BUILD_STATE_DIR }}/cache_timestamp.txt" ]; then
          echo "ç¼“å­˜æ—¶é—´æˆ³å†…å®¹:"
          cat ${{ env.BUILD_STATE_DIR }}/cache_timestamp.txt
        fi
        df -h

    # ç°åœ¨å¯ä»¥å®‰å…¨åœ°è¿›è¡Œæ–‡ä»¶æ•´ç†å’Œä¸Šä¼ 
    - name: æ•´ç†æ–‡ä»¶
      id: organize
      if: steps.compile.outputs.status == 'success' && env.UPLOAD_FIRMWARE == 'true' && !cancelled()
      run: |
        cd /workdir/openwrt/bin/targets/*/*
        # æ³¨æ„ï¼šä¸è¦åˆ é™¤å¯èƒ½ç”¨äºç¼“å­˜çš„æ–‡ä»¶
        mkdir -p firmware
        FIRMWARE_FILES=$(find . -maxdepth 1 -name "*combined*" -or -name "*sysupgrade*")
        if [ -z "$FIRMWARE_FILES" ]; then
          echo "è­¦å‘Šï¼šæœªæ‰¾åˆ°å›ºä»¶æ–‡ä»¶ï¼Œä½¿ç”¨æ‰€æœ‰binæ–‡ä»¶"
          FIRMWARE_FILES=$(find . -maxdepth 1 -name "*.bin")
        fi
        if [ -n "$FIRMWARE_FILES" ]; then
          echo "$FIRMWARE_FILES" | xargs -i cp {} ./firmware/
        else
          cp -r * ./firmware/
        fi
        cp /workdir/openwrt/.config ./firmware/config.txt
        zip -r firmware.zip firmware
        echo "FIRMWARE=$PWD/firmware" >> $GITHUB_ENV
        echo "FIRMWARE_ZIP=$PWD/firmware.zip" >> $GITHUB_ENV
        echo "status=success" >> $GITHUB_OUTPUT

    # ä¸Šä¼ å›ºä»¶
    - name: ä¸Šä¼ å›ºä»¶ç›®å½•
      uses: actions/upload-artifact@main
      if: steps.organize.outputs.status == 'success' && !cancelled()
      with:
        name: OpenWrt_firmware${{ env.DEVICE_NAME }}${{ env.FILE_DATE }}
        path: ${{ env.FIRMWARE }}

    - name: ç”Ÿæˆå‘å¸ƒæ ‡ç­¾
      id: tag
      if: steps.organize.outputs.status == 'success' && env.UPLOAD_RELEASE == 'true' && !cancelled()
      run: |
        echo "RELEASE_TAG=$(date +"%Y.%m.%d-%H%M")" >> $GITHUB_OUTPUT
        echo "## OpenWrtå›ºä»¶æ„å»ºå®Œæˆ ğŸ“¦" > release.txt
        echo "ğŸ“… æ„å»ºæ—¶é—´: $(date +"%Y-%m-%d %H:%
