name: å…¨æ–°ç¼–è¯‘ç¬¬11ç‰ˆ(Gemini)

on:
  workflow_dispatch:
    inputs:
      ssh:
        description: 'SSHè°ƒè¯•'
        required: false
        default: 'false'
      clean_build:
        description: 'å®Œå…¨é‡æ–°ç¼–è¯‘'
        required: false
        default: 'false'
      config_file:
        description: 'é…ç½®æ–‡ä»¶'
        required: false
        default: 'å¢é‡ç¼“å­˜ä¼˜åŒ–.config'

env:
  REPO_URL: https://github.com/coolsnowwolf/lede
  REPO_BRANCH: master
  FEEDS_CONF_URL: https://github.com/tikkacn/openwrt-new-rom/raw/main/feeds.conf.default
  CONFIG_FILE: ${{ github.event.inputs.config_file || 'å¢é‡ç¼“å­˜ä¼˜åŒ–.config' }}
  DIY_P1_SH: diy-part1.sh
  DIY_P2_SH: diy-part2.sh
  UPLOAD_FIRMWARE: true
  UPLOAD_RELEASE: true
  TZ: Asia/Shanghai
  CCACHE_DIR: /workdir/ccache
  TOOLCHAIN_DIR: /workdir/openwrt/staging_dir
  TOOLCHAIN_BUILD_DIR: /workdir/openwrt/build_dir/toolchain-x86_64_gcc-13.3.0_musl
  PACKAGES_DIR: /workdir/openwrt/bin/targets
  BUILD_STATE_DIR: /workdir/build_state
  CCACHE_LOGFILE: /tmp/ccache_detailed.log # æ–°å¢: ccacheè¯¦ç»†æ—¥å¿—æ–‡ä»¶è·¯å¾„
  DEBUG_LOG_FILE: /tmp/build_debug_summary.log # æ–°å¢: è°ƒè¯•æ‘˜è¦æ—¥å¿—æ–‡ä»¶è·¯å¾„

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@main

    - name: ä¼˜åŒ–ç£ç›˜ç©ºé—´
      uses: easimon/maximize-build-space@master
      with:
        root-reserve-mb: 20480
        swap-size-mb: 5120
        remove-dotnet: 'true'
        remove-android: 'true'
        remove-haskell: 'true'
        remove-codeql: 'true'
        remove-docker-images: 'true'
        build-mount-path: '/workdir'

    - name: é¢å¤–æ¸…ç†ç£ç›˜ç©ºé—´å¹¶æ£€æŸ¥
      run: |
        echo "æ¸…ç†é¢å¤–ç£ç›˜ç©ºé—´..."
        sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /usr/local/share/boost
        sudo rm -rf /usr/share/swift /usr/local/julia* /opt/hostedtoolcache/CodeQL
        docker image prune -a -f || true
        docker system prune -af || true
        sudo apt-get clean
        sudo apt-get autoremove -y
        ROOT_AVAIL=$(df -m /dev/root | tail -1 | awk '{print $4}')
        echo "æ ¹åˆ†åŒºå¯ç”¨ç©ºé—´: ${ROOT_AVAIL}MB"
        if [ "$ROOT_AVAIL" -lt 20480 ]; then
          echo "é”™è¯¯ï¼š/dev/root å¯ç”¨ç©ºé—´ä¸è¶³ 20GB"
          exit 1
        fi
        df -h

    - name: åˆå§‹åŒ–ç¯å¢ƒ
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        sudo -E apt-get -qq update
        sudo -E apt-get -qq install ack antlr3 asciidoc autoconf automake autopoint binutils bison build-essential \
        bzip2 ccache clang cmake cpio curl device-tree-compiler flex gawk gcc-multilib g++-multilib gettext \
        genisoimage git gperf haveged help2man intltool libc6-dev-i386 libelf-dev libfuse-dev libglib2.0-dev \
        libgmp3-dev libltdl-dev libmpc-dev libmpfr-dev libncurses5-dev libncursesw5-dev libpython3-dev \
        libreadline-dev libssl-dev libtool llvm lrzsz msmtp ninja-build p7zip p7zip-full patch pkgconf \
        python3 python3-pyelftools python3-setuptools qemu-utils rsync scons squashfs-tools subversion \
        swig texinfo uglifyjs upx-ucl unzip vim wget xmlto xxd zlib1g-dev
        sudo -E apt-get -qq clean
        sudo timedatectl set-timezone "$TZ"
        mkdir -p ${{ env.BUILD_STATE_DIR }} ${{ env.CCACHE_DIR }}
        chmod -R 777 /workdir
        echo '#!/bin/bash' > $GITHUB_WORKSPACE/diy-part1.sh
        echo '# Feeds å·²é€šè¿‡ FEEDS_CONF_URL é…ç½®' >> $GITHUB_WORKSPACE/diy-part1.sh
        echo '# æ— è‡ªå®šä¹‰å†…å®¹ (diy-part1.sh)' >> $GITHUB_WORKSPACE/diy-part1.sh # æ˜ç¡®æ— å†…å®¹
        chmod +x $GITHUB_WORKSPACE/diy-part1.sh
        echo '#!/bin/bash' > $GITHUB_WORKSPACE/diy-part2.sh
        echo 'sed -i "s/OpenWrt /OpenWrt_AutoBuild /" package/lean/default-settings/files/zzz-default-settings' >> $GITHUB_WORKSPACE/diy-part2.sh
        echo '# æ— é¢å¤–è‡ªå®šä¹‰å†…å®¹ (diy-part2.sh)' >> $GITHUB_WORKSPACE/diy-part2.sh # æ˜ç¡®é™¤bannerå¤–æ— å†…å®¹
        chmod +x $GITHUB_WORKSPACE/diy-part2.sh
        if [ ! -f "$GITHUB_WORKSPACE/$CONFIG_FILE" ]; then
          echo "è­¦å‘Šï¼šé…ç½®æ–‡ä»¶ $CONFIG_FILE ä¸å­˜åœ¨ï¼Œåˆ›å»ºé»˜è®¤é…ç½®æ–‡ä»¶"
          echo "# åˆ›å»ºé»˜è®¤çš„æœ€å°åŒ–é…ç½®æ–‡ä»¶" > $GITHUB_WORKSPACE/$CONFIG_FILE
          echo "CONFIG_TARGET_x86=y" >> $GITHUB_WORKSPACE/$CONFIG_FILE
          echo "CONFIG_TARGET_x86_64=y" >> $GITHUB_WORKSPACE/$CONFIG_FILE
          echo "CONFIG_TARGET_x86_64_DEVICE_generic=y" >> $GITHUB_WORKSPACE/$CONFIG_FILE
          echo "CONFIG_PACKAGE_luci=y" >> $GITHUB_WORKSPACE/$CONFIG_FILE
        fi
        df -h

    - name: å…‹éš†æºä»£ç å¹¶é…ç½® Feeds
      working-directory: /workdir
      run: |
        git clone --depth 1 $REPO_URL -b $REPO_BRANCH openwrt
        ln -sf /workdir/openwrt $GITHUB_WORKSPACE/openwrt
        cd openwrt
        find . -type f -name "*.sh" -exec chmod +x {} \;
        curl -L -o feeds.conf.default "$FEEDS_CONF_URL" || echo "è­¦å‘Šï¼šæ— æ³•ä¸‹è½½ feeds.conf.defaultï¼Œä½¿ç”¨ä»“åº“é»˜è®¤é…ç½®"
        cat feeds.conf.default
        rm -rf .git
        mkdir -p ${{ env.PACKAGES_DIR }} ${{ env.TOOLCHAIN_DIR }}
        mkdir -p ${{ env.TOOLCHAIN_BUILD_DIR }} ${{ env.BUILD_STATE_DIR }}
        mkdir -p logs

    - name: æ¢å¤å·¥å…·é“¾ç¼“å­˜
      uses: actions/cache@v3
      id: cache-toolchain
      if: inputs.clean_build != 'true'
      with:
        path: |
          ${{ env.TOOLCHAIN_DIR }}
          ${{ env.TOOLCHAIN_BUILD_DIR }}
        key: toolchain-${{ env.REPO_BRANCH }}-fixed-cache

    - name: æ¢å¤ç¼–è¯‘åŒ…ç¼“å­˜
      uses: actions/cache@v3
      id: cache-packages
      if: inputs.clean_build != 'true'
      with:
        path: ${{ env.PACKAGES_DIR }}
        key: packages-${{ env.REPO_BRANCH }}-fixed-cache

    - name: æ¢å¤CCACHEç¼“å­˜
      uses: actions/cache@v3
      id: cache-ccache
      with: # CCACHE æ€»æ˜¯å°è¯•æ¢å¤ï¼Œé™¤éæ˜¯å®Œå…¨ clean_build (ç”±ç”¨æˆ·å†³å®šæ˜¯å¦è¦æ¸…ç©ºç½‘é¡µä¸Šçš„cache)
        path: ${{ env.CCACHE_DIR }}
        key: ccache-${{ env.REPO_BRANCH }}-fixed-cache

    - name: æ¢å¤æ„å»ºçŠ¶æ€ç¼“å­˜
      uses: actions/cache@v3
      id: cache-state
      if: inputs.clean_build != 'true'
      with:
        path: ${{ env.BUILD_STATE_DIR }}
        key: state-${{ env.REPO_BRANCH }}-fixed-cache

    - name: æ£€æŸ¥ç¼“å­˜æ¢å¤çŠ¶æ€
      run: |
        echo "--- Debug Log: Cache Status ---" | tee -a ${{ env.DEBUG_LOG_FILE }}
        echo "CONFIG_FILE: ${{ env.CONFIG_FILE }}" | tee -a ${{ env.DEBUG_LOG_FILE }}
        echo "å·¥å…·é“¾ç¼“å­˜æ¢å¤çŠ¶æ€: ${{ steps.cache-toolchain.outputs.cache-hit == 'true' && 'æˆåŠŸ' || 'æœªæ‰¾åˆ°ç¼“å­˜æˆ–ä¸ä½¿ç”¨' }}" | tee -a ${{ env.DEBUG_LOG_FILE }}
        echo "ç¼–è¯‘åŒ…ç¼“å­˜æ¢å¤çŠ¶æ€: ${{ steps.cache-packages.outputs.cache-hit == 'true' && 'æˆåŠŸ' || 'æœªæ‰¾åˆ°ç¼“å­˜æˆ–ä¸ä½¿ç”¨' }}" | tee -a ${{ env.DEBUG_LOG_FILE }}
        echo "CCACHEç¼“å­˜æ¢å¤çŠ¶æ€: ${{ steps.cache-ccache.outputs.cache-hit == 'true' && 'æˆåŠŸ' || 'æœªæ‰¾åˆ°ç¼“å­˜' }}" | tee -a ${{ env.DEBUG_LOG_FILE }}
        echo "æ„å»ºçŠ¶æ€ç¼“å­˜æ¢å¤çŠ¶æ€: ${{ steps.cache-state.outputs.cache-hit == 'true' && 'æˆåŠŸ' || 'æœªæ‰¾åˆ°ç¼“å­˜æˆ–ä¸ä½¿ç”¨' }}" | tee -a ${{ env.DEBUG_LOG_FILE }}
        echo "å·¥å…·é“¾ç›®å½•å¤§å°: $(du -sh ${{ env.TOOLCHAIN_DIR }} 2>/dev/null || echo 'ç›®å½•ä¸å­˜åœ¨æˆ–ä¸ºç©º')" | tee -a ${{ env.DEBUG_LOG_FILE }}
        echo "å·¥å…·é“¾æ„å»ºç›®å½•å¤§å°: $(du -sh ${{ env.TOOLCHAIN_BUILD_DIR }} 2>/dev/null || echo 'ç›®å½•ä¸å­˜åœ¨æˆ–ä¸ºç©º')" | tee -a ${{ env.DEBUG_LOG_FILE }}
        echo "ç¼–è¯‘åŒ…ç›®å½•å¤§å°: $(du -sh ${{ env.PACKAGES_DIR }} 2>/dev/null || echo 'ç›®å½•ä¸å­˜åœ¨æˆ–ä¸ºç©º')" | tee -a ${{ env.DEBUG_LOG_FILE }}
        echo "CCACHEç›®å½•å¤§å°: $(du -sh ${{ env.CCACHE_DIR }} 2>/dev/null || echo 'ç›®å½•ä¸å­˜åœ¨æˆ–ä¸ºç©º')" | tee -a ${{ env.DEBUG_LOG_FILE }}
        find ${{ env.TOOLCHAIN_DIR }}/host/bin -name "gcc*" 2>/dev/null | head -5 || echo "æœªæ‰¾åˆ°ä¸»æœºgcc"
        find ${{ env.TOOLCHAIN_DIR }}/toolchain-* -name "*gcc*" 2>/dev/null | head -5 || echo "æœªæ‰¾åˆ°äº¤å‰ç¼–è¯‘å™¨gcc"
        ls -la ${{ env.BUILD_STATE_DIR }}/ || echo "æ„å»ºçŠ¶æ€ç›®å½•ä¸ºç©º"
        if [ -f "${{ env.BUILD_STATE_DIR }}/config.md5" ]; then
          echo "ä¹‹å‰MD5: $(cat ${{ env.BUILD_STATE_DIR }}/config.md5)" | tee -a ${{ env.DEBUG_LOG_FILE }}
        fi
        echo "--- End Debug Log: Cache Status ---" | tee -a ${{ env.DEBUG_LOG_FILE }}
        df -h

    - name: é…ç½®ç¼–è¯‘ç¯å¢ƒ
      run: |
        cd /workdir/openwrt
        if [ -f ".config" ]; then
          cp .config .config.original
        fi
        $GITHUB_WORKSPACE/$DIY_P1_SH
        echo "æ›´æ–°å¹¶å®‰è£… Feeds..."
        ./scripts/feeds update -a
        ./scripts/feeds install -a
        [ -e $GITHUB_WORKSPACE/files ] && cp -r $GITHUB_WORKSPACE/files ./files
        cp $GITHUB_WORKSPACE/$CONFIG_FILE ./.config
        cp .config .config.input # ä¿å­˜ä¸€ä»½è¾“å…¥é…ç½®ç”¨äºæ¯”è¾ƒ
        $GITHUB_WORKSPACE/$DIY_P2_SH
        echo "CONFIG_AUTOREMOVE=n" >> .config
        echo "CONFIG_AUTOREBUILD=n" >> .config
        echo "ç¡®ä¿åŒ…å«å¿…è¦çš„å›ºä»¶ç”Ÿæˆé…ç½®..."
        # ... (çœç•¥äº†éƒ¨åˆ†å›ºä»¶é…ç½®ç¡®ä¿é€»è¾‘ï¼Œä¸åŸç‰ˆä¸€è‡´) ...
        if ! grep -q "CONFIG_TARGET_ROOTFS_SQUASHFS=y" .config; then echo "CONFIG_TARGET_ROOTFS_SQUASHFS=y" >> .config; fi
        if ! grep -q "CONFIG_TARGET_IMAGES_GZIP=y" .config; then echo "CONFIG_TARGET_IMAGES_GZIP=y" >> .config; fi
        if ! grep -q "CONFIG_TARGET_ROOTFS_TARGZ=y" .config; then echo "CONFIG_TARGET_ROOTFS_TARGZ=y" >> .config; fi
        if grep -q "CONFIG_TARGET_x86=y" .config; then
          if ! grep -q "CONFIG_GRUB_IMAGES=y" .config; then echo "CONFIG_GRUB_IMAGES=y" >> .config; fi
          if ! grep -q "CONFIG_TARGET_IMAGES_PAD=y" .config; then echo "CONFIG_TARGET_IMAGES_PAD=y" >> .config; fi
        fi
        make defconfig
        grep "^CONFIG_PACKAGE_.*=y" .config.input | sort > packages_input.txt || true
        grep "^CONFIG_PACKAGE_.*=y" .config | sort > packages_defconfig.txt || true
        comm -23 packages_input.txt packages_defconfig.txt > missing_packages.txt
        if [ -s missing_packages.txt ]; then
          echo "è­¦å‘Šï¼šä»¥ä¸‹åŒ…åœ¨ defconfig åç¼ºå¤±ï¼Œå°†å°è¯•æ¢å¤ï¼š" | tee -a ${{ env.DEBUG_LOG_FILE }}
          cat missing_packages.txt | tee -a ${{ env.DEBUG_LOG_FILE }}
          cat missing_packages.txt >> .config
          while read -r line; do
            pkg=$(echo "$line" | sed 's/CONFIG_PACKAGE_\(.*\)=y/\1/')
            echo "å®‰è£…åŒ…: $pkg"
            ./scripts/feeds install "$pkg" || echo "è­¦å‘Šï¼šæ— æ³•å®‰è£… $pkgï¼Œå¯èƒ½ä¸åœ¨ feeds ä¸­"
          done < missing_packages.txt
          make defconfig
        else
          echo "æ‰€æœ‰é…ç½®é¡¹å‡ä¿ç•™ï¼Œæ— ç¼ºå¤±" | tee -a ${{ env.DEBUG_LOG_FILE }}
        fi
        echo "æœ€ç»ˆé…ç½®ä¸­çš„é•œåƒç”Ÿæˆé€‰é¡¹:" | tee -a ${{ env.DEBUG_LOG_FILE }}
        grep -E "CONFIG_TARGET_ROOTFS|CONFIG_TARGET_IMAGES|CONFIG_GRUB|CONFIG_ISO|CONFIG_EFI" .config | tee -a ${{ env.DEBUG_LOG_FILE }} || echo "æœªæ‰¾åˆ°é•œåƒç›¸å…³é…ç½®" | tee -a ${{ env.DEBUG_LOG_FILE }}
        diff .config.input .config > config_diff.txt || echo "é…ç½®æ— å·®å¼‚"
        echo "--- Debug Log: Config diff after defconfig and recovery ---" | tee -a ${{ env.DEBUG_LOG_FILE }}
        cat config_diff.txt | tee -a ${{ env.DEBUG_LOG_FILE }}
        echo "--- End Debug Log: Config diff ---" | tee -a ${{ env.DEBUG_LOG_FILE }}
        df -h

    - name: æ£€æŸ¥æºç å˜åŒ–
      id: check-feeds
      run: |
        cd /workdir/openwrt
        mkdir -p ${{ env.BUILD_STATE_DIR }}
        find feeds -type f -name "Makefile" -exec sha256sum {} \; | sort | sha256sum > ${{ env.BUILD_STATE_DIR }}/feeds.sha256
        CURRENT_FEEDS_HASH=$(cat ${{ env.BUILD_STATE_DIR }}/feeds.sha256 | awk '{print $1}')
        PREVIOUS_FEEDS_HASH=$(cat ${{ env.BUILD_STATE_DIR }}/previous_feeds.sha256 2>/dev/null | awk '{print $1}' || echo "")
        echo "--- Debug Log: Feeds Change Check ---" | tee -a ${{ env.DEBUG_LOG_FILE }}
        echo "å½“å‰ feeds å“ˆå¸Œ: $CURRENT_FEEDS_HASH" | tee -a ${{ env.DEBUG_LOG_FILE }}
        echo "ä¹‹å‰ feeds å“ˆå¸Œ: $PREVIOUS_FEEDS_HASH" | tee -a ${{ env.DEBUG_LOG_FILE }}
        if [ "$CURRENT_FEEDS_HASH" != "$PREVIOUS_FEEDS_HASH" ]; then
          echo "feeds_changed=true" >> $GITHUB_ENV
          echo "Feeds å·²å˜æ›´ï¼Œéœ€è¦é‡æ–°ç¼–è¯‘" | tee -a ${{ env.DEBUG_LOG_FILE }}
        else
          echo "feeds_changed=false" >> $GITHUB_ENV
          echo "Feeds æœªå˜æ›´ï¼Œå¯ä»¥ä½¿ç”¨ç¼“å­˜åŒ…" | tee -a ${{ env.DEBUG_LOG_FILE }}
        fi
        echo "--- End Debug Log: Feeds Change Check ---" | tee -a ${{ env.DEBUG_LOG_FILE }}
        cp ${{ env.BUILD_STATE_DIR }}/feeds.sha256 ${{ env.BUILD_STATE_DIR }}/previous_feeds.sha256

    - name: æ¢å¤å·²ç¼–è¯‘è½¯ä»¶åŒ… (æ—¥å¿—æ­¥éª¤)
      if: steps.cache-packages.outputs.cache-hit == 'true'
      run: |
        echo "--- Debug Log: Cached Packages Status ---" | tee -a ${{ env.DEBUG_LOG_FILE }}
        if [ "${{ env.feeds_changed }}" = "true" ]; then
          echo "feeds å·²æ›´æ–°ï¼Œå¯èƒ½ä¸ä¼šä½¿ç”¨æ—§çš„ç¼–è¯‘åŒ…ç¼“å­˜ä¸­çš„æ‰€æœ‰å†…å®¹ (OpenWrt makeå†³å®š)" | tee -a ${{ env.DEBUG_LOG_FILE }}
        else
          echo "feeds æœªå˜æ›´ï¼ŒOpenWrt make å¯èƒ½ä¼šä½¿ç”¨ç¼“å­˜çš„ç¼–è¯‘åŒ…" | tee -a ${{ env.DEBUG_LOG_FILE }}
        fi
        echo "å·²ç¼“å­˜çš„ç¼–è¯‘åŒ…ç›®å½• (${{ env.PACKAGES_DIR }}) æ–‡ä»¶æ•°é‡: $(find ${{ env.PACKAGES_DIR }} -type f | wc -l)" | tee -a ${{ env.DEBUG_LOG_FILE }}
        echo "--- End Debug Log: Cached Packages Status ---" | tee -a ${{ env.DEBUG_LOG_FILE }}

    - name: å¼€å¯SSHè°ƒè¯•
      uses: mxschmitt/action-tmate@v3
      if: github.event.inputs.ssh == 'true' # ä¿æŒä¸å˜

    - name: ä¸‹è½½è½¯ä»¶åŒ…
      run: |
        cd /workdir/openwrt
        MAX_RETRIES=3
        RETRY_WAIT=10
        cat > download_with_retry.sh << 'EOF'
        #!/bin/bash
        # ... (download_with_retry.sh å†…å®¹ä¿æŒä¸å˜) ...
        set -e; MAX_RETRIES=$1; RETRY_WAIT=$2; shift 2; retries=0
        until [ $retries -ge $MAX_RETRIES ]; do
          echo "å°è¯•ä¸‹è½½ï¼Œç¬¬ $((retries+1)) æ¬¡ï¼Œå…± $MAX_RETRIES æ¬¡...";
          if make download -j8 "$@" 2>&1 | tee download_attempt_$retries.log; then echo "ä¸‹è½½æˆåŠŸï¼"; exit 0; fi
          retries=$((retries+1));
          if [ $retries -lt $MAX_RETRIES ]; then echo "ä¸‹è½½å¤±è´¥ï¼Œç­‰å¾… $RETRY_WAIT ç§’åé‡è¯•..."; sleep $RETRY_WAIT; fi
        done
        echo "è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°ï¼Œä¿å­˜æ—¥å¿—ä»¥åˆ†æå¤±è´¥çš„åŒ…..."; mkdir -p logs; cp download_attempt_$(($retries-1)).log logs/download_failures.log; exit 1
        EOF
        chmod +x download_with_retry.sh
        ./download_with_retry.sh $MAX_RETRIES $RETRY_WAIT || make download -j1 V=s
        mkdir -p ${{ env.CCACHE_DIR }}
        ccache -o cache_dir=${{ env.CCACHE_DIR }}
        ccache -o max_size=8G
        ccache -z # åœ¨ç¼–è¯‘å‰æ¸…é›¶ï¼Œä»¥å‡†ç¡®ç»Ÿè®¡æœ¬æ¬¡ç¼–è¯‘çš„ccacheæƒ…å†µ
        df -h

    - name: æ£€æµ‹ä¸‹è½½å¤±è´¥çš„åŒ…
      run: |
        # ... (detect_failed_downloads.sh å†…å®¹ä¿æŒä¸å˜) ...
        cd /workdir/openwrt
        cat > detect_failed_downloads.sh << 'EOF'
        #!/bin/bash
        if [ -f "logs/download_failures.log" ]; then
          echo "åˆ†æä¸‹è½½å¤±è´¥æ—¥å¿—..." | tee -a ${{ env.DEBUG_LOG_FILE }};
          grep -E "(curl:.*(403|404)|No more mirrors to try)" logs/download_failures.log > failed_urls.txt || true;
          declare -A failed_packages;
          while IFS= read -r line; do if [[ $line =~ \/([^\/]+)[-_][0-9].*\.tar ]]; then pkg_name="${BASH_REMATCH[1]}"; failed_packages["$pkg_name"]=1; echo "æ£€æµ‹åˆ°ä¸‹è½½å¤±è´¥çš„åŒ…: $pkg_name" | tee -a ${{ env.DEBUG_LOG_FILE }}; fi; done < failed_urls.txt;
          if [ ${#failed_packages[@]} -gt 0 ]; then
            echo "ä»¥ä¸‹åŒ…å°†è¢«ç¦ç”¨ï¼Œå› ä¸ºæ— æ³•ä¸‹è½½ï¼š" | tee -a ${{ env.DEBUG_LOG_FILE }};
            for pkg in "${!failed_packages[@]}"; do
              echo " - $pkg" | tee -a ${{ env.DEBUG_LOG_FILE }};
              grep -l "CONFIG_PACKAGE_.*$pkg.*=y" .config | while read config_file; do pkgs=$(grep -o "CONFIG_PACKAGE_[^=]*$pkg[^=]*=y" "$config_file" || true); if [ -n "$pkgs" ]; then while IFS= read -r pkg_config; do pkg_name_conf=$(echo "$pkg_config" | cut -d'=' -f1); echo "ç¦ç”¨é…ç½®: $pkg_name_conf" | tee -a ${{ env.DEBUG_LOG_FILE }}; sed -i "/$pkg_name_conf=y/d" .config; echo "$pkg_name_conf=n" >> .config; done <<< "$pkgs"; fi; done;
            done;
            make defconfig; echo "å·²ç¦ç”¨æ— æ³•ä¸‹è½½çš„åŒ…ï¼Œå¹¶æ›´æ–°é…ç½®" | tee -a ${{ env.DEBUG_LOG_FILE }}; exit 0;
          fi;
        fi;
        echo "æ²¡æœ‰æ£€æµ‹åˆ°ä¸‹è½½å¤±è´¥çš„åŒ…ï¼Œæˆ–æ— éœ€ç¦ç”¨ä»»ä½•åŒ…" | tee -a ${{ env.DEBUG_LOG_FILE }}; exit 0;
        EOF
        chmod +x detect_failed_downloads.sh
        ./detect_failed_downloads.sh

    - name: æ™ºèƒ½ç¼–è¯‘å›ºä»¶
      id: compile
      run: |
        echo "--- Debug Log: Compile Step Start ---" | tee -a ${{ env.DEBUG_LOG_FILE }}
        cd /workdir/openwrt
        export CCACHE_DIR=${{ env.CCACHE_DIR }}
        export PATH="/usr/lib/ccache:$PATH"
        export CCACHE_LOGFILE=${{ env.CCACHE_LOGFILE }} # ç¡®ä¿è„šæœ¬å†…ä¹Ÿè®¾ç½®
        echo "CCACHE_LOGFILE in compile step set to: $CCACHE_LOGFILE" | tee -a ${{ env.DEBUG_LOG_FILE }}

        cleanup_temp_files() { # ... (ä¿æŒä¸å˜) ...
          echo "æ¸…ç†ä¸´æ—¶æ–‡ä»¶ä»¥é‡Šæ”¾ç©ºé—´..."; find /tmp -type f -delete || true; df -h;
        }
        save_cache_info() { # ... (ä¿æŒä¸å˜) ...
          echo "ä¿å­˜ç¼“å­˜çŠ¶æ€ä¿¡æ¯..."; mkdir -p ${{ env.BUILD_STATE_DIR }}; cp .config ${{ env.BUILD_STATE_DIR }}/config.txt;
          echo "$TOOLCHAIN_MD5" > ${{ env.BUILD_STATE_DIR }}/toolchain.md5; echo "$PACKAGE_MD5" > ${{ env.BUILD_STATE_DIR }}/package.md5; echo "ä¿å­˜æ„å»ºçŠ¶æ€å®Œæˆ";
        }
        handle_failed_downloads() { # ... (ä¿æŒä¸å˜, æ—¥å¿—å¯ä»¥è€ƒè™‘åŠ å…¥ tee -a ${{ env.DEBUG_LOG_FILE }}) ...
          echo "æ£€æµ‹åˆ°ç¼–è¯‘å¤±è´¥ï¼Œå°è¯•è¯†åˆ«ä¸‹è½½é—®é¢˜..." | tee -a ${{ env.DEBUG_LOG_FILE }}; mkdir -p logs; COMPILE_LOG="logs/compile_error.log"; echo "$1" > "$COMPILE_LOG";
          local failed_packages=();
          if grep -q "No more mirrors to try\|Download failed" "$COMPILE_LOG"; then
            local pkg=$(grep -B 5 "No more mirrors to try\|Download failed" "$COMPILE_LOG" | grep -o "package/feeds/[^/]*/[^[:space:]]*" | head -n 1 | awk -F'/' '{print $NF}');
            if [ -n "$pkg" ]; then failed_packages+=("$pkg"); echo "æ£€æµ‹åˆ°åŒ… $pkg ä¸‹è½½å¤±è´¥" | tee -a ${{ env.DEBUG_LOG_FILE }};
            else pkg=$(grep -o "Building package .* in .*" "$COMPILE_LOG" | tail -n 1 | awk '{print $3}'); if [ -n "$pkg" ]; then failed_packages+=("$pkg"); echo "æ£€æµ‹åˆ°å½“å‰æ„å»ºçš„åŒ… $pkg å¯èƒ½ä¸‹è½½å¤±è´¥" | tee -a ${{ env.DEBUG_LOG_FILE }}; fi; fi;
          fi;
          if [ ${#failed_packages[@]} -gt 0 ]; then
            echo "ä»¥ä¸‹åŒ…ä¸‹è½½å¤±è´¥ï¼Œå°†ä»é…ç½®ä¸­ç¦ç”¨ï¼š" | tee -a ${{ env.DEBUG_LOG_FILE }};
            for pkg_item in "${failed_packages[@]}"; do echo "- $pkg_item" | tee -a ${{ env.DEBUG_LOG_FILE }}; grep -l "CONFIG_PACKAGE_.*$pkg_item.*=y" .config | while read config_file_item; do local pkgs_conf=$(grep -o "CONFIG_PACKAGE_[^=]*$pkg_item[^=]*=y" "$config_file_item" || true); if [ -n "$pkgs_conf" ]; then while IFS= read -r pkg_conf_line; do local pkg_name_conf_item=$(echo "$pkg_conf_line" | cut -d'=' -f1); echo "ç¦ç”¨é…ç½®: $pkg_name_conf_item" | tee -a ${{ env.DEBUG_LOG_FILE }}; sed -i "/$pkg_name_conf_item=y/d" .config; echo "$pkg_name_conf_item=n" >> .config; done <<< "$pkgs_conf"; fi; done; done;
            make defconfig; echo "é‡æ–°å¼€å§‹ç¼–è¯‘æµç¨‹ï¼Œè·³è¿‡æœ‰é—®é¢˜çš„åŒ…..." | tee -a ${{ env.DEBUG_LOG_FILE }}; return 0;
          fi;
          return 1;
        }

        compile_firmware() {
          echo ">>> CCACHE: Zeroing statistics at start of compile_firmware function." | tee -a ${{ env.DEBUG_LOG_FILE }}
          ccache -z
          echo ">>> CCACHE: Statistics at START of compile_firmware function (after zeroing):" | tee -a ${{ env.DEBUG_LOG_FILE }}
          ccache -s | tee -a ${{ env.DEBUG_LOG_FILE }}

          if [ $DO_FULL_BUILD -eq 1 ]; then
            echo "--- Compile Branch: Full Build ---" | tee -a ${{ env.DEBUG_LOG_FILE }}
            echo "ä¸‹è½½ä¾èµ–..." | tee -a ${{ env.DEBUG_LOG_FILE }}
            ./download_with_retry.sh $MAX_RETRIES $RETRY_WAIT || make download -j1 V=s
            ./detect_failed_downloads.sh
            if [ ! -d "${{ env.TOOLCHAIN_DIR }}/toolchain-"* ]; then
              echo "ç¼–è¯‘å·¥å…·é“¾..." | tee -a ${{ env.DEBUG_LOG_FILE }}
              make -j$(nproc) tools/compile V=s || make -j1 V=s tools/compile
              make -j$(nproc) toolchain/compile V=s || make -j1 V=s toolchain/compile
            else
              echo "å·¥å…·é“¾å·²å­˜åœ¨ï¼Œè·³è¿‡ç¼–è¯‘" | tee -a ${{ env.DEBUG_LOG_FILE }}
            fi
            cleanup_temp_files
            echo "ç¼–è¯‘å®Œæ•´å›ºä»¶..." | tee -a ${{ env.DEBUG_LOG_FILE }}
            if ! make -j$(nproc) V=s 2>&1 | tee logs/compile_output.log; then
              if handle_failed_downloads "$(cat logs/compile_output.log)"; then
                make -j$(nproc) V=s || make -j1 V=s
              else
                make -j1 V=s
              fi
            fi
          elif [ $DO_PACKAGE_BUILD -eq 1 ] || [ "${{ env.feeds_changed }}" = "true" ]; then
            echo "--- Compile Branch: Package Build or Feeds Changed ---" | tee -a ${{ env.DEBUG_LOG_FILE }}
            echo "è½¯ä»¶åŒ…é…ç½®å˜åŒ–æˆ–æºç æ›´æ–°ï¼Œç¼–è¯‘è½¯ä»¶åŒ…..." | tee -a ${{ env.DEBUG_LOG_FILE }}
            echo ">>> WARNING: About to run 'make package/clean' because DO_PACKAGE_BUILD is $DO_PACKAGE_BUILD or feeds_changed is ${{ env.feeds_changed }}. This will clean all previously compiled packages." | tee -a ${{ env.DEBUG_LOG_FILE }}
            make -j$(nproc) package/clean V=s || make -j1 V=s package/clean
            if ! make -j$(nproc) package/compile V=s 2>&1 | tee logs/compile_output.log; then
              if handle_failed_downloads "$(cat logs/compile_output.log)"; then
                make -j$(nproc) package/compile V=s || make -j1 V=s package/compile
              else
                make -j1 V=s package/compile
              fi
            fi
            make -j$(nproc) package/index V=s || make -j1 V=s package/index
            echo "å¼ºåˆ¶æ‰§è¡Œå›ºä»¶ç”Ÿæˆæ­¥éª¤..." | tee -a ${{ env.DEBUG_LOG_FILE }}
            make -j$(nproc) target/install V=s || make -j1 V=s target/install
          else
            echo "--- Compile Branch: Minimal Incremental Build ---" | tee -a ${{ env.DEBUG_LOG_FILE }}
            echo "é…ç½®å’Œfeedséƒ½æœªå˜åŒ–ï¼Œæ‰§è¡Œæœ€å°å¢é‡ç¼–è¯‘..." | tee -a ${{ env.DEBUG_LOG_FILE }}
            if ! make -j$(nproc) V=s 2>&1 | tee logs/compile_output.log; then
              if handle_failed_downloads "$(cat logs/compile_output.log)"; then
                make -j$(nproc) V=s || make -j1 V=s
              else
                make -j1 V=s
              fi
            fi
          fi
          echo "ç¡®ä¿æ‰§è¡Œå›ºä»¶ç”Ÿæˆæ­¥éª¤ï¼Œæ— è®ºå‰é¢ç¼–è¯‘æ˜¯å¦æˆåŠŸ..." | tee -a ${{ env.DEBUG_LOG_FILE }}
          make -j$(nproc) target/install V=s || make -j1 V=s target/install
          save_cache_info
          echo "æ£€æŸ¥å›ºä»¶ç”Ÿæˆç»“æœ:" | tee -a ${{ env.DEBUG_LOG_FILE }}
          find bin/targets -type f -name "*.bin" -o -name "*combined*" -o -name "*sysupgrade*" | xargs ls -lh || echo "æ²¡æœ‰æ‰¾åˆ°å›ºä»¶æ–‡ä»¶ï¼" | tee -a ${{ env.DEBUG_LOG_FILE }}
          if [ -z "$(find bin/targets -type f -name "*.bin" -o -name "*combined*" -o -name "*sysupgrade*")" ]; then
            echo "æœªæ‰¾åˆ°å›ºä»¶æ–‡ä»¶ï¼Œå°è¯•å•ç‹¬æ„å»ºé•œåƒ..." | tee -a ${{ env.DEBUG_LOG_FILE }}
            if [ -d "bin/packages" ]; then
              echo "å·²æœ‰è½¯ä»¶åŒ…ï¼Œå°è¯•å•ç‹¬æ„å»ºå›ºä»¶é•œåƒ..." | tee -a ${{ env.DEBUG_LOG_FILE }}
              make -j1 target/install V=s
              find bin/targets -type f -name "*.bin" -o -name "*combined*" -o -name "*sysupgrade*" | xargs ls -lh || echo "æ„å»ºå›ºä»¶ä»ç„¶å¤±è´¥ï¼" | tee -a ${{ env.DEBUG_LOG_FILE }}
            fi
          fi

          echo ">>> CCACHE: Statistics at END of compile_firmware function:" | tee -a ${{ env.DEBUG_LOG_FILE }}
          ccache -s | tee -a ${{ env.DEBUG_LOG_FILE }}

          if [ $? -eq 0 ]; then
            echo "compile_firmwareå‡½æ•°åˆ¤æ–­ä¸ºæˆåŠŸ" | tee -a ${{ env.DEBUG_LOG_FILE }}
          else
            echo "compile_firmwareå‡½æ•°åˆ¤æ–­ä¸ºå¤±è´¥" | tee -a ${{ env.DEBUG_LOG_FILE }}
            # exit 1 # ä¿æŒåŸæ¥çš„é€»è¾‘ï¼Œå¦‚æœè¿™é‡Œé€€å‡ºï¼Œåç»­çš„status=successå¯èƒ½ä¸ä¼šæ‰§è¡Œ
          fi
        }
        
        MAX_RETRIES=3 # ä¸‹è½½é‡è¯•å‚æ•°
        RETRY_WAIT=10

        TOOLCHAIN_CONFIG=$(grep "^CONFIG_TARGET" .config | sort)
        TOOLCHAIN_MD5=$(echo "$TOOLCHAIN_CONFIG" | md5sum | awk '{print $1}')
        PREVIOUS_TOOLCHAIN_MD5=$(cat ${{ env.BUILD_STATE_DIR }}/toolchain.md5 2>/dev/null || echo "")
        PACKAGE_CONFIG=$(grep "^CONFIG_PACKAGE" .config | sort)
        PACKAGE_MD5=$(echo "$PACKAGE_CONFIG" | md5sum | awk '{print $1}')
        PREVIOUS_PACKAGE_MD5=$(cat ${{ env.BUILD_STATE_DIR }}/package.md5 2>/dev/null || echo "")
        DO_FULL_BUILD=0
        DO_PACKAGE_BUILD=0

        echo "--- Debug Log: Build Decision Variables ---" | tee -a ${{ env.DEBUG_LOG_FILE }}
        echo "Input clean_build: ${{ github.event.inputs.clean_build }}" | tee -a ${{ env.DEBUG_LOG_FILE }}
        echo "Current TOOLCHAIN_MD5: $TOOLCHAIN_MD5 (from .config)" | tee -a ${{ env.DEBUG_LOG_FILE }}
        echo "Previous TOOLCHAIN_MD5: $PREVIOUS_TOOLCHAIN_MD5 (from cache)" | tee -a ${{ env.DEBUG_LOG_FILE }}
        echo "Current PACKAGE_MD5: $PACKAGE_MD5 (from .config)" | tee -a ${{ env.DEBUG_LOG_FILE }}
        echo "Previous PACKAGE_MD5: $PREVIOUS_PACKAGE_MD5 (from cache)" | tee -a ${{ env.DEBUG_LOG_FILE }}
        echo "env.feeds_changed: ${{ env.feeds_changed }}" | tee -a ${{ env.DEBUG_LOG_FILE }}

        if [ "${{ github.event.inputs.clean_build }}" = "true" ]; then
          echo "clean_build is true, setting DO_FULL_BUILD=1" | tee -a ${{ env.DEBUG_LOG_FILE }}
          DO_FULL_BUILD=1
        elif [ -z "$PREVIOUS_TOOLCHAIN_MD5" ] || [ "$TOOLCHAIN_MD5" != "$PREVIOUS_TOOLCHAIN_MD5" ]; then
          echo "Toolchain config changed or first build, setting DO_FULL_BUILD=1" | tee -a ${{ env.DEBUG_LOG_FILE }}
          DO_FULL_BUILD=1
        elif [ -z "$PREVIOUS_PACKAGE_MD5" ] || [ "$PACKAGE_MD5" != "$PREVIOUS_PACKAGE_MD5" ]; then
          echo "Package config changed, setting DO_PACKAGE_BUILD=1" | tee -a ${{ env.DEBUG_LOG_FILE }}
          DO_PACKAGE_BUILD=1
        else
          echo "Config appears unchanged, checking feeds_changed for package build decision..." | tee -a ${{ env.DEBUG_LOG_FILE }}
          if [ "${{ env.feeds_changed }}" = "true" ]; then
             echo "feeds_changed is true, setting DO_PACKAGE_BUILD=1" | tee -a ${{ env.DEBUG_LOG_FILE }}
             DO_PACKAGE_BUILD=1 # å¦‚æœä»… feeds å˜åŒ–ï¼Œä¹Ÿè§¦å‘åŒ…ç¼–è¯‘
          fi
        fi
        echo "Final DO_FULL_BUILD: $DO_FULL_BUILD" | tee -a ${{ env.DEBUG_LOG_FILE }}
        echo "Final DO_PACKAGE_BUILD: $DO_PACKAGE_BUILD" | tee -a ${{ env.DEBUG_LOG_FILE }}
        echo "--- End Debug Log: Build Decision Variables ---" | tee -a ${{ env.DEBUG_LOG_FILE }}

        compile_firmware # è°ƒç”¨ç¼–è¯‘å‡½æ•°

        # ç¡®ä¿ compile_firmware çš„é€€å‡ºçŠ¶æ€è¢«æ­£ç¡®å¤„ç†
        # å¦‚æœ compile_firmware å†…éƒ¨ exit 1, è¿™é‡Œå¯èƒ½ä¸ä¼šæ‰§è¡Œ
        # ä½†æˆ‘ä»¬å¸Œæœ›å³ä½¿ç¼–è¯‘å¤±è´¥ä¹Ÿå°½å¯èƒ½è®°å½•æ—¥å¿—å’Œä¸Šä¼ 
        local compile_status=$? 
        if [ $compile_status -ne 0 ]; then
          echo "compile_firmware exited with status $compile_status" | tee -a ${{ env.DEBUG_LOG_FILE }}
          echo "status=failure" >> $GITHUB_OUTPUT
          # exit $compile_status # ä¿æŒåŸæ¥çš„é€»è¾‘ï¼Œå¦‚æœè¿™é‡Œé€€å‡ºï¼Œåç»­çš„status=successå¯èƒ½ä¸ä¼šæ‰§è¡Œ
        else
          echo "DEVICE_NAME=_$(grep '^CONFIG_TARGET.*DEVICE.*=y' .config | sed -r 's/.*DEVICE_(.*)=y/\1/' | tr '\n' '_')" >> $GITHUB_ENV
          echo "FILE_DATE=_$(date +"%Y%m%d%H%M")" >> $GITHUB_ENV
          echo "status=success" >> $GITHUB_OUTPUT
        fi
        echo "Final ccache stats for the entire compile step:" | tee -a ${{ env.DEBUG_LOG_FILE }}
        ccache -s | tee -a ${{ env.DEBUG_LOG_FILE }}
        df -h | tee -a ${{ env.DEBUG_LOG_FILE }}
        echo "--- Debug Log: Compile Step End ---" | tee -a ${{ env.DEBUG_LOG_FILE }}
        # å¦‚æœ compile_firmware å†…éƒ¨ exit 1, è„šæœ¬å¯èƒ½å·²ç»ç»ˆæ­¢
        # ä¸ºäº†ç¡®ä¿åç»­æ­¥éª¤ï¼ˆå¦‚ä¸Šä¼ debug logï¼‰æ‰§è¡Œï¼Œé¿å…åœ¨è¿™é‡Œç›´æ¥ exit 1 é™¤éå¿…è¦

    # ... (åç»­æ­¥éª¤å¦‚ æ£€æŸ¥å›ºä»¶ç”Ÿæˆç»“æœ, æ£€æŸ¥å·¥å…·é“¾å¤§å°, ä¿å­˜ç¼“å­˜ç­‰ä¿æŒä¸å˜) ...
    # ä½†è¦ç¡®ä¿è¿™äº›æ­¥éª¤åœ¨ç¼–è¯‘å¤±è´¥æ—¶ä¹Ÿèƒ½åˆç†æ‰§è¡Œæˆ–è·³è¿‡ï¼Œç‰¹åˆ«æ˜¯ç¼“å­˜ä¿å­˜æ­¥éª¤

    - name: æ£€æŸ¥å›ºä»¶ç”Ÿæˆç»“æœ # (ä¿æŒä¸å˜)
      run: |
        echo "æ£€æŸ¥å›ºä»¶ç”Ÿæˆç»“æœ..."
        find /workdir/openwrt/bin/targets -type f | sort
        echo "å›ºä»¶æ–‡ä»¶å¤§å°:"
        find /workdir/openwrt/bin/targets -type f -name "*.bin" -o -name "*combined*" -o -name "*sysupgrade*" | xargs ls -lh || echo "æœªæ‰¾åˆ°å›ºä»¶æ–‡ä»¶"
        echo "æ£€æŸ¥squashfsæ–‡ä»¶:"
        find /workdir/openwrt/build_dir -name "*.squashfs" | xargs ls -lh || echo "æœªæ‰¾åˆ°squashfsæ–‡ä»¶"
        if [ -z "$(find /workdir/openwrt/bin/targets -type f -name "*.bin" -o -name "*combined*" -o -name "*sysupgrade*")" ]; then
          echo "è­¦å‘Šï¼šæœªæ‰¾åˆ°å›ºä»¶æ–‡ä»¶ï¼Œå°è¯•å¼ºåˆ¶é‡æ–°ç”Ÿæˆ..."
          cd /workdir/openwrt
          if ! grep -q "CONFIG_TARGET_ROOTFS_SQUASHFS=y" .config; then echo "CONFIG_TARGET_ROOTFS_SQUASHFS=y" >> .config; fi
          if grep -q "CONFIG_TARGET_x86=y" .config; then
            if ! grep -q "CONFIG_GRUB_IMAGES=y" .config; then echo "CONFIG_GRUB_IMAGES=y" >> .config; fi
            if ! grep -q "CONFIG_TARGET_IMAGES_GZIP=y" .config; then echo "CONFIG_TARGET_IMAGES_GZIP=y" >> .config; fi
          fi
          make defconfig; make -j1 target/install V=s;
          echo "é‡æ–°æ£€æŸ¥å›ºä»¶æ–‡ä»¶:";
          find /workdir/openwrt/bin/targets -type f -name "*.bin" -o -name "*combined*" -o -name "*sysupgrade*" | xargs ls -lh || echo "ä»ç„¶æœªæ‰¾åˆ°å›ºä»¶æ–‡ä»¶";
        fi

    - name: å¤‡ä»½ç¼“å­˜å‰æ£€æŸ¥å·¥å…·é“¾å¤§å° # (ä¿æŒä¸å˜)
      if: "!cancelled()"
      run: |
        echo "ç¼–è¯‘å®Œæˆï¼Œæ£€æŸ¥å·¥å…·é“¾å¤§å°..." | tee -a ${{ env.DEBUG_LOG_FILE }}
        echo "å·¥å…·é“¾ç›®å½•å¤§å°: $(du -sh ${{ env.TOOLCHAIN_DIR }} 2>/dev/null || echo 'ç›®å½•ä¸å­˜åœ¨æˆ–ä¸ºç©º')" | tee -a ${{ env.DEBUG_LOG_FILE }}
        # ... å…¶ä»– du -sh å‘½ä»¤ä¹ŸåŠ å…¥ tee -a ...
        mkdir -p ${{ env.BUILD_STATE_DIR }}
        echo "ç¼“å­˜åˆ›å»ºæ—¶é—´: $(date)" > ${{ env.BUILD_STATE_DIR }}/cache_timestamp.txt
        echo "è¿è¡ŒID: ${{ github.run_id }}" >> ${{ env.BUILD_STATE_DIR }}/cache_timestamp.txt
        echo "æ„å»ºåˆ†æ”¯: ${{ env.REPO_BRANCH }}" >> ${{ env.BUILD_STATE_DIR }}/cache_timestamp.txt

    - name: ä¿å­˜å·¥å…·é“¾ç¼“å­˜ # (ä¿æŒä¸å˜)
      uses: actions/cache@v3
      if: "!cancelled()"
      with:
        path: |
          ${{ env.TOOLCHAIN_DIR }}
          ${{ env.TOOLCHAIN_BUILD_DIR }}
        key: toolchain-${{ env.REPO_BRANCH }}-fixed-cache
        
    - name: ä¿å­˜ç¼–è¯‘åŒ…ç¼“å­˜ # (ä¿æŒä¸å˜)
      uses: actions/cache@v3
      if: "!cancelled()"
      with:
        path: ${{ env.PACKAGES_DIR }}
        key: packages-${{ env.REPO_BRANCH }}-fixed-cache
        
    - name: ä¿å­˜æ„å»ºçŠ¶æ€ç¼“å­˜ # (ä¿æŒä¸å˜)
      uses: actions/cache@v3
      if: "!cancelled()"
      with:
        path: ${{ env.BUILD_STATE_DIR }}
        key: state-${{ env.REPO_BRANCH }}-fixed-cache
        
    - name: ä¿å­˜CCACHEç¼“å­˜ # (ä¿æŒä¸å˜)
      uses: actions/cache@v3
      if: "!cancelled()"
      with:
        path: ${{ env.CCACHE_DIR }}
        key: ccache-${{ env.REPO_BRANCH }}-fixed-cache

    - name: éªŒè¯ç¼“å­˜å·²ä¿å­˜ # (ä¿æŒä¸å˜, æ—¥å¿—å¯ä»¥åŠ å…¥ tee -a)
      if: "!cancelled()"
      run: |
        echo "å·²å®Œæˆæ‰€æœ‰ç¼“å­˜ä¿å­˜ï¼Œç°åœ¨å¯ä»¥å®‰å…¨åœ°è¿›è¡Œåç»­æ–‡ä»¶æ•´ç†å’Œæ¸…ç†æ“ä½œ" | tee -a ${{ env.DEBUG_LOG_FILE }}
        if [ -f "${{ env.BUILD_STATE_DIR }}/cache_timestamp.txt" ]; then
          echo "ç¼“å­˜æ—¶é—´æˆ³å†…å®¹:" | tee -a ${{ env.DEBUG_LOG_FILE }}
          cat ${{ env.BUILD_STATE_DIR }}/cache_timestamp.txt | tee -a ${{ env.DEBUG_LOG_FILE }}
        fi
        df -h | tee -a ${{ env.DEBUG_LOG_FILE }}

    - name: Upload Debug Logs # æ–°å¢: ä¸Šä¼ è°ƒè¯•æ—¥å¿—æ­¥éª¤
      if: always() # ç¡®ä¿å³ä½¿å‰é¢çš„æ­¥éª¤å¤±è´¥ï¼Œä¹Ÿä¼šå°è¯•ä¸Šä¼ æ—¥å¿—
      uses: actions/upload-artifact@main
      with:
        name: build-debug-logs-${{ github.run_id }}
        path: |
          ${{ env.DEBUG_LOG_FILE }}
          ${{ env.CCACHE_LOGFILE }}
        retention-days: 7 # ä¿ç•™7å¤©

    - name: æ•´ç†æ–‡ä»¶ # (ä¿æŒä¸å˜)
      id: organize
      # ç¡®ä¿ compile step çš„ output status è¢«æ­£ç¡®å¼•ç”¨
      if: steps.compile.outputs.status == 'success' && env.UPLOAD_FIRMWARE == 'true' && !cancelled()
      run: |
        # ... (æ•´ç†æ–‡ä»¶è„šæœ¬ä¿æŒä¸å˜) ...
        echo "æœç´¢æ‰€æœ‰å¯èƒ½çš„å›ºä»¶æ–‡ä»¶..."
        find /workdir/openwrt/bin -type f \( -name "*.bin" -o -name "*.img" -o -name "*sysupgrade*" -o -name "*combined*" \) -exec ls -lh {} + || echo "æœªæ‰¾åˆ°å¯èƒ½çš„å›ºä»¶æ–‡ä»¶"
        if [ ! -d "/workdir/openwrt/bin/targets" ]; then
          echo "é”™è¯¯ï¼šç¼–è¯‘ç›®æ ‡ç›®å½•ä¸å­˜åœ¨ï¼Œå¯èƒ½ç¼–è¯‘å¤±è´¥"; mkdir -p /workdir/openwrt/bin/targets/empty/firmware;
          echo "FIRMWARE=/workdir/openwrt/bin/targets/empty/firmware" >> $GITHUB_ENV; echo "status=success" >> $GITHUB_OUTPUT; exit 0;
        fi
        TARGET_DIRS=$(find /workdir/openwrt/bin/targets -mindepth 2 -maxdepth 2 -type d);
        if [ -z "$TARGET_DIRS" ]; then echo "è­¦å‘Šï¼šæœªæ‰¾åˆ°å…·ä½“ç›®æ ‡ç›®å½•ï¼Œåˆ›å»ºé€šç”¨ç›®å½•"; mkdir -p /workdir/openwrt/bin/targets/generic/generic; TARGET_DIRS="/workdir/openwrt/bin/targets/generic/generic"; fi
        for TARGET_DIR in $TARGET_DIRS; do
          echo "å¤„ç†ç›®æ ‡ç›®å½•: $TARGET_DIR"; cd "$TARGET_DIR"; rm -rf firmware; mkdir -p firmware; FILES_FOUND=0;
          for pattern in "*combined*" "*sysupgrade*" "*.img" "*.bin"; do
            echo "å°è¯•å¤åˆ¶åŒ¹é… $pattern çš„æ–‡ä»¶..."; if find . -maxdepth 1 -name "$pattern" -print -quit | grep -q .; then find . -maxdepth 1 -name "$pattern" -exec cp -f {} ./firmware/ \;; FILES_FOUND=1; fi;
          done;
          if [ $FILES_FOUND -eq 0 ]; then echo "æœªæ‰¾åˆ°æ ‡å‡†å›ºä»¶æ–‡ä»¶ï¼Œå°è¯•å¤åˆ¶æ‰€æœ‰å¯èƒ½çš„æ–‡ä»¶..."; find . -maxdepth 1 -type f -not -name "*.manifest" -not -name "*.txt" -not -name "*.json" -not -name "*.buildinfo" -exec cp -f {} ./firmware/ \;; fi;
          if [ -f "/workdir/openwrt/.config" ]; then cp -f /workdir/openwrt/.config ./firmware/config.txt; fi;
          if [ -n "$(ls -A firmware)" ]; then echo "æˆåŠŸå¤åˆ¶å›ºä»¶æ–‡ä»¶åˆ° $TARGET_DIR/firmware"; ls -lh firmware/; echo "FIRMWARE=$TARGET_DIR/firmware" >> $GITHUB_ENV; echo "status=success" >> $GITHUB_OUTPUT; break;
          else echo "è­¦å‘Š: $TARGET_DIR ä¸­æœªæ‰¾åˆ°å¯ç”¨å›ºä»¶æ–‡ä»¶"; fi;
        done;
        if [ -z "$FIRMWARE" ] && [ -z "$FIRMWARE_ZIP" ]; then # æ£€æŸ¥æ˜¯å¦å·²ç»æœ‰FIRMWAREç¯å¢ƒå˜é‡ï¼Œé¿å…è¦†ç›–
          echo "è­¦å‘Šï¼šæœªèƒ½åœ¨ä»»ä½•ç›®æ ‡ç›®å½•ä¸­æ‰¾åˆ°å›ºä»¶æ–‡ä»¶ï¼Œä½¿ç”¨ç´§æ€¥å¤‡ç”¨æ–¹æ³•"; BACKUP_DIR="/workdir/openwrt/bin/targets/generic/backup_firmware"; mkdir -p "$BACKUP_DIR/firmware";
          find /workdir/openwrt/bin -type f -not -path "*/packages/*" -exec cp -f {} "$BACKUP_DIR/firmware/" \;;
          if [ -f "/workdir/openwrt/.config" ]; then cp -f /workdir/openwrt/.config "$BACKUP_DIR/firmware/config.txt"; else echo "# ç´§æ€¥å¤‡ç”¨é…ç½®" > "$BACKUP_DIR/firmware/config.txt"; fi;
          echo "FIRMWARE=$BACKUP_DIR/firmware" >> $GITHUB_ENV; echo "status=success" >> $GITHUB_OUTPUT; # ç¡®ä¿åœ¨ç´§æ€¥æƒ…å†µä¸‹ä¹Ÿè¾“å‡º status
        fi;
        # åˆ›å»ºå›ºä»¶å‹ç¼©åŒ…é€»è¾‘ä¿®æ­£
        if [ -n "$FIRMWARE" ] && [ -d "$FIRMWARE" ]; then # ç¡®ä¿ FIRMWARE æ˜¯ä¸€ä¸ªç›®å½•
          cd $(dirname "$FIRMWARE"); zip -r firmware.zip $(basename "$FIRMWARE");
          echo "FIRMWARE_ZIP=$(dirname "$FIRMWARE")/firmware.zip" >> $GITHUB_ENV; # FIRMWARE_ZIP æŒ‡å‘ zip æ–‡ä»¶
        elif [ -n "$FIRMWARE" ] && [ ! -d "$FIRMWARE" ]; then # å¦‚æœ FIRMWARE ä¸æ˜¯ç›®å½•ï¼Œå¯èƒ½æ˜¯å•ä¸ªæ–‡ä»¶
           echo "è­¦å‘Š: FIRMWARE ç¯å¢ƒå˜é‡ ($FIRMWARE) ä¸æ˜¯ä¸€ä¸ªç›®å½•ï¼Œæ— æ³•åˆ›å»º zip åŒ…ã€‚"
        fi

    - name: ä¸Šä¼ å›ºä»¶ç›®å½•
      uses: actions/upload-artifact@main
      if: steps.organize.outputs.status == 'success' && !cancelled()
      with:
        name: OpenWrt_firmware${{ env.DEVICE_NAME }}${{ env.FILE_DATE }}
        path: ${{ env.FIRMWARE_ZIP || env.FIRMWARE }} # ä¼˜å…ˆä¸Šä¼ zipï¼Œå¦‚æœä¸å­˜åœ¨åˆ™ä¸Šä¼ ç›®å½•

    - name: ç”Ÿæˆå‘å¸ƒæ ‡ç­¾ # (ä¿æŒä¸å˜)
      id: tag
      if: steps.organize.outputs.status == 'success' && env.UPLOAD_RELEASE == 'true' && !cancelled()
      run: |
        echo "RELEASE_TAG=$(date +"%Y.%m.%d-%H%M")" >> $GITHUB_OUTPUT
        echo "## OpenWrtå›ºä»¶æ„å»ºå®Œæˆ ğŸ“¦" > release.txt
        echo "ğŸ“… æ„å»ºæ—¶é—´: $(date +"%Y-%m-%d %H:%M")" >> release.txt
        echo "ğŸ“‚ å›ºä»¶ä¸‹è½½" >> release.txt
        echo "âš ï¸ è¯·åœ¨åˆ·æœºå‰å…ˆåšå¥½å¤‡ä»½ï¼" >> release.txt
        echo "status=success" >> $GITHUB_OUTPUT # ç¡®ä¿ status è¾“å‡º

    - name: ä¸Šä¼ å›ºä»¶åˆ°Releases # (ä¿æŒä¸å˜)
      uses: softprops/action-gh-release@v2
      if: steps.tag.outputs.status == 'success' && !cancelled()
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ steps.tag.outputs.RELEASE_TAG }}
        body_path: release.txt
        # files: ${{ env.FIRMWARE }}/* # å¦‚æœFIRMWAREæ˜¯ç›®å½•
        files: ${{ env.FIRMWARE_ZIP || env.FIRMWARE }}/* # ä¼˜å…ˆä¸Šä¼ zipä¸­çš„æ‰€æœ‰æ–‡ä»¶ï¼Œæˆ–FIRMWAREç›®å½•ä¸‹çš„æ‰€æœ‰æ–‡ä»¶

    - name: åˆ é™¤æ—§çš„Releases # (ä¿æŒä¸å˜)
      uses: dev-drprasad/delete-older-releases@master
      if: env.UPLOAD_RELEASE == 'true' && !cancelled()
      with:
        keep_latest: 3
        delete_tags: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
