name: å…¨æ–°ç¼–è¯‘ç¬¬äºŒç‰ˆ

on:
  repository_dispatch:
  workflow_dispatch:
    inputs:
      ssh:
        description: 'SSHè°ƒè¯•'
        required: false
        default: 'false'
      clean_build:
        description: 'æ¸…ç†ç¼“å­˜å¹¶å®Œå…¨é‡æ–°ç¼–è¯‘'
        required: false
        default: 'false'
      config_file:
        description: 'é…ç½®æ–‡ä»¶'
        required: false
        default: 'å¢é‡ç¼“å­˜ä¼˜åŒ–.config'

env:
  REPO_URL: https://github.com/coolsnowwolf/lede
  REPO_BRANCH: master
  FEEDS_CONF: feeds.conf.default
  CONFIG_FILE: ${{ github.event.inputs.config_file || 'å¢é‡ç¼“å­˜ä¼˜åŒ–.config' }}
  DIY_P1_SH: diy-part1.sh
  DIY_P2_SH: diy-part2.sh
  UPLOAD_BIN_DIR: false
  UPLOAD_FIRMWARE: true
  UPLOAD_RELEASE: true
  TZ: Asia/Shanghai
  CCACHE_DIR: /workdir/ccache
  # æé«˜åŒ…ç¼“å­˜ä¼˜å…ˆçº§ï¼Œé™ä½ä¸‹è½½ç¼“å­˜ä¼˜å…ˆçº§
  CACHE_PRIORITY: "package"

jobs:
  build:
    runs-on: ubuntu-22.04
    if: github.event.repository.owner.id == github.event.sender.id || !github.event.sender.id

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@main

    - name: ä¼˜åŒ–ç£ç›˜ç©ºé—´
      uses: easimon/maximize-build-space@master
      with:
        root-reserve-mb: 2048
        swap-size-mb: 1
        remove-dotnet: 'true'
        remove-android: 'true'
        remove-haskell: 'true'
        remove-codeql: 'true'
        remove-docker-images: 'true'
        build-mount-path: '/workdir'

    - name: æ˜¾ç¤ºç£ç›˜ç©ºé—´ä½¿ç”¨æƒ…å†µ
      run: |
        df -hT
        echo "å·¥ä½œç›®å½•ç©ºé—´æƒ…å†µï¼š"
        df -hT /workdir

    - name: åˆå§‹åŒ–ç¯å¢ƒ
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        sudo -E apt-get -qq update
        sudo -E apt-get -qq install $(curl -fsSL https://raw.githubusercontent.com/coolsnowwolf/lede/master/prereq-build.mk | grep -o 'package-y += .*' | sed 's/package-y += //g')
        sudo -E apt-get -qq install ack antlr3 asciidoc autoconf automake autopoint binutils bison build-essential \
        bzip2 ccache cmake cpio curl device-tree-compiler fastjar flex gawk gettext gcc-multilib g++-multilib \
        git gperf haveged help2man intltool libc6-dev-i386 libelf-dev libglib2.0-dev libgmp3-dev libltdl-dev \
        libmpc-dev libmpfr-dev libncurses5-dev libncursesw5-dev libreadline-dev libssl-dev libtool lrzsz \
        mkisofs msmtp nano ninja-build p7zip p7zip-full patch pkgconf python2.7 python3 python3-pyelftools \
        libpython3-dev qemu-utils rsync scons squashfs-tools subversion swig texinfo uglifyjs upx-ucl unzip \
        vim wget xmlto xxd zlib1g-dev python3-setuptools
        sudo -E apt-get -qq autoremove --purge
        sudo -E apt-get -qq clean
        sudo timedatectl set-timezone "$TZ"
        # åˆ›å»ºå¿…è¦ç›®å½•
        mkdir -p /workdir/package_info
        mkdir -p /workdir/package_list
        mkdir -p /workdir/compiled_packages
        mkdir -p ${{ env.CCACHE_DIR }}
        echo "WORKDIR=/workdir" >> $GITHUB_ENV

    - name: å…‹éš†æºä»£ç 
      working-directory: /workdir
      run: |
        git clone --depth 1 $REPO_URL -b $REPO_BRANCH openwrt
        ln -sf /workdir/openwrt $GITHUB_WORKSPACE/openwrt
        cd openwrt
        echo "é¡¹ç›®ç‰ˆæœ¬: $(git rev-parse HEAD)" > /workdir/source_version.txt
        find . -type f -name "*.sh" -exec chmod +x {} \;

    # ä¼˜å…ˆæ¢å¤å·²ç¼–è¯‘åŒ…çš„ç¼“å­˜
    - name: æ¢å¤å·²ç¼–è¯‘åŒ…ç¼“å­˜
      uses: actions/cache@v3
      if: inputs.clean_build != 'true'
      with:
        path: |
          /workdir/compiled_packages
          /workdir/package_info
          /workdir/package_list
        key: compiled-packages-${{ env.REPO_URL }}-${{ env.REPO_BRANCH }}-${{ hashFiles(format('{0}/{1}', github.workspace, env.CONFIG_FILE)) }}-${{ hashFiles('/workdir/source_version.txt') }}
        restore-keys: |
          compiled-packages-${{ env.REPO_URL }}-${{ env.REPO_BRANCH }}-

    # æ¢å¤å·¥å…·é“¾ç¼“å­˜
    - name: æ¢å¤å·¥å…·é“¾ç¼“å­˜
      uses: actions/cache@v3
      if: inputs.clean_build != 'true'
      with:
        path: |
          /workdir/openwrt/staging_dir/toolchain-*
          /workdir/openwrt/build_dir/toolchain-*
        key: toolchain-${{ env.REPO_URL }}-${{ env.REPO_BRANCH }}-${{ hashFiles('/workdir/source_version.txt') }}
        restore-keys: |
          toolchain-${{ env.REPO_URL }}-${{ env.REPO_BRANCH }}-

    # æ¢å¤CCACHEç¼“å­˜
    - name: æ¢å¤CCACHEç¼“å­˜
      uses: actions/cache@v3
      with:
        path: ${{ env.CCACHE_DIR }}
        key: ccache-${{ env.REPO_URL }}-${{ env.REPO_BRANCH }}-${{ hashFiles('/workdir/source_version.txt') }}
        restore-keys: |
          ccache-${{ env.REPO_URL }}-${{ env.REPO_BRANCH }}-

    # æœ‰é€‰æ‹©æ€§åœ°æ¢å¤ä¸‹è½½ç¼“å­˜ï¼ˆä¼˜å…ˆçº§è¾ƒä½ï¼‰
    - name: æ¢å¤ä¸‹è½½ç¼“å­˜
      uses: actions/cache@v3
      if: env.CACHE_PRIORITY != 'package'
      with:
        path: |
          /workdir/openwrt/dl
        key: dl-${{ env.REPO_URL }}-${{ env.REPO_BRANCH }}-${{ hashFiles('/workdir/source_version.txt') }}
        restore-keys: |
          dl-${{ env.REPO_URL }}-${{ env.REPO_BRANCH }}-

    - name: åŠ è½½è‡ªå®šä¹‰feeds
      run: |
        [ -e $FEEDS_CONF ] && mv $FEEDS_CONF /workdir/openwrt/feeds.conf.default
        chmod +x $DIY_P1_SH
        cd /workdir/openwrt
        $GITHUB_WORKSPACE/$DIY_P1_SH

    - name: æ›´æ–°feeds
      run: |
        cd /workdir/openwrt
        ./scripts/feeds update -a

    - name: å®‰è£…feeds
      run: |
        cd /workdir/openwrt
        ./scripts/feeds install -a

    - name: åŠ è½½è‡ªå®šä¹‰é…ç½®
      run: |
        [ -e files ] && mv files /workdir/openwrt/files
        if [ ! -e "$CONFIG_FILE" ]; then
          echo "Error: $CONFIG_FILE not found!" >&2
          exit 1
        fi
        mv $CONFIG_FILE /workdir/openwrt/.config
        chmod +x $DIY_P2_SH
        cd /workdir/openwrt
        $GITHUB_WORKSPACE/$DIY_P2_SH

    - name: å¼€å¯SSHè°ƒè¯•
      uses: mxschmitt/action-tmate@v3
      if: github.event.inputs.ssh == 'true'

    - name: é…ç½®CCACHE
      run: |
        cd /workdir/openwrt
        ccache -o cache_dir=${{ env.CCACHE_DIR }}
        ccache -o max_size=5G  # é€‚å½“å‡å°CCACHEå¤§å°
        ccache -z

    - name: æ™ºèƒ½å¢é‡ç¼–è¯‘å›ºä»¶
      id: compile
      run: |
        cd /workdir/openwrt
        make defconfig
        
        # è®¾ç½®CCACHEç¯å¢ƒå˜é‡
        export CCACHE_DIR=${{ env.CCACHE_DIR }}
        export PATH="/usr/lib/ccache:$PATH"
        
        # å¦‚æœæ˜¯å¼ºåˆ¶å®Œå…¨é‡æ–°ç¼–è¯‘
        if [ "${{ github.event.inputs.clean_build }}" = "true" ]; then
          echo "è¿›è¡Œå®Œå…¨é‡æ–°ç¼–è¯‘..."
          make -j$(nproc) || make -j1 V=s
          echo "status=success" >> $GITHUB_OUTPUT
          exit 0
        fi
        
        # é«˜çº§å¢é‡ç¼–è¯‘ç­–ç•¥
        
        # 1. æå–å½“å‰é…ç½®çš„æ‰€æœ‰åŒ…
        mkdir -p /workdir/package_list
        grep "^CONFIG_PACKAGE" .config | sort > /workdir/package_list/current_packages.txt
        
        # 2. ç”ŸæˆåŒ…ä¿¡æ¯ç´¢å¼•
        if [ ! -f "/workdir/package_info/packages_index.json" ]; then
          echo "é¦–æ¬¡è¿è¡Œï¼Œåˆ›å»ºåŒ…ç´¢å¼•..."
          echo "{}" > /workdir/package_info/packages_index.json
        fi
        
        # 3. æ£€æŸ¥å“ªäº›åŒ…éœ€è¦é‡æ–°ç¼–è¯‘
        if [ ! -f "/workdir/package_list/previous_packages.txt" ]; then
          echo "é¦–æ¬¡è¿è¡Œï¼Œç¼–è¯‘æ‰€æœ‰è½¯ä»¶åŒ…..."
          FULL_BUILD=1
        else
          echo "æ£€æµ‹å¢é‡ç¼–è¯‘..."
          
          # 3.1 æ¯”è¾ƒåŒ…åˆ—è¡¨å·®å¼‚
          comm -13 /workdir/package_list/previous_packages.txt /workdir/package_list/current_packages.txt > /workdir/package_list/added_packages.txt
          comm -23 /workdir/package_list/previous_packages.txt /workdir/package_list/current_packages.txt > /workdir/package_list/removed_packages.txt
          
          # 3.2 ç”Ÿæˆä¸€ä¸ªæ™ºèƒ½çš„ç¼–è¯‘åˆ—è¡¨
          > /workdir/package_list/to_compile.txt
          
          # æ·»åŠ æ–°å¢çš„åŒ…
          if [ -s "/workdir/package_list/added_packages.txt" ]; then
            cat /workdir/package_list/added_packages.txt >> /workdir/package_list/to_compile.txt
            echo "æ£€æµ‹åˆ°æ–°å¢çš„åŒ…ï¼Œå°†è¿›è¡Œç¼–è¯‘ã€‚"
          fi
          
          # æ£€æŸ¥å·²æœ‰åŒ…ä¸­æºç å˜åŒ–çš„åŒ…
          echo "æ£€æŸ¥æºç å˜åŒ–..."
          for PKG in $(grep "^CONFIG_PACKAGE" .config | sed 's/CONFIG_PACKAGE_\(.*\)=y/\1/'); do
            # è·³è¿‡å·²æ·»åŠ çš„åŒ…
            if grep -q "CONFIG_PACKAGE_${PKG}=y" /workdir/package_list/added_packages.txt 2>/dev/null; then
              continue
            fi
            
            PKG_DIR=$(find package feeds -type d -name "$PKG" | head -n 1)
            if [ -n "$PKG_DIR" ]; then
              # è®¡ç®—å½“å‰æºç å“ˆå¸Œ
              CUR_HASH=$(find "$PKG_DIR" -type f -not -path "*/.git/*" -exec sha256sum {} \; | sort | sha256sum | awk '{print $1}')
              
              # æ£€æŸ¥å†å²å“ˆå¸Œ
              if [ -f "/workdir/package_info/${PKG}.hash" ]; then
                PREV_HASH=$(cat "/workdir/package_info/${PKG}.hash")
                if [ "$CUR_HASH" != "$PREV_HASH" ]; then
                  echo "CONFIG_PACKAGE_${PKG}=y" >> /workdir/package_list/to_compile.txt
                  echo "åŒ… $PKG æºç æœ‰å˜åŒ–ï¼Œå°†é‡æ–°ç¼–è¯‘"
                else
                  echo "åŒ… $PKG æºç æ— å˜åŒ–ï¼Œè·³è¿‡ç¼–è¯‘"
                fi
              else
                echo "CONFIG_PACKAGE_${PKG}=y" >> /workdir/package_list/to_compile.txt
                echo "åŒ… $PKG æ²¡æœ‰å†å²å“ˆå¸Œï¼Œå°†è¿›è¡Œç¼–è¯‘"
              fi
              
              # ä¿å­˜å½“å‰å“ˆå¸Œ
              echo "$CUR_HASH" > "/workdir/package_info/${PKG}.hash"
            fi
          done
          
          # åˆ¤æ–­æ˜¯å¦éœ€è¦å®Œæ•´æ„å»º
          if [ $(cat /workdir/package_list/to_compile.txt | wc -l) -gt $(grep "^CONFIG_PACKAGE" .config | wc -l | awk '{print int($1/3)}') ]; then
            echo "éœ€è¦é‡æ–°ç¼–è¯‘çš„åŒ…è¶…è¿‡ä¸‰åˆ†ä¹‹ä¸€ï¼Œå°†è¿›è¡Œå®Œæ•´æ„å»º..."
            FULL_BUILD=1
          fi
        fi
        
        # 4. ç¼–è¯‘ç­–ç•¥æ‰§è¡Œ
        if [ "$FULL_BUILD" = "1" ]; then
          # 4.1 è¿›è¡Œå®Œå…¨ç¼–è¯‘
          echo "æ‰§è¡Œå®Œæ•´æ„å»º..."
          make -j$(nproc) || make -j1 V=s
        else
          # 4.2 è¿›è¡Œå¢é‡ç¼–è¯‘
          echo "æ‰§è¡Œå¢é‡ç¼–è¯‘..."
          
          # ç¡®ä¿å·¥å…·é“¾å¯ç”¨
          if [ ! -d "staging_dir/toolchain-x86_64_gcc-*" ]; then
            echo "å·¥å…·é“¾ä¸å­˜åœ¨ï¼Œç¼–è¯‘å·¥å…·é“¾..."
            make -j$(nproc) tools/install || make -j1 V=s tools/install
            make -j$(nproc) toolchain/install || make -j1 V=s toolchain/install
          fi
          
          # æ™ºèƒ½å¤„ç†å·²åˆ é™¤çš„åŒ…
          if [ -s "/workdir/package_list/removed_packages.txt" ]; then
            echo "æ¸…ç†å·²åˆ é™¤çš„åŒ…..."
            while read -r PKG; do
              PKG_NAME=$(echo "$PKG" | sed 's/CONFIG_PACKAGE_\(.*\)=y/\1/')
              echo "æ¸…ç†åŒ…: $PKG_NAME"
              make package/${PKG_NAME}/clean || echo "è­¦å‘Š: æ¸…ç† $PKG_NAME å¤±è´¥"
            done < /workdir/package_list/removed_packages.txt
          fi
          
          # æ™ºèƒ½ç¼–è¯‘éœ€è¦æ›´æ–°çš„åŒ…
          if [ -s "/workdir/package_list/to_compile.txt" ]; then
            echo "å¼€å§‹ç¼–è¯‘éœ€è¦æ›´æ–°çš„åŒ…..."
            
            # åˆ†æ‰¹ç¼–è¯‘ï¼Œé¿å…ä¾èµ–é—®é¢˜
            TOTAL_PKGS=$(cat /workdir/package_list/to_compile.txt | wc -l)
            if [ $TOTAL_PKGS -le 5 ]; then
              # å°‘é‡åŒ…å•ç‹¬ç¼–è¯‘
              while read -r PKG; do
                PKG_NAME=$(echo "$PKG" | sed 's/CONFIG_PACKAGE_\(.*\)=y/\1/')
                echo "ç¼–è¯‘å•ä¸ªåŒ…: $PKG_NAME"
                make package/${PKG_NAME}/{clean,compile} -j$(nproc) || {
                  echo "è­¦å‘Š: åŒ… $PKG_NAME ç¼–è¯‘å¤±è´¥ï¼Œå°è¯•ä¾èµ–æ–¹å¼ç¼–è¯‘"
                  make package/${PKG_NAME}/compile -j$(nproc) || echo "è­¦å‘Š: åŒ… $PKG_NAME å†æ¬¡ç¼–è¯‘å¤±è´¥"
                }
              done < /workdir/package_list/to_compile.txt
            else
              # æ‰¹é‡åŒ…ä¸€æ¬¡ç¼–è¯‘
              echo "æ‰¹é‡ç¼–è¯‘å¤šä¸ªåŒ…..."
              make -j$(nproc) || make -j1 V=s
            fi
          else
            echo "æ²¡æœ‰åŒ…éœ€è¦æ›´æ–°ï¼Œè·³è¿‡ç¼–è¯‘æ­¥éª¤"
          fi
          
          # æœ€åç¡®ä¿æ‰€æœ‰å†…å®¹æ­£ç¡®ç”Ÿæˆ
          echo "æœ€ç»ˆæ„å»ºå›ºä»¶..."
          make -j$(nproc) || make -j1 V=s
        fi
        
        # 5. æ›´æ–°åŒ…è®°å½•
        cp /workdir/package_list/current_packages.txt /workdir/package_list/previous_packages.txt
        
        # 6. ä¿å­˜å·²ç¼–è¯‘åŒ…ï¼ˆå¯é€‰ï¼Œè§†ç©ºé—´æƒ…å†µè€Œå®šï¼‰
        echo "å¤‡ä»½ç¼–è¯‘åçš„åŒ…..."
        mkdir -p /workdir/compiled_packages
        find bin/packages/ -type f -name "*.ipk" -exec cp -f {} /workdir/compiled_packages/ \; || true
        
        # æ˜¾ç¤ºç¼–è¯‘ç»“æœ
        echo "çŠ¶æ€ï¼šæˆåŠŸ"
        echo "status=success" >> $GITHUB_OUTPUT
        echo "DEVICE_NAME=_$(grep '^CONFIG_TARGET.*DEVICE.*=y' .config | sed -r 's/.*DEVICE_(.*)=y/\1/' | tr '\n' '_')" >> $GITHUB_ENV
        echo "FILE_DATE=_$(date +"%Y%m%d%H%M")" >> $GITHUB_ENV
        
        # æ˜¾ç¤ºCCACHEç»Ÿè®¡ä¿¡æ¯
        ccache -s
        
        # æ˜¾ç¤ºç£ç›˜ä½¿ç”¨æƒ…å†µ
        df -hT

    - name: æ•´ç†æ–‡ä»¶
      id: organize
      if: env.UPLOAD_FIRMWARE == 'true' && !cancelled()
      run: |
        cd /workdir/openwrt/bin/targets/*/*
        rm -rf packages
        mkdir -p firmware
        find . -maxdepth 1 -name "*combined*" -or -name "*sysupgrade*" | xargs -i cp {} ./firmware/
        cp /workdir/openwrt/.config ./firmware/config.txt
        zip -r firmware.zip firmware
        echo "FIRMWARE=$PWD/firmware" >> $GITHUB_ENV
        echo "FIRMWARE_ZIP=$PWD/firmware.zip" >> $GITHUB_ENV
        echo "status=success" >> $GITHUB_OUTPUT

    - name: ä¸Šä¼ å›ºä»¶ç›®å½•
      uses: actions/upload-artifact@main
      if: steps.organize.outputs.status == 'success' && !cancelled()
      with:
        name: OpenWrt_firmware${{ env.DEVICE_NAME }}${{ env.FILE_DATE }}
        path: ${{ env.FIRMWARE }}

    - name: ç”Ÿæˆå‘å¸ƒæ ‡ç­¾
      id: tag
      if: env.UPLOAD_RELEASE == 'true' && !cancelled()
      run: |
        echo "release_tag=$(date +"%Y.%m.%d-%H%M")" >> $GITHUB_OUTPUT
        echo "## OpenWrtå›ºä»¶æ„å»ºå®Œæˆ ğŸ“¦" > release.txt
        echo "ğŸ“… æ„å»ºæ—¶é—´: $(date +"%Y-%m-%d %H:%M")" >> release.txt
        echo "ğŸ“‚ å›ºä»¶ä¸‹è½½" >> release.txt
        echo "âš ï¸ è¯·åœ¨åˆ·æœºå‰å…ˆåšå¥½å¤‡ä»½ï¼" >> release.txt
        echo "status=success" >> $GITHUB_OUTPUT

    - name: ä¸Šä¼ å›ºä»¶åˆ°Releases
      uses: softprops/action-gh-release@v2
      if: steps.tag.outputs.status == 'success' && !cancelled()
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ steps.tag.outputs.release_tag }}
        body_path: release.txt
        files: ${{ env.FIRMWARE }}/*

    - name: åˆ é™¤æ—§çš„å·¥ä½œæµè¿è¡Œè®°å½•
      uses: Mattraks/delete-workflow-runs@v2
      with:
        retain_days: 1
        keep_minimum_runs: 3

    - name: åˆ é™¤æ—§çš„Releases
      uses: dev-drprasad/delete-older-releases@master
      if: env.UPLOAD_RELEASE == 'true' && !cancelled()
      with:
        keep_latest: 3
        delete_tags: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
