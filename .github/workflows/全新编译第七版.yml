name: å…¨æ–°ç¼–è¯‘ç¬¬ä¸ƒç‰ˆ

on:
  workflow_dispatch:
    inputs:
      ssh:
        description: 'SSHè°ƒè¯•'
        required: false
        default: 'false'
      clean_build:
        description: 'å®Œå…¨é‡æ–°ç¼–è¯‘'
        required: false
        default: 'false'
      config_file:
        description: 'é…ç½®æ–‡ä»¶'
        required: false
        default: 'å¢é‡ç¼“å­˜ä¼˜åŒ–.config'

env:
  REPO_URL: https://github.com/coolsnowwolf/lede
  REPO_BRANCH: master
  CONFIG_FILE: ${{ github.event.inputs.config_file || 'å¢é‡ç¼“å­˜ä¼˜åŒ–.config' }}
  DIY_P1_SH: diy-part1.sh
  DIY_P2_SH: diy-part2.sh
  UPLOAD_FIRMWARE: true
  UPLOAD_RELEASE: true
  TZ: Asia/Shanghai
  CCACHE_DIR: /workdir/ccache

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@main

    - name: ä¼˜åŒ–ç£ç›˜ç©ºé—´
      uses: easimon/maximize-build-space@master
      with:
        root-reserve-mb: 20480  # ä¸º /dev/root é¢„ç•™ 20GB
        swap-size-mb: 5120      # äº¤æ¢ç©ºé—´ 5GB
        remove-dotnet: 'true'
        remove-android: 'true'
        remove-haskell: 'true'
        remove-codeql: 'true'
        remove-docker-images: 'true'
        build-mount-path: '/workdir'

    - name: é¢å¤–æ¸…ç†ç£ç›˜ç©ºé—´å¹¶æ£€æŸ¥
      run: |
        echo "æ¸…ç†é¢å¤–ç£ç›˜ç©ºé—´..."
        sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /usr/local/share/boost
        sudo rm -rf /usr/share/swift /usr/local/julia* /opt/hostedtoolcache/CodeQL
        docker image prune -a -f || true
        docker system prune -af || true
        sudo apt-get clean
        sudo apt-get autoremove -y

        ROOT_AVAIL=$(df -m /dev/root | tail -1 | awk '{print $4}')
        echo "æ ¹åˆ†åŒºå¯ç”¨ç©ºé—´: ${ROOT_AVAIL}MB"
        if [ "$ROOT_AVAIL" -lt 20480 ]; then
          echo "é”™è¯¯ï¼š/dev/root å¯ç”¨ç©ºé—´ä¸è¶³ 20GB"
          exit 1
        fi
        df -h

    - name: åˆå§‹åŒ–ç¯å¢ƒ
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        sudo -E apt-get -qq update
        sudo -E apt-get -qq install ack antlr3 asciidoc autoconf automake autopoint binutils bison build-essential \
        bzip2 ccache cmake cpio curl device-tree-compiler fastjar flex gawk gettext gcc-multilib g++-multilib \
        git gperf haveged help2man intltool libc6-dev-i386 libelf-dev libglib2.0-dev libgmp3-dev libltdl-dev \
        libmpc-dev libmpfr-dev libncurses5-dev libncursesw5-dev libreadline-dev libssl-dev libtool lrzsz \
        mkisofs msmtp nano ninja-build p7zip p7zip-full patch pkgconf python2.7 python3 python3-pyelftools \
        libpython3-dev qemu-utils rsync scons squashfs-tools subversion swig texinfo uglifyjs upx-ucl unzip \
        vim wget xmlto xxd zlib1g-dev python3-setuptools jq
        sudo -E apt-get -qq clean
        sudo timedatectl set-timezone "$TZ"
        mkdir -p /workdir/package_cache /workdir/build_state /workdir/toolchain_cache ${{ env.CCACHE_DIR }}
        chmod -R 777 /workdir
        
        echo '#!/bin/bash' > $GITHUB_WORKSPACE/diy-part1.sh
        echo 'echo "src-git passwall https://github.com/xiaorouji/openwrt-passwall" >> feeds.conf.default' >> $GITHUB_WORKSPACE/diy-part1.sh
        chmod +x $GITHUB_WORKSPACE/diy-part1.sh
        
        echo '#!/bin/bash' > $GITHUB_WORKSPACE/diy-part2.sh
        echo 'sed -i "s/OpenWrt /OpenWrt_AutoBuild /" package/lean/default-settings/files/zzz-default-settings' >> $GITHUB_WORKSPACE/diy-part2.sh
        chmod +x $GITHUB_WORKSPACE/diy-part2.sh
        
        if [ ! -f "$GITHUB_WORKSPACE/$CONFIG_FILE" ]; then
          echo "è­¦å‘Šï¼šé…ç½®æ–‡ä»¶ $CONFIG_FILE ä¸å­˜åœ¨ï¼Œåˆ›å»ºé»˜è®¤é…ç½®æ–‡ä»¶"
          echo "# åˆ›å»ºé»˜è®¤çš„æœ€å°åŒ–é…ç½®æ–‡ä»¶" > $GITHUB_WORKSPACE/$CONFIG_FILE
          echo "CONFIG_TARGET_x86=y" >> $GITHUB_WORKSPACE/$CONFIG_FILE
          echo "CONFIG_TARGET_x86_64=y" >> $GITHUB_WORKSPACE/$CONFIG_FILE
          echo "CONFIG_TARGET_x86_64_DEVICE_generic=y" >> $GITHUB_WORKSPACE/$CONFIG_FILE
          echo "CONFIG_PACKAGE_luci=y" >> $GITHUB_WORKSPACE/$CONFIG_FILE
        fi
        
        df -h

    - name: å…‹éš†æºä»£ç 
      working-directory: /workdir
      run: |
        git clone --depth 1 $REPO_URL -b $REPO_BRANCH openwrt
        ln -sf /workdir/openwrt $GITHUB_WORKSPACE/openwrt
        cd openwrt
        find . -type f -name "*.sh" -exec chmod +x {} \;
        rm -rf .git

    - name: æ¢å¤ç¼–è¯‘åŒ…ç¼“å­˜
      uses: actions/cache@v3
      id: cache-packages
      if: inputs.clean_build != 'true'
      with:
        path: |
          /workdir/package_cache
          /workdir/openwrt/bin/packages
          /workdir/openwrt/bin/targets/*/packages
        key: packages-${{ env.REPO_BRANCH }}-${{ hashFiles(github.event.inputs.config_file || 'å¢é‡ç¼“å­˜ä¼˜åŒ–.config') }}
        restore-keys: |
          packages-${{ env.REPO_BRANCH }}-

    - name: æ¢å¤å·¥å…·é“¾ç¼“å­˜
      uses: actions/cache@v3
      id: cache-toolchain
      if: inputs.clean_build != 'true'
      with:
        path: /workdir/toolchain_cache/staging_dir
        key: toolchain-${{ env.REPO_BRANCH }}-${{ hashFiles(github.event.inputs.config_file || 'å¢é‡ç¼“å­˜ä¼˜åŒ–.config') }}
        restore-keys: |
          toolchain-${{ env.REPO_BRANCH }}-

    - name: æ¢å¤CCACHEç¼“å­˜
      uses: actions/cache@v3
      id: cache-ccache
      with:
        path: ${{ env.CCACHE_DIR }}
        key: ccache-${{ env.REPO_BRANCH }}-${{ hashFiles(github.event.inputs.config_file || 'å¢é‡ç¼“å­˜ä¼˜åŒ–.config') }}
        restore-keys: |
          ccache-${{ env.REPO_BRANCH }}-

    - name: æ¢å¤æ„å»ºçŠ¶æ€
      uses: actions/cache@v3
      id: cache-state
      if: inputs.clean_build != 'true'
      with:
        path: /workdir/build_state
        key: state-${{ env.REPO_BRANCH }}-${{ hashFiles(github.event.inputs.config_file || 'å¢é‡ç¼“å­˜ä¼˜åŒ–.config') }}
        restore-keys: |
          state-${{ env.REPO_BRANCH }}-

    - name: æ¢å¤Feedsç¼“å­˜
      uses: actions/cache@v3
      id: cache-feeds
      if: inputs.clean_build != 'true'
      with:
        path: /workdir/openwrt/feeds
        key: feeds-${{ env.REPO_BRANCH }}-${{ hashFiles(github.event.inputs.config_file || 'å¢é‡ç¼“å­˜ä¼˜åŒ–.config') }}
        restore-keys: |
          feeds-${{ env.REPO_BRANCH }}-

    - name: æ£€æŸ¥ç¼“å­˜æ¢å¤çŠ¶æ€
      run: |
        echo "ç¼–è¯‘åŒ…ç¼“å­˜æ¢å¤çŠ¶æ€: ${{ steps.cache-packages.outputs.cache-hit == 'true' && 'æˆåŠŸ' || 'æœªæ‰¾åˆ°ç¼“å­˜' }}"
        echo "å·¥å…·é“¾ç¼“å­˜æ¢å¤çŠ¶æ€: ${{ steps.cache-toolchain.outputs.cache-hit == 'true' && 'æˆåŠŸ' || 'æœªæ‰¾åˆ°ç¼“å­˜' }}"
        echo "CCACHEç¼“å­˜æ¢å¤çŠ¶æ€: ${{ steps.cache-ccache.outputs.cache-hit == 'true' && 'æˆåŠŸ' || 'æœªæ‰¾åˆ°ç¼“å­˜' }}"
        echo "æ„å»ºçŠ¶æ€ç¼“å­˜æ¢å¤çŠ¶æ€: ${{ steps.cache-state.outputs.cache-hit == 'true' && 'æˆåŠŸ' || 'æœªæ‰¾åˆ°ç¼“å­˜' }}"
        echo "Feedsç¼“å­˜æ¢å¤çŠ¶æ€: ${{ steps.cache-feeds.outputs.cache-hit == 'true' && 'æˆåŠŸ' || 'æœªæ‰¾åˆ°ç¼“å­˜' }}"
        
        ls -la /workdir/build_state/ || echo "æ„å»ºçŠ¶æ€ç›®å½•ä¸ºç©º"
        if [ -f "/workdir/build_state/config.md5" ]; then
          echo "ä¹‹å‰MD5: $(cat /workdir/build_state/config.md5)"
        fi
        if [ -f "/workdir/toolchain_cache/staging_dir/host/bin/libdeflate-gzip" ]; then
          echo "å·¥å…·é“¾åŒ…å« libdeflate-gzipï¼Œç¼“å­˜æ­£å¸¸"
        else
          echo "è­¦å‘Šï¼šå·¥å…·é“¾ç¼“å­˜ç¼ºå°‘ libdeflate-gzip"
        fi
        df -h

    - name: é…ç½®ç¼–è¯‘ç¯å¢ƒ
      run: |
        cd /workdir/openwrt
        if [ -d "/workdir/toolchain_cache/staging_dir" ]; then
          ln -sf /workdir/toolchain_cache/staging_dir .
        fi
        if [ -f ".config" ]; then
          cp .config .config.original
        fi
        $GITHUB_WORKSPACE/$DIY_P1_SH
        if [ -d "feeds" ]; then
          echo "Feeds å·²å­˜åœ¨ï¼Œè·³è¿‡æ›´æ–°"
        else
          echo "Feeds ä¸å­˜åœ¨ï¼Œæ‰§è¡Œæ›´æ–°..."
          ./scripts/feeds update -a
        fi
        ./scripts/feeds install -a
        [ -e $GITHUB_WORKSPACE/files ] && cp -r $GITHUB_WORKSPACE/files ./files
        cp $GITHUB_WORKSPACE/$CONFIG_FILE ./.config
        $GITHUB_WORKSPACE/$DIY_P2_SH
        echo "CONFIG_AUTOREMOVE=n" >> .config
        echo "CONFIG_AUTOREBUILD=n" >> .config
        make defconfig
        df -h

    - name: æ£€æŸ¥æºç å˜åŒ–
      id: check-feeds
      run: |
        cd /workdir/openwrt
        find feeds -type f -name "Makefile" -exec sha256sum {} \; | sort | sha256sum > /workdir/build_state/feeds.sha256
        CURRENT_FEEDS_HASH=$(cat /workdir/build_state/feeds.sha256 | awk '{print $1}')
        PREVIOUS_FEEDS_HASH=$(cat /workdir/build_state/previous_feeds.sha256 || echo "")
        if [ "$CURRENT_FEEDS_HASH" != "$PREVIOUS_FEEDS_HASH" ]; then
          echo "feeds_changed=true" >> $GITHUB_ENV
        else
          echo "feeds_changed=false" >> $GITHUB_ENV
        fi
        echo "å½“å‰ feeds å“ˆå¸Œ: $CURRENT_FEEDS_HASH"
        echo "ä¹‹å‰ feeds å“ˆå¸Œ: $PREVIOUS_FEEDS_HASH"
        cp /workdir/build_state/feeds.sha256 /workdir/build_state/previous_feeds.sha256

    - name: æ¢å¤å·²ç¼–è¯‘è½¯ä»¶åŒ…
      if: steps.cache-packages.outputs.cache-hit == 'true'
      run: |
        cd /workdir/openwrt
        mkdir -p bin/packages bin/targets
        if [ "${{ env.feeds_changed }}" = "true" ]; then
          echo "feeds å·²æ›´æ–°ï¼Œè·³è¿‡æ¢å¤æ—§çš„ç¼–è¯‘åŒ…ç¼“å­˜"
        else
          cp -r /workdir/package_cache/bin/packages/* bin/packages/ || true
          cp -r /workdir/package_cache/bin/targets/* bin/targets/ || true
          echo "å·²æ¢å¤ç¼“å­˜ä¸­çš„è½¯ä»¶åŒ…"
          ls -la bin/packages/
        fi

    - name: å¼€å¯SSHè°ƒè¯•
      uses: mxschmitt/action-tmate@v3
      if: github.event.inputs.ssh == 'true'

    - name: ä¸‹è½½è½¯ä»¶åŒ…
      run: |
        cd /workdir/openwrt
        make download -j8 || make download -j1 V=s
        mkdir -p ${{ env.CCACHE_DIR }}
        ccache -o cache_dir=${{ env.CCACHE_DIR }}
        ccache -o max_size=5G
        ccache -z
        rm -rf dl || true
        df -h

    - name: æ™ºèƒ½ç¼–è¯‘å›ºä»¶
      id: compile
      run: |
        cd /workdir/openwrt
        export CCACHE_DIR=${{ env.CCACHE_DIR }}
        export PATH="/usr/lib/ccache:$PATH"

        cleanup_temp_files() {
          echo "æ¸…ç†ä¸´æ—¶æ–‡ä»¶ä»¥é‡Šæ”¾ç©ºé—´..."
          find /tmp -type f -delete || true
          df -h
        }

        save_toolchain() {
          echo "ä¿å­˜å·¥å…·é“¾åˆ°ç¼“å­˜..."
          mkdir -p /workdir/toolchain_cache
          if [ -d "staging_dir" ]; then
            cp -r staging_dir/* /workdir/toolchain_cache/
            TOOLCHAIN_SIZE=$(du -sh /workdir/toolchain_cache | awk '{print $1}')
            TOOLCHAIN_FILES=$(find /workdir/toolchain_cache -type f | wc -l)
            echo "å·¥å…·é“¾ç¼“å­˜å¤§å°: $TOOLCHAIN_SIZE"
            echo "å·¥å…·é“¾æ–‡ä»¶æ•°: $TOOLCHAIN_FILES"
            ls -la /workdir/toolchain_cache/host/bin || echo "host/bin ç›®å½•ä¸ºç©º"
            echo "### å·¥å…·é“¾ç¼“å­˜ä¿å­˜" >> $GITHUB_STEP_SUMMARY
            echo "- å¤§å°: $TOOLCHAIN_SIZE" >> $GITHUB_STEP_SUMMARY
            echo "- æ–‡ä»¶æ•°: $TOOLCHAIN_FILES" >> $GITHUB_STEP_SUMMARY
            echo "- è·¯å¾„: /workdir/toolchain_cache" >> $GITHUB_STEP_SUMMARY
          else
            echo "æ— å·¥å…·é“¾ç›®å½•å¯ä¿å­˜"
          fi
        }

        save_packages() {
          echo "ä¿å­˜ç¼–è¯‘åŒ…åˆ°ç¼“å­˜..."
          mkdir -p /workdir/package_cache
          if [ -d "bin/packages" ] || [ -d "bin/targets" ]; then
            [ -d "bin/packages" ] && cp -r bin/packages /workdir/package_cache/
            [ -d "bin/targets" ] && mkdir -p /workdir/package_cache/bin && cp -r bin/targets /workdir/package_cache/bin/
            PACKAGE_SIZE=$(du -sh /workdir/package_cache | awk '{print $1}')
            PACKAGE_FILES=$(find /workdir/package_cache -type f | wc -l)
            echo "ç¼–è¯‘åŒ…ç¼“å­˜å¤§å°: $PACKAGE_SIZE"
            echo "ç¼–è¯‘åŒ…æ–‡ä»¶æ•°: $PACKAGE_FILES"
            echo "ä¿å­˜è·¯å¾„: /workdir/package_cache"
            echo "### ç¼–è¯‘åŒ…ç¼“å­˜ä¿å­˜" >> $GITHUB_STEP_SUMMARY
            echo "- å¤§å°: $PACKAGE_SIZE" >> $GITHUB_STEP_SUMMARY
            echo "- æ–‡ä»¶æ•°: $PACKAGE_FILES" >> $GITHUB_STEP_SUMMARY
            echo "- è·¯å¾„: /workdir/package_cache" >> $GITHUB_STEP_SUMMARY
          else
            echo "æ— ç¼–è¯‘åŒ…å¯ä¿å­˜"
          fi
        }

        compile_firmware() {
          if [ $DO_FULL_BUILD -eq 1 ]; then
            if [ ! -d "staging_dir/toolchain-"* ]; then
              echo "ç¼–è¯‘å·¥å…·é“¾..."
              make -j$(nproc) tools/compile || make -j1 V=s tools/compile
              make -j$(nproc) toolchain/compile || make -j1 V=s toolchain/compile
              save_toolchain
            else
              echo "å·¥å…·é“¾å·²å­˜åœ¨ï¼Œè·³è¿‡ç¼–è¯‘"
            fi
            cleanup_temp_files
            echo "ç¼–è¯‘å®Œæ•´å›ºä»¶..."
            make -j$(nproc) || make -j1 V=s
          elif [ $DO_PACKAGE_BUILD -eq 1 ] || [ "${{ env.feeds_changed }}" = "true" ]; then
            echo "è½¯ä»¶åŒ…é…ç½®å˜åŒ–æˆ–æºç æ›´æ–°ï¼Œç¼–è¯‘è½¯ä»¶åŒ…..."
            make -j$(nproc) package/clean || make -j1 V=s package/clean
            make -j$(nproc) package/compile || make -j1 V=s package/compile
            make -j$(nproc) package/index || make -j1 V=s package/index
          else
            echo "æœ€å°åŒ–å¢é‡ç¼–è¯‘..."
            make -j$(nproc) || make -j1 V=s
          fi

          if [ $? -eq 0 ]; then
            echo "ç¼–è¯‘æˆåŠŸ"
            save_toolchain
            save_packages
            mkdir -p /workdir/build_state
            cp .config /workdir/build_state/config.txt
            echo "$TOOLCHAIN_MD5" > /workdir/build_state/toolchain.md5
            echo "$PACKAGE_MD5" > /workdir/build_state/package.md5
            echo "ä¿å­˜æ„å»ºçŠ¶æ€å®Œæˆ"
            echo "æ£€æŸ¥ç¼“å­˜å†…å®¹ï¼š"
            ls -la /workdir/package_cache || echo "ç¼–è¯‘åŒ…ç¼“å­˜ç›®å½•ä¸ºç©º"
            ls -la /workdir/toolchain_cache || echo "å·¥å…·é“¾ç¼“å­˜ç›®å½•ä¸ºç©º"
            ls -la /workdir/build_state || echo "æ„å»ºçŠ¶æ€ç¼“å­˜ç›®å½•ä¸ºç©º"
          else
            echo "ç¼–è¯‘å¤±è´¥"
            exit 1
          fi
        }

        TOOLCHAIN_CONFIG=$(grep "^CONFIG_TARGET" .config | sort)
        TOOLCHAIN_MD5=$(echo "$TOOLCHAIN_CONFIG" | md5sum | awk '{print $1}')
        PREVIOUS_TOOLCHAIN_MD5=$(cat /workdir/build_state/toolchain.md5 || echo "")

        PACKAGE_CONFIG=$(grep "^CONFIG_PACKAGE" .config | sort)
        PACKAGE_MD5=$(echo "$PACKAGE_CONFIG" | md5sum | awk '{print $1}')
        PREVIOUS_PACKAGE_MD5=$(cat /workdir/build_state/package.md5 || echo "")

        DO_FULL_BUILD=0
        DO_PACKAGE_BUILD=0

        if [ -z "$PREVIOUS_TOOLCHAIN_MD5" ] || [ "$TOOLCHAIN_MD5" != "$PREVIOUS_TOOLCHAIN_MD5" ] || [ "${{ github.event.inputs.clean_build }}" = "true" ] || [ ! -d "feeds" ]; then
          echo "å·¥å…·é“¾é…ç½®å˜åŒ–ã€é¦–æ¬¡ç¼–è¯‘æˆ– feeds ç¼ºå¤±ï¼Œéœ€è¦å…¨é‡ç¼–è¯‘"
          DO_FULL_BUILD=1
        elif [ -z "$PREVIOUS_PACKAGE_MD5" ] || [ "$PACKAGE_MD5" != "$PREVIOUS_PACKAGE_MD5" ]; then
          echo "è½¯ä»¶åŒ…é…ç½®å˜åŒ–ï¼Œéœ€è¦ç¼–è¯‘è½¯ä»¶åŒ…"
          DO_PACKAGE_BUILD=1
        else
          echo "é…ç½®æœªå˜ï¼Œæ£€æŸ¥æºç å˜åŒ–..."
        fi

        compile_firmware

        echo "DEVICE_NAME=_$(grep '^CONFIG_TARGET.*DEVICE.*=y' .config | sed -r 's/.*DEVICE_(.*)=y/\1/' | tr '\n' '_')" >> $GITHUB_ENV
        echo "FILE_DATE=_$(date +"%Y%m%d%H%M")" >> $GITHUB_ENV
        echo "status=success" >> $GITHUB_OUTPUT
        ccache -s
        df -h

    - name: æ•´ç†æ–‡ä»¶
      id: organize
      if: steps.compile.outputs.status == 'success' && env.UPLOAD_FIRMWARE == 'true' && !cancelled()
      run: |
        cd /workdir/openwrt/bin/targets/*/*
        rm -rf packages || true
        mkdir -p firmware
        FIRMWARE_FILES=$(find . -maxdepth 1 -name "*combined*" -or -name "*sysupgrade*")
        if [ -z "$FIRMWARE_FILES" ]; then
          echo "è­¦å‘Šï¼šæœªæ‰¾åˆ°å›ºä»¶æ–‡ä»¶ï¼Œä½¿ç”¨æ‰€æœ‰binæ–‡ä»¶"
          FIRMWARE_FILES=$(find . -maxdepth 1 -name "*.bin")
        fi
        if [ -n "$FIRMWARE_FILES" ]; then
          echo "$FIRMWARE_FILES" | xargs -i cp {} ./firmware/
        else
          cp -r * ./firmware/
        fi
        cp /workdir/openwrt/.config ./firmware/config.txt
        zip -r firmware.zip firmware
        echo "FIRMWARE=$PWD/firmware" >> $GITHUB_ENV
        echo "FIRMWARE_ZIP=$PWD/firmware.zip" >> $GITHUB_ENV
        echo "status=success" >> $GITHUB_OUTPUT

    - name: ä¸Šä¼ å›ºä»¶ç›®å½•
      uses: actions/upload-artifact@main
      if: steps.organize.outputs.status == 'success' && !cancelled()
      with:
        name: OpenWrt_firmware${{ env.DEVICE_NAME }}${{ env.FILE_DATE }}
        path: ${{ env.FIRMWARE }}

    - name: ç”Ÿæˆå‘å¸ƒæ ‡ç­¾
      id: tag
      if: steps.organize.outputs.status == 'success' && env.UPLOAD_RELEASE == 'true' && !cancelled()
      run: |
        echo "RELEASE_TAG=$(date +"%Y.%m.%d-%H%M")" >> $GITHUB_OUTPUT
        echo "## OpenWrtå›ºä»¶æ„å»ºå®Œæˆ ğŸ“¦" > release.txt
        echo "ğŸ“… æ„å»ºæ—¶é—´: $(date +"%Y-%m-%d %H:%M")" >> release.txt
        echo "ğŸ“‚ å›ºä»¶ä¸‹è½½" >> release.txt
        echo "âš ï¸ è¯·åœ¨åˆ·æœºå‰å…ˆåšå¥½å¤‡ä»½ï¼" >> release.txt
        echo "status=success" >> $GITHUB_OUTPUT

    - name: ä¸Šä¼ å›ºä»¶åˆ°Releases
      uses: softprops/action-gh-release@v2
      if: steps.tag.outputs.status == 'success' && !cancelled()
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ steps.tag.outputs.RELEASE_TAG }}
        body_path: release.txt
        files: ${{ env.FIRMWARE }}/*

    - name: åˆ é™¤æ—§çš„Releases
      uses: dev-drprasad/delete-older-releases@master
      if: env.UPLOAD_RELEASE == 'true' && !cancelled()
      with:
        keep_latest: 3
        delete_tags: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: æ¸…ç†å·¥ä½œç›®å½•
      if: always()
      run: |
        echo "æ¸…ç†å·¥ä½œç›®å½•ä»¥é‡Šæ”¾ç©ºé—´ï¼ˆä¿ç•™ build_dirï¼‰..."
        rm -rf /workdir/openwrt/staging_dir || true
        rm -rf /workdir/openwrt/tmp || true
        df -h
