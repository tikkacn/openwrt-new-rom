name: å…¨æ–°ç¼–è¯‘ç¬¬ä¸ƒç‰ˆ

on:
  workflow_dispatch:
    inputs:
      ssh:
        description: 'SSHè°ƒè¯•'
        required: false
        default: 'false'
      clean_build:
        description: 'å®Œå…¨é‡æ–°ç¼–è¯‘'
        required: false
        default: 'false'
      config_file:
        description: 'é…ç½®æ–‡ä»¶'
        required: false
        default: 'å¢é‡ç¼“å­˜ä¼˜åŒ–.config'

env:
  REPO_URL: https://github.com/coolsnowwolf/lede
  REPO_BRANCH: master
  CONFIG_FILE: ${{ github.event.inputs.config_file || 'å¢é‡ç¼“å­˜ä¼˜åŒ–.config' }}
  DIY_P1_SH: diy-part1.sh
  DIY_P2_SH: diy-part2.sh
  UPLOAD_FIRMWARE: true
  UPLOAD_RELEASE: true
  TZ: Asia/Shanghai
  CCACHE_DIR: /workdir/ccache

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@main

    - name: ä¼˜åŒ–ç£ç›˜ç©ºé—´
      uses: easimon/maximize-build-space@master
      with:
        root-reserve-mb: 30720  # å¢åŠ æ ¹ç›®å½•ä¿ç•™ç©ºé—´è‡³çº¦30GB
        swap-size-mb: 1
        remove-dotnet: 'true'
        remove-android: 'true'
        remove-haskell: 'true'
        remove-codeql: 'true'
        remove-docker-images: 'true'
        build-mount-path: '/workdir'

    - name: è®¾ç½®ä¸´æ—¶ç›®å½•åœ¨å·¥ä½œåŒº
      run: |
        mkdir -p /workdir/tmp
        sudo chmod 777 /workdir/tmp
        echo "TMPDIR=/workdir/tmp" >> $GITHUB_ENV
        # ç¡®ä¿æ‰€æœ‰ä¸´æ—¶æ–‡ä»¶éƒ½å­˜å‚¨åœ¨/workdirä¸­
        export TMPDIR=/workdir/tmp
        echo "ä½¿ç”¨ä¸´æ—¶ç›®å½•: $TMPDIR"
        df -h

    - name: é¢å¤–æ¸…ç†ç£ç›˜ç©ºé—´
      run: |
        echo "æ¸…ç†é¢å¤–ç£ç›˜ç©ºé—´..."
        sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /usr/local/share/boost
        sudo rm -rf /usr/share/swift /usr/local/julia* /opt/hostedtoolcache/CodeQL
        sudo rm -rf /opt/hostedtoolcache/* /usr/local/lib/node_modules
        docker image prune -a -f || true
        docker system prune -af || true
        sudo apt-get clean
        sudo apt-get autoremove -y
        df -h  # æ˜¾ç¤ºå½“å‰ç£ç›˜ä½¿ç”¨æƒ…å†µ

    - name: åˆå§‹åŒ–ç¯å¢ƒ
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        sudo -E apt-get -qq update
        sudo -E apt-get -qq install $(curl -fsSL https://raw.githubusercontent.com/coolsnowwolf/lede/master/prereq-build.mk | grep -o 'package-y += .*' | sed 's/package-y += //g')
        sudo -E apt-get -qq install ack antlr3 asciidoc autoconf automake autopoint binutils bison build-essential \
        bzip2 ccache cmake cpio curl device-tree-compiler fastjar flex gawk gettext gcc-multilib g++-multilib \
        git gperf haveged help2man intltool libc6-dev-i386 libelf-dev libglib2.0-dev libgmp3-dev libltdl-dev \
        libmpc-dev libmpfr-dev libncurses5-dev libncursesw5-dev libreadline-dev libssl-dev libtool lrzsz \
        mkisofs msmtp nano ninja-build p7zip p7zip-full patch pkgconf python2.7 python3 python3-pyelftools \
        libpython3-dev qemu-utils rsync scons squashfs-tools subversion swig texinfo uglifyjs upx-ucl unzip \
        vim wget xmlto xxd zlib1g-dev python3-setuptools jq
        sudo -E apt-get -qq clean
        sudo timedatectl set-timezone "$TZ"
        mkdir -p /workdir/package_cache /workdir/build_state /workdir/toolchain_cache ${{ env.CCACHE_DIR }}
        chmod -R 777 /workdir
        
        # åˆ›å»ºDIYè„šæœ¬
        echo '#!/bin/bash' > $GITHUB_WORKSPACE/diy-part1.sh
        echo '# è‡ªå®šä¹‰feedsæº' >> $GITHUB_WORKSPACE/diy-part1.sh
        echo 'echo "src-git passwall https://github.com/xiaorouji/openwrt-passwall" >> feeds.conf.default' >> $GITHUB_WORKSPACE/diy-part1.sh
        chmod +x $GITHUB_WORKSPACE/diy-part1.sh
        
        echo '#!/bin/bash' > $GITHUB_WORKSPACE/diy-part2.sh
        echo '# è‡ªå®šä¹‰é…ç½®' >> $GITHUB_WORKSPACE/diy-part2.sh
        echo 'sed -i "s/OpenWrt /OpenWrt_AutoBuild /" package/lean/default-settings/files/zzz-default-settings' >> $GITHUB_WORKSPACE/diy-part2.sh
        chmod +x $GITHUB_WORKSPACE/diy-part2.sh
        
        # åˆ›å»ºé»˜è®¤é…ç½®æ–‡ä»¶(å¦‚æœä¸å­˜åœ¨)
        if [ ! -f "$GITHUB_WORKSPACE/$CONFIG_FILE" ]; then
          echo "# åˆ›å»ºé»˜è®¤çš„æœ€å°åŒ–é…ç½®æ–‡ä»¶" > $GITHUB_WORKSPACE/$CONFIG_FILE
          echo "CONFIG_TARGET_x86=y" >> $GITHUB_WORKSPACE/$CONFIG_FILE
          echo "CONFIG_TARGET_x86_64=y" >> $GITHUB_WORKSPACE/$CONFIG_FILE
          echo "CONFIG_TARGET_x86_64_DEVICE_generic=y" >> $GITHUB_WORKSPACE/$CONFIG_FILE
          echo "CONFIG_PACKAGE_luci=y" >> $GITHUB_WORKSPACE/$CONFIG_FILE
        fi
        
        # æ˜¾ç¤ºç£ç›˜ä½¿ç”¨æƒ…å†µ
        df -h

    - name: å…‹éš†æºä»£ç 
      working-directory: /workdir
      run: |
        git clone --depth 1 $REPO_URL -b $REPO_BRANCH openwrt
        ln -sf /workdir/openwrt $GITHUB_WORKSPACE/openwrt
        cd openwrt
        find . -type f -name "*.sh" -exec chmod +x {} \;
        
        # ä¿å­˜ä»£ç ç‰ˆæœ¬ä¿¡æ¯
        mkdir -p /workdir/build_state
        git rev-parse HEAD > /workdir/build_state/current_git_commit
        git log -1 --pretty=format:"%h - %an, %ar : %s" > /workdir/build_state/current_git_info
        echo "å½“å‰æºç ç‰ˆæœ¬: $(cat /workdir/build_state/current_git_info)"
        
        # æ¸…ç†ä¸å¿…è¦çš„å†…å®¹
        rm -rf .git

    # æ¢å¤æ„å»ºç›®å½•ç¼“å­˜ - åŒ…æ‹¬æ•´ä¸ªbuild_dirç›®å½•ï¼ŒåŠ é€Ÿå¢é‡ç¼–è¯‘
    - name: æ¢å¤æ„å»ºç›®å½•ç¼“å­˜
      uses: actions/cache@v3
      id: cache-builddir
      if: inputs.clean_build != 'true'
      with:
        path: /workdir/openwrt/build_dir
        key: builddir-${{ github.run_id }}
        restore-keys: |
          builddir-

    # æ¢å¤ç¼–è¯‘åŒ…ç¼“å­˜ - æœ€é«˜ä¼˜å…ˆçº§ç¼“å­˜ï¼Œä½†åªä¿ç•™å¿…è¦éƒ¨åˆ†
    - name: æ¢å¤ç¼–è¯‘åŒ…ç¼“å­˜
      uses: actions/cache@v3
      id: cache-packages
      if: inputs.clean_build != 'true'
      with:
        path: |
          /workdir/package_cache
          /workdir/openwrt/bin/packages
          /workdir/openwrt/bin/targets
          !/workdir/openwrt/staging_dir/target-*/root*
        key: packages-${{ github.run_id }}
        restore-keys: |
          packages-

    # æ¢å¤å·¥å…·é“¾ç¼“å­˜ - æ¬¡è¦ä¼˜å…ˆçº§
    - name: æ¢å¤å·¥å…·é“¾ç¼“å­˜
      uses: actions/cache@v3
      id: cache-toolchain
      if: inputs.clean_build != 'true'
      with:
        path: |
          /workdir/toolchain_cache
        key: toolchain-${{ github.run_id }}
        restore-keys: |
          toolchain-

    # æ¢å¤CCACHEç¼“å­˜ - åŠ é€Ÿç¼–è¯‘
    - name: æ¢å¤CCACHEç¼“å­˜
      uses: actions/cache@v3
      id: cache-ccache
      with:
        path: ${{ env.CCACHE_DIR }}
        key: ccache-${{ github.run_id }}
        restore-keys: |
          ccache-

    # æ¢å¤æ„å»ºçŠ¶æ€
    - name: æ¢å¤æ„å»ºçŠ¶æ€
      uses: actions/cache@v3
      id: cache-state
      if: inputs.clean_build != 'true'
      with:
        path: /workdir/build_state
        key: state-${{ github.run_id }}
        restore-keys: |
          state-

    # === å…³é”®ä¿®å¤éƒ¨åˆ†ï¼šè§£å†³æƒé™é—®é¢˜ ===
    - name: ä¿®å¤æ–‡ä»¶æƒé™
      run: |
        echo "ä¿®å¤ç¼“å­˜æ–‡ä»¶æƒé™..."
        
        # ä¿®å¤staging_dirç›®å½•æƒé™
        if [ -d "/workdir/openwrt/staging_dir" ]; then
          echo "ä¿®å¤staging_diræƒé™..."
          sudo chown -R $(id -u):$(id -g) /workdir/openwrt/staging_dir
          sudo find /workdir/openwrt/staging_dir -type d -exec chmod 755 {} \;
          sudo find /workdir/openwrt/staging_dir -type f -exec chmod 644 {} \;
          # ç‰¹åˆ«å¤„ç†å¯æ‰§è¡Œæ–‡ä»¶ï¼Œç¡®ä¿æœ‰æ‰§è¡Œæƒé™
          sudo find /workdir/openwrt/staging_dir -type f -name "*.sh" -exec chmod +x {} \;
          sudo find /workdir/openwrt/staging_dir/host/bin -type f -exec chmod +x {} \; 2>/dev/null || true
          sudo find /workdir/openwrt/staging_dir/toolchain-*/bin -type f -exec chmod +x {} \; 2>/dev/null || true
          sudo find /workdir/openwrt/staging_dir/toolchain-*/libexec -type f -exec chmod +x {} \; 2>/dev/null || true
        fi
        
        # ä¿®å¤å·¥å…·é“¾ç¼“å­˜æƒé™
        if [ -d "/workdir/toolchain_cache" ]; then
          echo "ä¿®å¤å·¥å…·é“¾ç¼“å­˜æƒé™..."
          sudo chown -R $(id -u):$(id -g) /workdir/toolchain_cache
          sudo find /workdir/toolchain_cache -type d -exec chmod 755 {} \;
          sudo find /workdir/toolchain_cache -type f -exec chmod 644 {} \;
          sudo find /workdir/toolchain_cache -type f -name "*.sh" -exec chmod +x {} \; 2>/dev/null || true
          sudo find /workdir/toolchain_cache/host/bin -type f -exec chmod +x {} \; 2>/dev/null || true
          sudo find /workdir/toolchain_cache -path "*/bin/*" -type f -exec chmod +x {} \; 2>/dev/null || true
          sudo find /workdir/toolchain_cache -path "*/libexec/*" -type f -exec chmod +x {} \; 2>/dev/null || true
        fi
        
        # ä¿®å¤build_dirç›®å½•æƒé™
        if [ -d "/workdir/openwrt/build_dir" ]; then
          echo "ä¿®å¤build_diræƒé™..."
          sudo chown -R $(id -u):$(id -g) /workdir/openwrt/build_dir
          sudo find /workdir/openwrt/build_dir -type d -exec chmod 755 {} \;
          sudo find /workdir/openwrt/build_dir -type f -exec chmod 644 {} \;
          sudo find /workdir/openwrt/build_dir -type f -name "*.sh" -exec chmod +x {} \;
        fi
        
        # ç¡®ä¿å·¥ä½œç›®å½•æ‰€æœ‰è€…æ­£ç¡®
        sudo chown -R $(id -u):$(id -g) /workdir

    # æ£€æŸ¥å·¥å…·é“¾æ¢å¤å¹¶å¤åˆ¶
    - name: æ£€æŸ¥å’Œå‡†å¤‡å·¥å…·é“¾
      run: |
        if [ -d "/workdir/toolchain_cache" ] && [ "$(ls -A /workdir/toolchain_cache 2>/dev/null)" ]; then
          echo "å·¥å…·é“¾ç¼“å­˜æ‰¾åˆ°ï¼Œå‡†å¤‡æ¢å¤..."
          # ç¡®ä¿ç›®æ ‡ç›®å½•å­˜åœ¨
          mkdir -p /workdir/openwrt/staging_dir/
          
          echo "å¤åˆ¶å·¥å…·é“¾æ–‡ä»¶..."
          cp -r /workdir/toolchain_cache/* /workdir/openwrt/staging_dir/ || true
          
          # é‡è¦ï¼šç¡®ä¿æ‰€æœ‰äºŒè¿›åˆ¶æ–‡ä»¶æœ‰æ‰§è¡Œæƒé™
          echo "è®¾ç½®å¯æ‰§è¡Œæƒé™..."
          find /workdir/openwrt/staging_dir -path "*/bin/*" -type f -exec chmod +x {} \; 2>/dev/null || true
          find /workdir/openwrt/staging_dir -path "*/libexec/*" -type f -exec chmod +x {} \; 2>/dev/null || true
          find /workdir/openwrt/staging_dir/host/bin -type f -exec chmod +x {} \; 2>/dev/null || true
          
          echo "å·¥å…·é“¾æ¢å¤å®Œæˆï¼ŒéªŒè¯å…³é”®å¯æ‰§è¡Œæ–‡ä»¶..."
          if [ -f "/workdir/openwrt/staging_dir/host/bin/mkhash" ]; then
            ls -la /workdir/openwrt/staging_dir/host/bin/mkhash
          else
            echo "mkhashæ–‡ä»¶ä¸å­˜åœ¨ï¼Œå¯èƒ½éœ€è¦å…¨é‡ç¼–è¯‘"
          fi
        else
          echo "å·¥å…·é“¾ç¼“å­˜ç›®å½•ä¸ºç©ºæˆ–ä¸å­˜åœ¨ï¼Œå°†è¿›è¡Œå…¨é‡ç¼–è¯‘"
        fi
        
        # æ¢å¤åŒ…ç¼“å­˜
        if [ -d "/workdir/package_cache" ] && [ "$(ls -A /workdir/package_cache 2>/dev/null)" ]; then
          echo "ä»ç¼“å­˜æ¢å¤ç¼–è¯‘åŒ…..."
          mkdir -p /workdir/openwrt/bin/
          if [ -d "/workdir/package_cache/bin" ]; then
            cp -r /workdir/package_cache/bin/* /workdir/openwrt/bin/ || true
          fi
          echo "ä»ç¼“å­˜æ¢å¤ç¼–è¯‘åŒ…å®Œæˆ"
        fi

    # é…ç½®ç¼–è¯‘ç¯å¢ƒ - ä¿®æ”¹ä»¥ä¿ç•™åŸå§‹é…ç½®
    - name: é…ç½®ç¼–è¯‘ç¯å¢ƒ
      run: |
        cd /workdir/openwrt
        
        # åŠ è½½è‡ªå®šä¹‰feeds
        $GITHUB_WORKSPACE/$DIY_P1_SH
        
        # æ›´æ–°feeds
        ./scripts/feeds update -a
        ./scripts/feeds install -a
        
        # åŠ è½½è‡ªå®šä¹‰é…ç½®
        [ -e $GITHUB_WORKSPACE/files ] && cp -r $GITHUB_WORKSPACE/files ./files
        cp $GITHUB_WORKSPACE/$CONFIG_FILE ./.config
        $GITHUB_WORKSPACE/$DIY_P2_SH
        
        # ç¦ç”¨è‡ªåŠ¨é‡å»ºå’Œè‡ªåŠ¨ç§»é™¤ - è¿™å¯¹å¢é‡ç¼–è¯‘è‡³å…³é‡è¦
        echo "CONFIG_AUTOREMOVE=n" >> .config
        echo "CONFIG_AUTOREBUILD=n" >> .config
        echo "CONFIG_CCACHE=y" >> .config
        
        # åº”ç”¨é…ç½®å‰åæ¯”è¾ƒå˜åŒ–
        echo "åº”ç”¨defconfigå‰åé…ç½®å·®å¼‚:"
        cp .config .config.before_defconfig
        make defconfig
        diff -u .config.before_defconfig .config || true
        
        # åˆ›å»ºåŒ…è·Ÿè¸ªè„šæœ¬
        mkdir -p /workdir/build_state
        grep "^CONFIG_PACKAGE_" .config | sort > /workdir/build_state/current_packages.txt
        if [ -f "/workdir/build_state/previous_packages.txt" ]; then
          echo "å¯¹æ¯”å½“å‰åŒ…ä¸ä¸Šæ¬¡ç¼–è¯‘çš„å·®å¼‚:"
          diff -u /workdir/build_state/previous_packages.txt /workdir/build_state/current_packages.txt || true
          PACKAGE_DIFF_COUNT=$(comm -3 /workdir/build_state/current_packages.txt /workdir/build_state/previous_packages.txt | wc -l)
          echo "å˜åŒ–çš„åŒ…æ•°é‡: $PACKAGE_DIFF_COUNT"
        else
          echo "é¦–æ¬¡ç¼–è¯‘ï¼Œåˆ›å»ºåŒ…åˆ—è¡¨"
        fi
        
        # å°†å½“å‰é…ç½®ä¿å­˜ä¸ºæ¯”è¾ƒåŸºå‡†ï¼Œç¡®ä¿æ–‡ä»¶å­˜åœ¨
        cp .config /workdir/build_state/config.txt.current
        
        # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
        rm -rf /tmp/* || true
        df -h

    - name: å¼€å¯SSHè°ƒè¯•
      uses: mxschmitt/action-tmate@v3
      if: github.event.inputs.ssh == 'true'

    # ä¸‹è½½è½¯ä»¶åŒ…
    - name: ä¸‹è½½è½¯ä»¶åŒ…
      run: |
        cd /workdir/openwrt
        make download -j8 || make download -j1 V=s
        
        # é…ç½®CCACHE - ä¼˜åŒ–è®¾ç½®ä»¥æé«˜ç¼“å­˜å‘½ä¸­ç‡
        mkdir -p ${{ env.CCACHE_DIR }}
        ccache -o cache_dir=${{ env.CCACHE_DIR }}
        ccache -o max_size=5G  # å¢å¤§CCACHEå¤§å°
        ccache -o sloppiness=file_macro,time_macros,include_file_mtime,include_file_ctime,pch_defines
        ccache -o hash_dir=false
        ccache -o compression=true
        ccache -o compression_level=1
        ccache -z
        
        # æ˜¾ç¤ºCCACHEé…ç½®
        ccache -p
        
        # æ¸…ç†ä¸‹è½½ç¼“å­˜ä»¥èŠ‚çœç©ºé—´
        rm -rf dl || true
        df -h

    # æ™ºèƒ½å¢é‡ç¼–è¯‘ï¼Œä¿ç•™åŒ…å˜æ›´è¯„ä¼°é€»è¾‘
    - name: æ™ºèƒ½ç¼–è¯‘å›ºä»¶
      id: compile
      run: |
        cd /workdir/openwrt
        export CCACHE_DIR=${{ env.CCACHE_DIR }}
        export PATH="/usr/lib/ccache:$PATH"
        
        # åˆ›å»ºç¼–è¯‘é”å®šæ–‡ä»¶ï¼Œç¡®ä¿ä¸­æ–­æ—¶ä¹Ÿèƒ½æ¢å¤
        touch .config.lock
        
        # æ›´é«˜æ•ˆçš„ä¸­é—´æ¸…ç†å‡½æ•° - åªæ¸…ç†æœ€å¤§çš„æ–‡ä»¶
        cleanup_temp_files() {
          echo "æ¸…ç†ä¸´æ—¶æ–‡ä»¶ä»¥é‡Šæ”¾ç©ºé—´..."
          # åªåˆ é™¤è¶…å¤§æ–‡ä»¶ï¼Œä¿ç•™å¤§éƒ¨åˆ†ä¸­é—´æ–‡ä»¶ä»¥åŠ é€Ÿå¢é‡ç¼–è¯‘
          find build_dir -type f -size +100M | grep -v "\.ipk$" | xargs rm -f || true
          find /workdir -name "*.log" -type f -delete || true
          rm -rf /tmp/* 2>/dev/null || true
          if [ -d "/workdir/tmp" ]; then
            find /workdir/tmp -type f -delete || true
          fi
          df -h  # æ˜¾ç¤ºç£ç›˜ä½¿ç”¨æƒ…å†µ
        }
        
        # å·¥å…·é“¾ç¼“å­˜å‡½æ•° - ä¿®å¤æƒé™é—®é¢˜
        save_toolchain() {
          echo "ä¿å­˜å·¥å…·é“¾åˆ°ç¼“å­˜..."
          sudo mkdir -p /workdir/toolchain_cache
          sudo chmod -R 755 /workdir/toolchain_cache
          
          if [ -d "staging_dir/toolchain-"* ]; then
            echo "å¤åˆ¶å·¥å…·é“¾åˆ°ç¼“å­˜ç›®å½•..."
            # ä¿®å¤æ–‡ä»¶æƒé™
            sudo find staging_dir/toolchain-* -type d -exec chmod 755 {} \;
            sudo find staging_dir/toolchain-* -type f -exec chmod 644 {} \;
            sudo find staging_dir/host -type d -exec chmod 755 {} \;
            sudo find staging_dir/host -type f -exec chmod 644 {} \;
            # ç¡®ä¿äºŒè¿›åˆ¶æ–‡ä»¶å¯æ‰§è¡Œ
            sudo find staging_dir/host/bin -type f -exec chmod +x {} \; 2>/dev/null || true
            sudo find staging_dir/toolchain-*/bin -type f -exec chmod +x {} \; 2>/dev/null || true
            sudo find staging_dir/toolchain-*/libexec -type f -exec chmod +x {} \; 2>/dev/null || true
            
            # å¤åˆ¶åˆ°ç¼“å­˜
            sudo cp -r staging_dir/toolchain-* /workdir/toolchain_cache/ || true
            sudo cp -r staging_dir/host /workdir/toolchain_cache/ || true
            
            echo "å·¥å…·é“¾ç¼“å­˜å¤§å°:"
            du -sh /workdir/toolchain_cache
            echo "TOOLCHAIN_CACHED=true" >> $GITHUB_ENV
          else
            echo "è­¦å‘Šï¼šå·¥å…·é“¾ç›®å½•ä¸å­˜åœ¨ï¼Œç¼“å­˜å¤±è´¥"
            echo "TOOLCHAIN_CACHED=false" >> $GITHUB_ENV
          fi
        }
        
        # ä¼˜åŒ–çš„ç¼–è¯‘å‡½æ•° - ä½¿ç”¨ä¸åŒçš„å‘½ä»¤å¤„ç†å¢é‡å’Œå…¨é‡ç¼–è¯‘
        compile_firmware() {
          # é¦–å…ˆæ£€æŸ¥å·¥å…·é“¾æ–‡ä»¶æƒé™
          if [ -f "staging_dir/host/bin/mkhash" ] && [ ! -x "staging_dir/host/bin/mkhash" ]; then
            echo "ä¿®å¤mkhashå’Œå…¶ä»–å·¥å…·é“¾æ–‡ä»¶æƒé™..."
            find staging_dir/host/bin -type f -exec chmod +x {} \; 2>/dev/null || true
            find staging_dir/toolchain-*/bin -type f -exec chmod +x {} \; 2>/dev/null || true
            find staging_dir/toolchain-*/libexec -type f -exec chmod +x {} \; 2>/dev/null || true
          fi
          
          # åªåœ¨å…¨é‡ç¼–è¯‘æˆ–å·¥å…·é“¾ä¸å­˜åœ¨æ—¶æ„å»ºå·¥å…·é“¾
          if [ $DO_FULL_BUILD -eq 1 ] || [ ! -d "staging_dir/toolchain-"* ]; then
            echo "ç¼–è¯‘å·¥å…·é“¾..."
            make -j$(nproc) tools/compile || make -j1 V=s tools/compile
            
            if [ $? -ne 0 ]; then
              echo "å·¥å…·ç¼–è¯‘å¤±è´¥"
              return 1
            fi
            
            cleanup_temp_files
            
            echo "ç¼–è¯‘å·¥å…·é“¾åº“..."
            make -j$(nproc) toolchain/compile || make -j1 V=s toolchain/compile
            
            if [ $? -ne 0 ]; then
              echo "å·¥å…·é“¾ç¼–è¯‘å¤±è´¥"
              return 1
            fi
            
            # åœ¨å·¥å…·é“¾ç¼–è¯‘åç«‹å³ä¿å­˜
            save_toolchain
            
            cleanup_temp_files
          else
            echo "ä½¿ç”¨ç°æœ‰å·¥å…·é“¾ï¼Œè·³è¿‡å·¥å…·é“¾ç¼–è¯‘é˜¶æ®µ..."
          fi
          
          if [ $DO_FULL_BUILD -eq 1 ]; then
            echo "æ‰§è¡Œå…¨é‡ç¼–è¯‘ä¸»å›ºä»¶..."
            make -j$(nproc) || make -j1 V=s
          else
            echo "æ‰§è¡Œä¼˜åŒ–çš„å¢é‡ç¼–è¯‘..."
            # ä½¿ç”¨ç‰¹æ®Šå‘½ä»¤è¿›è¡Œå¢é‡ç¼–è¯‘ï¼Œé¿å…é‡å»ºä¸éœ€è¦æ›´æ–°çš„åŒ…
            # IGNORE_ERRORS=1å…è®¸ç»§ç»­æ„å»ºå³ä½¿æŸäº›åŒ…å¤±è´¥
            # FORCE_UNSAFE_CONFIGURE=1è§£å†³æŸäº›åŒ…çš„é…ç½®æ£€æŸ¥é—®é¢˜
            
            if [ $CODE_UPDATED -eq 1 ]; then
              echo "æ›´æ–°å—æºç å˜æ›´å½±å“çš„è½¯ä»¶åŒ…..."
              make package/compile IGNORE_ERRORS=1 FORCE_UNSAFE_CONFIGURE=1 -j$(nproc) || true
              make package/index
            fi
            
            # å¿«é€Ÿæ„å»ºå›ºä»¶ï¼Œè·³è¿‡åŒ…ç¼–è¯‘
            echo "ç”Ÿæˆæœ€ç»ˆå›ºä»¶..."
            make target/install -j$(nproc) IGNORE_ERRORS=1 || make target/install V=s
            make package/index
            make json_overview_image_info
            make checksum
          fi
          
          if [ -d "bin/targets" ]; then
            echo "ç¼–è¯‘æˆåŠŸ"
            # ä¿å­˜ç¼–è¯‘åçš„åŒ…åˆ°ç¼“å­˜ç›®å½• - ä¿®å¤æƒé™é—®é¢˜
            sudo mkdir -p /workdir/package_cache
            sudo chmod -R 755 /workdir/package_cache
            
            if [ -d "bin/packages" ]; then
              echo "å¤‡ä»½ç¼–è¯‘åŒ…åˆ°ç¼“å­˜..."
              
              # ä¿®å¤æ–‡ä»¶æƒé™
              sudo find bin/packages -type d -exec chmod 755 {} \;
              sudo find bin/packages -type f -exec chmod 644 {} \;
              
              sudo mkdir -p /workdir/package_cache/bin
              sudo cp -r bin/packages /workdir/package_cache/bin/ || true
            fi
            
            if [ -d "bin/targets" ]; then
              # ä¿®å¤æ–‡ä»¶æƒé™
              sudo find bin/targets -type d -exec chmod 755 {} \;
              sudo find bin/targets -type f -exec chmod 644 {} \;
              
              sudo mkdir -p /workdir/package_cache/bin
              sudo cp -r bin/targets /workdir/package_cache/bin/ || true
            fi
            
            # ä¿å­˜å½“å‰åŒ…é…ç½®
            cp /workdir/build_state/current_packages.txt /workdir/build_state/previous_packages.txt
            # ä¿å­˜é…ç½®æ–‡ä»¶ï¼Œä¿ç•™æ³¨é‡Šå’Œæ’åº
            cp .config /workdir/build_state/config.txt
            # ä¿å­˜æ’é™¤æ³¨é‡Šåçš„é…ç½®MD5ï¼Œä¸æ£€æŸ¥æ—¶ä¸€è‡´
            grep -v "^#" .config | sort | md5sum | awk '{print $1}' > /workdir/build_state/config.md5
            # ä¿å­˜æºä»£ç ç‰ˆæœ¬ä¿¡æ¯
            if [ -f "/workdir/build_state/current_git_commit" ]; then
              cp /workdir/build_state/current_git_commit /workdir/build_state/previous_git_commit
            fi
            if [ -f "/workdir/build_state/current_git_info" ]; then
              cp /workdir/build_state/current_git_info /workdir/build_state/previous_git_info
            fi
            return 0
          else
            echo "ç¼–è¯‘å¤±è´¥"
            return 1
          fi
        }
        
        # å†³å®šæ˜¯å¦è¿›è¡Œå…¨é‡ç¼–è¯‘ - æ™ºèƒ½å†³ç­–é€»è¾‘
        DO_FULL_BUILD=0
        CODE_UPDATED=0
        
        if [ "${{ github.event.inputs.clean_build }}" = "true" ]; then
          echo "ç”¨æˆ·è¯·æ±‚å®Œå…¨é‡æ–°ç¼–è¯‘"
          DO_FULL_BUILD=1
        elif [ ! -f "/workdir/build_state/previous_packages.txt" ]; then
          echo "é¦–æ¬¡ç¼–è¯‘ï¼Œéœ€è¦å…¨é‡æ„å»º"
          DO_FULL_BUILD=1
        elif [ ! -f "/workdir/build_state/config.md5" ]; then
          echo "æœªæ‰¾åˆ°ä¹‹å‰çš„é…ç½®MD5ï¼Œéœ€è¦å…¨é‡æ„å»º"
          DO_FULL_BUILD=1
        elif [ ! -d "/workdir/openwrt/build_dir" ] || [ ! "$(ls -A /workdir/openwrt/build_dir 2>/dev/null)" ]; then
          echo "æ„å»ºç›®å½•ä¸å­˜åœ¨æˆ–ä¸ºç©ºï¼Œéœ€è¦å…¨é‡æ„å»º"
          DO_FULL_BUILD=1
        else
          # æ£€æŸ¥æºä»£ç æ›´æ–°
          if [ -f "/workdir/build_state/previous_git_commit" ] && [ -f "/workdir/build_state/current_git_commit" ]; then
            PREVIOUS_COMMIT=$(cat /workdir/build_state/previous_git_commit)
            CURRENT_COMMIT=$(cat /workdir/build_state/current_git_commit)
            echo "å½“å‰ä»£ç ç‰ˆæœ¬: $(cat /workdir/build_state/current_git_info)"
            if [ -f "/workdir/build_state/previous_git_info" ]; then
              echo "ä¸Šæ¬¡ä»£ç ç‰ˆæœ¬: $(cat /workdir/build_state/previous_git_info)"
            fi
            
            if [ "$PREVIOUS_COMMIT" != "$CURRENT_COMMIT" ]; then
              echo "æºä»£ç å·²æ›´æ–°ï¼Œä¼šå½±å“åˆ°è½¯ä»¶åŒ…çš„ç¼–è¯‘"
              CODE_UPDATED=1
            else
              echo "æºä»£ç æœªæ›´æ–°"
            fi
          else
            echo "æ— æ³•æ¯”è¾ƒä»£ç ç‰ˆæœ¬ï¼Œç»§ç»­æ£€æŸ¥é…ç½®å˜æ›´"
          fi
          
          # æ£€æŸ¥é…ç½®å˜åŒ–å¹¶è®°å½•è¯¦ç»†æ—¥å¿—
          CURRENT_CONFIG_CONTENT=$(grep -v "^#" .config | sort)
          CURRENT_MD5=$(echo "$CURRENT_CONFIG_CONTENT" | md5sum | awk '{print $1}')
          PREVIOUS_MD5=$(cat /workdir/build_state/config.md5)
          echo "å½“å‰é…ç½®MD5: $CURRENT_MD5"
          echo "ä¹‹å‰é…ç½®MD5: $PREVIOUS_MD5"
          
          # å‡†å¤‡é…ç½®æ–‡ä»¶ç”¨äºæ¯”è¾ƒ
          if [ ! -f "/workdir/build_state/config.txt" ] && [ -f "/workdir/build_state/config.txt.current" ]; then
            echo "ä½¿ç”¨å½“å‰ä¿å­˜çš„é…ç½®ä½œä¸ºæ¯”è¾ƒåŸºå‡†"
            cp /workdir/build_state/config.txt.current /workdir/build_state/config.txt
          fi
          
          if [ "$CURRENT_MD5" != "$PREVIOUS_MD5" ]; then
            echo "é…ç½®å·²æ›´æ”¹ï¼Œåˆ†æå˜æ›´..."
            if [ -f "/workdir/build_state/config.txt" ]; then
              # æ£€æŸ¥æ·»åŠ çš„è½¯ä»¶åŒ…æ•°é‡
              ADDED_PACKAGES=$(diff -u <(grep -v "^#" /workdir/build_state/config.txt | sort) <(grep -v "^#" .config | sort) | grep "^+CONFIG_PACKAGE_" | wc -l)
              # æ£€æŸ¥ç§»é™¤çš„è½¯ä»¶åŒ…æ•°é‡
              REMOVED_PACKAGES=$(diff -u <(grep -v "^#" /workdir/build_state/config.txt | sort) <(grep -v "^#" .config | sort) | grep "^-CONFIG_PACKAGE_" | wc -l)
              # æ£€æŸ¥å…¶ä»–é…ç½®å˜æ›´(éè½¯ä»¶åŒ…)
              OTHER_CONFIG_CHANGES=$(diff -u <(grep -v "^#" /workdir/build_state/config.txt | grep -v "CONFIG_PACKAGE_" | sort) <(grep -v "^#" .config | grep -v "CONFIG_PACKAGE_" | sort) | grep "^[+-]" | wc -l)
              
              # æ˜¾ç¤ºå˜æ›´è¯¦æƒ…
              echo "æ·»åŠ çš„è½¯ä»¶åŒ…: $ADDED_PACKAGES"
              echo "ç§»é™¤çš„è½¯ä»¶åŒ…: $REMOVED_PACKAGES"
              echo "å…¶ä»–é…ç½®å˜æ›´: $OTHER_CONFIG_CHANGES"
              
              # åˆ—å‡ºæ·»åŠ å’Œç§»é™¤çš„åŒ…è¯¦æƒ…
              echo "æ·»åŠ çš„è½¯ä»¶åŒ…:"
              diff -u <(grep -v "^#" /workdir/build_state/config.txt | sort) <(grep -v "^#" .config | sort) | grep "^+CONFIG_PACKAGE_" || echo "æ— "
              echo "ç§»é™¤çš„è½¯ä»¶åŒ…:"
              diff -u <(grep -v "^#" /workdir/build_state/config.txt | sort) <(grep -v "^#" .config | sort) | grep "^-CONFIG_PACKAGE_" || echo "æ— "
              
              # åˆ¤æ–­æ˜¯å¦å¯ä»¥è¿›è¡Œå¢é‡æ„å»º
              if [ $OTHER_CONFIG_CHANGES -eq 0 ] && [ $((ADDED_PACKAGES + REMOVED_PACKAGES)) -lt 10 ]; then
                echo "åªæœ‰å°‘é‡è½¯ä»¶åŒ…å˜æ›´ï¼Œæ‰§è¡Œå¢é‡æ„å»º..."
                DO_FULL_BUILD=0
              else
                echo "é…ç½®å˜æ›´è¾ƒå¤§ï¼Œéœ€è¦å…¨é‡æ„å»º"
                DO_FULL_BUILD=1
              fi
            else
              echo "ä¹‹å‰çš„é…ç½®æ–‡ä»¶ä¸å­˜åœ¨ï¼Œæ— æ³•åˆ†æå·®å¼‚ï¼Œæ‰§è¡Œå…¨é‡æ„å»º"
              DO_FULL_BUILD=1
            fi
          else
            echo "é…ç½®æœªæ›´æ”¹"
            if [ $CODE_UPDATED -eq 1 ]; then
              echo "æºä»£ç å·²æ›´æ–°ï¼Œæ‰§è¡Œä¼˜åŒ–çš„å¢é‡æ„å»ºä»¥æ›´æ–°è½¯ä»¶åŒ…..."
              DO_FULL_BUILD=0
            else
              echo "é…ç½®å’Œæºä»£ç éƒ½æœªå˜æ›´ï¼Œæ‰§è¡Œå¿«é€Ÿå¢é‡æ„å»º"
              DO_FULL_BUILD=0
            fi
          fi
        fi
        
        # æ£€æŸ¥å·¥å…·é“¾æ˜¯å¦å¯ç”¨ï¼Œå¦‚æœä¸å¯ç”¨åˆ™å¼ºåˆ¶å…¨é‡ç¼–è¯‘
        if [ ! -d "staging_dir/toolchain-"* ]; then
          echo "å·¥å…·é“¾ä¸å­˜åœ¨ï¼Œéœ€è¦é‡æ–°ç¼–è¯‘"
          DO_FULL_BUILD=1
        else
          echo "æ£€æµ‹åˆ°ç°æœ‰å·¥å…·é“¾ï¼Œæ£€æŸ¥æ˜¯å¦å®Œæ•´..."
          if [ ! -f "staging_dir/host/bin/mkhash" ]; then
            echo "å…³é”®å·¥å…·é“¾æ–‡ä»¶ç¼ºå¤±ï¼Œéœ€è¦é‡æ–°ç¼–è¯‘"
            DO_FULL_BUILD=1
          else
            # æ£€æŸ¥å¯æ‰§è¡Œæƒé™
            if [ ! -x "staging_dir/host/bin/mkhash" ]; then
              echo "mkhashæ²¡æœ‰æ‰§è¡Œæƒé™ï¼Œä¿®å¤æƒé™..."
              chmod +x staging_dir/host/bin/mkhash
            fi
            ls -la staging_dir/toolchain-*
          fi
        fi
        
        # å¦‚æœé…ç½®æœ‰å˜åŒ–ä¸”æºä»£ç æ›´æ–°ï¼Œå¼ºåˆ¶ç¼–è¯‘æ–°å¢çš„åŒ…
        if [ "$CURRENT_MD5" != "$PREVIOUS_MD5" ] && [ -f "/workdir/build_state/config.txt" ]; then
          echo "ç¡®ä¿å˜åŒ–çš„è½¯ä»¶åŒ…è¢«ç¼–è¯‘..."
          
          # åˆ—å‡ºæ·»åŠ çš„åŒ…ï¼Œç¡®ä¿å®ƒä»¬è¢«ç¼–è¯‘
          ADDED_PACKAGES=$(diff -u <(grep -v "^#" /workdir/build_state/config.txt | sort) <(grep -v "^#" .config | sort) | grep "^+CONFIG_PACKAGE_" | sed 's/+CONFIG_PACKAGE_//g' | sed 's/=y//g')
          if [ -n "$ADDED_PACKAGES" ]; then
            echo "ç¡®ä¿æ–°æ·»åŠ çš„åŒ…è¢«ç¼–è¯‘:"
            echo "$ADDED_PACKAGES" | while read pkg; do
              if [ -n "$pkg" ]; then
                echo "å¼ºåˆ¶é‡æ–°ç¼–è¯‘: $pkg"
                make package/$pkg/compile -j$(nproc) V=s || true
              fi
            done
          fi
        fi
        
        # æ‰§è¡Œç¼–è¯‘
        compile_firmware
        
        # æ£€æŸ¥ç¼–è¯‘ç»“æœ
        if [ -d "bin/targets" ]; then
          echo "ç¼–è¯‘æˆåŠŸï¼Œå¤‡ä»½ç¼–è¯‘ç¼“å­˜..."
          
          # ä¿å­˜å·¥å…·é“¾åˆ°ç¼“å­˜
          if [ -d "staging_dir/toolchain-"* ]; then
            echo "ä¿å­˜å·¥å…·é“¾åˆ°ç¼“å­˜..."
            mkdir -p /workdir/toolchain_cache
            cp -r staging_dir/toolchain-* /workdir/toolchain_cache/ || true
            cp -r staging_dir/host /workdir/toolchain_cache/ || true
          fi
          
          # ä¿å­˜ç¼–è¯‘åŒ…åˆ°ç¼“å­˜
          if [ -d "bin/packages" ]; then
            echo "ä¿å­˜ç¼–è¯‘åŒ…åˆ°ç¼“å­˜..."
            mkdir -p /workdir/package_cache/bin
            cp -r bin/packages /workdir/package_cache/bin/ || true
          fi
          
          if [ -d "bin/targets" ]; then
            mkdir -p /workdir/package_cache/bin
            cp -r bin/targets /workdir/package_cache/bin/ || true
          fi
          
          # ä¿å­˜å½“å‰åŒ…é…ç½®
          cp /workdir/build_state/current_packages.txt /workdir/build_state/previous_packages.txt
          # ä¿å­˜é…ç½®æ–‡ä»¶
          cp .config /workdir/build_state/config.txt
          # ä¿å­˜é…ç½®MD5
          grep -v "^#" .config | sort | md5sum | awk '{print $1}' > /workdir/build_state/config.md5
          # ä¿å­˜æºä»£ç ç‰ˆæœ¬ä¿¡æ¯
          if [ -f "/workdir/build_state/current_git_commit" ]; then
            cp /workdir/build_state/current_git_commit /workdir/build_state/previous_git_commit
          fi
          if [ -f "/workdir/build_state/current_git_info" ]; then
            cp /workdir/build_state/current_git_info /workdir/build_state/previous_git_info
          fi
          
          echo "å›ºä»¶ç¼–è¯‘å®Œæˆ"
          echo "DEVICE_NAME=_$(grep '^CONFIG_TARGET.*DEVICE.*=y' .config | sed -r 's/.*DEVICE_(.*)=y/\1/' | tr '\n' '_')" >> $GITHUB_ENV
          echo "FILE_DATE=_$(date +"%Y%m%d%H%M")" >> $GITHUB_ENV
          echo "status=success" >> $GITHUB_OUTPUT
        else
          echo "å›ºä»¶ç¼–è¯‘å¤±è´¥"
          echo "status=failed" >> $GITHUB_OUTPUT
        fi
        
        # æ˜¾ç¤ºCCACHEç»Ÿè®¡ä¿¡æ¯
        ccache -s
        
        # æ˜¾ç¤ºç£ç›˜ä½¿ç”¨æƒ…å†µ
        df -h

    # æ•´ç†æ–‡ä»¶
    - name: æ•´ç†æ–‡ä»¶
      id: organize
      if: steps.compile.outputs.status == 'success' && env.UPLOAD_FIRMWARE == 'true' && !cancelled()
      run: |
        # é¦–å…ˆéªŒè¯ç›®å½•å­˜åœ¨
        if [ ! -d "/workdir/openwrt/bin/targets" ]; then
          echo "é”™è¯¯ï¼šå›ºä»¶ç›®å½•ä¸å­˜åœ¨"
          exit 1
        fi
        
        cd /workdir/openwrt/bin/targets/*/*
        rm -rf packages || true
        mkdir -p firmware
        
        # æŸ¥æ‰¾å›ºä»¶æ–‡ä»¶
        FIRMWARE_FILES=$(find . -maxdepth 1 -name "*combined*" -or -name "*sysupgrade*")
        if [ -z "$FIRMWARE_FILES" ]; then
          echo "è­¦å‘Šï¼šæœªæ‰¾åˆ°å›ºä»¶æ–‡ä»¶ï¼Œä½¿ç”¨æ‰€æœ‰binæ–‡ä»¶"
          FIRMWARE_FILES=$(find . -maxdepth 1 -name "*.bin")
        fi
        
        # å¤åˆ¶æ‰¾åˆ°çš„æ–‡ä»¶
        if [ -n "$FIRMWARE_FILES" ]; then
          echo "$FIRMWARE_FILES" | xargs -i cp {} ./firmware/
        else
          echo "é”™è¯¯ï¼šæœªæ‰¾åˆ°ä»»ä½•å›ºä»¶æ–‡ä»¶"
          # å¤åˆ¶æ‰€æœ‰æ–‡ä»¶ä½œä¸ºå¤‡é€‰
          cp -r * ./firmware/
        fi
        
        # å¤åˆ¶é…ç½®æ–‡ä»¶
        cp /workdir/openwrt/.config ./firmware/config.txt
        
        # åˆ›å»ºzipæ–‡ä»¶
        zip -r firmware.zip firmware
        echo "FIRMWARE=$PWD/firmware" >> $GITHUB_ENV
        echo "FIRMWARE_ZIP=$PWD/firmware.zip" >> $GITHUB_ENV
        echo "status=success" >> $GITHUB_OUTPUT

    # ä¸Šä¼ å›ºä»¶ç›®å½•
    - name: ä¸Šä¼ å›ºä»¶ç›®å½•
      uses: actions/upload-artifact@main
      if: steps.organize.outputs.status == 'success' && !cancelled()
      with:
        name: OpenWrt_firmware${{ env.DEVICE_NAME }}${{ env.FILE_DATE }}
        path: ${{ env.FIRMWARE }}

    # ç”Ÿæˆå‘å¸ƒæ ‡ç­¾
    - name: ç”Ÿæˆå‘å¸ƒæ ‡ç­¾
      id: tag
      if: steps.organize.outputs.status == 'success' && env.UPLOAD_RELEASE == 'true' && !cancelled()
      run: |
        echo "release_tag=$(date +"%Y.%m.%d-%H%M")" >> $GITHUB_OUTPUT
        echo "## OpenWrtå›ºä»¶æ„å»ºå®Œæˆ ğŸ“¦" > release.txt
        echo "ğŸ“… æ„å»ºæ—¶é—´: $(date +"%Y-%m-%d %H:%M")" >> release.txt
        echo "ğŸ“‚ å›ºä»¶ä¸‹è½½" >> release.txt
        echo "âš ï¸ è¯·åœ¨åˆ·æœºå‰å…ˆåšå¥½å¤‡ä»½ï¼" >> release.txt
        echo "status=success" >> $GITHUB_OUTPUT

    # ä¸Šä¼ å›ºä»¶åˆ°Releases
    - name: ä¸Šä¼ å›ºä»¶åˆ°Releases
      uses: softprops/action-gh-release@v2
      if: steps.tag.outputs.status == 'success' && !cancelled()
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ steps.tag.outputs.release_tag }}
        body_path: release.txt
        files: ${{ env.FIRMWARE }}/*

    # åˆ é™¤æ—§çš„Releases
    - name: åˆ é™¤æ—§çš„Releases
      uses: dev-drprasad/delete-older-releases@master
      if: env.UPLOAD_RELEASE == 'true' && !cancelled()
      with:
        keep_latest: 3
        delete_tags: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
