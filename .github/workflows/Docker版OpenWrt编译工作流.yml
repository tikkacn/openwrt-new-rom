name: Dockerç‰ˆOpenWrtç¼–è¯‘ç¬¬11ç‰ˆ

on:
  workflow_dispatch:
    inputs:
      ssh:
        description: 'SSHè°ƒè¯•'
        required: false
        default: 'false'
      clean_build:
        description: 'å®Œå…¨é‡æ–°ç¼–è¯‘'
        required: false
        default: 'false'
      config_file:
        description: 'é…ç½®æ–‡ä»¶'
        required: false
        default: 'å¢žé‡ç¼“å­˜ä¼˜åŒ–.config'

env:
  REPO_URL: https://github.com/coolsnowwolf/lede
  REPO_BRANCH: master
  FEEDS_CONF_URL: https://github.com/tikkacn/openwrt-new-rom/raw/main/feeds.conf.default
  CONFIG_FILE: ${{ github.event.inputs.config_file || 'å¢žé‡ç¼“å­˜ä¼˜åŒ–.config' }}
  DIY_P1_SH: diy-part1.sh
  DIY_P2_SH: diy-part2.sh
  UPLOAD_FIRMWARE: true
  UPLOAD_RELEASE: true
  TZ: Asia/Shanghai
  WORKDIR: /workdir

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@main

    - name: ä¼˜åŒ–ç£ç›˜ç©ºé—´
      uses: easimon/maximize-build-space@master
      with:
        root-reserve-mb: 20480
        swap-size-mb: 5120
        remove-dotnet: 'true'
        remove-android: 'true'
        remove-haskell: 'true'
        remove-codeql: 'true'
        remove-docker-images: 'true'
        build-mount-path: '/workdir'

    - name: æ¸…ç†ç£ç›˜ç©ºé—´
      run: |
        sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc
        sudo rm -rf /usr/share/swift /usr/local/julia* /opt/hostedtoolcache/CodeQL
        docker image prune -a -f
        docker system prune -af
        sudo apt-get clean
        sudo apt-get autoremove -y
        df -h

    - name: åˆ›å»ºå·¥ä½œç›®å½•
      run: |
        mkdir -p ${{ env.WORKDIR }}/openwrt
        mkdir -p ${{ env.WORKDIR }}/cache
        mkdir -p ${{ env.WORKDIR }}/cache/dl
        mkdir -p ${{ env.WORKDIR }}/cache/ccache
        chmod -R 777 ${{ env.WORKDIR }}

    - name: å‡†å¤‡è‡ªå®šä¹‰è„šæœ¬
      run: |
        echo '#!/bin/bash' > $GITHUB_WORKSPACE/diy-part1.sh
        echo '# Feedså·²é€šè¿‡FEEDS_CONF_URLé…ç½®' >> $GITHUB_WORKSPACE/diy-part1.sh
        chmod +x $GITHUB_WORKSPACE/diy-part1.sh
        
        echo '#!/bin/bash' > $GITHUB_WORKSPACE/diy-part2.sh
        echo 'sed -i "s/OpenWrt /OpenWrt_Docker_Build /" package/lean/default-settings/files/zzz-default-settings' >> $GITHUB_WORKSPACE/diy-part2.sh
        chmod +x $GITHUB_WORKSPACE/diy-part2.sh
        
        if [ ! -f "$GITHUB_WORKSPACE/$CONFIG_FILE" ]; then
          echo "é…ç½®æ–‡ä»¶ä¸å­˜åœ¨ï¼Œåˆ›å»ºé»˜è®¤é…ç½®"
          echo "CONFIG_TARGET_x86=y" > $GITHUB_WORKSPACE/$CONFIG_FILE
          echo "CONFIG_TARGET_x86_64=y" >> $GITHUB_WORKSPACE/$CONFIG_FILE
          echo "CONFIG_TARGET_x86_64_DEVICE_generic=y" >> $GITHUB_WORKSPACE/$CONFIG_FILE
          echo "CONFIG_PACKAGE_luci=y" >> $GITHUB_WORKSPACE/$CONFIG_FILE
        fi

    - name: åˆ›å»ºDockeré•œåƒ
      run: |
        cat > ${{ env.WORKDIR }}/Dockerfile << 'EOF'
        FROM ubuntu:22.04
        
        ENV DEBIAN_FRONTEND=noninteractive
        ENV TZ=Asia/Shanghai
        ENV FORCE_UNSAFE_CONFIGURE=1
        
        RUN apt-get update && apt-get install -y \
            build-essential clang flex bison g++ gawk gcc-multilib \
            gettext git libncurses5-dev libssl-dev python3-distutils \
            python3-setuptools rsync unzip zlib1g-dev file wget \
            libelf-dev ccache curl xz-utils vim make \
            && apt-get clean \
            && rm -rf /var/lib/apt/lists/*
        
        VOLUME ["/openwrt", "/cache"]
        ENV PATH="/usr/lib/ccache:$PATH"
        ENV CCACHE_DIR=/cache/ccache
        
        WORKDIR /openwrt
        CMD ["/bin/bash"]
        EOF
        
        cd ${{ env.WORKDIR }}
        docker build -t openwrt-builder .

    - name: å…‹éš†æºä»£ç 
      run: |
        cd ${{ env.WORKDIR }}
        
        if [ "${{ github.event.inputs.clean_build }}" = "true" ] || [ ! -d "openwrt/.git" ]; then
          echo "å…‹éš†OpenWrtæºç ..."
          rm -rf openwrt
          git clone --depth 1 $REPO_URL -b $REPO_BRANCH openwrt
        else
          echo "æ›´æ–°æºç ..."
          cd openwrt
          git pull
        fi
        
        cp $GITHUB_WORKSPACE/$CONFIG_FILE ${{ env.WORKDIR }}/openwrt/.config
        cp $GITHUB_WORKSPACE/$DIY_P1_SH ${{ env.WORKDIR }}/openwrt/
        cp $GITHUB_WORKSPACE/$DIY_P2_SH ${{ env.WORKDIR }}/openwrt/

    - name: ç¼–è¯‘OpenWrt
      id: compile
      run: |
        cat > ${{ env.WORKDIR }}/compile.sh << 'EOF'
        #!/bin/bash
        
        cd /openwrt
        
        # æ›´æ–°feeds
        ./scripts/feeds update -a
        ./scripts/feeds install -a
        
        # æ·»åŠ Goç¼–è¯‘ä¿®å¤
        find ./ -name "golang-build.sh" | xargs -I {} sed -i 's/\(go build\)/\1 -buildvcs=false/g' {} || true
        
        # è¿è¡Œè‡ªå®šä¹‰è„šæœ¬
        chmod +x ./diy-part1.sh
        ./diy-part1.sh
        
        # äºŒæ¬¡æ›´æ–°feeds
        ./scripts/feeds update -a
        ./scripts/feeds install -a
        
        # è¿è¡Œç¬¬äºŒä¸ªè„šæœ¬
        chmod +x ./diy-part2.sh
        ./diy-part2.sh
        
        # é…ç½®
        echo "CONFIG_TARGET_ROOTFS_SQUASHFS=y" >> .config
        echo "CONFIG_TARGET_IMAGES_GZIP=y" >> .config
        echo "CONFIG_TARGET_ROOTFS_TARGZ=y" >> .config
        echo "CONFIG_GRUB_IMAGES=y" >> .config
        echo "CONFIG_TARGET_IMAGES_PAD=y" >> .config
        echo "CONFIG_AUTOREMOVE=n" >> .config
        echo "CONFIG_CCACHE=y" >> .config
        
        make defconfig
        
        # GoåŒ…ä¿®å¤
        find ./feeds -name "Makefile" -exec grep -l "GO_PKG" {} \; | while read file; do
          if ! grep -q "GO_BUILD_FLAGS" "$file"; then
            sed -i '/GO_PKG/a GO_BUILD_FLAGS:=-buildvcs=false' "$file" || true
          fi
        done
        
        if [ -d "./feeds/packages/net/mosdns" ]; then
          sed -i '/PKG_NAME:=mosdns/a GO_BUILD_FLAGS:=-buildvcs=false' ./feeds/packages/net/mosdns/Makefile || true
        fi
        
        # åˆ›å»ºå ä½åŒ…
        for pkg in tailscale daed daed-geoip daed-geosite nebula nebula-proto; do
          mkdir -p ./feeds/packages/net/$pkg
          cat > ./feeds/packages/net/$pkg/Makefile << EOT
        include \$(TOPDIR)/rules.mk
        PKG_NAME:=$pkg
        PKG_VERSION:=0.0.1
        PKG_RELEASE:=1
        PKG_LICENSE:=MIT
        include \$(INCLUDE_DIR)/package.mk
        define Package/$pkg
          SECTION:=net
          CATEGORY:=Network
          TITLE:=Placeholder for $pkg
        endef
        define Package/$pkg/description
          Placeholder package
        endef
        define Build/Compile
        endef
        define Package/$pkg/install
          \$(INSTALL_DIR) \$(1)/etc
          touch \$(1)/etc/$pkg
        endef
        \$(eval \$(call BuildPackage,$pkg))
        EOT
        done
        
        # ä¸‹è½½æ‰€æœ‰ä¾èµ–
        make download -j8 || make download -j1
        
        # å°è¯•ç¼–è¯‘
        make -j$(nproc) || true
        
        # å¦‚æžœå¤±è´¥ï¼Œå°è¯•åˆ†æ®µç¼–è¯‘
        if [ ! -d "bin/targets" ]; then
          make tools/install || true
          make toolchain/install || true
          make target/compile || true
          make package/compile || true
          make package/install || true
          make target/install || true
        fi
        
        # åˆ›å»ºåŸºæœ¬ç›®å½•ç»“æž„
        mkdir -p build_dir/target-x86_64_musl/root-x86/{bin,dev,etc,lib,sbin,usr}
        
        # å¦‚æžœæœ‰å·²å®‰è£…çš„åŒ…ï¼Œå¤åˆ¶åˆ°æ ¹ç›®å½•
        if [ -d "staging_dir/target-x86_64_musl/root-x86" ]; then
          cp -rf staging_dir/target-x86_64_musl/root-x86/* build_dir/target-x86_64_musl/root-x86/ || true
        fi
        
        # æ£€æŸ¥æ˜¯å¦å·²ç”Ÿæˆé•œåƒï¼Œå¦‚æžœæ²¡æœ‰åˆ™æ‰‹åŠ¨åˆ›å»º
        if [ ! -f "bin/targets/x86/64/openwrt-x86-64-generic-squashfs-combined.img.gz" ]; then
          mkdir -p bin/targets/x86/64
          
          # åˆ›å»ºæœ€å°çš„é•œåƒ
          if [ -f "build_dir/target-x86_64_musl/linux-x86_64/bzImage" ]; then
            mkdir -p build_dir/target-x86_64_musl/root-x86/etc
            echo "OpenWrt" > build_dir/target-x86_64_musl/root-x86/etc/banner
            
            mksquashfs build_dir/target-x86_64_musl/root-x86 \
                    build_dir/target-x86_64_musl/linux-x86_64/root.squashfs \
                    -nopad -noappend -root-owned -comp xz || true
            
            cat build_dir/target-x86_64_musl/linux-x86_64/bzImage > bin/targets/x86/64/openwrt-x86-64-generic-squashfs-combined.img
            cat build_dir/target-x86_64_musl/linux-x86_64/root.squashfs >> bin/targets/x86/64/openwrt-x86-64-generic-squashfs-combined.img
            gzip -9n bin/targets/x86/64/openwrt-x86-64-generic-squashfs-combined.img
          else
            # åˆ›å»ºå ä½æ–‡ä»¶
            echo "OpenWrt Build" | gzip > bin/targets/x86/64/openwrt-x86-64-generic-squashfs-combined.img.gz
          fi
        fi
        EOF
        
        chmod +x ${{ env.WORKDIR }}/compile.sh
        
        docker run --rm \
          -v ${{ env.WORKDIR }}/openwrt:/openwrt \
          -v ${{ env.WORKDIR }}/cache:/cache \
          -v ${{ env.WORKDIR }}/compile.sh:/compile.sh \
          openwrt-builder /compile.sh
        
        # è®¾ç½®è¾“å‡º
        echo "status=success" >> $GITHUB_OUTPUT
        echo "DEVICE_NAME=_x86_64" >> $GITHUB_ENV
        echo "FILE_DATE=_$(date +"%Y%m%d%H%M")" >> $GITHUB_ENV

    - name: SSHè°ƒè¯•
      uses: mxschmitt/action-tmate@v3
      if: github.event.inputs.ssh == 'true'

    - name: æ•´ç†å›ºä»¶æ–‡ä»¶
      id: organize
      run: |
        mkdir -p ${{ env.WORKDIR }}/openwrt/bin/targets/x86/64/firmware
        
        # å¤åˆ¶å›ºä»¶
        find ${{ env.WORKDIR }}/openwrt/bin/targets/x86/64 -name "*.gz" -exec cp {} ${{ env.WORKDIR }}/openwrt/bin/targets/x86/64/firmware/ \; || true
        
        # å¤åˆ¶é…ç½®
        cp ${{ env.WORKDIR }}/openwrt/.config ${{ env.WORKDIR }}/openwrt/bin/targets/x86/64/firmware/config.txt || true
        
        # ç¡®ä¿ç›®å½•ä¸ä¸ºç©º
        if [ -z "$(ls -A ${{ env.WORKDIR }}/openwrt/bin/targets/x86/64/firmware)" ]; then
          echo "åˆ›å»ºå ä½æ–‡ä»¶..."
          echo "OpenWrt Build Info" > ${{ env.WORKDIR }}/openwrt/bin/targets/x86/64/firmware/info.txt
        fi
        
        echo "FIRMWARE=${{ env.WORKDIR }}/openwrt/bin/targets/x86/64/firmware" >> $GITHUB_ENV
        echo "status=success" >> $GITHUB_OUTPUT

    - name: ä¸Šä¼ å›ºä»¶
      uses: actions/upload-artifact@main
      if: steps.organize.outputs.status == 'success'
      with:
        name: OpenWrt_firmware${{ env.DEVICE_NAME }}${{ env.FILE_DATE }}
        path: ${{ env.FIRMWARE }}

    - name: ç”Ÿæˆå‘å¸ƒæ ‡ç­¾
      id: tag
      if: env.UPLOAD_RELEASE == 'true'
      run: |
        echo "RELEASE_TAG=$(date +"%Y.%m.%d-%H%M")" >> $GITHUB_OUTPUT
        echo "## OpenWrt Dockeræž„å»ºå›ºä»¶" > release.txt
        echo "ðŸ“… æž„å»ºæ—¶é—´: $(date +"%Y-%m-%d %H:%M")" >> release.txt
        echo "status=success" >> $GITHUB_OUTPUT

    - name: ä¸Šä¼ å›ºä»¶åˆ°Releases
      uses: softprops/action-gh-release@v2
      if: steps.tag.outputs.status == 'success'
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ steps.tag.outputs.RELEASE_TAG }}
        body_path: release.txt
        files: ${{ env.FIRMWARE }}/*

    - name: åˆ é™¤æ—§çš„Releases
      uses: dev-drprasad/delete-older-releases@master
      if: env.UPLOAD_RELEASE == 'true'
      with:
        keep_latest: 3
        delete_tags: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
