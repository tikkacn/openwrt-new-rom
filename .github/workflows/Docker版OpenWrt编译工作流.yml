name: å…¨æ–°ç¼–è¯‘Dockerç¼“å­˜ä¼˜åŒ–ç¬¬11ç‰ˆ

on:
  workflow_dispatch:
    inputs:
      ssh:
        description: 'SSHè°ƒè¯•'
        required: false
        default: 'false'
      clean_build:
        description: 'å®Œå…¨é‡æ–°ç¼–è¯‘'
        required: false
        default: 'false'
      config_file:
        description: 'é…ç½®æ–‡ä»¶'
        required: false
        default: 'å¢žé‡ç¼“å­˜ä¼˜åŒ–.config'

env:
  REPO_URL: https://github.com/coolsnowwolf/lede
  REPO_BRANCH: master
  FEEDS_CONF_URL: https://github.com/tikkacn/openwrt-new-rom/raw/main/feeds.conf.default
  CONFIG_FILE: ${{ github.event.inputs.config_file || 'å¢žé‡ç¼“å­˜ä¼˜åŒ–.config' }}
  DIY_P1_SH: diy-part1.sh
  DIY_P2_SH: diy-part2.sh
  UPLOAD_FIRMWARE: true
  UPLOAD_RELEASE: true
  TZ: Asia/Shanghai
  # ç¼“å­˜ç›®å½•çŽ¯å¢ƒå˜é‡
  WORKDIR: /workdir
  CACHE_DIR: /workdir/cache
  CCACHE_DIR: /workdir/cache/ccache
  DL_DIR: /workdir/cache/dl
  BUILD_DIR: /workdir/cache/build_dir
  STAGING_DIR: /workdir/cache/staging_dir
  TOOLCHAIN_DIR: /workdir/cache/staging_dir
  BUILD_STATE_DIR: /workdir/cache/build_state
  # ä½¿ç”¨æ›´å¯é çš„Dockeré•œåƒ
  DOCKER_CONTAINER: mwarning/openwrt-builder:latest

jobs:
  build:
    runs-on: ubuntu-22.04
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@main

    - name: ä¼˜åŒ–ç£ç›˜ç©ºé—´
      uses: easimon/maximize-build-space@master
      with:
        root-reserve-mb: 20480
        swap-size-mb: 5120
        remove-dotnet: 'true'
        remove-android: 'true'
        remove-haskell: 'true'
        remove-codeql: 'true'
        remove-docker-images: 'true'
        build-mount-path: '/workdir'

    - name: é¢å¤–æ¸…ç†ç£ç›˜ç©ºé—´å¹¶æ£€æŸ¥
      run: |
        echo "æ¸…ç†é¢å¤–ç£ç›˜ç©ºé—´..."
        sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /usr/local/share/boost
        sudo rm -rf /usr/share/swift /usr/local/julia* /opt/hostedtoolcache/CodeQL
        docker image prune -a -f || true
        docker system prune -af || true
        sudo apt-get clean
        sudo apt-get autoremove -y
        ROOT_AVAIL=$(df -m /dev/root | tail -1 | awk '{print $4}')
        echo "æ ¹åˆ†åŒºå¯ç”¨ç©ºé—´: ${ROOT_AVAIL}MB"
        if [ "$ROOT_AVAIL" -lt 20480 ]; then
          echo "é”™è¯¯ï¼š/dev/root å¯ç”¨ç©ºé—´ä¸è¶³ 20GB"
          exit 1
        fi
        df -h

    - name: æ‹‰å–Dockeré•œåƒ
      run: |
        echo "æ‹‰å–Dockeræž„å»ºé•œåƒ..."
        # å…ˆå°è¯•æ‹‰å–é•œåƒï¼Œå¦‚æžœå¤±è´¥åˆ™å®‰è£…æœ¬åœ°ä¾èµ–
        if ! docker pull ${{ env.DOCKER_CONTAINER }}; then
          echo "Dockeré•œåƒæ‹‰å–å¤±è´¥ï¼Œåˆ›å»ºæœ¬åœ°æž„å»ºçŽ¯å¢ƒ..."
          # åˆ›å»ºä¸€ä¸ªç®€å•çš„Dockerfile
          cat > Dockerfile << 'EOF'
FROM debian:11

RUN apt-get update && apt-get install -y \
    build-essential \
    ccache \
    clang \
    cmake \
    curl \
    file \
    g++ \
    gawk \
    gcc \
    gettext \
    git \
    libelf-dev \
    libncurses5-dev \
    libssl-dev \
    make \
    msmtp \
    perl \
    python3 \
    python3-pip \
    rsync \
    unzip \
    wget \
    zlib1g-dev \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*

# æ·»åŠ ä¸€ä¸ªç”¨æˆ·ä»¥é¿å…æƒé™é—®é¢˜
RUN useradd -m builder -u 1000 \
    && echo "builder ALL=(ALL) NOPASSWD:ALL" > /etc/sudoers.d/builder \
    && chmod 0440 /etc/sudoers.d/builder

USER builder
WORKDIR /home/builder

ENV PATH="/usr/lib/ccache:${PATH}"
EOF
          docker build -t local/openwrt-builder:latest .
          # ä½¿ç”¨æœ¬åœ°æž„å»ºçš„é•œåƒ
          echo "DOCKER_CONTAINER=local/openwrt-builder:latest" >> $GITHUB_ENV
        fi
        
        # åˆ›å»ºç¼“å­˜ç›®å½•
        echo "åˆ›å»ºç¼“å­˜ç›®å½•ç»“æž„..."
        mkdir -p ${{ env.CACHE_DIR }}/{ccache,dl,build_dir,staging_dir,build_state}
        chmod -R 777 ${{ env.CACHE_DIR }}
        
        # åœ¨å·¥ä½œç›®å½•ä¸‹åˆ›å»ºopenwrtç›®å½•
        mkdir -p ${{ env.WORKDIR }}/openwrt
        chmod -R 777 ${{ env.WORKDIR }}/openwrt
        
        # æ˜¾ç¤ºç›®å½•ç»“æž„å’Œæƒé™
        ls -la ${{ env.WORKDIR }}
        ls -la ${{ env.CACHE_DIR }}

    # æ¢å¤dlç›®å½•ç¼“å­˜
    - name: æ¢å¤ä¸‹è½½ç¼“å­˜
      uses: actions/cache@v3
      id: cache-dl
      if: inputs.clean_build != 'true'
      with:
        path: ${{ env.DL_DIR }}
        key: dl-${{ env.REPO_BRANCH }}-${{ hashFiles('feeds.conf.default') }}
        restore-keys: |
          dl-${{ env.REPO_BRANCH }}-

    # æ¢å¤build_dirç¼“å­˜
    - name: æ¢å¤æž„å»ºç¼“å­˜
      uses: actions/cache@v3
      id: cache-build
      if: inputs.clean_build != 'true'
      with:
        path: ${{ env.BUILD_DIR }}
        key: build-${{ env.REPO_BRANCH }}-${{ hashFiles('**/*.config') }}
        restore-keys: |
          build-${{ env.REPO_BRANCH }}-

    # æ¢å¤staging_dirç¼“å­˜
    - name: æ¢å¤å·¥å…·é“¾ç¼“å­˜
      uses: actions/cache@v3
      id: cache-staging
      if: inputs.clean_build != 'true'
      with:
        path: ${{ env.STAGING_DIR }}
        key: staging-${{ env.REPO_BRANCH }}-${{ hashFiles('**/*.config') }}
        restore-keys: |
          staging-${{ env.REPO_BRANCH }}-

    # æ¢å¤CCACHEç¼“å­˜
    - name: æ¢å¤CCACHEç¼“å­˜
      uses: actions/cache@v3
      id: cache-ccache
      with:
        path: ${{ env.CCACHE_DIR }}
        key: ccache-${{ env.REPO_BRANCH }}-${{ hashFiles('**/*.config') }}
        restore-keys: |
          ccache-${{ env.REPO_BRANCH }}-

    # æ¢å¤æž„å»ºçŠ¶æ€ç¼“å­˜
    - name: æ¢å¤æž„å»ºçŠ¶æ€ç¼“å­˜
      uses: actions/cache@v3
      id: cache-state
      if: inputs.clean_build != 'true'
      with:
        path: ${{ env.BUILD_STATE_DIR }}
        key: state-${{ env.REPO_BRANCH }}-${{ hashFiles('**/*.config') }}
        restore-keys: |
          state-${{ env.REPO_BRANCH }}-

    - name: æ£€æŸ¥ç¼“å­˜æ¢å¤çŠ¶æ€
      run: |
        echo "CONFIG_FILE: ${{ env.CONFIG_FILE }}"
        echo "ä¸‹è½½ç¼“å­˜æ¢å¤çŠ¶æ€: ${{ steps.cache-dl.outputs.cache-hit == 'true' && 'æˆåŠŸ' || 'æœªæ‰¾åˆ°ç¼“å­˜' }}"
        echo "æž„å»ºç¼“å­˜æ¢å¤çŠ¶æ€: ${{ steps.cache-build.outputs.cache-hit == 'true' && 'æˆåŠŸ' || 'æœªæ‰¾åˆ°ç¼“å­˜' }}"
        echo "å·¥å…·é“¾ç¼“å­˜æ¢å¤çŠ¶æ€: ${{ steps.cache-staging.outputs.cache-hit == 'true' && 'æˆåŠŸ' || 'æœªæ‰¾åˆ°ç¼“å­˜' }}"
        echo "CCACHEç¼“å­˜æ¢å¤çŠ¶æ€: ${{ steps.cache-ccache.outputs.cache-hit == 'true' && 'æˆåŠŸ' || 'æœªæ‰¾åˆ°ç¼“å­˜' }}"
        echo "æž„å»ºçŠ¶æ€ç¼“å­˜æ¢å¤çŠ¶æ€: ${{ steps.cache-state.outputs.cache-hit == 'true' && 'æˆåŠŸ' || 'æœªæ‰¾åˆ°ç¼“å­˜' }}"
        
        # æ£€æŸ¥ç¼“å­˜ç›®å½•å¤§å°
        echo "ä¸‹è½½ç›®å½•å¤§å°: $(du -sh ${{ env.DL_DIR }} 2>/dev/null || echo 'ç›®å½•ä¸å­˜åœ¨æˆ–ä¸ºç©º')"
        echo "æž„å»ºç›®å½•å¤§å°: $(du -sh ${{ env.BUILD_DIR }} 2>/dev/null || echo 'ç›®å½•ä¸å­˜åœ¨æˆ–ä¸ºç©º')"
        echo "å·¥å…·é“¾ç›®å½•å¤§å°: $(du -sh ${{ env.STAGING_DIR }} 2>/dev/null || echo 'ç›®å½•ä¸å­˜åœ¨æˆ–ä¸ºç©º')"
        echo "CCACHEç›®å½•å¤§å°: $(du -sh ${{ env.CCACHE_DIR }} 2>/dev/null || echo 'ç›®å½•ä¸å­˜åœ¨æˆ–ä¸ºç©º')"
        
        # æ£€æŸ¥å¯ç”¨ç©ºé—´
        df -h

    - name: å‡†å¤‡åˆå§‹åŒ–è„šæœ¬
      run: |
        # åˆ›å»ºDIYè„šæœ¬
        echo '#!/bin/bash' > $GITHUB_WORKSPACE/diy-part1.sh
        echo '# Feeds å·²é€šè¿‡ FEEDS_CONF_URL é…ç½®' >> $GITHUB_WORKSPACE/diy-part1.sh
        chmod +x $GITHUB_WORKSPACE/diy-part1.sh
        
        echo '#!/bin/bash' > $GITHUB_WORKSPACE/diy-part2.sh
        echo 'sed -i "s/OpenWrt /OpenWrt_AutoBuild /" package/lean/default-settings/files/zzz-default-settings' >> $GITHUB_WORKSPACE/diy-part2.sh
        chmod +x $GITHUB_WORKSPACE/diy-part2.sh
        
        # æ£€æŸ¥é…ç½®æ–‡ä»¶æ˜¯å¦å­˜åœ¨
        if [ ! -f "$GITHUB_WORKSPACE/$CONFIG_FILE" ]; then
          echo "è­¦å‘Šï¼šé…ç½®æ–‡ä»¶ $CONFIG_FILE ä¸å­˜åœ¨ï¼Œåˆ›å»ºé»˜è®¤é…ç½®æ–‡ä»¶"
          echo "# åˆ›å»ºé»˜è®¤çš„æœ€å°åŒ–é…ç½®æ–‡ä»¶" > $GITHUB_WORKSPACE/$CONFIG_FILE
          echo "CONFIG_TARGET_x86=y" >> $GITHUB_WORKSPACE/$CONFIG_FILE
          echo "CONFIG_TARGET_x86_64=y" >> $GITHUB_WORKSPACE/$CONFIG_FILE
          echo "CONFIG_TARGET_x86_64_DEVICE_generic=y" >> $GITHUB_WORKSPACE/$CONFIG_FILE
          echo "CONFIG_PACKAGE_luci=y" >> $GITHUB_WORKSPACE/$CONFIG_FILE
        fi
        
        # åˆ›å»ºDockerç¼–è¯‘è„šæœ¬
        cat > $GITHUB_WORKSPACE/docker-compile.sh << 'EOF'
        #!/bin/bash
        set -e

        # æ˜¾ç¤ºçŽ¯å¢ƒä¿¡æ¯
        echo "è¿è¡ŒçŽ¯å¢ƒ: $(uname -a)"
        echo "å½“å‰ç”¨æˆ·: $(whoami)"
        echo "å½“å‰ç›®å½•: $(pwd)"
        echo "ç›®å½•å†…å®¹: $(ls -la)"

        # è®¾ç½®CCACHE
        export CCACHE_DIR=/home/builder/cache/ccache
        ccache -M 8G
        ccache -o compression=true
        ccache -o compression_level=9
        ccache -o hash_dir=false
        ccache -o sloppiness=file_macro,include_file_ctime,include_file_mtime,time_macros
        
        # è®¾ç½®ç¼–è¯‘å™¨çŽ¯å¢ƒå˜é‡
        export PATH="/usr/lib/ccache:$PATH"
        export CONFIG_AUTOREMOVE=n
        export CONFIG_AUTOREBUILD=n
        export FORCE_UNSAFE_CONFIGURE=1
        
        # é…ç½®DLç›®å½•
        echo "é…ç½®OpenWrtæºä»£ç å’Œä¸‹è½½ç›®å½•..."
        cd /home/builder/openwrt
        
        if [ ! -f ".config" ]; then
          echo "å¤åˆ¶é…ç½®æ–‡ä»¶..."
          cp /config_file .config
        fi
        
        # é“¾æŽ¥ç¼“å­˜ç›®å½•
        echo "é“¾æŽ¥ç¼“å­˜ç›®å½•..."
        mkdir -p dl build_dir staging_dir
        
        if [ -d "/home/builder/cache/dl" ]; then
          echo "é“¾æŽ¥dlç›®å½•..."
          rm -rf dl
          ln -sf /home/builder/cache/dl ./dl
        else
          echo "åˆ›å»ºdlç›®å½•..."
          mkdir -p dl
          ln -sf $(pwd)/dl /home/builder/cache/dl
        fi
        
        if [ -d "/home/builder/cache/build_dir" ]; then
          echo "é“¾æŽ¥build_dirç›®å½•..."
          rm -rf build_dir
          ln -sf /home/builder/cache/build_dir ./build_dir
        else
          echo "åˆ›å»ºbuild_dirç›®å½•..."
          mkdir -p build_dir
          ln -sf $(pwd)/build_dir /home/builder/cache/build_dir
        fi
        
        if [ -d "/home/builder/cache/staging_dir" ]; then
          echo "é“¾æŽ¥staging_dirç›®å½•..."
          rm -rf staging_dir
          ln -sf /home/builder/cache/staging_dir ./staging_dir
        else
          echo "åˆ›å»ºstaging_dirç›®å½•..."
          mkdir -p staging_dir
          ln -sf $(pwd)/staging_dir /home/builder/cache/staging_dir
        fi
        
        # èŽ·å–ç¼“å­˜çŠ¶æ€
        REBUILD_TOOLCHAIN=0
        REBUILD_PACKAGES=0
        CLEAN_BUILD="${1:-false}"
        
        if [ "$CLEAN_BUILD" = "true" ]; then
          REBUILD_TOOLCHAIN=1
          REBUILD_PACKAGES=1
          echo "ç”¨æˆ·è¯·æ±‚å®Œå…¨é‡æ–°ç¼–è¯‘"
        fi
        
        # æ£€æŸ¥é…ç½®æ–‡ä»¶å˜åŒ–
        mkdir -p /home/builder/cache/build_state
        TOOLCHAIN_CONFIG=$(grep "^CONFIG_TARGET" .config | sort)
        TOOLCHAIN_MD5=$(echo "$TOOLCHAIN_CONFIG" | md5sum | awk '{print $1}')
        PREVIOUS_TOOLCHAIN_MD5=$(cat /home/builder/cache/build_state/toolchain.md5 2>/dev/null || echo "")
        PACKAGE_CONFIG=$(grep "^CONFIG_PACKAGE" .config | sort)
        PACKAGE_MD5=$(echo "$PACKAGE_CONFIG" | md5sum | awk '{print $1}')
        PREVIOUS_PACKAGE_MD5=$(cat /home/builder/cache/build_state/package.md5 2>/dev/null || echo "")
        
        if [ -z "$PREVIOUS_TOOLCHAIN_MD5" ] || [ "$TOOLCHAIN_MD5" != "$PREVIOUS_TOOLCHAIN_MD5" ]; then
          echo "å·¥å…·é“¾é…ç½®å˜åŒ–ï¼Œéœ€è¦é‡å»ºå·¥å…·é“¾"
          REBUILD_TOOLCHAIN=1
        fi
        
        if [ -z "$PREVIOUS_PACKAGE_MD5" ] || [ "$PACKAGE_MD5" != "$PREVIOUS_PACKAGE_MD5" ]; then
          echo "è½¯ä»¶åŒ…é…ç½®å˜åŒ–ï¼Œéœ€è¦é‡æ–°ç¼–è¯‘åŒ…"
          REBUILD_PACKAGES=1
        fi
        
        echo "æ›´æ–°å’Œå®‰è£…feeds..."
        ./scripts/feeds update -a
        ./scripts/feeds install -a
        make defconfig
        
        # ä¸‹è½½åŒ…å«é‡è¯•
        echo "ä¸‹è½½æºç åŒ…..."
        make download -j8 || make download -j1 V=s
        
        # ç¼–è¯‘æ­¥éª¤
        if [ $REBUILD_TOOLCHAIN -eq 1 ]; then
          echo "å¼€å§‹æž„å»ºå·¥å…·é“¾ (å·¥å…·é“¾é…ç½®å·²æ›´æ”¹)..."
          make tools/compile -j$(nproc) || make tools/compile V=s
          make toolchain/compile -j$(nproc) || make toolchain/compile V=s
        else
          echo "è·³è¿‡å·¥å…·é“¾æž„å»º (ä½¿ç”¨ç¼“å­˜)"
        fi
        
        if [ $REBUILD_PACKAGES -eq 1 ]; then
          echo "ç¼–è¯‘è½¯ä»¶åŒ… (è½¯ä»¶åŒ…é…ç½®å·²æ›´æ”¹)..."
          make package/compile -j$(nproc) IGNORE_ERRORS=1 || make package/compile V=s IGNORE_ERRORS=1
          make package/index V=s
        else
          echo "è·³è¿‡è½¯ä»¶åŒ…ç¼–è¯‘ (ä½¿ç”¨ç¼“å­˜)"
        fi
        
        # æ— è®ºæ˜¯å¦é‡æ–°ç¼–è¯‘ï¼Œéƒ½ç”Ÿæˆå›ºä»¶
        echo "ç”Ÿæˆå›ºä»¶..."
        make -j$(nproc) || make -j1 V=s
        
        # ä¿å­˜æž„å»ºçŠ¶æ€
        echo "$TOOLCHAIN_MD5" > /home/builder/cache/build_state/toolchain.md5
        echo "$PACKAGE_MD5" > /home/builder/cache/build_state/package.md5
        echo "æž„å»ºå®Œæˆï¼Œæ˜¾ç¤ºç”Ÿæˆçš„å›ºä»¶æ–‡ä»¶..."
        find bin/targets -type f -name "*.bin" -o -name "*combined*" -o -name "*sysupgrade*" | xargs ls -lh || echo "æœªæ‰¾åˆ°å›ºä»¶æ–‡ä»¶!"
        
        # æ˜¾ç¤ºCCACHEç»Ÿè®¡
        ccache -s
        EOF
        
        chmod +x $GITHUB_WORKSPACE/docker-compile.sh

    - name: åœ¨Dockerå®¹å™¨ä¸­å…‹éš†æºä»£ç 
      run: |
        # åœ¨Dockerå®¹å™¨ä¸­å…‹éš†æºä»£ç 
        docker run --rm \
          -v ${{ env.WORKDIR }}/openwrt:/home/builder/openwrt \
          -v ${{ env.CACHE_DIR }}:/home/builder/cache \
          -w /home/builder/openwrt \
          ${{ env.DOCKER_CONTAINER }} \
          /bin/bash -c "git clone --depth 1 ${{ env.REPO_URL }} -b ${{ env.REPO_BRANCH }} . && \
          curl -L -o feeds.conf.default '${{ env.FEEDS_CONF_URL }}' || echo 'è­¦å‘Šï¼šæ— æ³•ä¸‹è½½ feeds.conf.defaultï¼Œä½¿ç”¨ä»“åº“é»˜è®¤é…ç½®' && \
          cat feeds.conf.default && \
          rm -rf .git"
        
        # ç¡®ä¿æƒé™æ­£ç¡®
        sudo chown -R $(id -u):$(id -g) ${{ env.WORKDIR }}/openwrt
        sudo chown -R $(id -u):$(id -g) ${{ env.CACHE_DIR }}
        
        # å¤åˆ¶é…ç½®æ–‡ä»¶åˆ°å·¥ä½œç›®å½•
        cp $GITHUB_WORKSPACE/$CONFIG_FILE ${{ env.WORKDIR }}/openwrt/.config
        
        echo "æºç å…‹éš†å®Œæˆï¼Œæ˜¾ç¤ºç›®å½•ç»“æž„:"
        ls -la ${{ env.WORKDIR }}/openwrt

    - name: å¼€å¯SSHè°ƒè¯•
      uses: mxschmitt/action-tmate@v3
      if: github.event.inputs.ssh == 'true'

    - name: åœ¨Dockerå®¹å™¨ä¸­ç¼–è¯‘å›ºä»¶
      id: compile
      run: |
        # å¤åˆ¶ç¼–è¯‘è„šæœ¬å’Œé…ç½®æ–‡ä»¶åˆ°å®¹å™¨
        cp $GITHUB_WORKSPACE/docker-compile.sh ${{ env.WORKDIR }}/openwrt/
        cp $GITHUB_WORKSPACE/$CONFIG_FILE ${{ env.WORKDIR }}/openwrt/config_file
        
        # åœ¨Dockerå®¹å™¨ä¸­è¿è¡Œç¼–è¯‘
        docker run --rm \
          -v ${{ env.WORKDIR }}/openwrt:/home/builder/openwrt \
          -v ${{ env.CACHE_DIR }}:/home/builder/cache \
          -v $GITHUB_WORKSPACE/docker-compile.sh:/home/builder/openwrt/docker-compile.sh \
          -v $GITHUB_WORKSPACE/$CONFIG_FILE:/config_file \
          -w /home/builder/openwrt \
          -e DEBIAN_FRONTEND=noninteractive \
          -e TZ=${{ env.TZ }} \
          ${{ env.DOCKER_CONTAINER }} \
          /bin/bash -c "chmod +x /home/builder/openwrt/docker-compile.sh && /home/builder/openwrt/docker-compile.sh ${{ github.event.inputs.clean_build }}"
        
        # ç”Ÿæˆè®¾å¤‡åå’Œæ—¥æœŸ
        cd ${{ env.WORKDIR }}/openwrt
        echo "DEVICE_NAME=_$(grep '^CONFIG_TARGET.*DEVICE.*=y' .config | sed -r 's/.*DEVICE_(.*)=y/\1/' | tr '\n' '_')" >> $GITHUB_ENV
        echo "FILE_DATE=_$(date +"%Y%m%d%H%M")" >> $GITHUB_ENV
        echo "status=success" >> $GITHUB_OUTPUT
        
        # æ£€æŸ¥ç¼–è¯‘ç»“æžœ
        echo "æ£€æŸ¥å›ºä»¶ç¼–è¯‘ç»“æžœ:"
        find ${{ env.WORKDIR }}/openwrt/bin/targets -type f -name "*.bin" -o -name "*combined*" -o -name "*sysupgrade*" | xargs ls -lh || echo "æœªæ‰¾åˆ°å›ºä»¶æ–‡ä»¶!"

    # ä¿å­˜dlç›®å½•ç¼“å­˜
    - name: ä¿å­˜ä¸‹è½½ç¼“å­˜
      uses: actions/cache@v3
      if: "!cancelled()"
      with:
        path: ${{ env.DL_DIR }}
        key: dl-${{ env.REPO_BRANCH }}-${{ hashFiles('feeds.conf.default') }}

    # ä¿å­˜build_dirç¼“å­˜
    - name: ä¿å­˜æž„å»ºç¼“å­˜
      uses: actions/cache@v3
      if: "!cancelled()"
      with:
        path: ${{ env.BUILD_DIR }}
        key: build-${{ env.REPO_BRANCH }}-${{ hashFiles('**/*.config') }}

    # ä¿å­˜staging_dirç¼“å­˜
    - name: ä¿å­˜å·¥å…·é“¾ç¼“å­˜
      uses: actions/cache@v3
      if: "!cancelled()"
      with:
        path: ${{ env.STAGING_DIR }}
        key: staging-${{ env.REPO_BRANCH }}-${{ hashFiles('**/*.config') }}

    # ä¿å­˜CCACHEç¼“å­˜
    - name: ä¿å­˜CCACHEç¼“å­˜
      uses: actions/cache@v3
      if: "!cancelled()"
      with:
        path: ${{ env.CCACHE_DIR }}
        key: ccache-${{ env.REPO_BRANCH }}-${{ hashFiles('**/*.config') }}

    # ä¿å­˜æž„å»ºçŠ¶æ€ç¼“å­˜
    - name: ä¿å­˜æž„å»ºçŠ¶æ€ç¼“å­˜
      uses: actions/cache@v3
      if: "!cancelled()"
      with:
        path: ${{ env.BUILD_STATE_DIR }}
        key: state-${{ env.REPO_BRANCH }}-${{ hashFiles('**/*.config') }}

    - name: æ•´ç†æ–‡ä»¶
      id: organize
      if: steps.compile.outputs.status == 'success' && env.UPLOAD_FIRMWARE == 'true' && !cancelled()
      run: |
        # é¦–å…ˆå¹¿æ³›æœç´¢æ‰€æœ‰å¯èƒ½çš„å›ºä»¶æ–‡ä»¶
        echo "æœç´¢æ‰€æœ‰å¯èƒ½çš„å›ºä»¶æ–‡ä»¶..."
        find ${{ env.WORKDIR }}/openwrt/bin -type f -name "*.bin" -o -name "*.img" -o -name "*sysupgrade*" -o -name "*combined*" | \
          xargs -r ls -lh || echo "æœªæ‰¾åˆ°å¯èƒ½çš„å›ºä»¶æ–‡ä»¶"
          
        # æ£€æŸ¥æ˜¯å¦æœ‰ç›®æ ‡ç›®å½•
        if [ ! -d "${{ env.WORKDIR }}/openwrt/bin/targets" ]; then
          echo "é”™è¯¯ï¼šç¼–è¯‘ç›®æ ‡ç›®å½•ä¸å­˜åœ¨ï¼Œå¯èƒ½ç¼–è¯‘å¤±è´¥"
          # å³ä½¿æ²¡æœ‰å›ºä»¶æ–‡ä»¶ä¹Ÿä¸æŠ¥é”™ï¼Œè€Œæ˜¯åˆ›å»ºä¸€ä¸ªç©ºçš„å›ºä»¶ç›®å½•
          mkdir -p ${{ env.WORKDIR }}/openwrt/bin/targets/empty/firmware
          echo "FIRMWARE=${{ env.WORKDIR }}/openwrt/bin/targets/empty/firmware" >> $GITHUB_ENV
          echo "status=success" >> $GITHUB_OUTPUT
          exit 0
        fi
        
        # æŸ¥æ‰¾æ‰€æœ‰ç›®æ ‡ç›®å½•
        TARGET_DIRS=$(find ${{ env.WORKDIR }}/openwrt/bin/targets -mindepth 2 -maxdepth 2 -type d)
        
        if [ -z "$TARGET_DIRS" ]; then
          echo "è­¦å‘Šï¼šæœªæ‰¾åˆ°å…·ä½“ç›®æ ‡ç›®å½•ï¼Œåˆ›å»ºé€šç”¨ç›®å½•"
          mkdir -p ${{ env.WORKDIR }}/openwrt/bin/targets/generic/generic
          TARGET_DIRS="${{ env.WORKDIR }}/openwrt/bin/targets/generic/generic"
        fi
        
        # å¯¹äºŽæ¯ä¸ªç›®æ ‡ç›®å½•ï¼Œå°è¯•æŸ¥æ‰¾å›ºä»¶æ–‡ä»¶
        for TARGET_DIR in $TARGET_DIRS; do
          echo "å¤„ç†ç›®æ ‡ç›®å½•: $TARGET_DIR"
          cd "$TARGET_DIR"
          
          # åˆ›å»ºå›ºä»¶ç›®å½•å¹¶ç¡®ä¿å®ƒæ˜¯ç©ºçš„
          rm -rf firmware
          mkdir -p firmware
          
          # æŸ¥æ‰¾å›ºä»¶æ–‡ä»¶ - ä½¿ç”¨æ›´å®½æ¾çš„åŒ¹é…è§„åˆ™
          FILES_FOUND=0
          
          # å°è¯•å¤åˆ¶æ ‡å‡†å›ºä»¶æ–‡ä»¶
          for pattern in "*combined*" "*sysupgrade*" "*.img" "*.bin"; do
            echo "å°è¯•å¤åˆ¶åŒ¹é… $pattern çš„æ–‡ä»¶..."
            if find . -maxdepth 1 -name "$pattern" | grep -q .; then
              find . -maxdepth 1 -name "$pattern" -exec cp -f {} ./firmware/ \;
              FILES_FOUND=1
            fi
          done
          
          # å¦‚æžœæ²¡æœ‰æ‰¾åˆ°æ ‡å‡†å›ºä»¶æ–‡ä»¶ï¼Œå°è¯•å¤åˆ¶æ‰€æœ‰éžæ¸…å•æ–‡ä»¶
          if [ $FILES_FOUND -eq 0 ]; then
            echo "æœªæ‰¾åˆ°æ ‡å‡†å›ºä»¶æ–‡ä»¶ï¼Œå°è¯•å¤åˆ¶æ‰€æœ‰å¯èƒ½çš„æ–‡ä»¶..."
            find . -maxdepth 1 -type f -not -name "*.manifest" -not -name "*.txt" -not -name "*.json" \
              -not -name "*.buildinfo" -exec cp -f {} ./firmware/ \;
          fi
          
          # å¤åˆ¶é…ç½®æ–‡ä»¶
          if [ -f "${{ env.WORKDIR }}/openwrt/.config" ]; then
            cp -f ${{ env.WORKDIR }}/openwrt/.config ./firmware/config.txt
          fi
          
          # æ£€æŸ¥æ˜¯å¦æˆåŠŸå¤åˆ¶äº†ä»»ä½•æ–‡ä»¶
          if [ -n "$(ls -A firmware)" ]; then
            echo "æˆåŠŸå¤åˆ¶å›ºä»¶æ–‡ä»¶åˆ° $TARGET_DIR/firmware"
            echo "å›ºä»¶å†…å®¹:"
            ls -lh firmware/
            
            echo "FIRMWARE=$TARGET_DIR/firmware" >> $GITHUB_ENV
            echo "status=success" >> $GITHUB_OUTPUT
            break
          else
            echo "è­¦å‘Š: $TARGET_DIR ä¸­æœªæ‰¾åˆ°å¯ç”¨å›ºä»¶æ–‡ä»¶"
          fi
        done
        
        # å¦‚æžœæ²¡æœ‰æ‰¾åˆ°ä»»ä½•å›ºä»¶æ–‡ä»¶ï¼Œä½¿ç”¨ç´§æ€¥å¤‡ç”¨æ–¹æ³•
        if [ -z "$FIRMWARE" ]; then
          echo "è­¦å‘Šï¼šæœªèƒ½åœ¨ä»»ä½•ç›®æ ‡ç›®å½•ä¸­æ‰¾åˆ°å›ºä»¶æ–‡ä»¶ï¼Œä½¿ç”¨ç´§æ€¥å¤‡ç”¨æ–¹æ³•"
          BACKUP_DIR="${{ env.WORKDIR }}/openwrt/bin/targets/generic/backup_firmware"
          mkdir -p "$BACKUP_DIR/firmware"
          
          # å¤åˆ¶æ‰€æœ‰binç›®å½•ä¸‹çš„éžåŒ…æ–‡ä»¶
          find ${{ env.WORKDIR }}/openwrt/bin -type f -not -path "*/packages/*" -exec cp -f {} "$BACKUP_DIR/firmware/" \;
          
          # ç¡®ä¿è‡³å°‘æœ‰ä¸€ä¸ªé…ç½®æ–‡ä»¶
          if [ -f "${{ env.WORKDIR }}/openwrt/.config" ]; then
            cp -f ${{ env.WORKDIR }}/openwrt/.config "$BACKUP_DIR/firmware/config.txt"
          else
            echo "# ç´§æ€¥å¤‡ç”¨é…ç½®" > "$BACKUP_DIR/firmware/config.txt"
          fi
          
          echo "FIRMWARE=$BACKUP_DIR/firmware" >> $GITHUB_ENV
          echo "status=success" >> $GITHUB_OUTPUT
        fi
        
        # åˆ›å»ºå›ºä»¶åŽ‹ç¼©åŒ…
        if [ -n "$FIRMWARE" ]; then
          cd $(dirname "$FIRMWARE")
          zip -r firmware.zip $(basename "$FIRMWARE")
          echo "FIRMWARE_ZIP=$(dirname "$FIRMWARE")/firmware.zip" >> $GITHUB_ENV
        fi

    # ä¸Šä¼ å›ºä»¶
    - name: ä¸Šä¼ å›ºä»¶ç›®å½•
      uses: actions/upload-artifact@main
      if: steps.organize.outputs.status == 'success' && !cancelled()
      with:
        name: OpenWrt_firmware${{ env.DEVICE_NAME }}${{ env.FILE_DATE }}
        path: ${{ env.FIRMWARE }}

    - name: ç”Ÿæˆå‘å¸ƒæ ‡ç­¾
      id: tag
      if: steps.organize.outputs.status == 'success' && env.UPLOAD_RELEASE == 'true' && !cancelled()
      run: |
        echo "RELEASE_TAG=$(date +"%Y.%m.%d-%H%M")" >> $GITHUB_OUTPUT
        echo "## OpenWrtå›ºä»¶æž„å»ºå®Œæˆ ðŸ“¦" > release.txt
        echo "ðŸ“… æž„å»ºæ—¶é—´: $(date +"%Y-%m-%d %H:%M")" >> release.txt
        echo "ðŸ“‚ å›ºä»¶ä¸‹è½½" >> release.txt
        echo "âš ï¸ è¯·åœ¨åˆ·æœºå‰å…ˆåšå¥½å¤‡ä»½ï¼" >> release.txt
        echo "status=success" >> $GITHUB_OUTPUT

    - name: ä¸Šä¼ å›ºä»¶åˆ°Releases
      uses: softprops/action-gh-release@v2
      if: steps.tag.outputs.status == 'success' && !cancelled()
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ steps.tag.outputs.RELEASE_TAG }}
        body_path: release.txt
        files: ${{ env.FIRMWARE }}/*

    - name: åˆ é™¤æ—§çš„Releases
      uses: dev-drprasad/delete-older-releases@master
      if: env.UPLOAD_RELEASE == 'true' && !cancelled()
      with:
        keep_latest: 3
        delete_tags: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
