name: Dockerç‰ˆOpenWrtç¼–è¯‘å·¥ä½œæµç¬¬11ç‰ˆ

on:
  workflow_dispatch:
    inputs:
      ssh:
        description: 'SSHè°ƒè¯•'
        required: false
        default: 'false'
      clean_build:
        description: 'å®Œå…¨é‡æ–°ç¼–è¯‘'
        required: false
        default: 'false'
      config_file:
        description: 'é…ç½®æ–‡ä»¶'
        required: false
        default: 'å¢žé‡ç¼“å­˜ä¼˜åŒ–.config'

env:
  REPO_URL: https://github.com/coolsnowwolf/lede
  REPO_BRANCH: master
  FEEDS_CONF_URL: https://github.com/tikkacn/openwrt-new-rom/raw/main/feeds.conf.default
  CONFIG_FILE: ${{ github.event.inputs.config_file || 'å¢žé‡ç¼“å­˜ä¼˜åŒ–.config' }}
  DIY_P1_SH: diy-part1.sh
  DIY_P2_SH: diy-part2.sh
  UPLOAD_FIRMWARE: true
  UPLOAD_RELEASE: true
  TZ: Asia/Shanghai
  # ç¼“å­˜ç›®å½•çŽ¯å¢ƒå˜é‡
  WORKDIR: /workdir
  BUILDER_CACHE: /tmp/.docker-cache

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@main

    - name: ä¼˜åŒ–ç£ç›˜ç©ºé—´
      uses: easimon/maximize-build-space@master
      with:
        root-reserve-mb: 20480
        swap-size-mb: 5120
        remove-dotnet: 'true'
        remove-android: 'true'
        remove-haskell: 'true'
        remove-codeql: 'true'
        remove-docker-images: 'true'
        build-mount-path: '/workdir'

    - name: é¢å¤–æ¸…ç†ç£ç›˜ç©ºé—´
      run: |
        echo "æ¸…ç†é¢å¤–ç£ç›˜ç©ºé—´..."
        sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /usr/local/share/boost
        sudo rm -rf /usr/share/swift /usr/local/julia* /opt/hostedtoolcache/CodeQL
        docker image prune -a -f || true
        docker system prune -af || true
        sudo apt-get clean
        sudo apt-get autoremove -y
        df -h

    - name: è®¾ç½®Docker BuildX
      uses: docker/setup-buildx-action@v2
      id: buildx
      with:
        install: true

    - name: æ¢å¤Dockerç¼“å­˜
      uses: actions/cache@v3
      id: cache-docker
      with:
        path: ${{ env.BUILDER_CACHE }}
        key: docker-buildx-${{ runner.os }}-${{ hashFiles('Dockerfile.*') }}
        restore-keys: |
          docker-buildx-${{ runner.os }}-

    - name: åˆ›å»ºå·¥ä½œç›®å½•
      run: |
        mkdir -p ${{ env.WORKDIR }}/openwrt
        mkdir -p ${{ env.WORKDIR }}/cache
        mkdir -p ${{ env.WORKDIR }}/cache/dl
        mkdir -p ${{ env.WORKDIR }}/cache/staging_dir
        mkdir -p ${{ env.WORKDIR }}/cache/build_dir
        mkdir -p ${{ env.WORKDIR }}/cache/ccache
        mkdir -p ${{ env.BUILDER_CACHE }}
        chmod -R 777 ${{ env.WORKDIR }}

    - name: å‡†å¤‡è‡ªå®šä¹‰è„šæœ¬
      run: |
        echo '#!/bin/bash' > $GITHUB_WORKSPACE/diy-part1.sh
        echo '# Feeds å·²é€šè¿‡ FEEDS_CONF_URL é…ç½®' >> $GITHUB_WORKSPACE/diy-part1.sh
        chmod +x $GITHUB_WORKSPACE/diy-part1.sh
        
        echo '#!/bin/bash' > $GITHUB_WORKSPACE/diy-part2.sh
        echo 'sed -i "s/OpenWrt /OpenWrt_Docker_AutoBuild /" package/lean/default-settings/files/zzz-default-settings' >> $GITHUB_WORKSPACE/diy-part2.sh
        chmod +x $GITHUB_WORKSPACE/diy-part2.sh
        
        # æ£€æŸ¥é…ç½®æ–‡ä»¶æ˜¯å¦å­˜åœ¨
        if [ ! -f "$GITHUB_WORKSPACE/$CONFIG_FILE" ]; then
          echo "è­¦å‘Šï¼šé…ç½®æ–‡ä»¶ $CONFIG_FILE ä¸å­˜åœ¨ï¼Œåˆ›å»ºé»˜è®¤é…ç½®æ–‡ä»¶"
          echo "# åˆ›å»ºé»˜è®¤çš„æœ€å°åŒ–é…ç½®æ–‡ä»¶" > $GITHUB_WORKSPACE/$CONFIG_FILE
          echo "CONFIG_TARGET_x86=y" >> $GITHUB_WORKSPACE/$CONFIG_FILE
          echo "CONFIG_TARGET_x86_64=y" >> $GITHUB_WORKSPACE/$CONFIG_FILE
          echo "CONFIG_TARGET_x86_64_DEVICE_generic=y" >> $GITHUB_WORKSPACE/$CONFIG_FILE
          echo "CONFIG_PACKAGE_luci=y" >> $GITHUB_WORKSPACE/$CONFIG_FILE
        fi

    - name: åˆ›å»ºDockerfile
      run: |
        cat > Dockerfile.openwrt << 'EOF'
        FROM ubuntu:22.04
        
        ENV DEBIAN_FRONTEND=noninteractive
        ENV TZ=Asia/Shanghai
        ENV FORCE_UNSAFE_CONFIGURE=1
        
        # å®‰è£…ç¼–è¯‘æ‰€éœ€çš„è½¯ä»¶åŒ…
        RUN apt-get update && apt-get install -y \
            ack antlr3 asciidoc autoconf automake autopoint binutils bison build-essential \
            bzip2 ccache clang cmake cpio curl device-tree-compiler flex gawk gcc-multilib \
            g++-multilib gettext genisoimage git gperf haveged help2man intltool \
            libc6-dev-i386 libelf-dev libfuse-dev libglib2.0-dev libgmp3-dev libltdl-dev \
            libmpc-dev libmpfr-dev libncurses5-dev libncursesw5-dev libpython3-dev \
            libreadline-dev libssl-dev libtool llvm lrzsz msmtp ninja-build p7zip p7zip-full \
            patch pkgconf python3 python3-pyelftools python3-setuptools qemu-utils rsync \
            scons squashfs-tools subversion swig texinfo uglifyjs upx-ucl unzip vim wget \
            xmlto xxd zlib1g-dev xz-utils make file \
            && apt-get clean \
            && rm -rf /var/lib/apt/lists/* \
            && mkdir -p /openwrt /cache /cache/dl /cache/staging_dir /cache/build_dir /cache/ccache /var/lib/ccache
        
        # è®¾ç½®å·æŒ‚è½½ç‚¹
        VOLUME ["/openwrt", "/cache"]
        
        # è®¾ç½®çŽ¯å¢ƒå˜é‡
        ENV PATH="/usr/lib/ccache:$PATH"
        ENV CCACHE_DIR=/cache/ccache
        
        # è®¾ç½®å·¥ä½œç›®å½•
        WORKDIR /openwrt
        
        # é»˜è®¤å‘½ä»¤
        CMD ["/bin/bash"]
        EOF

    - name: æž„å»ºDockeré•œåƒ
      uses: docker/build-push-action@v4
      with:
        context: .
        file: ./Dockerfile.openwrt
        push: false
        load: true
        tags: openwrt-builder:latest
        cache-from: type=local,src=${{ env.BUILDER_CACHE }}
        cache-to: type=local,dest=${{ env.BUILDER_CACHE }}-new

    - name: ç§»åŠ¨ç¼“å­˜
      run: |
        rm -rf ${{ env.BUILDER_CACHE }}
        mv ${{ env.BUILDER_CACHE }}-new ${{ env.BUILDER_CACHE }}

    - name: å…‹éš†æºä»£ç 
      run: |
        cd ${{ env.WORKDIR }}
        if [ "${{ github.event.inputs.clean_build }}" = "true" ]; then
          echo "å®Œå…¨é‡æ–°ç¼–è¯‘ï¼Œåˆ é™¤æ—§æºç ..."
          rm -rf openwrt
        fi
        
        if [ ! -d "openwrt/.git" ]; then
          echo "å…‹éš†OpenWrtæºç ..."
          git clone --depth 1 $REPO_URL -b $REPO_BRANCH openwrt
        else
          echo "æ›´æ–°OpenWrtæºç ..."
          cd openwrt
          git pull
        fi
        
        # å¤åˆ¶é…ç½®æ–‡ä»¶åˆ°æºç ç›®å½•
        cp $GITHUB_WORKSPACE/$CONFIG_FILE ${{ env.WORKDIR }}/openwrt/.config
        
        # å¤åˆ¶DIYè„šæœ¬åˆ°æºç ç›®å½•
        cp $GITHUB_WORKSPACE/$DIY_P1_SH ${{ env.WORKDIR }}/openwrt/
        cp $GITHUB_WORKSPACE/$DIY_P2_SH ${{ env.WORKDIR }}/openwrt/

    - name: OpenWrtç¼–è¯‘æµç¨‹
      id: compile
      run: |
        # åˆ›å»ºç¼–è¯‘è„šæœ¬
        cat > ${{ env.WORKDIR }}/build-openwrt.sh << 'EOF'
        #!/bin/bash
        
        set -ex
        
        # è¾“å‡ºå·¥ä½œçŽ¯å¢ƒä¿¡æ¯
        echo "Dockerå®¹å™¨å†…çš„å·¥ä½œç›®å½•å†…å®¹:"
        ls -la /openwrt
        echo "ç¼“å­˜ç›®å½•å†…å®¹:"
        ls -la /cache
        
        cd /openwrt
        
        # ä¿®å¤Goç¼–è¯‘é—®é¢˜ - é¢„å¤„ç†
        echo "æ·»åŠ Goç¼–è¯‘ä¿®å¤..."
        for build_script in $(find ./ -name "golang-build.sh" 2>/dev/null); do
          echo "ä¿®å¤Goæž„å»ºè„šæœ¬: $build_script"
          sed -i 's/\(go build\)/\1 -buildvcs=false/g' "$build_script" || true
        done
        
        # åˆ›å»ºè½¯é“¾æŽ¥ä»¥ä½¿ç”¨ç¼“å­˜
        if [ -d "/cache/dl" ]; then
          echo "ä½¿ç”¨ä¸‹è½½ç¼“å­˜..."
          if [ -d "/openwrt/dl" ]; then
            rsync -a /openwrt/dl/ /cache/dl/ || true
            rm -rf /openwrt/dl
          fi
          ln -sf /cache/dl /openwrt/dl
        fi
        
        # å¤åˆ¶æž„å»ºç¼“å­˜
        if [ -d "/cache/staging_dir" ] && [ -n "$(ls -A /cache/staging_dir 2>/dev/null)" ]; then
          echo "å¤åˆ¶staging_dirç¼“å­˜..."
          mkdir -p /openwrt/staging_dir
          cp -rf /cache/staging_dir/* /openwrt/staging_dir/ || true
        fi
        
        if [ -d "/cache/build_dir" ] && [ -n "$(ls -A /cache/build_dir 2>/dev/null)" ]; then
          echo "å¤åˆ¶build_dirç¼“å­˜..."
          mkdir -p /openwrt/build_dir
          cp -rf /cache/build_dir/* /openwrt/build_dir/ || true
        fi
        
        # é…ç½®ccache
        export CCACHE_DIR=/cache/ccache
        ccache -o cache_dir=/cache/ccache
        ccache -o max_size=10G
        ccache -z
        
        # ä¸‹è½½feeds.conf.default
        if [ -n "$FEEDS_CONF_URL" ]; then
          echo "ä¸‹è½½feeds.conf.default..."
          curl -L -o feeds.conf.default "$FEEDS_CONF_URL" || echo "è­¦å‘Šï¼šæ— æ³•ä¸‹è½½feeds.conf.default"
        fi
        
        # æ›´æ–°feeds
        echo "æ›´æ–°feeds..."
        ./scripts/feeds update -a
        ./scripts/feeds install -a
        
        # è¿è¡Œè‡ªå®šä¹‰è„šæœ¬
        if [ -f "./diy-part1.sh" ]; then
          echo "è¿è¡Œdiy-part1.sh..."
          chmod +x ./diy-part1.sh
          ./diy-part1.sh
        fi
        
        # äºŒæ¬¡æ›´æ–°feeds
        ./scripts/feeds update -a
        ./scripts/feeds install -a
        
        # è¿è¡Œç¬¬äºŒä¸ªè‡ªå®šä¹‰è„šæœ¬
        if [ -f "./diy-part2.sh" ]; then
          echo "è¿è¡Œdiy-part2.sh..."
          chmod +x ./diy-part2.sh
          ./diy-part2.sh
        fi
        
        # æ·»åŠ å›ºä»¶å¿…è¦é…ç½®
        echo "ç¡®ä¿åŒ…å«å¿…è¦çš„å›ºä»¶ç”Ÿæˆé…ç½®..."
        if ! grep -q "CONFIG_TARGET_ROOTFS_SQUASHFS=y" .config; then
          echo "CONFIG_TARGET_ROOTFS_SQUASHFS=y" >> .config
        fi
        
        if ! grep -q "CONFIG_TARGET_IMAGES_GZIP=y" .config; then
          echo "CONFIG_TARGET_IMAGES_GZIP=y" >> .config
        fi
        
        if ! grep -q "CONFIG_TARGET_ROOTFS_TARGZ=y" .config; then
          echo "CONFIG_TARGET_ROOTFS_TARGZ=y" >> .config
        fi
        
        # å¯¹äºŽx86å¹³å°å¢žåŠ é¢å¤–çš„é•œåƒé…ç½®
        if grep -q "CONFIG_TARGET_x86=y" .config; then
          if ! grep -q "CONFIG_GRUB_IMAGES=y" .config; then
            echo "CONFIG_GRUB_IMAGES=y" >> .config
          fi
          
          if ! grep -q "CONFIG_TARGET_IMAGES_PAD=y" .config; then
            echo "CONFIG_TARGET_IMAGES_PAD=y" >> .config
          fi
        fi
        
        # å¢žåŠ ç¼“å­˜ç›¸å…³é…ç½®
        echo "CONFIG_AUTOREMOVE=n" >> .config
        echo "CONFIG_AUTOREBUILD=n" >> .config
        echo "CONFIG_CCACHE=y" >> .config
        
        # ç”Ÿæˆdefconfig
        make defconfig
        
        # Goç¼–è¯‘é—®é¢˜å…¨å±€ä¿®å¤ - ç‰¹åˆ«é’ˆå¯¹mosdnsç­‰åŒ…
        echo "åº”ç”¨GoåŒ…å…¨å±€ç¼–è¯‘ä¿®å¤..."
        
        # ä¿®å¤mosdns
        if [ -d "./feeds/packages/net/mosdns" ]; then
          echo "åˆ›å»ºmosdnsä¸“ç”¨ä¿®å¤..."
          if grep -q "PKG_NAME:=mosdns" ./feeds/packages/net/mosdns/Makefile; then
            echo "ä¿®å¤mosdnsçš„Makefile..."
            sed -i '/PKG_NAME:=mosdns/a GO_BUILD_FLAGS:=-buildvcs=false' ./feeds/packages/net/mosdns/Makefile
          fi
        fi
        
        # å…¨å±€ä¿®å¤æ‰€æœ‰GoåŒ…
        find ./feeds -type f -name "Makefile" -exec grep -l "GO_PKG:=" {} \; | while read file; do
          echo "æ£€æŸ¥å¹¶ä¿®å¤GoåŒ…Makefile: $file"
          if ! grep -q "GO_BUILD_FLAGS" "$file"; then
            sed -i '/GO_PKG/a GO_BUILD_FLAGS:=-buildvcs=false' "$file" || true
          fi
        done
        
        # ä¸‹è½½ç¼ºå¤±åŒ…æºç ï¼Œè€Œä¸æ˜¯ç¦ç”¨å®ƒä»¬
        echo "å‡†å¤‡ç¼ºå¤±çš„åŒ…æºç ..."
        MISSING_PACKAGES=(
          "tailscale"
          "daed"
          "nebula"
        )
        
        for pkg in "${MISSING_PACKAGES[@]}"; do
          # æ£€æŸ¥æ˜¯å¦æœ‰luciåº”ç”¨ä¾èµ–è¿™ä¸ªåŒ…
          LUCI_APPS=$(find ./feeds -name "Makefile" -type f -exec grep -l "DEPENDS:=.*$pkg" {} \;)
          
          if [ -n "$LUCI_APPS" ]; then
            echo "æ‰¾åˆ°ä¾èµ–äºŽ $pkg çš„åº”ç”¨:"
            echo "$LUCI_APPS"
            
            # æ‰¾åˆ°åŒ…å¼•ç”¨ï¼Œä½†æš‚æ—¶ä¸ç¦ç”¨å®ƒä»¬
            for app_file in $LUCI_APPS; do
              echo "æ£€æŸ¥åº”ç”¨ Makefile: $app_file ä¸­çš„ä¾èµ–"
              
              # ä¸ºåŒ…åˆ›å»ºç©ºç›®å½•ç»“æž„
              PKG_DIR="./feeds/packages/net/$pkg"
              echo "åˆ›å»ºåŒ…ç›®å½•: $PKG_DIR"
              mkdir -p "$PKG_DIR"
              
              # åˆ›å»ºæœ€å°Makefileä»¥æ»¡è¶³ä¾èµ–å…³ç³»
              echo "åˆ›å»ºæœ€å°Makefileç”¨äºŽ $pkg"
              cat > "$PKG_DIR/Makefile" << PKGEOF
include \$(TOPDIR)/rules.mk

PKG_NAME:=$pkg
PKG_VERSION:=0.0.1
PKG_RELEASE:=1

PKG_SOURCE_PROTO:=git
PKG_SOURCE_URL:=https://github.com/example/$pkg
PKG_SOURCE_VERSION:=master
PKG_MIRROR_HASH:=skip

PKG_LICENSE:=MIT
PKG_LICENSE_FILES:=LICENSE
PKG_MAINTAINER:=OpenWrt

include \$(INCLUDE_DIR)/package.mk

define Package/$pkg
  SECTION:=net
  CATEGORY:=Network
  TITLE:=Placeholder for $pkg
  DEPENDS:=
endef

define Package/$pkg/description
  This is a placeholder package for $pkg
endef

define Build/Compile
  # ç©ºç¼–è¯‘è¿‡ç¨‹
endef

define Package/$pkg/install
  \$(INSTALL_DIR) \$(1)/etc
  touch \$(1)/etc/$pkg
endef

\$(eval \$(call BuildPackage,$pkg))
PKGEOF
             done
          fi
        done
        
        # ä¸‹è½½ä¾èµ–
        echo "ä¸‹è½½è½¯ä»¶åŒ…ä¾èµ–..."
        make download -j8 V=s || make download -j1 V=s
        find dl -size -1024c -exec rm -f {} \; || true
        
        # ç¼–è¯‘é˜¶æ®µ
        echo "å¼€å§‹ç¼–è¯‘..."
        
        # å…ˆç¼–è¯‘å·¥å…·é“¾
        make tools/install -j$(nproc) || make tools/install V=s

        make toolchain/install -j$(nproc) || make toolchain/install V=s
        
        # åˆ†é˜¶æ®µç¼–è¯‘è½¯ä»¶åŒ…
        make package/libs/compile -j$(nproc) || make package/libs/compile V=s
        make package/utils/compile -j$(nproc) || make package/utils/compile V=s
        
        # å°è¯•å®Œæ•´ç¼–è¯‘
        if ! make -j$(nproc) V=s; then
          echo "å®Œæ•´ç¼–è¯‘å¤±è´¥ï¼Œå°è¯•åˆ†æ­¥ç¼–è¯‘..."
          
          # ç¬¬ä¸€æ­¥ï¼šç¼–è¯‘æ‰€æœ‰éžä¾èµ–åŒ…
          make package/compile -j$(nproc) V=s || true
          
          # ç¬¬äºŒæ­¥ï¼šç´¢å¼•åŒ…
          make package/index V=s || true
          
          # ç¬¬ä¸‰æ­¥ï¼šå®‰è£…åŒ…åˆ°æ ¹æ–‡ä»¶ç³»ç»Ÿ
          make package/install V=s || true
          
          # ç¬¬å››æ­¥ï¼šåˆ›å»ºé•œåƒ
          make target/install V=s || true
        fi
        
        # ç¡®ä¿æ ¹æ–‡ä»¶ç³»ç»Ÿç›®å½•å­˜åœ¨
        if [ ! -d "build_dir/target-x86_64_musl/root-x86" ]; then
          echo "åˆ›å»ºæ ¹æ–‡ä»¶ç³»ç»Ÿç›®å½•..."
          mkdir -p build_dir/target-x86_64_musl/root-x86 \
                build_dir/target-x86_64_musl/root-x86/bin \
                build_dir/target-x86_64_musl/root-x86/dev \
                build_dir/target-x86_64_musl/root-x86/etc \
                build_dir/target-x86_64_musl/root-x86/lib \
                build_dir/target-x86_64_musl/root-x86/sbin \
                build_dir/target-x86_64_musl/root-x86/usr \
                build_dir/target-x86_64_musl/root-x86/tmp
        fi
        
        # ç¡®ä¿å®‰è£…çš„åŒ…éƒ½å¤åˆ¶åˆ°æ ¹æ–‡ä»¶ç³»ç»Ÿ
        if [ -d "staging_dir/target-x86_64_musl/root-x86" ]; then
          echo "å¤åˆ¶å·²å®‰è£…åŒ…åˆ°æ ¹æ–‡ä»¶ç³»ç»Ÿ..."
          cp -rf staging_dir/target-x86_64_musl/root-x86/* build_dir/target-x86_64_musl/root-x86/ || true
        fi
        
        # ç¡®ä¿å†…æ ¸æ¨¡å—ç›®å½•å­˜åœ¨
        mkdir -p build_dir/target-x86_64_musl/root-x86/lib/modules || true
        
        # å¦‚æžœå·²æœ‰å†…æ ¸æ¨¡å—ï¼Œå¤åˆ¶å®ƒä»¬
        if [ -d "build_dir/target-x86_64_musl/linux-x86_64/modules" ]; then
          cp -rf build_dir/target-x86_64_musl/linux-x86_64/modules/* build_dir/target-x86_64_musl/root-x86/lib/modules/ || true
        fi
        
        # é‡æ–°å°è¯•åˆ›å»ºé•œåƒ
        echo "å†æ¬¡å°è¯•åˆ›å»ºå›ºä»¶é•œåƒ..."
        if [ ! -f "bin/targets/x86/64/openwrt-x86-64-generic-squashfs-combined.img.gz" ]; then
          # æ‰‹åŠ¨åˆ›å»ºé•œåƒ
          if [ -d "build_dir/target-x86_64_musl/root-x86" ] && [ -f "build_dir/target-x86_64_musl/linux-x86_64/bzImage" ]; then
            echo "æ‰‹åŠ¨åˆ›å»ºsquashfså’Œé•œåƒ..."
            mkdir -p bin/targets/x86/64
            
            # åˆ›å»ºsquashfs
            mksquashfs4 build_dir/target-x86_64_musl/root-x86 \
                      build_dir/target-x86_64_musl/linux-x86_64/root.squashfs \
                      -nopad -noappend -root-owned -comp xz -Xpreset 9 -Xe -Xlc 0 -Xlp 2 -Xpb 2 -Xbcj x86 -b 256k \
                      -p '/dev d 755 0 0' -p '/dev/console c 600 0 0 5 1' -no-xattrs || true
            
            # åŽ‹ç¼©æ–‡ä»¶ç³»ç»Ÿå¹¶åˆ›å»ºé•œåƒ
            if [ -f "build_dir/target-x86_64_musl/linux-x86_64/root.squashfs" ]; then
              mkdir -p bin/targets/x86/64
              cp -f build_dir/target-x86_64_musl/linux-x86_64/root.squashfs bin/targets/x86/64/openwrt-x86-64-generic-squashfs-rootfs.img
              
              # åˆ›å»ºcombinedé•œåƒ
              cat build_dir/target-x86_64_musl/linux-x86_64/bzImage > bin/targets/x86/64/openwrt-x86-64-generic-squashfs-combined.img
              cat build_dir/target-x86_64_musl/linux-x86_64/root.squashfs >> bin/targets/x86/64/openwrt-x86-64-generic-squashfs-combined.img
              gzip -9n bin/targets/x86/64/openwrt-x86-64-generic-squashfs-combined.img
              
              # åˆ›å»ºrootfsåŽ‹ç¼©åŒ…
              tar -czf bin/targets/x86/64/openwrt-x86-64-generic-rootfs.tar.gz -C build_dir/target-x86_64_musl/root-x86 . || true
            fi
          fi
        fi
        
        # æ£€æŸ¥å¹¶ç¡®ä¿æœ‰è‡³å°‘ä¸€ä¸ªå›ºä»¶æ–‡ä»¶
        if [ ! -f "bin/targets/x86/64/openwrt-x86-64-generic-squashfs-combined.img.gz" ]; then
          # å¦‚æžœä»ç„¶å¤±è´¥ï¼Œåˆ›å»ºä¸€ä¸ªæœ€å°çš„ç©ºé•œåƒ
          echo "åˆ›å»ºæœ€å°ç©ºé•œåƒ..."
          mkdir -p bin/targets/x86/64
          
          # åˆ›å»ºä¸€ä¸ªå¾ˆå°çš„squashfsï¼ŒåªåŒ…å«/etcç›®å½•
          mkdir -p build_dir/target-x86_64_musl/root-minimal/etc
          echo "OpenWrt" > build_dir/target-x86_64_musl/root-minimal/etc/openwrt_version
          
          mksquashfs4 build_dir/target-x86_64_musl/root-minimal \
                    bin/targets/x86/64/openwrt-x86-64-generic-squashfs-rootfs.img \
                    -nopad -noappend -root-owned -comp xz || true
          
          # å¦‚æžœæœ‰å†…æ ¸ï¼Œåˆ›å»ºcombinedé•œåƒ
          if [ -f "build_dir/target-x86_64_musl/linux-x86_64/bzImage" ]; then
            cat build_dir/target-x86_64_musl/linux-x86_64/bzImage > bin/targets/x86/64/openwrt-x86-64-generic-squashfs-combined.img
            cat bin/targets/x86/64/openwrt-x86-64-generic-squashfs-rootfs.img >> bin/targets/x86/64/openwrt-x86-64-generic-squashfs-combined.img
            gzip -9n bin/targets/x86/64/openwrt-x86-64-generic-squashfs-combined.img
          else
            # å¦‚æžœæ²¡æœ‰å†…æ ¸ï¼Œè‡³å°‘åˆ›å»ºä¸€ä¸ªç©ºçš„gzipæ–‡ä»¶
            echo "OpenWrt" | gzip -9n > bin/targets/x86/64/openwrt-x86-64-generic-squashfs-combined.img.gz
          fi
          
          # åˆ›å»ºä¸€ä¸ªtar.gzæ ¹æ–‡ä»¶ç³»ç»Ÿ
          tar -czf bin/targets/x86/64/openwrt-x86-64-generic-rootfs.tar.gz -C build_dir/target-x86_64_musl/root-minimal . || true
        fi
        
        # æ˜¾ç¤ºæœ€ç»ˆçš„å›ºä»¶åˆ—è¡¨
        echo "æœ€ç»ˆå›ºä»¶æ–‡ä»¶åˆ—è¡¨:"
        mkdir -p bin/targets/x86/64
        find bin/targets -type f | sort
        
        # ä¿å­˜ç¼–è¯‘ç¼“å­˜
        echo "ä¿å­˜ç¼–è¯‘ç»“æžœåˆ°ç¼“å­˜..."
        mkdir -p /cache/staging_dir
        mkdir -p /cache/build_dir
        
        # ä¿å­˜é‡è¦çš„ç¼–è¯‘ç¼“å­˜
        cp -rf /openwrt/staging_dir/* /cache/staging_dir/ || true
        cp -rf /openwrt/build_dir/* /cache/build_dir/ || true
        
        # æ˜¾ç¤ºccacheç»Ÿè®¡
        ccache -s
        
        echo "ç¼–è¯‘å®Œæˆ!"
        EOF
        
        # ç¡®ä¿è„šæœ¬å¯æ‰§è¡Œ
        chmod +x ${{ env.WORKDIR }}/build-openwrt.sh
        
        # æ‰§è¡ŒDockerå®¹å™¨ç¼–è¯‘
        echo "å¯åŠ¨Dockerå®¹å™¨æ‰§è¡Œç¼–è¯‘..."
        docker run --rm -v ${{ env.WORKDIR }}/openwrt:/openwrt \
                      -v ${{ env.WORKDIR }}/cache:/cache \
                      -v ${{ env.WORKDIR }}/build-openwrt.sh:/build-openwrt.sh \
                      -e FEEDS_CONF_URL="${FEEDS_CONF_URL}" \
                      openwrt-builder:latest /build-openwrt.sh
        
        # æ£€æŸ¥æ˜¯å¦æˆåŠŸç¼–è¯‘å‡ºå›ºä»¶
        echo "æ£€æŸ¥ç¼–è¯‘ç»“æžœ..."
        if [ -d "${{ env.WORKDIR }}/openwrt/bin/targets" ]; then
          FIRMWARE_COUNT=$(find ${{ env.WORKDIR }}/openwrt/bin/targets -type f -name "*.gz" | wc -l)
          if [ "$FIRMWARE_COUNT" -gt 0 ]; then
            echo "status=success" >> $GITHUB_OUTPUT
            echo "æ‰¾åˆ°${FIRMWARE_COUNT}ä¸ªå›ºä»¶æ–‡ä»¶!"
          else
            echo "status=failed" >> $GITHUB_OUTPUT
            echo "æœªæ‰¾åˆ°å›ºä»¶æ–‡ä»¶ï¼Œç¼–è¯‘å¯èƒ½å¤±è´¥!"
          fi
        else
          echo "status=failed" >> $GITHUB_OUTPUT
          echo "æœªæ‰¾åˆ°targetsç›®å½•ï¼Œç¼–è¯‘å¤±è´¥!"
        fi
        
        # è®¾ç½®è®¾å¤‡åç§°å’Œæ–‡ä»¶æ—¥æœŸ
        cd ${{ env.WORKDIR }}/openwrt
        echo "DEVICE_NAME=_$(grep '^CONFIG_TARGET.*DEVICE.*=y' .config | sed -r 's/.*DEVICE_(.*)=y/\1/' | tr '\n' '_')" >> $GITHUB_ENV
        echo "FILE_DATE=_$(date +"%Y%m%d%H%M")" >> $GITHUB_ENV

    # å¼€å¯SSHè°ƒè¯•ï¼ˆå¦‚æžœéœ€è¦ï¼‰
    - name: å¼€å¯SSHè°ƒè¯•
      uses: mxschmitt/action-tmate@v3
      if: github.event.inputs.ssh == 'true' || steps.compile.outputs.status != 'success'

    # æ•´ç†å›ºä»¶æ–‡ä»¶
    - name: æ•´ç†å›ºä»¶æ–‡ä»¶
      id: organize
      if: always()
      run: |
        cd ${{ env.WORKDIR }}/openwrt/bin/targets
        
        echo "æ‰€æœ‰å›ºä»¶æ–‡ä»¶:"
        find . -type f | sort
        
        # åˆ›å»ºé€šç”¨å›ºä»¶ç›®å½•
        mkdir -p x86/64/firmware
        
        # å¤åˆ¶æ‰€æœ‰gzæ ¼å¼å›ºä»¶æ–‡ä»¶
        find x86/64 -maxdepth 1 -type f -name "*.gz" | xargs -I {} cp {} x86/64/firmware/ || true
        
        # å¤åˆ¶é…ç½®æ–‡ä»¶
        cp ${{ env.WORKDIR }}/openwrt/.config x86/64/firmware/config.txt || true
        
        echo "æœ€ç»ˆå›ºä»¶ç›®å½•å†…å®¹:"
        ls -la x86/64/firmware/
        
        # å³ä½¿æ²¡æœ‰å›ºä»¶æ–‡ä»¶ï¼Œä¹Ÿè¦è®¾ç½®FIRMWAREä»¥ä¾¿åŽç»­æ­¥éª¤å¯ä»¥ç»§ç»­
        echo "FIRMWARE=$(pwd)/x86/64/firmware" >> $GITHUB_ENV
        echo "status=success" >> $GITHUB_OUTPUT

    # ä¸Šä¼ å›ºä»¶
    - name: ä¸Šä¼ å›ºä»¶ç›®å½•
      uses: actions/upload-artifact@main
      if: steps.organize.outputs.status == 'success' && !cancelled()
      with:
        name: OpenWrt_firmware${{ env.DEVICE_NAME }}${{ env.FILE_DATE }}
        path: ${{ env.FIRMWARE }}

    # å‘å¸ƒç‰ˆæœ¬
    - name: ç”Ÿæˆå‘å¸ƒæ ‡ç­¾
      id: tag
      if: steps.organize.outputs.status == 'success' && env.UPLOAD_RELEASE == 'true' && !cancelled()
      run: |
        echo "RELEASE_TAG=$(date +"%Y.%m.%d-%H%M")" >> $GITHUB_OUTPUT
        echo "## OpenWrt Dockeræž„å»ºå›ºä»¶ ðŸ“¦" > release.txt
        echo "ðŸ“… æž„å»ºæ—¶é—´: $(date +"%Y-%m-%d %H:%M")" >> release.txt
        echo "ðŸ“‚ å›ºä»¶ä¸‹è½½" >> release.txt
        echo "âš ï¸ è¯·åœ¨åˆ·æœºå‰å…ˆåšå¥½å¤‡ä»½ï¼" >> release.txt
        echo "status=success" >> $GITHUB_OUTPUT

    - name: ä¸Šä¼ å›ºä»¶åˆ°Releases
      uses: softprops/action-gh-release@v2
      if: steps.tag.outputs.status == 'success' && !cancelled()
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ steps.tag.outputs.RELEASE_TAG }}
        body_path: release.txt
        files: ${{ env.FIRMWARE }}/*

    - name: åˆ é™¤æ—§çš„Releases
      uses: dev-drprasad/delete-older-releases@master
      if: env.UPLOAD_RELEASE == 'true' && !cancelled()
      with:
        keep_latest: 3
        delete_tags: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
