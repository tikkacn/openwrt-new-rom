name: "1. Init OpenWrt Build Environment"

on:
  schedule:
    - cron: '0 16 * * 0,3'  # 每周日和周三的 UTC 16:00
  workflow_dispatch:

permissions:
  contents: read
  packages: read
  actions: write

env:
  TZ: Asia/Shanghai

jobs:
  init:
    runs-on: ubuntu-22.04
    
    steps:
    - name: Free Disk Space
      uses: jlumbroso/free-disk-space@main
      with:
        tool-cache: false
        android: true
        dotnet: true
        haskell: true
        large-packages: true
        swap-storage: true
        docker-images: true

    - name: Checkout
      uses: actions/checkout@main

    - name: Cache apt packages
      uses: actions/cache@v3
      with:
        path: /var/cache/apt
        key: ${{ runner.os }}-apt-${{ hashFiles('**/depends-ubuntu-2204') }}
        restore-keys: |
          ${{ runner.os }}-apt-

    - name: Init Build Dependencies
      run: |
        sudo rm -rf /etc/apt/sources.list.d/* /usr/share/dotnet /usr/local/lib/android /opt/ghc
        sudo -E apt-get -qq update
        sudo -E apt-get -qq install $(curl -fsSL https://raw.githubusercontent.com/tikkacn/openwrt-new-rom/main/depends-ubuntu-2204)
        sudo -E apt-get -qq autoremove --purge
        sudo -E apt-get -qq clean
        
        # 验证安装
        for pkg in build-essential clang flex bison g++ gawk gcc-multilib g++-multilib \
                  gettext git libncurses5-dev libssl-dev python3-distutils rsync unzip \
                  zlib1g-dev file wget; do
          dpkg -l | grep -q "^ii  $pkg" || {
            echo "Error: Package $pkg not installed"
            exit 1
          }
        done

    - name: Delete workflow runs
      uses: Mattraks/delete-workflow-runs@v2
      with:
        retain_days: 1
        keep_minimum_runs: 3